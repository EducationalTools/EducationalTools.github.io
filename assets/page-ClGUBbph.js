const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/bun-sqlite-dialect-C3P_ISb5-BAbVJ2ug.js","assets/chunk-JMJ3UQ3L-DLa4wvEN.js","assets/button-D7tyPeF-.js","assets/index-CPvIzByb.js","assets/bundle-mjs-BNe0Xlio.js","assets/utils-BB8OEnXs.js","assets/card-BpPdZkTd.js","assets/empty-Cg1BKJnV.js","assets/input-DE-BWp1k.js","assets/constants-DzlEtQAh.js","assets/ConvexAuthState-CCLe0bpr.js","assets/auth-client-CoRsmko_.js","assets/sha2-CO3l0I8W.js","assets/index-Dr94eIYd.js","assets/index-Bqq4DHLr.js","assets/index-vAMRNKaC.js","assets/alert-dialog-C5z3n2hc.js","assets/index-BoNYA7lJ.js","assets/index-CeJ37sa3.js","assets/index-RdSmrbPg.js","assets/state-DJ_Xbwdm.js","assets/experimental-check-BwBX2eWT.js","assets/node-sqlite-dialect-D6w8Ekdz-BOQCjX4i.js","assets/index-DGf9FXR5.js","assets/index-C758adAn.js"])))=>i.map(i=>d[i]);
import{p as L,A as wd,w as Nd,z as gd,a as bn}from"./chunk-JMJ3UQ3L-DLa4wvEN.js";import{B as pr}from"./button-D7tyPeF-.js";import{C as Co,a as Lo,b as Do,c as qo}from"./card-BpPdZkTd.js";import{E as bd,a as vd,b as Ed,c as Od,d as Ad}from"./empty-Cg1BKJnV.js";import{I as gi}from"./input-DE-BWp1k.js";import{c as Td}from"./utils-BB8OEnXs.js";import{p as le,b as As,c as Hr,d as Fr,i as Sd,e as xd,a as Ht,A as _o,m as vn,N as Vr}from"./constants-DzlEtQAh.js";import{_ as Rr,B as Ce,c as Pu,l as tt,g as ee,s as Me,p as Ts,b as bi,d as br,e as Rd,f as Vs,h as Id,i as Mn,r as kd,A as V,j as Po,E as Cd,k as ri,m as ke,n as Ld,o as $u,q as Dd,t as qd,u as _d,v as vr,w as Bs,x as Pd,y as $d,z as Wd,C as Wu,D as Ud,F as Md,G as jd,H as Fd,I as Vd,J as Bd,K as Uu,L as Ft,M as En,N as Jd,O as Gd,P as ye,Q as Se,R as he,S as st,T as vi,U as $o,V as On,W as An,X as Tn,Y as Sn,Z as Hd,$ as Ei,a0 as qe,a1 as Ss,a2 as Qd,a3 as Yd,a4 as zd,a5 as Kd,a6 as Xd,a7 as Zd,a8 as el,a9 as tl,aa as Mu,ab as vt,ac as rl,ad as nl,a as il}from"./auth-client-CoRsmko_.js";import{Y as sl,l as ol,y as al,_ as ul,c as Wo}from"./index-Dr94eIYd.js";import{t as Qt}from"./index-Bqq4DHLr.js";import{c as Re,j as Ke,g as ni,v as $e,p as ii,d as $t,e as cl,u as dl,f as Uo,b as ll}from"./ConvexAuthState-CCLe0bpr.js";import{o as Mo,s as jo}from"./sha2-CO3l0I8W.js";import{A as Fo,a as Vo,b as Bo,c as Jo,d as Go,e as Ho,f as Qo,g as Yo,h as zo}from"./alert-dialog-C5z3n2hc.js";import{i as hl}from"./experimental-check-BwBX2eWT.js";function xn({className:t,...e}){return L.jsx("div",{"data-slot":"skeleton",className:Td("bg-accent animate-pulse rounded-md",t),...e})}var fl=Object.defineProperty,pl=(t,e,r)=>e in t?fl(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,de=(t,e,r)=>pl(t,typeof e!="symbol"?e+"":e,r);const ml="https://docs.convex.dev/error#undefined-validator";function dn(t,e){const r=e!==void 0?` for field "${e}"`:"";throw new Error(`A validator is undefined${r} in ${t}. This is often caused by circular imports. See ${ml} for details.`)}class Ye{constructor({isOptional:e}){de(this,"type"),de(this,"fieldPaths"),de(this,"isOptional"),de(this,"isConvexValidator"),this.isOptional=e,this.isConvexValidator=!0}}class Js extends Ye{constructor({isOptional:e,tableName:r}){if(super({isOptional:e}),de(this,"tableName"),de(this,"kind","id"),typeof r!="string")throw new Error("v.id(tableName) requires a string");this.tableName=r}get json(){return{type:"id",tableName:this.tableName}}asOptional(){return new Js({isOptional:"optional",tableName:this.tableName})}}class jn extends Ye{constructor(){super(...arguments),de(this,"kind","float64")}get json(){return{type:"number"}}asOptional(){return new jn({isOptional:"optional"})}}class Fn extends Ye{constructor(){super(...arguments),de(this,"kind","int64")}get json(){return{type:"bigint"}}asOptional(){return new Fn({isOptional:"optional"})}}class Gs extends Ye{constructor(){super(...arguments),de(this,"kind","boolean")}get json(){return{type:this.kind}}asOptional(){return new Gs({isOptional:"optional"})}}class Hs extends Ye{constructor(){super(...arguments),de(this,"kind","bytes")}get json(){return{type:this.kind}}asOptional(){return new Hs({isOptional:"optional"})}}class Qs extends Ye{constructor(){super(...arguments),de(this,"kind","string")}get json(){return{type:this.kind}}asOptional(){return new Qs({isOptional:"optional"})}}class Ys extends Ye{constructor(){super(...arguments),de(this,"kind","null")}get json(){return{type:this.kind}}asOptional(){return new Ys({isOptional:"optional"})}}class zs extends Ye{constructor(){super(...arguments),de(this,"kind","any")}get json(){return{type:this.kind}}asOptional(){return new zs({isOptional:"optional"})}}class Zt extends Ye{constructor({isOptional:e,fields:r}){super({isOptional:e}),de(this,"fields"),de(this,"kind","object"),globalThis.Object.entries(r).forEach(([n,i])=>{if(i===void 0&&dn("v.object()",n),!i.isConvexValidator)throw new Error("v.object() entries must be validators")}),this.fields=r}get json(){return{type:this.kind,value:globalThis.Object.fromEntries(globalThis.Object.entries(this.fields).map(([e,r])=>[e,{fieldType:r.json,optional:r.isOptional==="optional"}]))}}asOptional(){return new Zt({isOptional:"optional",fields:this.fields})}omit(...e){const r={...this.fields};for(const n of e)delete r[n];return new Zt({isOptional:this.isOptional,fields:r})}pick(...e){const r={};for(const n of e)r[n]=this.fields[n];return new Zt({isOptional:this.isOptional,fields:r})}partial(){const e={};for(const[r,n]of globalThis.Object.entries(this.fields))e[r]=n.asOptional();return new Zt({isOptional:this.isOptional,fields:e})}extend(e){return new Zt({isOptional:this.isOptional,fields:{...this.fields,...e}})}}class Ks extends Ye{constructor({isOptional:e,value:r}){if(super({isOptional:e}),de(this,"value"),de(this,"kind","literal"),typeof r!="string"&&typeof r!="boolean"&&typeof r!="number"&&typeof r!="bigint")throw new Error("v.literal(value) must be a string, number, or boolean");this.value=r}get json(){return{type:this.kind,value:Re(this.value)}}asOptional(){return new Ks({isOptional:"optional",value:this.value})}}class Xs extends Ye{constructor({isOptional:e,element:r}){super({isOptional:e}),de(this,"element"),de(this,"kind","array"),r===void 0&&dn("v.array()"),this.element=r}get json(){return{type:this.kind,value:this.element.json}}asOptional(){return new Xs({isOptional:"optional",element:this.element})}}class Zs extends Ye{constructor({isOptional:e,key:r,value:n}){if(super({isOptional:e}),de(this,"key"),de(this,"value"),de(this,"kind","record"),r===void 0&&dn("v.record()","key"),n===void 0&&dn("v.record()","value"),r.isOptional==="optional")throw new Error("Record validator cannot have optional keys");if(n.isOptional==="optional")throw new Error("Record validator cannot have optional values");if(!r.isConvexValidator||!n.isConvexValidator)throw new Error("Key and value of v.record() but be validators");this.key=r,this.value=n}get json(){return{type:this.kind,keys:this.key.json,values:{fieldType:this.value.json,optional:!1}}}asOptional(){return new Zs({isOptional:"optional",key:this.key,value:this.value})}}class eo extends Ye{constructor({isOptional:e,members:r}){super({isOptional:e}),de(this,"members"),de(this,"kind","union"),r.forEach((n,i)=>{if(n===void 0&&dn("v.union()",`member at index ${i}`),!n.isConvexValidator)throw new Error("All members of v.union() must be validators")}),this.members=r}get json(){return{type:this.kind,value:this.members.map(e=>e.json)}}asOptional(){return new eo({isOptional:"optional",members:this.members})}}function ju(t){return!!t.isConvexValidator}function Fu(t){return ju(t)?t:a.object(t)}const a={id:t=>new Js({isOptional:"required",tableName:t}),null:()=>new Ys({isOptional:"required"}),number:()=>new jn({isOptional:"required"}),float64:()=>new jn({isOptional:"required"}),bigint:()=>new Fn({isOptional:"required"}),int64:()=>new Fn({isOptional:"required"}),boolean:()=>new Gs({isOptional:"required"}),string:()=>new Qs({isOptional:"required"}),bytes:()=>new Hs({isOptional:"required"}),literal:t=>new Ks({isOptional:"required",value:t}),array:t=>new Xs({isOptional:"required",element:t}),object:t=>new Zt({isOptional:"required",fields:t}),record:(t,e)=>new Zs({isOptional:"required",key:t,value:e}),union:(...t)=>new eo({isOptional:"required",members:t}),any:()=>new zs({isOptional:"required"}),optional:t=>t.asOptional(),nullable:t=>a.union(t,a.null())};function Oi(t,e,r){return{...ni(e),args:Re(ii(r)),version:$e,requestId:t}}function yl(t){return{runQuery:async(e,r)=>{const n=await le("1.0/actions/query",Oi(t,e,r));return Ke(n)},runMutation:async(e,r)=>{const n=await le("1.0/actions/mutation",Oi(t,e,r));return Ke(n)},runAction:async(e,r)=>{const n=await le("1.0/actions/action",Oi(t,e,r));return Ke(n)}}}var wl=Object.defineProperty,Nl=(t,e,r)=>e in t?wl(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,Ko=(t,e,r)=>Nl(t,typeof e!="symbol"?e+"":e,r);class gl{constructor(){Ko(this,"_isExpression"),Ko(this,"_value")}}function K(t,e,r,n){if(t===void 0)throw new TypeError(`Must provide arg ${e} \`${n}\` to \`${r}\``)}function bl(t,e,r,n){if(!Number.isInteger(t)||t<0)throw new TypeError(`Arg ${e} \`${n}\` to \`${r}\` must be a non-negative integer`)}var vl=Object.defineProperty,El=(t,e,r)=>e in t?vl(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,xs=(t,e,r)=>El(t,typeof e!="symbol"?e+"":e,r);function Ol(t){return async(e,r,n)=>{if(K(e,1,"vectorSearch","tableName"),K(r,2,"vectorSearch","indexName"),K(n,3,"vectorSearch","query"),!n.vector||!Array.isArray(n.vector)||n.vector.length===0)throw Error("`vector` must be a non-empty Array in vectorSearch");return await new Al(t,e+"."+r,n).collect()}}class Al{constructor(e,r,n){xs(this,"requestId"),xs(this,"state"),this.requestId=e;const i=n.filter?qn(n.filter(Tl)):null;this.state={type:"preparing",query:{indexName:r,limit:n.limit,vector:n.vector,expressions:i}}}async collect(){if(this.state.type==="consumed")throw new Error("This query is closed and can't emit any more values.");const e=this.state.query;this.state={type:"consumed"};const{results:r}=await le("1.0/actions/vectorSearch",{requestId:this.requestId,version:$e,query:e});return r}}let Dn=class extends gl{constructor(e){super(),xs(this,"inner"),this.inner=e}serialize(){return this.inner}};function qn(t){return t instanceof Dn?t.serialize():{$literal:$t(t)}}const Tl={eq(t,e){if(typeof t!="string")throw new Error("The first argument to `q.eq` must be a field name.");return new Dn({$eq:[qn(new Dn({$field:t})),qn(e)]})},or(...t){return new Dn({$or:t.map(qn)})}};function to(t){return{getUserIdentity:async()=>await le("1.0/getUserIdentity",{requestId:t})}}var Sl=Object.defineProperty,xl=(t,e,r)=>e in t?Sl(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,Xo=(t,e,r)=>xl(t,typeof e!="symbol"?e+"":e,r);class Rl{constructor(){Xo(this,"_isExpression"),Xo(this,"_value")}}var Il=Object.defineProperty,kl=(t,e,r)=>e in t?Il(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,Cl=(t,e,r)=>kl(t,e+"",r);class Ee extends Rl{constructor(e){super(),Cl(this,"inner"),this.inner=e}serialize(){return this.inner}}function X(t){return t instanceof Ee?t.serialize():{$literal:$t(t)}}const Ll={eq(t,e){return new Ee({$eq:[X(t),X(e)]})},neq(t,e){return new Ee({$neq:[X(t),X(e)]})},lt(t,e){return new Ee({$lt:[X(t),X(e)]})},lte(t,e){return new Ee({$lte:[X(t),X(e)]})},gt(t,e){return new Ee({$gt:[X(t),X(e)]})},gte(t,e){return new Ee({$gte:[X(t),X(e)]})},add(t,e){return new Ee({$add:[X(t),X(e)]})},sub(t,e){return new Ee({$sub:[X(t),X(e)]})},mul(t,e){return new Ee({$mul:[X(t),X(e)]})},div(t,e){return new Ee({$div:[X(t),X(e)]})},mod(t,e){return new Ee({$mod:[X(t),X(e)]})},neg(t){return new Ee({$neg:X(t)})},and(...t){return new Ee({$and:t.map(X)})},or(...t){return new Ee({$or:t.map(X)})},not(t){return new Ee({$not:X(t)})},field(t){return new Ee({$field:t})}};var Dl=Object.defineProperty,ql=(t,e,r)=>e in t?Dl(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,_l=(t,e,r)=>ql(t,e+"",r);class Pl{constructor(){_l(this,"_isIndexRange")}}var $l=Object.defineProperty,Wl=(t,e,r)=>e in t?$l(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,Zo=(t,e,r)=>Wl(t,typeof e!="symbol"?e+"":e,r);class kt extends Pl{constructor(e){super(),Zo(this,"rangeExpressions"),Zo(this,"isConsumed"),this.rangeExpressions=e,this.isConsumed=!1}static new(){return new kt([])}consume(){if(this.isConsumed)throw new Error("IndexRangeBuilder has already been used! Chain your method calls like `q => q.eq(...).eq(...)`. See https://docs.convex.dev/using/indexes");this.isConsumed=!0}eq(e,r){return this.consume(),new kt(this.rangeExpressions.concat({type:"Eq",fieldPath:e,value:$t(r)}))}gt(e,r){return this.consume(),new kt(this.rangeExpressions.concat({type:"Gt",fieldPath:e,value:$t(r)}))}gte(e,r){return this.consume(),new kt(this.rangeExpressions.concat({type:"Gte",fieldPath:e,value:$t(r)}))}lt(e,r){return this.consume(),new kt(this.rangeExpressions.concat({type:"Lt",fieldPath:e,value:$t(r)}))}lte(e,r){return this.consume(),new kt(this.rangeExpressions.concat({type:"Lte",fieldPath:e,value:$t(r)}))}export(){return this.consume(),this.rangeExpressions}}var Ul=Object.defineProperty,Ml=(t,e,r)=>e in t?Ul(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,jl=(t,e,r)=>Ml(t,e+"",r);class Fl{constructor(){jl(this,"_isSearchFilter")}}var Vl=Object.defineProperty,Bl=(t,e,r)=>e in t?Vl(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,ea=(t,e,r)=>Bl(t,typeof e!="symbol"?e+"":e,r);class Qr extends Fl{constructor(e){super(),ea(this,"filters"),ea(this,"isConsumed"),this.filters=e,this.isConsumed=!1}static new(){return new Qr([])}consume(){if(this.isConsumed)throw new Error("SearchFilterBuilder has already been used! Chain your method calls like `q => q.search(...).eq(...)`.");this.isConsumed=!0}search(e,r){return K(e,1,"search","fieldName"),K(r,2,"search","query"),this.consume(),new Qr(this.filters.concat({type:"Search",fieldPath:e,value:r}))}eq(e,r){return K(e,1,"eq","fieldName"),arguments.length!==2&&K(r,2,"search","value"),this.consume(),new Qr(this.filters.concat({type:"Eq",fieldPath:e,value:$t(r)}))}export(){return this.consume(),this.filters}}var Jl=Object.defineProperty,Gl=(t,e,r)=>e in t?Jl(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,Rs=(t,e,r)=>Gl(t,typeof e!="symbol"?e+"":e,r);const ta=256;class Vu{constructor(e){Rs(this,"tableName"),this.tableName=e}withIndex(e,r){K(e,1,"withIndex","indexName");let n=kt.new();return r!==void 0&&(n=r(n)),new Vt({source:{type:"IndexRange",indexName:this.tableName+"."+e,range:n.export(),order:null},operators:[]})}withSearchIndex(e,r){K(e,1,"withSearchIndex","indexName"),K(r,2,"withSearchIndex","searchFilter");const n=Qr.new();return new Vt({source:{type:"Search",indexName:this.tableName+"."+e,filters:r(n).export()},operators:[]})}fullTableScan(){return new Vt({source:{type:"FullTableScan",tableName:this.tableName,order:null},operators:[]})}order(e){return this.fullTableScan().order(e)}async count(){const e=await le("1.0/count",{table:this.tableName});return Ke(e)}filter(e){return this.fullTableScan().filter(e)}limit(e){return this.fullTableScan().limit(e)}collect(){return this.fullTableScan().collect()}take(e){return this.fullTableScan().take(e)}paginate(e){return this.fullTableScan().paginate(e)}first(){return this.fullTableScan().first()}unique(){return this.fullTableScan().unique()}[Symbol.asyncIterator](){return this.fullTableScan()[Symbol.asyncIterator]()}}function ra(t){throw new Error(t==="consumed"?"This query is closed and can't emit any more values.":"This query has been chained with another operator and can't be reused.")}class Vt{constructor(e){Rs(this,"state"),Rs(this,"tableNameForErrorMessages"),this.state={type:"preparing",query:e},e.source.type==="FullTableScan"?this.tableNameForErrorMessages=e.source.tableName:this.tableNameForErrorMessages=e.source.indexName.split(".")[0]}takeQuery(){if(this.state.type!=="preparing")throw new Error("A query can only be chained once and can't be chained after iteration begins.");const e=this.state.query;return this.state={type:"closed"},e}startQuery(){if(this.state.type==="executing")throw new Error("Iteration can only begin on a query once.");(this.state.type==="closed"||this.state.type==="consumed")&&ra(this.state.type);const e=this.state.query,{queryId:r}=As("1.0/queryStream",{query:e,version:$e});return this.state={type:"executing",queryId:r},r}closeQuery(){if(this.state.type==="executing"){const e=this.state.queryId;As("1.0/queryCleanup",{queryId:e})}this.state={type:"consumed"}}order(e){K(e,1,"order","order");const r=this.takeQuery();if(r.source.type==="Search")throw new Error("Search queries must always be in relevance order. Can not set order manually.");if(r.source.order!==null)throw new Error("Queries may only specify order at most once");return r.source.order=e,new Vt(r)}filter(e){K(e,1,"filter","predicate");const r=this.takeQuery();if(r.operators.length>=ta)throw new Error(`Can't construct query with more than ${ta} operators`);return r.operators.push({filter:X(e(Ll))}),new Vt(r)}limit(e){K(e,1,"limit","n");const r=this.takeQuery();return r.operators.push({limit:e}),new Vt(r)}[Symbol.asyncIterator](){return this.startQuery(),this}async next(){(this.state.type==="closed"||this.state.type==="consumed")&&ra(this.state.type);const e=this.state.type==="preparing"?this.startQuery():this.state.queryId,{value:r,done:n}=await le("1.0/queryStreamNext",{queryId:e});return n&&this.closeQuery(),{value:Ke(r),done:n}}return(){return this.closeQuery(),Promise.resolve({done:!0,value:void 0})}async paginate(e){if(K(e,1,"paginate","options"),typeof e?.numItems!="number"||e.numItems<0)throw new Error(`\`options.numItems\` must be a positive number. Received \`${e?.numItems}\`.`);const r=this.takeQuery(),n=e.numItems,i=e.cursor,s=e?.endCursor??null,u=e.maximumRowsRead??null,{page:d,isDone:c,continueCursor:h,splitCursor:l,pageStatus:y}=await le("1.0/queryPage",{query:r,cursor:i,endCursor:s,pageSize:n,maximumRowsRead:u,maximumBytesRead:e.maximumBytesRead,version:$e});return{page:d.map(f=>Ke(f)),isDone:c,continueCursor:h,splitCursor:l,pageStatus:y}}async collect(){const e=[];for await(const r of this)e.push(r);return e}async take(e){return K(e,1,"take","n"),bl(e,1,"take","n"),this.limit(e).collect()}async first(){const e=await this.take(1);return e.length===0?null:e[0]}async unique(){const e=await this.take(2);if(e.length===0)return null;if(e.length===2)throw new Error(`unique() query returned more than one result from table ${this.tableNameForErrorMessages}:
 [${e[0]._id}, ${e[1]._id}, ...]`);return e[0]}}async function Is(t,e,r){if(K(e,1,"get","id"),typeof e!="string")throw new Error(`Invalid argument \`id\` for \`db.get\`, expected string but got '${typeof e}': ${e}`);const n={id:Re(e),isSystem:r,version:$e,table:t},i=await le("1.0/get",n);return Ke(i)}function Bu(){const t=(i=!1)=>({get:async(s,u)=>u!==void 0?await Is(s,u,i):await Is(void 0,s,i),query:s=>new Ds(s,i).query(),normalizeId:(s,u)=>{K(s,1,"normalizeId","tableName"),K(u,2,"normalizeId","id");const d=s.startsWith("_");if(d!==i)throw new Error(`${d?"System":"User"} tables can only be accessed from db.${i?"":"system."}normalizeId().`);const c=As("1.0/db/normalizeId",{table:s,idString:u});return Ke(c).id},system:null,table:s=>new Ds(s,i)}),{system:e,...r}=t(!0),n=t();return n.system=r,n}async function Ju(t,e){if(t.startsWith("_"))throw new Error("System tables (prefixed with `_`) are read-only.");K(t,1,"insert","table"),K(e,2,"insert","value");const r=await le("1.0/insert",{table:t,value:Re(e)});return Ke(r)._id}async function ks(t,e,r){K(e,1,"patch","id"),K(r,2,"patch","value"),await le("1.0/shallowMerge",{id:Re(e),value:cl(r),table:t})}async function Cs(t,e,r){K(e,1,"replace","id"),K(r,2,"replace","value"),await le("1.0/replace",{id:Re(e),value:Re(r),table:t})}async function Ls(t,e){K(e,1,"delete","id"),await le("1.0/remove",{id:Re(e),table:t})}function Hl(){const t=Bu();return{get:t.get,query:t.query,normalizeId:t.normalizeId,system:t.system,insert:async(e,r)=>await Ju(e,r),patch:async(e,r,n)=>n!==void 0?await ks(e,r,n):await ks(void 0,e,r),replace:async(e,r,n)=>n!==void 0?await Cs(e,r,n):await Cs(void 0,e,r),delete:async(e,r)=>r!==void 0?await Ls(e,r):await Ls(void 0,e),table:e=>new Ql(e,!1)}}class Ds{constructor(e,r){this.tableName=e,this.isSystem=r}async get(e){return Is(this.tableName,e,this.isSystem)}query(){const e=this.tableName.startsWith("_");if(e!==this.isSystem)throw new Error(`${e?"System":"User"} tables can only be accessed from db.${this.isSystem?"":"system."}query().`);return new Vu(this.tableName)}}class Ql extends Ds{async insert(e){return Ju(this.tableName,e)}async patch(e,r){return ks(this.tableName,e,r)}async replace(e,r){return Cs(this.tableName,e,r)}async delete(e){return Ls(this.tableName,e)}}function Yl(){return{runAfter:async(t,e,r)=>{const n=Gu(t,e,r);return await le("1.0/schedule",n)},runAt:async(t,e,r)=>{const n=Hu(t,e,r);return await le("1.0/schedule",n)},cancel:async t=>{K(t,1,"cancel","id");const e={id:Re(t)};await le("1.0/cancel_job",e)}}}function zl(t){return{runAfter:async(e,r,n)=>{const i={requestId:t,...Gu(e,r,n)};return await le("1.0/actions/schedule",i)},runAt:async(e,r,n)=>{const i={requestId:t,...Hu(e,r,n)};return await le("1.0/actions/schedule",i)},cancel:async e=>{K(e,1,"cancel","id");const r={id:Re(e)};return await le("1.0/actions/cancel_job",r)}}}function Gu(t,e,r){if(typeof t!="number")throw new Error("`delayMs` must be a number");if(!isFinite(t))throw new Error("`delayMs` must be a finite number");if(t<0)throw new Error("`delayMs` must be non-negative");const n=ii(r),i=ni(e),s=(Date.now()+t)/1e3;return{...i,ts:s,args:Re(n),version:$e}}function Hu(t,e,r){let n;if(t instanceof Date)n=t.valueOf()/1e3;else if(typeof t=="number")n=t/1e3;else throw new Error("The invoke time must a Date or a timestamp");const i=ni(e),s=ii(r);return{...i,ts:n,args:Re(s),version:$e}}function Qu(t){return{getUrl:async e=>(K(e,1,"getUrl","storageId"),await le("1.0/storageGetUrl",{requestId:t,version:$e,storageId:e})),getMetadata:async e=>await le("1.0/storageGetMetadata",{requestId:t,version:$e,storageId:e})}}function Yu(t){const e=Qu(t);return{generateUploadUrl:async()=>await le("1.0/storageGenerateUploadUrl",{requestId:t,version:$e}),delete:async r=>{await le("1.0/storageDelete",{requestId:t,version:$e,storageId:r})},getUrl:e.getUrl,getMetadata:e.getMetadata}}function Kl(t){return{...Yu(t),store:async(r,n)=>await Hr("storage/storeBlob",{requestId:t,version:$e,blob:r,options:n}),get:async r=>await Hr("storage/getBlob",{requestId:t,version:$e,storageId:r})}}async function Xl(t,e){const n=Ke(JSON.parse(e)),i={db:Hl(),auth:to(""),storage:Yu(""),scheduler:Yl(),runQuery:(u,d)=>_s("query",u,d),runMutation:(u,d)=>_s("mutation",u,d)},s=await ro(t,i,n);return zu(s),JSON.stringify(Re(s===void 0?null:s))}function zu(t){if(t instanceof Vu||t instanceof Vt)throw new Error("Return value is a Query. Results must be retrieved with `.collect()`, `.take(n), `.unique()`, or `.first()`.")}async function ro(t,e,r){let n;try{n=await Promise.resolve(t(e,...r))}catch(i){throw Zl(i)}return n}function no(t,e){return(r,n)=>(globalThis.console.warn(`Convex functions should not directly call other Convex functions. Consider calling a helper function instead. e.g. \`export const foo = ${t}(...); await foo(ctx);\` is not supported. See https://docs.convex.dev/production/best-practices/#use-helper-functions-to-write-shared-code`),e(r,n))}function Zl(t){if(typeof t=="object"&&t!==null&&Symbol.for("ConvexError")in t){const e=t;return e.data=JSON.stringify(Re(e.data===void 0?null:e.data)),e.ConvexErrorSymbol=Symbol.for("ConvexError"),e}else return t}function io(){if(typeof window>"u"||window.__convexAllowFunctionsInBrowser)return;(Object.getOwnPropertyDescriptor(globalThis,"window")?.get?.toString().includes("[native code]")??!1)&&console.error("Convex functions should not be imported in the browser. This will throw an error in future versions of `convex`. If this is a false negative, please report it to Convex support.")}function Ku(t,e){if(e===void 0)throw new Error(`A validator is undefined for field "${t}". This is often caused by circular imports. See https://docs.convex.dev/error#undefined-validator for details.`);return e}function Xu(t){return()=>{let e=a.any();return typeof t=="object"&&t.args!==void 0&&(e=Fu(t.args)),JSON.stringify(e.json,Ku)}}function Zu(t){return()=>{let e;return typeof t=="object"&&t.returns!==void 0&&(e=Fu(t.returns)),JSON.stringify(e?e.json:null,Ku)}}const Ai=t=>{const e=typeof t=="function"?t:t.handler,r=no("internalMutation",e);return io(),r.isMutation=!0,r.isInternal=!0,r.invokeMutation=n=>Xl(e,n),r.exportArgs=Xu(t),r.exportReturns=Zu(t),r._handler=e,r};async function eh(t,e){const n=Ke(JSON.parse(e)),i={db:Bu(),auth:to(""),storage:Qu(""),runQuery:(u,d)=>_s("query",u,d)},s=await ro(t,i,n);return zu(s),JSON.stringify(Re(s===void 0?null:s))}const th=t=>{const e=typeof t=="function"?t:t.handler,r=no("query",e);return io(),r.isQuery=!0,r.isPublic=!0,r.invokeQuery=n=>eh(e,n),r.exportArgs=Xu(t),r.exportReturns=Zu(t),r._handler=e,r};async function rh(t,e){const i={...yl(""),auth:to(""),storage:Kl(""),scheduler:zl(""),vectorSearch:Ol("")};return await ro(t,i,[e])}const qs=t=>{const e=no("httpAction",t);return io(),e.isHttp=!0,e.invokeHttpAction=r=>rh(t,r),e._handler=t,e};async function _s(t,e,r){const n=ii(r),i={udfType:t,args:Re(n),...ni(e)},s=await le("1.0/runUdf",i);return Ke(s)}var nh=Object.defineProperty,ih=(t,e,r)=>e in t?nh(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,Yt=(t,e,r)=>ih(t,typeof e!="symbol"?e+"":e,r);const ec=["GET","POST","PUT","DELETE","OPTIONS","PATCH"];function sh(t){return t==="HEAD"?"GET":t}const oh=()=>new ah;class ah{constructor(){Yt(this,"exactRoutes",new Map),Yt(this,"prefixRoutes",new Map),Yt(this,"isRouter",!0),Yt(this,"route",e=>{if(!e.handler)throw new Error("route requires handler");if(!e.method)throw new Error("route requires method");const{method:r,handler:n}=e;if(!ec.includes(r))throw new Error(`'${r}' is not an allowed HTTP method (like GET, POST, PUT etc.)`);if("path"in e){if("pathPrefix"in e)throw new Error("Invalid httpRouter route: cannot contain both 'path' and 'pathPrefix'");if(!e.path.startsWith("/"))throw new Error(`path '${e.path}' does not start with a /`);if(e.path.startsWith("/.files/")||e.path==="/.files")throw new Error(`path '${e.path}' is reserved`);const i=this.exactRoutes.has(e.path)?this.exactRoutes.get(e.path):new Map;if(i.has(r))throw new Error(`Path '${e.path}' for method ${r} already in use`);i.set(r,n),this.exactRoutes.set(e.path,i)}else if("pathPrefix"in e){if(!e.pathPrefix.startsWith("/"))throw new Error(`pathPrefix '${e.pathPrefix}' does not start with a /`);if(!e.pathPrefix.endsWith("/"))throw new Error(`pathPrefix ${e.pathPrefix} must end with a /`);if(e.pathPrefix.startsWith("/.files/"))throw new Error(`pathPrefix '${e.pathPrefix}' is reserved`);const i=this.prefixRoutes.get(r)||new Map;if(i.has(e.pathPrefix))throw new Error(`${e.method} pathPrefix ${e.pathPrefix} is already defined`);i.set(e.pathPrefix,n),this.prefixRoutes.set(r,i)}else throw new Error("Invalid httpRouter route entry: must contain either field 'path' or 'pathPrefix'")}),Yt(this,"getRoutes",()=>{const r=[...this.exactRoutes.keys()].sort().flatMap(s=>[...this.exactRoutes.get(s).keys()].sort().map(u=>[s,u,this.exactRoutes.get(s).get(u)])),i=[...this.prefixRoutes.keys()].sort().flatMap(s=>[...this.prefixRoutes.get(s).keys()].sort().map(u=>[`${u}*`,s,this.prefixRoutes.get(s).get(u)]));return[...r,...i]}),Yt(this,"lookup",(e,r)=>{r=sh(r);const n=this.exactRoutes.get(e)?.get(r);if(n)return[n,r,e];const s=[...(this.prefixRoutes.get(r)||new Map).entries()].sort(([u,d],[c,h])=>c.length-u.length);for(const[u,d]of s)if(e.startsWith(u))return[d,r,`${u}*`];return null}),Yt(this,"runRequest",async(e,r)=>{const n=Hr("requestFromConvexJson",{convexJson:JSON.parse(e)});let i=r;(!i||typeof i!="string")&&(i=new URL(n.url).pathname);const s=n.method,u=this.lookup(i,s);if(!u){const y=new Response(`No HttpAction routed for ${i}`,{status:404});return JSON.stringify(Hr("convexJsonFromResponse",{response:y}))}const[d,c,h]=u,l=await d.invokeHttpAction(n);return JSON.stringify(Hr("convexJsonFromResponse",{response:l}))})}}var uh=Object.defineProperty,ch=(t,e,r)=>e in t?uh(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,at=(t,e,r)=>ch(t,typeof e!="symbol"?e+"":e,r);class na{constructor(e){at(this,"indexes"),at(this,"stagedDbIndexes"),at(this,"searchIndexes"),at(this,"stagedSearchIndexes"),at(this,"vectorIndexes"),at(this,"stagedVectorIndexes"),at(this,"validator"),this.indexes=[],this.stagedDbIndexes=[],this.searchIndexes=[],this.stagedSearchIndexes=[],this.vectorIndexes=[],this.stagedVectorIndexes=[],this.validator=e}" indexes"(){return this.indexes}index(e,r){return Array.isArray(r)?this.indexes.push({indexDescriptor:e,fields:r}):r.staged?this.stagedDbIndexes.push({indexDescriptor:e,fields:r.fields}):this.indexes.push({indexDescriptor:e,fields:r.fields}),this}searchIndex(e,r){return r.staged?this.stagedSearchIndexes.push({indexDescriptor:e,searchField:r.searchField,filterFields:r.filterFields||[]}):this.searchIndexes.push({indexDescriptor:e,searchField:r.searchField,filterFields:r.filterFields||[]}),this}vectorIndex(e,r){return r.staged?this.stagedVectorIndexes.push({indexDescriptor:e,vectorField:r.vectorField,dimensions:r.dimensions,filterFields:r.filterFields||[]}):this.vectorIndexes.push({indexDescriptor:e,vectorField:r.vectorField,dimensions:r.dimensions,filterFields:r.filterFields||[]}),this}self(){return this}export(){const e=this.validator.json;if(typeof e!="object")throw new Error("Invalid validator: please make sure that the parameter of `defineTable` is valid (see https://docs.convex.dev/database/schemas)");return{indexes:this.indexes,stagedDbIndexes:this.stagedDbIndexes,searchIndexes:this.searchIndexes,stagedSearchIndexes:this.stagedSearchIndexes,vectorIndexes:this.vectorIndexes,stagedVectorIndexes:this.stagedVectorIndexes,documentType:e}}}function Ne(t){return ju(t)?new na(t):new na(a.object(t))}class dh{constructor(e,r){at(this,"tables"),at(this,"strictTableNameTypes"),at(this,"schemaValidation"),this.tables=e,this.schemaValidation=r?.schemaValidation===void 0?!0:r.schemaValidation}export(){return JSON.stringify({tables:Object.entries(this.tables).map(([e,r])=>{const{indexes:n,stagedDbIndexes:i,searchIndexes:s,stagedSearchIndexes:u,vectorIndexes:d,stagedVectorIndexes:c,documentType:h}=r.export();return{tableName:e,indexes:n,stagedDbIndexes:i,searchIndexes:s,stagedSearchIndexes:u,vectorIndexes:d,stagedVectorIndexes:c,documentType:h}}),schemaValidation:this.schemaValidation})}}function so(t,e){return new dh(t,e)}so({_scheduled_functions:Ne({name:a.string(),args:a.array(a.any()),scheduledTime:a.float64(),completedTime:a.optional(a.float64()),state:a.union(a.object({kind:a.literal("pending")}),a.object({kind:a.literal("inProgress")}),a.object({kind:a.literal("success")}),a.object({kind:a.literal("failed"),error:a.string()}),a.object({kind:a.literal("canceled")}))}),_storage:Ne({sha256:a.string(),size:a.float64(),contentType:a.optional(a.string())})});function Et(t){return typeof t>"u"||t===void 0}function Oe(t){return typeof t=="string"}function Ir(t){return typeof t=="number"}function ln(t){return typeof t=="boolean"}function si(t){return t===null}function tc(t){return t instanceof Date}function oi(t){return typeof t=="bigint"}function lh(t){return typeof Buffer<"u"&&Buffer.isBuffer(t)}function Ie(t){return typeof t=="function"}function Ge(t){return typeof t=="object"&&t!==null}function o(t){return Object.freeze(t)}function Rn(t){return At(t)?t:[t]}function At(t){return Array.isArray(t)}function Je(t){return t}const H=o({is(t){return t.kind==="AlterTableNode"},create(t){return o({kind:"AlterTableNode",table:t})},cloneWithTableProps(t,e){return o({...t,...e})},cloneWithColumnAlteration(t,e){return o({...t,columnAlterations:t.columnAlterations?[...t.columnAlterations,e]:[e]})}}),Q=o({is(t){return t.kind==="IdentifierNode"},create(t){return o({kind:"IdentifierNode",name:t})}}),ft=o({is(t){return t.kind==="CreateIndexNode"},create(t){return o({kind:"CreateIndexNode",name:Q.create(t)})},cloneWith(t,e){return o({...t,...e})},cloneWithColumns(t,e){return o({...t,columns:[...t.columns||[],...e]})}}),rc=o({is(t){return t.kind==="CreateSchemaNode"},create(t,e){return o({kind:"CreateSchemaNode",schema:Q.create(t),...e})},cloneWith(t,e){return o({...t,...e})}}),hh=["preserve rows","delete rows","drop"],je=o({is(t){return t.kind==="CreateTableNode"},create(t){return o({kind:"CreateTableNode",table:t,columns:o([])})},cloneWithColumn(t,e){return o({...t,columns:o([...t.columns,e])})},cloneWithConstraint(t,e){return o({...t,constraints:t.constraints?o([...t.constraints,e]):o([e])})},cloneWithFrontModifier(t,e){return o({...t,frontModifiers:t.frontModifiers?o([...t.frontModifiers,e]):o([e])})},cloneWithEndModifier(t,e){return o({...t,endModifiers:t.endModifiers?o([...t.endModifiers,e]):o([e])})},cloneWith(t,e){return o({...t,...e})}}),Tt=o({is(t){return t.kind==="SchemableIdentifierNode"},create(t){return o({kind:"SchemableIdentifierNode",identifier:Q.create(t)})},createWithSchema(t,e){return o({kind:"SchemableIdentifierNode",schema:Q.create(t),identifier:Q.create(e)})}}),Yr=o({is(t){return t.kind==="DropIndexNode"},create(t,e){return o({kind:"DropIndexNode",name:Tt.create(t),...e})},cloneWith(t,e){return o({...t,...e})}}),Ps=o({is(t){return t.kind==="DropSchemaNode"},create(t,e){return o({kind:"DropSchemaNode",schema:Q.create(t),...e})},cloneWith(t,e){return o({...t,...e})}}),$s=o({is(t){return t.kind==="DropTableNode"},create(t,e){return o({kind:"DropTableNode",table:t,...e})},cloneWith(t,e){return o({...t,...e})}}),xt=o({is(t){return t.kind==="AliasNode"},create(t,e){return o({kind:"AliasNode",node:t,alias:e})}}),Nt=o({is(t){return t.kind==="TableNode"},create(t){return o({kind:"TableNode",table:Tt.create(t)})},createWithSchema(t,e){return o({kind:"TableNode",table:Tt.createWithSchema(t,e)})}});function Le(t){return Ge(t)&&Ie(t.toOperationNode)}function nc(t){return Ge(t)&&"expressionType"in t&&Le(t)}function fh(t){return Ge(t)&&"expression"in t&&Oe(t.alias)&&Le(t)}const ht=o({is(t){return t.kind==="SelectModifierNode"},create(t,e){return o({kind:"SelectModifierNode",modifier:t,of:e})},createWithExpression(t){return o({kind:"SelectModifierNode",rawModifier:t})}}),Bt=o({is(t){return t.kind==="AndNode"},create(t,e){return o({kind:"AndNode",left:t,right:e})}}),Dr=o({is(t){return t.kind==="OrNode"},create(t,e){return o({kind:"OrNode",left:t,right:e})}}),Ti=o({is(t){return t.kind==="OnNode"},create(t){return o({kind:"OnNode",on:t})},cloneWithOperation(t,e,r){return o({...t,on:e==="And"?Bt.create(t.on,r):Dr.create(t.on,r)})}}),ar=o({is(t){return t.kind==="JoinNode"},create(t,e){return o({kind:"JoinNode",joinType:t,table:e,on:void 0})},createWithOn(t,e,r){return o({kind:"JoinNode",joinType:t,table:e,on:Ti.create(r)})},cloneWithOn(t,e){return o({...t,on:t.on?Ti.cloneWithOperation(t.on,"And",e):Ti.create(e)})}}),kr=o({is(t){return t.kind==="BinaryOperationNode"},create(t,e,r){return o({kind:"BinaryOperationNode",leftOperand:t,operator:e,rightOperand:r})}}),ph=["=","==","!=","<>",">",">=","<","<=","in","not in","is","is not","like","not like","match","ilike","not ilike","@>","<@","^@","&&","?","?&","?|","!<","!>","<=>","!~","~","~*","!~*","@@","@@@","!!","<->","regexp","is distinct from","is not distinct from"],mh=["+","-","*","/","%","^","&","|","#","<<",">>"],ic=["->","->>"],yh=[...ph,...mh,"&&","||"],wh=["exists","not exists"],Nh=["not","-",...wh],gh=[...yh,...ic,...Nh,"between","between symmetric"],Jt=o({is(t){return t.kind==="OperatorNode"},create(t){return o({kind:"OperatorNode",operator:t})}});function ia(t){return Oe(t)&&ic.includes(t)}const we=o({is(t){return t.kind==="ColumnNode"},create(t){return o({kind:"ColumnNode",column:Q.create(t)})}}),oo=o({is(t){return t.kind==="SelectAllNode"},create(){return o({kind:"SelectAllNode"})}}),ai=o({is(t){return t.kind==="ReferenceNode"},create(t,e){return o({kind:"ReferenceNode",table:e,column:t})},createSelectAll(t){return o({kind:"ReferenceNode",table:t,column:oo.create()})}});class bh{#e;get dynamicReference(){return this.#e}get refType(){}constructor(e){this.#e=e}toOperationNode(){return cc(this.#e)}}function sc(t){return Ge(t)&&Le(t)&&Oe(t.dynamicReference)}const wt=o({is(t){return t.kind==="OrderByItemNode"},create(t,e){return o({kind:"OrderByItemNode",orderBy:t,direction:e})},cloneWith(t,e){return o({...t,...e})}}),ce=o({is(t){return t.kind==="RawNode"},create(t,e){return o({kind:"RawNode",sqlFragments:o(t),parameters:o(e)})},createWithSql(t){return ce.create([t],[])},createWithChild(t){return ce.create(["",""],[t])},createWithChildren(t){return ce.create(new Array(t.length+1).fill(""),t)}}),vh={is(t){return t.kind==="CollateNode"},create(t){return o({kind:"CollateNode",collation:Q.create(t)})}};class er{#e;constructor(e){this.#e=o(e)}desc(){return new er({node:wt.cloneWith(this.#e.node,{direction:ce.createWithSql("desc")})})}asc(){return new er({node:wt.cloneWith(this.#e.node,{direction:ce.createWithSql("asc")})})}nullsLast(){return new er({node:wt.cloneWith(this.#e.node,{nulls:"last"})})}nullsFirst(){return new er({node:wt.cloneWith(this.#e.node,{nulls:"first"})})}collate(e){return new er({node:wt.cloneWith(this.#e.node,{collation:vh.create(e)})})}toOperationNode(){return this.#e.node}}const sa=new Set;function qr(t){sa.has(t)||(sa.add(t),console.log(t))}function oc(t){return t==="asc"||t==="desc"}function ur(t){if(t.length===2)return[Si(t[0],t[1])];if(t.length===1){const[e]=t;return Array.isArray(e)?(qr("orderBy(array) is deprecated, use multiple orderBy calls instead."),e.map(r=>Si(r))):[Si(e)]}throw new Error(`Invalid number of arguments at order by! expected 1-2, received ${t.length}`)}function Si(t,e){const r=Eh(t);if(wt.is(r)){if(e)throw new Error("Cannot specify direction twice!");return r}return ac(r,e)}function Eh(t){if(wn(t))return fr(t);if(sc(t))return t.toOperationNode();const[e,r]=t.split(" ");return r?(qr("`orderBy('column asc')` is deprecated. Use `orderBy('column', 'asc')` instead."),ac(St(e),r)):St(t)}function ac(t,e){if(typeof e=="string"){if(!oc(e))throw new Error(`Invalid order by direction: ${e}`);return wt.create(t,ce.createWithSql(e))}if(nc(e))return qr("`orderBy(..., expr)` is deprecated. Use `orderBy(..., 'asc')` or `orderBy(..., (ob) => ...)` instead."),wt.create(t,e.toOperationNode());const r=wt.create(t);return e?e(new er({node:r})).toOperationNode():r}const Vn=o({is(t){return t.kind==="JSONReferenceNode"},create(t,e){return o({kind:"JSONReferenceNode",reference:t,traversal:e})},cloneWithTraversal(t,e){return o({...t,traversal:e})}}),uc=o({is(t){return t.kind==="JSONOperatorChainNode"},create(t){return o({kind:"JSONOperatorChainNode",operator:t,values:o([])})},cloneWithValue(t,e){return o({...t,values:o([...t.values,e])})}}),zr=o({is(t){return t.kind==="JSONPathNode"},create(t){return o({kind:"JSONPathNode",inOperator:t,pathLegs:o([])})},cloneWithLeg(t,e){return o({...t,pathLegs:o([...t.pathLegs,e])})}});function cc(t){return Oe(t)?St(t):t.toOperationNode()}function hn(t){return At(t)?t.map(e=>He(e)):[He(t)]}function He(t){return wn(t)?fr(t):cc(t)}function Oh(t,e){const r=St(t);if(ia(e))return Vn.create(r,uc.create(Jt.create(e)));const n=e.slice(0,-1);if(ia(n))return Vn.create(r,zr.create(Jt.create(n)));throw new Error(`Invalid JSON operator: ${e}`)}function St(t){if(!t.includes("."))return ai.create(we.create(t));const r=t.split(".").map(ao);if(r.length===3)return Th(r);if(r.length===2)return Sh(r);throw new Error(`invalid column reference ${t}`)}function Ah(t){const e=" as ";if(t.includes(e)){const[r,n]=t.split(e).map(ao);return xt.create(St(r),Q.create(n))}else return St(t)}function dc(t){return we.create(t)}function Bn(t){if(t.includes(" ")){const[r,n]=t.split(" ").map(ao);if(!oc(n))throw new Error(`invalid order direction "${n}" next to "${r}"`);return ur([r,n])[0]}else return dc(t)}function Th(t){const[e,r,n]=t;return ai.create(we.create(n),Nt.createWithSchema(e,r))}function Sh(t){const[e,r]=t;return ai.create(we.create(r),Nt.create(e))}function ao(t){return t.trim()}const lc=o({is(t){return t.kind==="PrimitiveValueListNode"},create(t){return o({kind:"PrimitiveValueListNode",values:o([...t])})}}),ui=o({is(t){return t.kind==="ValueListNode"},create(t){return o({kind:"ValueListNode",values:o(t)})}}),Xe=o({is(t){return t.kind==="ValueNode"},create(t){return o({kind:"ValueNode",value:t})},createImmediate(t){return o({kind:"ValueNode",value:t,immediate:!0})}});function xh(t){return At(t)?Rh(t):ge(t)}function ge(t){return wn(t)?fr(t):Xe.create(t)}function uo(t){return Ir(t)||ln(t)||si(t)}function co(t){if(!uo(t))throw new Error(`unsafe immediate value ${JSON.stringify(t)}`);return Xe.createImmediate(t)}function Rh(t){return t.some(wn)?ui.create(t.map(e=>ge(e))):lc.create(t)}const gt=o({is(t){return t.kind==="ParensNode"},create(t){return o({kind:"ParensNode",node:t})}});function Ae(t){if(t.length===3)return lo(t[0],t[1],t[2]);if(t.length===1)return ge(t[0]);throw new Error(`invalid arguments: ${JSON.stringify(t)}`)}function lo(t,e,r){return Ih(e)&&hc(r)?kr.create(He(t),Ws(e),Xe.createImmediate(r)):kr.create(He(t),Ws(e),xh(r))}function dt(t,e,r){return kr.create(He(t),Ws(e),He(r))}function oa(t,e){return Jn(Object.entries(t).filter(([,r])=>!Et(r)).map(([r,n])=>lo(r,hc(n)?"is":"=",n)),e)}function Jn(t,e,r=!0){const n=e==="and"?Bt.create:Dr.create;if(t.length===0)return kr.create(Xe.createImmediate(1),Jt.create("="),Xe.createImmediate(e==="and"?1:0));let i=aa(t[0]);for(let s=1;s<t.length;++s)i=n(i,aa(t[s]));return t.length>1&&r?gt.create(i):i}function Ih(t){return t==="is"||t==="is not"}function hc(t){return si(t)||ln(t)}function Ws(t){if(Oe(t)&&gh.includes(t))return Jt.create(t);if(Le(t))return t.toOperationNode();throw new Error(`invalid operator ${JSON.stringify(t)}`)}function aa(t){return Le(t)?t.toOperationNode():t}const Cr=o({is(t){return t.kind==="OrderByNode"},create(t){return o({kind:"OrderByNode",items:o([...t])})},cloneWithItems(t,e){return o({...t,items:o([...t.items,...e])})}}),ua=o({is(t){return t.kind==="PartitionByNode"},create(t){return o({kind:"PartitionByNode",items:o(t)})},cloneWithItems(t,e){return o({...t,items:o([...t.items,...e])})}}),Us=o({is(t){return t.kind==="OverNode"},create(){return o({kind:"OverNode"})},cloneWithOrderByItems(t,e){return o({...t,orderBy:t.orderBy?Cr.cloneWithItems(t.orderBy,e):Cr.create(e)})},cloneWithPartitionByItems(t,e){return o({...t,partitionBy:t.partitionBy?ua.cloneWithItems(t.partitionBy,e):ua.create(e)})}}),Gn=o({is(t){return t.kind==="FromNode"},create(t){return o({kind:"FromNode",froms:o(t)})},cloneWithFroms(t,e){return o({...t,froms:o([...t.froms,...e])})}}),ca=o({is(t){return t.kind==="GroupByNode"},create(t){return o({kind:"GroupByNode",items:o(t)})},cloneWithItems(t,e){return o({...t,items:o([...t.items,...e])})}}),da=o({is(t){return t.kind==="HavingNode"},create(t){return o({kind:"HavingNode",having:t})},cloneWithOperation(t,e,r){return o({...t,having:e==="And"?Bt.create(t.having,r):Dr.create(t.having,r)})}}),ve=o({is(t){return t.kind==="InsertQueryNode"},create(t,e,r){return o({kind:"InsertQueryNode",into:t,...e&&{with:e},replace:r})},createWithoutInto(){return o({kind:"InsertQueryNode"})},cloneWith(t,e){return o({...t,...e})}}),fc=o({is(t){return t.kind==="ListNode"},create(t){return o({kind:"ListNode",items:o(t)})}}),Tr=o({is(t){return t.kind==="UpdateQueryNode"},create(t,e){return o({kind:"UpdateQueryNode",table:t.length===1?t[0]:fc.create(t),...e&&{with:e}})},createWithoutTable(){return o({kind:"UpdateQueryNode"})},cloneWithFromItems(t,e){return o({...t,from:t.from?Gn.cloneWithFroms(t.from,e):Gn.create(e)})},cloneWithUpdates(t,e){return o({...t,updates:t.updates?o([...t.updates,...e]):e})},cloneWithLimit(t,e){return o({...t,limit:e})}}),la=o({is(t){return t.kind==="UsingNode"},create(t){return o({kind:"UsingNode",tables:o(t)})},cloneWithTables(t,e){return o({...t,tables:o([...t.tables,...e])})}}),Kr=o({is(t){return t.kind==="DeleteQueryNode"},create(t,e){return o({kind:"DeleteQueryNode",from:Gn.create(t),...e&&{with:e}})},cloneWithOrderByItems:(t,e)=>q.cloneWithOrderByItems(t,e),cloneWithoutOrderBy:t=>q.cloneWithoutOrderBy(t),cloneWithLimit(t,e){return o({...t,limit:e})},cloneWithoutLimit(t){return o({...t,limit:void 0})},cloneWithUsing(t,e){return o({...t,using:t.using!==void 0?la.cloneWithTables(t.using,e):la.create(e)})}}),_e=o({is(t){return t.kind==="WhereNode"},create(t){return o({kind:"WhereNode",where:t})},cloneWithOperation(t,e,r){return o({...t,where:e==="And"?Bt.create(t.where,r):Dr.create(t.where,r)})}}),ha=o({is(t){return t.kind==="ReturningNode"},create(t){return o({kind:"ReturningNode",selections:o(t)})},cloneWithSelections(t,e){return o({...t,selections:t.selections?o([...t.selections,...e]):o(e)})}}),kh=o({is(t){return t.kind==="ExplainNode"},create(t,e){return o({kind:"ExplainNode",format:t,options:e})}}),cr=o({is(t){return t.kind==="WhenNode"},create(t){return o({kind:"WhenNode",condition:t})},cloneWithResult(t,e){return o({...t,result:e})}}),ct=o({is(t){return t.kind==="MergeQueryNode"},create(t,e){return o({kind:"MergeQueryNode",into:t,...e&&{with:e}})},cloneWithUsing(t,e){return o({...t,using:e})},cloneWithWhen(t,e){return o({...t,whens:t.whens?o([...t.whens,e]):o([e])})},cloneWithThen(t,e){return o({...t,whens:t.whens?o([...t.whens.slice(0,-1),cr.cloneWithResult(t.whens[t.whens.length-1],e)]):void 0})}}),fa=o({is(t){return t.kind==="OutputNode"},create(t){return o({kind:"OutputNode",selections:o(t)})},cloneWithSelections(t,e){return o({...t,selections:t.selections?o([...t.selections,...e]):o(e)})}}),q=o({is(t){return Z.is(t)||ve.is(t)||Tr.is(t)||Kr.is(t)||ct.is(t)},cloneWithEndModifier(t,e){return o({...t,endModifiers:t.endModifiers?o([...t.endModifiers,e]):o([e])})},cloneWithWhere(t,e){return o({...t,where:t.where?_e.cloneWithOperation(t.where,"And",e):_e.create(e)})},cloneWithJoin(t,e){return o({...t,joins:t.joins?o([...t.joins,e]):o([e])})},cloneWithReturning(t,e){return o({...t,returning:t.returning?ha.cloneWithSelections(t.returning,e):ha.create(e)})},cloneWithoutReturning(t){return o({...t,returning:void 0})},cloneWithoutWhere(t){return o({...t,where:void 0})},cloneWithExplain(t,e,r){return o({...t,explain:kh.create(e,r?.toOperationNode())})},cloneWithTop(t,e){return o({...t,top:e})},cloneWithOutput(t,e){return o({...t,output:t.output?fa.cloneWithSelections(t.output,e):fa.create(e)})},cloneWithOrderByItems(t,e){return o({...t,orderBy:t.orderBy?Cr.cloneWithItems(t.orderBy,e):Cr.create(e)})},cloneWithoutOrderBy(t){return o({...t,orderBy:void 0})}}),Z=o({is(t){return t.kind==="SelectQueryNode"},create(t){return o({kind:"SelectQueryNode",...t&&{with:t}})},createFrom(t,e){return o({kind:"SelectQueryNode",from:Gn.create(t),...e&&{with:e}})},cloneWithSelections(t,e){return o({...t,selections:t.selections?o([...t.selections,...e]):o(e)})},cloneWithDistinctOn(t,e){return o({...t,distinctOn:t.distinctOn?o([...t.distinctOn,...e]):o(e)})},cloneWithFrontModifier(t,e){return o({...t,frontModifiers:t.frontModifiers?o([...t.frontModifiers,e]):o([e])})},cloneWithOrderByItems:(t,e)=>q.cloneWithOrderByItems(t,e),cloneWithGroupByItems(t,e){return o({...t,groupBy:t.groupBy?ca.cloneWithItems(t.groupBy,e):ca.create(e)})},cloneWithLimit(t,e){return o({...t,limit:e})},cloneWithOffset(t,e){return o({...t,offset:e})},cloneWithFetch(t,e){return o({...t,fetch:e})},cloneWithHaving(t,e){return o({...t,having:t.having?da.cloneWithOperation(t.having,"And",e):da.create(e)})},cloneWithSetOperations(t,e){return o({...t,setOperations:t.setOperations?o([...t.setOperations,...e]):o([...e])})},cloneWithoutSelections(t){return o({...t,selections:[]})},cloneWithoutLimit(t){return o({...t,limit:void 0})},cloneWithoutOffset(t){return o({...t,offset:void 0})},cloneWithoutOrderBy:t=>q.cloneWithoutOrderBy(t),cloneWithoutGroupBy(t){return o({...t,groupBy:void 0})}});class Xr{#e;constructor(e){this.#e=o(e)}on(...e){return new Xr({...this.#e,joinNode:ar.cloneWithOn(this.#e.joinNode,Ae(e))})}onRef(e,r,n){return new Xr({...this.#e,joinNode:ar.cloneWithOn(this.#e.joinNode,dt(e,r,n))})}onTrue(){return new Xr({...this.#e,joinNode:ar.cloneWithOn(this.#e.joinNode,ce.createWithSql("true"))})}$call(e){return e(this)}toOperationNode(){return this.#e.joinNode}}const Ch=o({is(t){return t.kind==="PartitionByItemNode"},create(t){return o({kind:"PartitionByItemNode",partitionBy:t})}});function Lh(t){return hn(t).map(Ch.create)}class Zr{#e;constructor(e){this.#e=o(e)}orderBy(...e){return new Zr({overNode:Us.cloneWithOrderByItems(this.#e.overNode,ur(e))})}clearOrderBy(){return new Zr({overNode:q.cloneWithoutOrderBy(this.#e.overNode)})}partitionBy(e){return new Zr({overNode:Us.cloneWithPartitionByItems(this.#e.overNode,Lh(e))})}$call(e){return e(this)}toOperationNode(){return this.#e.overNode}}const en=o({is(t){return t.kind==="SelectionNode"},create(t){return o({kind:"SelectionNode",selection:t})},createSelectAll(){return o({kind:"SelectionNode",selection:oo.create()})},createSelectAllFromTable(t){return o({kind:"SelectionNode",selection:ai.createSelectAll(t)})}});function Qe(t){return Ie(t)?Qe(t($r())):At(t)?t.map(e=>pa(e)):[pa(t)]}function pa(t){return Oe(t)?en.create(Ah(t)):sc(t)?en.create(t.toOperationNode()):en.create(Tc(t))}function Ze(t){return t?Array.isArray(t)?t.map(ma):[ma(t)]:[en.createSelectAll()]}function ma(t){if(Oe(t))return en.createSelectAllFromTable(pe(t));throw new Error(`invalid value selectAll expression: ${JSON.stringify(t)}`)}const Dh=o({is(t){return t.kind==="ValuesNode"},create(t){return o({kind:"ValuesNode",values:o(t)})}}),qh=o({is(t){return t.kind==="DefaultInsertValueNode"},create(){return o({kind:"DefaultInsertValueNode"})}});function pc(t){const e=Ie(t)?t($r()):t,r=At(e)?e:o([e]);return _h(r)}function _h(t){const e=Ph(t);return[o([...e.keys()].map(we.create)),Dh.create(t.map(r=>$h(r,e)))]}function Ph(t){const e=new Map;for(const r of t){const n=Object.keys(r);for(const i of n)!e.has(i)&&r[i]!==void 0&&e.set(i,e.size)}return e}function $h(t,e){const r=Object.keys(t),n=Array.from({length:e.size});let i=!1,s=r.length;for(const d of r){const c=e.get(d);if(Et(c)){s--;continue}const h=t[d];(Et(h)||wn(h))&&(i=!0),n[c]=h}if(s<e.size||i){const d=qh.create();return ui.create(n.map(c=>Et(c)?d:ge(c)))}return lc.create(n)}const mc=o({is(t){return t.kind==="ColumnUpdateNode"},create(t,e){return o({kind:"ColumnUpdateNode",column:t,value:e})}});function Wh(...t){return t.length===2?[mc.create(He(t[0]),ge(t[1]))]:ho(t[0])}function ho(t){const e=Ie(t)?t($r()):t;return Object.entries(e).filter(([r,n])=>n!==void 0).map(([r,n])=>mc.create(we.create(r),ge(n)))}const Uh=o({is(t){return t.kind==="OnDuplicateKeyNode"},create(t){return o({kind:"OnDuplicateKeyNode",updates:t})}});class Mh{insertId;numInsertedOrUpdatedRows;constructor(e,r){this.insertId=e,this.numInsertedOrUpdatedRows=r}}class mn extends Error{node;constructor(e){super("no result"),this.node=e}}function yn(t){return Object.prototype.hasOwnProperty.call(t,"prototype")}const Ve=o({is(t){return t.kind==="OnConflictNode"},create(){return o({kind:"OnConflictNode"})},cloneWith(t,e){return o({...t,...e})},cloneWithIndexWhere(t,e){return o({...t,indexWhere:t.indexWhere?_e.cloneWithOperation(t.indexWhere,"And",e):_e.create(e)})},cloneWithIndexOrWhere(t,e){return o({...t,indexWhere:t.indexWhere?_e.cloneWithOperation(t.indexWhere,"Or",e):_e.create(e)})},cloneWithUpdateWhere(t,e){return o({...t,updateWhere:t.updateWhere?_e.cloneWithOperation(t.updateWhere,"And",e):_e.create(e)})},cloneWithUpdateOrWhere(t,e){return o({...t,updateWhere:t.updateWhere?_e.cloneWithOperation(t.updateWhere,"Or",e):_e.create(e)})},cloneWithoutIndexWhere(t){return o({...t,indexWhere:void 0})},cloneWithoutUpdateWhere(t){return o({...t,updateWhere:void 0})}});class pt{#e;constructor(e){this.#e=o(e)}column(e){const r=we.create(e);return new pt({...this.#e,onConflictNode:Ve.cloneWith(this.#e.onConflictNode,{columns:this.#e.onConflictNode.columns?o([...this.#e.onConflictNode.columns,r]):o([r])})})}columns(e){const r=e.map(we.create);return new pt({...this.#e,onConflictNode:Ve.cloneWith(this.#e.onConflictNode,{columns:this.#e.onConflictNode.columns?o([...this.#e.onConflictNode.columns,...r]):o(r)})})}constraint(e){return new pt({...this.#e,onConflictNode:Ve.cloneWith(this.#e.onConflictNode,{constraint:Q.create(e)})})}expression(e){return new pt({...this.#e,onConflictNode:Ve.cloneWith(this.#e.onConflictNode,{indexExpression:e.toOperationNode()})})}where(...e){return new pt({...this.#e,onConflictNode:Ve.cloneWithIndexWhere(this.#e.onConflictNode,Ae(e))})}whereRef(e,r,n){return new pt({...this.#e,onConflictNode:Ve.cloneWithIndexWhere(this.#e.onConflictNode,dt(e,r,n))})}clearWhere(){return new pt({...this.#e,onConflictNode:Ve.cloneWithoutIndexWhere(this.#e.onConflictNode)})}doNothing(){return new jh({...this.#e,onConflictNode:Ve.cloneWith(this.#e.onConflictNode,{doNothing:!0})})}doUpdateSet(e){return new tn({...this.#e,onConflictNode:Ve.cloneWith(this.#e.onConflictNode,{updates:ho(e)})})}$call(e){return e(this)}}class jh{#e;constructor(e){this.#e=o(e)}toOperationNode(){return this.#e.onConflictNode}}class tn{#e;constructor(e){this.#e=o(e)}where(...e){return new tn({...this.#e,onConflictNode:Ve.cloneWithUpdateWhere(this.#e.onConflictNode,Ae(e))})}whereRef(e,r,n){return new tn({...this.#e,onConflictNode:Ve.cloneWithUpdateWhere(this.#e.onConflictNode,dt(e,r,n))})}clearWhere(){return new tn({...this.#e,onConflictNode:Ve.cloneWithoutUpdateWhere(this.#e.onConflictNode)})}$call(e){return e(this)}toOperationNode(){return this.#e.onConflictNode}}const Fh=o({is(t){return t.kind==="TopNode"},create(t,e){return o({kind:"TopNode",expression:t,modifiers:e})}});function _r(t,e){if(!Ir(t)&&!oi(t))throw new Error(`Invalid top expression: ${t}`);if(!Et(e)&&!Vh(e))throw new Error(`Invalid top modifiers: ${e}`);return Fh.create(t,e)}function Vh(t){return t==="percent"||t==="with ties"||t==="percent with ties"}const mr=o({is(t){return t.kind==="OrActionNode"},create(t){return o({kind:"OrActionNode",action:t})}});class Y{#e;constructor(e){this.#e=o(e)}values(e){const[r,n]=pc(e);return new Y({...this.#e,queryNode:ve.cloneWith(this.#e.queryNode,{columns:r,values:n})})}columns(e){return new Y({...this.#e,queryNode:ve.cloneWith(this.#e.queryNode,{columns:o(e.map(we.create))})})}expression(e){return new Y({...this.#e,queryNode:ve.cloneWith(this.#e.queryNode,{values:fr(e)})})}defaultValues(){return new Y({...this.#e,queryNode:ve.cloneWith(this.#e.queryNode,{defaultValues:!0})})}modifyEnd(e){return new Y({...this.#e,queryNode:q.cloneWithEndModifier(this.#e.queryNode,e.toOperationNode())})}ignore(){return new Y({...this.#e,queryNode:ve.cloneWith(this.#e.queryNode,{orAction:mr.create("ignore")})})}orIgnore(){return new Y({...this.#e,queryNode:ve.cloneWith(this.#e.queryNode,{orAction:mr.create("ignore")})})}orAbort(){return new Y({...this.#e,queryNode:ve.cloneWith(this.#e.queryNode,{orAction:mr.create("abort")})})}orFail(){return new Y({...this.#e,queryNode:ve.cloneWith(this.#e.queryNode,{orAction:mr.create("fail")})})}orReplace(){return new Y({...this.#e,queryNode:ve.cloneWith(this.#e.queryNode,{orAction:mr.create("replace")})})}orRollback(){return new Y({...this.#e,queryNode:ve.cloneWith(this.#e.queryNode,{orAction:mr.create("rollback")})})}top(e,r){return new Y({...this.#e,queryNode:q.cloneWithTop(this.#e.queryNode,_r(e,r))})}onConflict(e){return new Y({...this.#e,queryNode:ve.cloneWith(this.#e.queryNode,{onConflict:e(new pt({onConflictNode:Ve.create()})).toOperationNode()})})}onDuplicateKeyUpdate(e){return new Y({...this.#e,queryNode:ve.cloneWith(this.#e.queryNode,{onDuplicateKey:Uh.create(ho(e))})})}returning(e){return new Y({...this.#e,queryNode:q.cloneWithReturning(this.#e.queryNode,Qe(e))})}returningAll(){return new Y({...this.#e,queryNode:q.cloneWithReturning(this.#e.queryNode,Ze())})}output(e){return new Y({...this.#e,queryNode:q.cloneWithOutput(this.#e.queryNode,Qe(e))})}outputAll(e){return new Y({...this.#e,queryNode:q.cloneWithOutput(this.#e.queryNode,Ze(e))})}clearReturning(){return new Y({...this.#e,queryNode:q.cloneWithoutReturning(this.#e.queryNode)})}$call(e){return e(this)}$if(e,r){return e?r(this):new Y({...this.#e})}$castTo(){return new Y(this.#e)}$narrowType(){return new Y(this.#e)}$assertType(){return new Y(this.#e)}withPlugin(e){return new Y({...this.#e,executor:this.#e.executor.withPlugin(e)})}toOperationNode(){return this.#e.executor.transformQuery(this.#e.queryNode,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){const e=this.compile(),r=await this.#e.executor.executeQuery(e),{adapter:n}=this.#e.executor,i=e.query;return i.returning&&n.supportsReturning||i.output&&n.supportsOutput?r.rows:[new Mh(r.insertId,r.numAffectedRows??BigInt(0))]}async executeTakeFirst(){const[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=mn){const r=await this.executeTakeFirst();if(r===void 0)throw yn(e)?new e(this.toOperationNode()):e(this.toOperationNode());return r}async*stream(e=100){const r=this.compile(),n=this.#e.executor.stream(r,e);for await(const i of n)yield*i.rows}async explain(e,r){return await new Y({...this.#e,queryNode:q.cloneWithExplain(this.#e.queryNode,e,r)}).execute()}}class Bh{numDeletedRows;constructor(e){this.numDeletedRows=e}}const fo=o({is(t){return t.kind==="LimitNode"},create(t){return o({kind:"LimitNode",limit:t})}});class ae{#e;constructor(e){this.#e=o(e)}where(...e){return new ae({...this.#e,queryNode:q.cloneWithWhere(this.#e.queryNode,Ae(e))})}whereRef(e,r,n){return new ae({...this.#e,queryNode:q.cloneWithWhere(this.#e.queryNode,dt(e,r,n))})}clearWhere(){return new ae({...this.#e,queryNode:q.cloneWithoutWhere(this.#e.queryNode)})}top(e,r){return new ae({...this.#e,queryNode:q.cloneWithTop(this.#e.queryNode,_r(e,r))})}using(e){return new ae({...this.#e,queryNode:Kr.cloneWithUsing(this.#e.queryNode,Sr(e))})}innerJoin(...e){return this.#t("InnerJoin",e)}leftJoin(...e){return this.#t("LeftJoin",e)}rightJoin(...e){return this.#t("RightJoin",e)}fullJoin(...e){return this.#t("FullJoin",e)}#t(e,r){return new ae({...this.#e,queryNode:q.cloneWithJoin(this.#e.queryNode,di(e,r))})}returning(e){return new ae({...this.#e,queryNode:q.cloneWithReturning(this.#e.queryNode,Qe(e))})}returningAll(e){return new ae({...this.#e,queryNode:q.cloneWithReturning(this.#e.queryNode,Ze(e))})}output(e){return new ae({...this.#e,queryNode:q.cloneWithOutput(this.#e.queryNode,Qe(e))})}outputAll(e){return new ae({...this.#e,queryNode:q.cloneWithOutput(this.#e.queryNode,Ze(e))})}clearReturning(){return new ae({...this.#e,queryNode:q.cloneWithoutReturning(this.#e.queryNode)})}clearLimit(){return new ae({...this.#e,queryNode:Kr.cloneWithoutLimit(this.#e.queryNode)})}orderBy(...e){return new ae({...this.#e,queryNode:q.cloneWithOrderByItems(this.#e.queryNode,ur(e))})}clearOrderBy(){return new ae({...this.#e,queryNode:q.cloneWithoutOrderBy(this.#e.queryNode)})}limit(e){return new ae({...this.#e,queryNode:Kr.cloneWithLimit(this.#e.queryNode,fo.create(ge(e)))})}modifyEnd(e){return new ae({...this.#e,queryNode:q.cloneWithEndModifier(this.#e.queryNode,e.toOperationNode())})}$call(e){return e(this)}$if(e,r){return e?r(this):new ae({...this.#e})}$castTo(){return new ae(this.#e)}$narrowType(){return new ae(this.#e)}$assertType(){return new ae(this.#e)}withPlugin(e){return new ae({...this.#e,executor:this.#e.executor.withPlugin(e)})}toOperationNode(){return this.#e.executor.transformQuery(this.#e.queryNode,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){const e=this.compile(),r=await this.#e.executor.executeQuery(e),{adapter:n}=this.#e.executor,i=e.query;return i.returning&&n.supportsReturning||i.output&&n.supportsOutput?r.rows:[new Bh(r.numAffectedRows??BigInt(0))]}async executeTakeFirst(){const[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=mn){const r=await this.executeTakeFirst();if(r===void 0)throw yn(e)?new e(this.toOperationNode()):e(this.toOperationNode());return r}async*stream(e=100){const r=this.compile(),n=this.#e.executor.stream(r,e);for await(const i of n)yield*i.rows}async explain(e,r){return await new ae({...this.#e,queryNode:q.cloneWithExplain(this.#e.queryNode,e,r)}).execute()}}class Jh{numUpdatedRows;numChangedRows;constructor(e,r){this.numUpdatedRows=e,this.numChangedRows=r}}class re{#e;constructor(e){this.#e=o(e)}where(...e){return new re({...this.#e,queryNode:q.cloneWithWhere(this.#e.queryNode,Ae(e))})}whereRef(e,r,n){return new re({...this.#e,queryNode:q.cloneWithWhere(this.#e.queryNode,dt(e,r,n))})}clearWhere(){return new re({...this.#e,queryNode:q.cloneWithoutWhere(this.#e.queryNode)})}top(e,r){return new re({...this.#e,queryNode:q.cloneWithTop(this.#e.queryNode,_r(e,r))})}from(e){return new re({...this.#e,queryNode:Tr.cloneWithFromItems(this.#e.queryNode,Sr(e))})}innerJoin(...e){return this.#t("InnerJoin",e)}leftJoin(...e){return this.#t("LeftJoin",e)}rightJoin(...e){return this.#t("RightJoin",e)}fullJoin(...e){return this.#t("FullJoin",e)}#t(e,r){return new re({...this.#e,queryNode:q.cloneWithJoin(this.#e.queryNode,di(e,r))})}orderBy(...e){return new re({...this.#e,queryNode:q.cloneWithOrderByItems(this.#e.queryNode,ur(e))})}clearOrderBy(){return new re({...this.#e,queryNode:q.cloneWithoutOrderBy(this.#e.queryNode)})}limit(e){return new re({...this.#e,queryNode:Tr.cloneWithLimit(this.#e.queryNode,fo.create(ge(e)))})}set(...e){return new re({...this.#e,queryNode:Tr.cloneWithUpdates(this.#e.queryNode,Wh(...e))})}returning(e){return new re({...this.#e,queryNode:q.cloneWithReturning(this.#e.queryNode,Qe(e))})}returningAll(e){return new re({...this.#e,queryNode:q.cloneWithReturning(this.#e.queryNode,Ze(e))})}output(e){return new re({...this.#e,queryNode:q.cloneWithOutput(this.#e.queryNode,Qe(e))})}outputAll(e){return new re({...this.#e,queryNode:q.cloneWithOutput(this.#e.queryNode,Ze(e))})}modifyEnd(e){return new re({...this.#e,queryNode:q.cloneWithEndModifier(this.#e.queryNode,e.toOperationNode())})}clearReturning(){return new re({...this.#e,queryNode:q.cloneWithoutReturning(this.#e.queryNode)})}$call(e){return e(this)}$if(e,r){return e?r(this):new re({...this.#e})}$castTo(){return new re(this.#e)}$narrowType(){return new re(this.#e)}$assertType(){return new re(this.#e)}withPlugin(e){return new re({...this.#e,executor:this.#e.executor.withPlugin(e)})}toOperationNode(){return this.#e.executor.transformQuery(this.#e.queryNode,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){const e=this.compile(),r=await this.#e.executor.executeQuery(e),{adapter:n}=this.#e.executor,i=e.query;return i.returning&&n.supportsReturning||i.output&&n.supportsOutput?r.rows:[new Jh(r.numAffectedRows??BigInt(0),r.numChangedRows)]}async executeTakeFirst(){const[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=mn){const r=await this.executeTakeFirst();if(r===void 0)throw yn(e)?new e(this.toOperationNode()):e(this.toOperationNode());return r}async*stream(e=100){const r=this.compile(),n=this.#e.executor.stream(r,e);for await(const i of n)yield*i.rows}async explain(e,r){return await new re({...this.#e,queryNode:q.cloneWithExplain(this.#e.queryNode,e,r)}).execute()}}const ya=o({is(t){return t.kind==="CommonTableExpressionNameNode"},create(t,e){return o({kind:"CommonTableExpressionNameNode",table:Nt.create(t),columns:e?o(e.map(we.create)):void 0})}}),Hn=o({is(t){return t.kind==="CommonTableExpressionNode"},create(t,e){return o({kind:"CommonTableExpressionNode",name:t,expression:e})},cloneWith(t,e){return o({...t,...e})}});class Qn{#e;constructor(e){this.#e=o(e)}materialized(){return new Qn({...this.#e,node:Hn.cloneWith(this.#e.node,{materialized:!0})})}notMaterialized(){return new Qn({...this.#e,node:Hn.cloneWith(this.#e.node,{materialized:!1})})}toOperationNode(){return this.#e.node}}function wa(t,e){const r=e(rf()).toOperationNode();return Ie(t)?t(Gh(r)).toOperationNode():Hn.create(yc(t),r)}function Gh(t){return e=>new Qn({node:Hn.create(yc(e),t)})}function yc(t){if(t.includes("(")){const e=t.split(/[\(\)]/),r=e[0],n=e[1].split(",").map(i=>i.trim());return ya.create(r,n)}else return ya.create(t)}const In=o({is(t){return t.kind==="WithNode"},create(t,e){return o({kind:"WithNode",expressions:o([t]),...e})},cloneWithExpression(t,e){return o({...t,expressions:o([...t.expressions,e])})}}),Na=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9"];function wc(t){let e="";for(let r=0;r<t;++r)e+=Hh();return e}function Hh(){return Na[~~(Math.random()*Na.length)]}function B(){return new Qh}class Qh{#e;get queryId(){return this.#e===void 0&&(this.#e=wc(8)),this.#e}}class Nc{nodeStack=[];#e=o({AliasNode:this.transformAlias.bind(this),ColumnNode:this.transformColumn.bind(this),IdentifierNode:this.transformIdentifier.bind(this),SchemableIdentifierNode:this.transformSchemableIdentifier.bind(this),RawNode:this.transformRaw.bind(this),ReferenceNode:this.transformReference.bind(this),SelectQueryNode:this.transformSelectQuery.bind(this),SelectionNode:this.transformSelection.bind(this),TableNode:this.transformTable.bind(this),FromNode:this.transformFrom.bind(this),SelectAllNode:this.transformSelectAll.bind(this),AndNode:this.transformAnd.bind(this),OrNode:this.transformOr.bind(this),ValueNode:this.transformValue.bind(this),ValueListNode:this.transformValueList.bind(this),PrimitiveValueListNode:this.transformPrimitiveValueList.bind(this),ParensNode:this.transformParens.bind(this),JoinNode:this.transformJoin.bind(this),OperatorNode:this.transformOperator.bind(this),WhereNode:this.transformWhere.bind(this),InsertQueryNode:this.transformInsertQuery.bind(this),DeleteQueryNode:this.transformDeleteQuery.bind(this),ReturningNode:this.transformReturning.bind(this),CreateTableNode:this.transformCreateTable.bind(this),AddColumnNode:this.transformAddColumn.bind(this),ColumnDefinitionNode:this.transformColumnDefinition.bind(this),DropTableNode:this.transformDropTable.bind(this),DataTypeNode:this.transformDataType.bind(this),OrderByNode:this.transformOrderBy.bind(this),OrderByItemNode:this.transformOrderByItem.bind(this),GroupByNode:this.transformGroupBy.bind(this),GroupByItemNode:this.transformGroupByItem.bind(this),UpdateQueryNode:this.transformUpdateQuery.bind(this),ColumnUpdateNode:this.transformColumnUpdate.bind(this),LimitNode:this.transformLimit.bind(this),OffsetNode:this.transformOffset.bind(this),OnConflictNode:this.transformOnConflict.bind(this),OnDuplicateKeyNode:this.transformOnDuplicateKey.bind(this),CreateIndexNode:this.transformCreateIndex.bind(this),DropIndexNode:this.transformDropIndex.bind(this),ListNode:this.transformList.bind(this),PrimaryKeyConstraintNode:this.transformPrimaryKeyConstraint.bind(this),UniqueConstraintNode:this.transformUniqueConstraint.bind(this),ReferencesNode:this.transformReferences.bind(this),CheckConstraintNode:this.transformCheckConstraint.bind(this),WithNode:this.transformWith.bind(this),CommonTableExpressionNode:this.transformCommonTableExpression.bind(this),CommonTableExpressionNameNode:this.transformCommonTableExpressionName.bind(this),HavingNode:this.transformHaving.bind(this),CreateSchemaNode:this.transformCreateSchema.bind(this),DropSchemaNode:this.transformDropSchema.bind(this),AlterTableNode:this.transformAlterTable.bind(this),DropColumnNode:this.transformDropColumn.bind(this),RenameColumnNode:this.transformRenameColumn.bind(this),AlterColumnNode:this.transformAlterColumn.bind(this),ModifyColumnNode:this.transformModifyColumn.bind(this),AddConstraintNode:this.transformAddConstraint.bind(this),DropConstraintNode:this.transformDropConstraint.bind(this),RenameConstraintNode:this.transformRenameConstraint.bind(this),ForeignKeyConstraintNode:this.transformForeignKeyConstraint.bind(this),CreateViewNode:this.transformCreateView.bind(this),RefreshMaterializedViewNode:this.transformRefreshMaterializedView.bind(this),DropViewNode:this.transformDropView.bind(this),GeneratedNode:this.transformGenerated.bind(this),DefaultValueNode:this.transformDefaultValue.bind(this),OnNode:this.transformOn.bind(this),ValuesNode:this.transformValues.bind(this),SelectModifierNode:this.transformSelectModifier.bind(this),CreateTypeNode:this.transformCreateType.bind(this),DropTypeNode:this.transformDropType.bind(this),ExplainNode:this.transformExplain.bind(this),DefaultInsertValueNode:this.transformDefaultInsertValue.bind(this),AggregateFunctionNode:this.transformAggregateFunction.bind(this),OverNode:this.transformOver.bind(this),PartitionByNode:this.transformPartitionBy.bind(this),PartitionByItemNode:this.transformPartitionByItem.bind(this),SetOperationNode:this.transformSetOperation.bind(this),BinaryOperationNode:this.transformBinaryOperation.bind(this),UnaryOperationNode:this.transformUnaryOperation.bind(this),UsingNode:this.transformUsing.bind(this),FunctionNode:this.transformFunction.bind(this),CaseNode:this.transformCase.bind(this),WhenNode:this.transformWhen.bind(this),JSONReferenceNode:this.transformJSONReference.bind(this),JSONPathNode:this.transformJSONPath.bind(this),JSONPathLegNode:this.transformJSONPathLeg.bind(this),JSONOperatorChainNode:this.transformJSONOperatorChain.bind(this),TupleNode:this.transformTuple.bind(this),MergeQueryNode:this.transformMergeQuery.bind(this),MatchedNode:this.transformMatched.bind(this),AddIndexNode:this.transformAddIndex.bind(this),CastNode:this.transformCast.bind(this),FetchNode:this.transformFetch.bind(this),TopNode:this.transformTop.bind(this),OutputNode:this.transformOutput.bind(this),OrActionNode:this.transformOrAction.bind(this),CollateNode:this.transformCollate.bind(this)});transformNode(e,r){if(!e)return e;this.nodeStack.push(e);const n=this.transformNodeImpl(e,r);return this.nodeStack.pop(),o(n)}transformNodeImpl(e,r){return this.#e[e.kind](e,r)}transformNodeList(e,r){return e&&o(e.map(n=>this.transformNode(n,r)))}transformSelectQuery(e,r){return{kind:"SelectQueryNode",from:this.transformNode(e.from,r),selections:this.transformNodeList(e.selections,r),distinctOn:this.transformNodeList(e.distinctOn,r),joins:this.transformNodeList(e.joins,r),groupBy:this.transformNode(e.groupBy,r),orderBy:this.transformNode(e.orderBy,r),where:this.transformNode(e.where,r),frontModifiers:this.transformNodeList(e.frontModifiers,r),endModifiers:this.transformNodeList(e.endModifiers,r),limit:this.transformNode(e.limit,r),offset:this.transformNode(e.offset,r),with:this.transformNode(e.with,r),having:this.transformNode(e.having,r),explain:this.transformNode(e.explain,r),setOperations:this.transformNodeList(e.setOperations,r),fetch:this.transformNode(e.fetch,r),top:this.transformNode(e.top,r)}}transformSelection(e,r){return{kind:"SelectionNode",selection:this.transformNode(e.selection,r)}}transformColumn(e,r){return{kind:"ColumnNode",column:this.transformNode(e.column,r)}}transformAlias(e,r){return{kind:"AliasNode",node:this.transformNode(e.node,r),alias:this.transformNode(e.alias,r)}}transformTable(e,r){return{kind:"TableNode",table:this.transformNode(e.table,r)}}transformFrom(e,r){return{kind:"FromNode",froms:this.transformNodeList(e.froms,r)}}transformReference(e,r){return{kind:"ReferenceNode",column:this.transformNode(e.column,r),table:this.transformNode(e.table,r)}}transformAnd(e,r){return{kind:"AndNode",left:this.transformNode(e.left,r),right:this.transformNode(e.right,r)}}transformOr(e,r){return{kind:"OrNode",left:this.transformNode(e.left,r),right:this.transformNode(e.right,r)}}transformValueList(e,r){return{kind:"ValueListNode",values:this.transformNodeList(e.values,r)}}transformParens(e,r){return{kind:"ParensNode",node:this.transformNode(e.node,r)}}transformJoin(e,r){return{kind:"JoinNode",joinType:e.joinType,table:this.transformNode(e.table,r),on:this.transformNode(e.on,r)}}transformRaw(e,r){return{kind:"RawNode",sqlFragments:o([...e.sqlFragments]),parameters:this.transformNodeList(e.parameters,r)}}transformWhere(e,r){return{kind:"WhereNode",where:this.transformNode(e.where,r)}}transformInsertQuery(e,r){return{kind:"InsertQueryNode",into:this.transformNode(e.into,r),columns:this.transformNodeList(e.columns,r),values:this.transformNode(e.values,r),returning:this.transformNode(e.returning,r),onConflict:this.transformNode(e.onConflict,r),onDuplicateKey:this.transformNode(e.onDuplicateKey,r),endModifiers:this.transformNodeList(e.endModifiers,r),with:this.transformNode(e.with,r),ignore:e.ignore,orAction:this.transformNode(e.orAction,r),replace:e.replace,explain:this.transformNode(e.explain,r),defaultValues:e.defaultValues,top:this.transformNode(e.top,r),output:this.transformNode(e.output,r)}}transformValues(e,r){return{kind:"ValuesNode",values:this.transformNodeList(e.values,r)}}transformDeleteQuery(e,r){return{kind:"DeleteQueryNode",from:this.transformNode(e.from,r),using:this.transformNode(e.using,r),joins:this.transformNodeList(e.joins,r),where:this.transformNode(e.where,r),returning:this.transformNode(e.returning,r),endModifiers:this.transformNodeList(e.endModifiers,r),with:this.transformNode(e.with,r),orderBy:this.transformNode(e.orderBy,r),limit:this.transformNode(e.limit,r),explain:this.transformNode(e.explain,r),top:this.transformNode(e.top,r),output:this.transformNode(e.output,r)}}transformReturning(e,r){return{kind:"ReturningNode",selections:this.transformNodeList(e.selections,r)}}transformCreateTable(e,r){return{kind:"CreateTableNode",table:this.transformNode(e.table,r),columns:this.transformNodeList(e.columns,r),constraints:this.transformNodeList(e.constraints,r),temporary:e.temporary,ifNotExists:e.ifNotExists,onCommit:e.onCommit,frontModifiers:this.transformNodeList(e.frontModifiers,r),endModifiers:this.transformNodeList(e.endModifiers,r),selectQuery:this.transformNode(e.selectQuery,r)}}transformColumnDefinition(e,r){return{kind:"ColumnDefinitionNode",column:this.transformNode(e.column,r),dataType:this.transformNode(e.dataType,r),references:this.transformNode(e.references,r),primaryKey:e.primaryKey,autoIncrement:e.autoIncrement,unique:e.unique,notNull:e.notNull,unsigned:e.unsigned,defaultTo:this.transformNode(e.defaultTo,r),check:this.transformNode(e.check,r),generated:this.transformNode(e.generated,r),frontModifiers:this.transformNodeList(e.frontModifiers,r),endModifiers:this.transformNodeList(e.endModifiers,r),nullsNotDistinct:e.nullsNotDistinct,identity:e.identity,ifNotExists:e.ifNotExists}}transformAddColumn(e,r){return{kind:"AddColumnNode",column:this.transformNode(e.column,r)}}transformDropTable(e,r){return{kind:"DropTableNode",table:this.transformNode(e.table,r),ifExists:e.ifExists,cascade:e.cascade}}transformOrderBy(e,r){return{kind:"OrderByNode",items:this.transformNodeList(e.items,r)}}transformOrderByItem(e,r){return{kind:"OrderByItemNode",orderBy:this.transformNode(e.orderBy,r),direction:this.transformNode(e.direction,r),collation:this.transformNode(e.collation,r),nulls:e.nulls}}transformGroupBy(e,r){return{kind:"GroupByNode",items:this.transformNodeList(e.items,r)}}transformGroupByItem(e,r){return{kind:"GroupByItemNode",groupBy:this.transformNode(e.groupBy,r)}}transformUpdateQuery(e,r){return{kind:"UpdateQueryNode",table:this.transformNode(e.table,r),from:this.transformNode(e.from,r),joins:this.transformNodeList(e.joins,r),where:this.transformNode(e.where,r),updates:this.transformNodeList(e.updates,r),returning:this.transformNode(e.returning,r),endModifiers:this.transformNodeList(e.endModifiers,r),with:this.transformNode(e.with,r),explain:this.transformNode(e.explain,r),limit:this.transformNode(e.limit,r),top:this.transformNode(e.top,r),output:this.transformNode(e.output,r),orderBy:this.transformNode(e.orderBy,r)}}transformColumnUpdate(e,r){return{kind:"ColumnUpdateNode",column:this.transformNode(e.column,r),value:this.transformNode(e.value,r)}}transformLimit(e,r){return{kind:"LimitNode",limit:this.transformNode(e.limit,r)}}transformOffset(e,r){return{kind:"OffsetNode",offset:this.transformNode(e.offset,r)}}transformOnConflict(e,r){return{kind:"OnConflictNode",columns:this.transformNodeList(e.columns,r),constraint:this.transformNode(e.constraint,r),indexExpression:this.transformNode(e.indexExpression,r),indexWhere:this.transformNode(e.indexWhere,r),updates:this.transformNodeList(e.updates,r),updateWhere:this.transformNode(e.updateWhere,r),doNothing:e.doNothing}}transformOnDuplicateKey(e,r){return{kind:"OnDuplicateKeyNode",updates:this.transformNodeList(e.updates,r)}}transformCreateIndex(e,r){return{kind:"CreateIndexNode",name:this.transformNode(e.name,r),table:this.transformNode(e.table,r),columns:this.transformNodeList(e.columns,r),unique:e.unique,using:this.transformNode(e.using,r),ifNotExists:e.ifNotExists,where:this.transformNode(e.where,r),nullsNotDistinct:e.nullsNotDistinct}}transformList(e,r){return{kind:"ListNode",items:this.transformNodeList(e.items,r)}}transformDropIndex(e,r){return{kind:"DropIndexNode",name:this.transformNode(e.name,r),table:this.transformNode(e.table,r),ifExists:e.ifExists,cascade:e.cascade}}transformPrimaryKeyConstraint(e,r){return{kind:"PrimaryKeyConstraintNode",columns:this.transformNodeList(e.columns,r),name:this.transformNode(e.name,r),deferrable:e.deferrable,initiallyDeferred:e.initiallyDeferred}}transformUniqueConstraint(e,r){return{kind:"UniqueConstraintNode",columns:this.transformNodeList(e.columns,r),name:this.transformNode(e.name,r),nullsNotDistinct:e.nullsNotDistinct,deferrable:e.deferrable,initiallyDeferred:e.initiallyDeferred}}transformForeignKeyConstraint(e,r){return{kind:"ForeignKeyConstraintNode",columns:this.transformNodeList(e.columns,r),references:this.transformNode(e.references,r),name:this.transformNode(e.name,r),onDelete:e.onDelete,onUpdate:e.onUpdate,deferrable:e.deferrable,initiallyDeferred:e.initiallyDeferred}}transformSetOperation(e,r){return{kind:"SetOperationNode",operator:e.operator,expression:this.transformNode(e.expression,r),all:e.all}}transformReferences(e,r){return{kind:"ReferencesNode",table:this.transformNode(e.table,r),columns:this.transformNodeList(e.columns,r),onDelete:e.onDelete,onUpdate:e.onUpdate}}transformCheckConstraint(e,r){return{kind:"CheckConstraintNode",expression:this.transformNode(e.expression,r),name:this.transformNode(e.name,r)}}transformWith(e,r){return{kind:"WithNode",expressions:this.transformNodeList(e.expressions,r),recursive:e.recursive}}transformCommonTableExpression(e,r){return{kind:"CommonTableExpressionNode",name:this.transformNode(e.name,r),materialized:e.materialized,expression:this.transformNode(e.expression,r)}}transformCommonTableExpressionName(e,r){return{kind:"CommonTableExpressionNameNode",table:this.transformNode(e.table,r),columns:this.transformNodeList(e.columns,r)}}transformHaving(e,r){return{kind:"HavingNode",having:this.transformNode(e.having,r)}}transformCreateSchema(e,r){return{kind:"CreateSchemaNode",schema:this.transformNode(e.schema,r),ifNotExists:e.ifNotExists}}transformDropSchema(e,r){return{kind:"DropSchemaNode",schema:this.transformNode(e.schema,r),ifExists:e.ifExists,cascade:e.cascade}}transformAlterTable(e,r){return{kind:"AlterTableNode",table:this.transformNode(e.table,r),renameTo:this.transformNode(e.renameTo,r),setSchema:this.transformNode(e.setSchema,r),columnAlterations:this.transformNodeList(e.columnAlterations,r),addConstraint:this.transformNode(e.addConstraint,r),dropConstraint:this.transformNode(e.dropConstraint,r),renameConstraint:this.transformNode(e.renameConstraint,r),addIndex:this.transformNode(e.addIndex,r),dropIndex:this.transformNode(e.dropIndex,r)}}transformDropColumn(e,r){return{kind:"DropColumnNode",column:this.transformNode(e.column,r)}}transformRenameColumn(e,r){return{kind:"RenameColumnNode",column:this.transformNode(e.column,r),renameTo:this.transformNode(e.renameTo,r)}}transformAlterColumn(e,r){return{kind:"AlterColumnNode",column:this.transformNode(e.column,r),dataType:this.transformNode(e.dataType,r),dataTypeExpression:this.transformNode(e.dataTypeExpression,r),setDefault:this.transformNode(e.setDefault,r),dropDefault:e.dropDefault,setNotNull:e.setNotNull,dropNotNull:e.dropNotNull}}transformModifyColumn(e,r){return{kind:"ModifyColumnNode",column:this.transformNode(e.column,r)}}transformAddConstraint(e,r){return{kind:"AddConstraintNode",constraint:this.transformNode(e.constraint,r)}}transformDropConstraint(e,r){return{kind:"DropConstraintNode",constraintName:this.transformNode(e.constraintName,r),ifExists:e.ifExists,modifier:e.modifier}}transformRenameConstraint(e,r){return{kind:"RenameConstraintNode",oldName:this.transformNode(e.oldName,r),newName:this.transformNode(e.newName,r)}}transformCreateView(e,r){return{kind:"CreateViewNode",name:this.transformNode(e.name,r),temporary:e.temporary,orReplace:e.orReplace,ifNotExists:e.ifNotExists,materialized:e.materialized,columns:this.transformNodeList(e.columns,r),as:this.transformNode(e.as,r)}}transformRefreshMaterializedView(e,r){return{kind:"RefreshMaterializedViewNode",name:this.transformNode(e.name,r),concurrently:e.concurrently,withNoData:e.withNoData}}transformDropView(e,r){return{kind:"DropViewNode",name:this.transformNode(e.name,r),ifExists:e.ifExists,materialized:e.materialized,cascade:e.cascade}}transformGenerated(e,r){return{kind:"GeneratedNode",byDefault:e.byDefault,always:e.always,identity:e.identity,stored:e.stored,expression:this.transformNode(e.expression,r)}}transformDefaultValue(e,r){return{kind:"DefaultValueNode",defaultValue:this.transformNode(e.defaultValue,r)}}transformOn(e,r){return{kind:"OnNode",on:this.transformNode(e.on,r)}}transformSelectModifier(e,r){return{kind:"SelectModifierNode",modifier:e.modifier,rawModifier:this.transformNode(e.rawModifier,r),of:this.transformNodeList(e.of,r)}}transformCreateType(e,r){return{kind:"CreateTypeNode",name:this.transformNode(e.name,r),enum:this.transformNode(e.enum,r)}}transformDropType(e,r){return{kind:"DropTypeNode",name:this.transformNode(e.name,r),ifExists:e.ifExists}}transformExplain(e,r){return{kind:"ExplainNode",format:e.format,options:this.transformNode(e.options,r)}}transformSchemableIdentifier(e,r){return{kind:"SchemableIdentifierNode",schema:this.transformNode(e.schema,r),identifier:this.transformNode(e.identifier,r)}}transformAggregateFunction(e,r){return{kind:"AggregateFunctionNode",func:e.func,aggregated:this.transformNodeList(e.aggregated,r),distinct:e.distinct,orderBy:this.transformNode(e.orderBy,r),withinGroup:this.transformNode(e.withinGroup,r),filter:this.transformNode(e.filter,r),over:this.transformNode(e.over,r)}}transformOver(e,r){return{kind:"OverNode",orderBy:this.transformNode(e.orderBy,r),partitionBy:this.transformNode(e.partitionBy,r)}}transformPartitionBy(e,r){return{kind:"PartitionByNode",items:this.transformNodeList(e.items,r)}}transformPartitionByItem(e,r){return{kind:"PartitionByItemNode",partitionBy:this.transformNode(e.partitionBy,r)}}transformBinaryOperation(e,r){return{kind:"BinaryOperationNode",leftOperand:this.transformNode(e.leftOperand,r),operator:this.transformNode(e.operator,r),rightOperand:this.transformNode(e.rightOperand,r)}}transformUnaryOperation(e,r){return{kind:"UnaryOperationNode",operator:this.transformNode(e.operator,r),operand:this.transformNode(e.operand,r)}}transformUsing(e,r){return{kind:"UsingNode",tables:this.transformNodeList(e.tables,r)}}transformFunction(e,r){return{kind:"FunctionNode",func:e.func,arguments:this.transformNodeList(e.arguments,r)}}transformCase(e,r){return{kind:"CaseNode",value:this.transformNode(e.value,r),when:this.transformNodeList(e.when,r),else:this.transformNode(e.else,r),isStatement:e.isStatement}}transformWhen(e,r){return{kind:"WhenNode",condition:this.transformNode(e.condition,r),result:this.transformNode(e.result,r)}}transformJSONReference(e,r){return{kind:"JSONReferenceNode",reference:this.transformNode(e.reference,r),traversal:this.transformNode(e.traversal,r)}}transformJSONPath(e,r){return{kind:"JSONPathNode",inOperator:this.transformNode(e.inOperator,r),pathLegs:this.transformNodeList(e.pathLegs,r)}}transformJSONPathLeg(e,r){return{kind:"JSONPathLegNode",type:e.type,value:e.value}}transformJSONOperatorChain(e,r){return{kind:"JSONOperatorChainNode",operator:this.transformNode(e.operator,r),values:this.transformNodeList(e.values,r)}}transformTuple(e,r){return{kind:"TupleNode",values:this.transformNodeList(e.values,r)}}transformMergeQuery(e,r){return{kind:"MergeQueryNode",into:this.transformNode(e.into,r),using:this.transformNode(e.using,r),whens:this.transformNodeList(e.whens,r),with:this.transformNode(e.with,r),top:this.transformNode(e.top,r),endModifiers:this.transformNodeList(e.endModifiers,r),output:this.transformNode(e.output,r),returning:this.transformNode(e.returning,r)}}transformMatched(e,r){return{kind:"MatchedNode",not:e.not,bySource:e.bySource}}transformAddIndex(e,r){return{kind:"AddIndexNode",name:this.transformNode(e.name,r),columns:this.transformNodeList(e.columns,r),unique:e.unique,using:this.transformNode(e.using,r),ifNotExists:e.ifNotExists}}transformCast(e,r){return{kind:"CastNode",expression:this.transformNode(e.expression,r),dataType:this.transformNode(e.dataType,r)}}transformFetch(e,r){return{kind:"FetchNode",rowCount:this.transformNode(e.rowCount,r),modifier:e.modifier}}transformTop(e,r){return{kind:"TopNode",expression:e.expression,modifiers:e.modifiers}}transformOutput(e,r){return{kind:"OutputNode",selections:this.transformNodeList(e.selections,r)}}transformDataType(e,r){return e}transformSelectAll(e,r){return e}transformIdentifier(e,r){return e}transformValue(e,r){return e}transformPrimitiveValueList(e,r){return e}transformOperator(e,r){return e}transformDefaultInsertValue(e,r){return e}transformOrAction(e,r){return e}transformCollate(e,r){return e}}const Yh=o({AlterTableNode:!0,CreateIndexNode:!0,CreateSchemaNode:!0,CreateTableNode:!0,CreateTypeNode:!0,CreateViewNode:!0,RefreshMaterializedViewNode:!0,DeleteQueryNode:!0,DropIndexNode:!0,DropSchemaNode:!0,DropTableNode:!0,DropTypeNode:!0,DropViewNode:!0,InsertQueryNode:!0,RawNode:!0,SelectQueryNode:!0,UpdateQueryNode:!0,MergeQueryNode:!0}),zh={json_agg:!0,to_json:!0};class Kh extends Nc{#e;#t=new Set;#r=new Set;constructor(e){super(),this.#e=e}transformNodeImpl(e,r){if(!this.#i(e))return super.transformNodeImpl(e,r);const n=this.#u(e);for(const u of n)this.#r.add(u);const i=this.#o(e);for(const u of i)this.#t.add(u);const s=super.transformNodeImpl(e,r);for(const u of i)this.#t.delete(u);for(const u of n)this.#r.delete(u);return s}transformSchemableIdentifier(e,r){const n=super.transformSchemableIdentifier(e,r);return n.schema||!this.#t.has(e.identifier.name)?n:{...n,schema:Q.create(this.#e)}}transformReferences(e,r){const n=super.transformReferences(e,r);return n.table.table.schema?n:{...n,table:Nt.createWithSchema(this.#e,n.table.table.identifier.name)}}transformAggregateFunction(e,r){return{...super.transformAggregateFunction({...e,aggregated:[]},r),aggregated:this.#n(e,r,"aggregated")}}transformFunction(e,r){return{...super.transformFunction({...e,arguments:[]},r),arguments:this.#n(e,r,"arguments")}}#n(e,r,n){return zh[e.func]?e[n].map(i=>!Nt.is(i)||i.table.schema?this.transformNode(i,r):{...i,table:this.transformIdentifier(i.table.identifier,r)}):this.transformNodeList(e[n],r)}#i(e){return e.kind in Yh}#o(e){const r=new Set;if("name"in e&&e.name&&Tt.is(e.name)&&this.#a(e.name,r),"from"in e&&e.from)for(const n of e.from.froms)this.#s(n,r);if("into"in e&&e.into&&this.#s(e.into,r),"table"in e&&e.table&&this.#s(e.table,r),"joins"in e&&e.joins)for(const n of e.joins)this.#s(n.table,r);return"using"in e&&e.using&&(ar.is(e.using)?this.#s(e.using.table,r):this.#s(e.using,r)),r}#u(e){const r=new Set;return"with"in e&&e.with&&this.#c(e.with,r),r}#s(e,r){if(Nt.is(e))this.#a(e.table,r);else if(xt.is(e)&&Nt.is(e.node))this.#a(e.node.table,r);else if(fc.is(e))for(const n of e.items)this.#s(n,r)}#a(e,r){const n=e.identifier.name;!this.#t.has(n)&&!this.#r.has(n)&&r.add(n)}#c(e,r){for(const n of e.expressions){const i=n.name.table.table.identifier.name;this.#r.has(i)||r.add(i)}}}class Pr{#e;constructor(e){this.#e=new Kh(e)}transformQuery(e){return this.#e.transformNode(e.node,e.queryId)}async transformResult(e){return e.result}}const Xh=o({is(t){return t.kind==="MatchedNode"},create(t,e=!1){return o({kind:"MatchedNode",not:t,bySource:e})}});function ga(t,e,r){return cr.create(Jn([Xh.create(!t.isMatched,t.bySource),...e&&e.length>0?[e.length===3&&r?dt(e[0],e[1],e[2]):Ae(e)]:[]],"and",!1))}function rn(t){return Oe(t)?ce.create([t],[]):Le(t)?t.toOperationNode():t}class nn{#e;#t;#r;constructor(){this.#e=new Promise((e,r)=>{this.#r=r,this.#t=e})}get promise(){return this.#e}resolve=e=>{this.#t&&this.#t(e)};reject=e=>{this.#r&&this.#r(e)}}async function gc(t){const e=new nn,r=new nn;return t.provideConnection(async n=>(e.resolve(n),await r.promise)).catch(n=>e.reject(n)),o({connection:await e.promise,release:r.resolve})}const Zh=o([]);class bc{#e;constructor(e=Zh){this.#e=e}get plugins(){return this.#e}transformQuery(e,r){for(const n of this.#e){const i=n.transformQuery({node:e,queryId:r});if(i.kind===e.kind)e=i;else throw new Error(["KyselyPlugin.transformQuery must return a node","of the same kind that was given to it.",`The plugin was given a ${e.kind}`,`but it returned a ${i.kind}`].join(" "))}return e}async executeQuery(e){return await this.provideConnection(async r=>{const n=await r.executeQuery(e);return"numUpdatedOrDeletedRows"in n&&qr("kysely:warning: outdated driver/plugin detected! `QueryResult.numUpdatedOrDeletedRows` has been replaced with `QueryResult.numAffectedRows`."),await this.#t(n,e.queryId)})}async*stream(e,r){const{connection:n,release:i}=await gc(this);try{for await(const s of n.streamQuery(e,r))yield await this.#t(s,e.queryId)}finally{i()}}async#t(e,r){for(const n of this.#e)e=await n.transformResult({result:e,queryId:r});return e}}class Or extends bc{get adapter(){throw new Error("this query cannot be compiled to SQL")}compileQuery(){throw new Error("this query cannot be compiled to SQL")}provideConnection(){throw new Error("this query cannot be executed")}withConnectionProvider(){throw new Error("this query cannot have a connection provider")}withPlugin(e){return new Or([...this.plugins,e])}withPlugins(e){return new Or([...this.plugins,...e])}withPluginAtFront(e){return new Or([e,...this.plugins])}withoutPlugins(){return new Or([])}}const ci=new Or;class ef{numChangedRows;constructor(e){this.numChangedRows=e}}class Ct{#e;constructor(e){this.#e=o(e)}modifyEnd(e){return new Ct({...this.#e,queryNode:q.cloneWithEndModifier(this.#e.queryNode,e.toOperationNode())})}top(e,r){return new Ct({...this.#e,queryNode:q.cloneWithTop(this.#e.queryNode,_r(e,r))})}using(...e){return new Pe({...this.#e,queryNode:ct.cloneWithUsing(this.#e.queryNode,di("Using",e))})}returning(e){return new Ct({...this.#e,queryNode:q.cloneWithReturning(this.#e.queryNode,Qe(e))})}returningAll(e){return new Ct({...this.#e,queryNode:q.cloneWithReturning(this.#e.queryNode,Ze(e))})}output(e){return new Ct({...this.#e,queryNode:q.cloneWithOutput(this.#e.queryNode,Qe(e))})}outputAll(e){return new Ct({...this.#e,queryNode:q.cloneWithOutput(this.#e.queryNode,Ze(e))})}}class Pe{#e;constructor(e){this.#e=o(e)}modifyEnd(e){return new Pe({...this.#e,queryNode:q.cloneWithEndModifier(this.#e.queryNode,e.toOperationNode())})}top(e,r){return new Pe({...this.#e,queryNode:q.cloneWithTop(this.#e.queryNode,_r(e,r))})}whenMatched(){return this.#t([])}whenMatchedAnd(...e){return this.#t(e)}whenMatchedAndRef(e,r,n){return this.#t([e,r,n],!0)}#t(e,r){return new ba({...this.#e,queryNode:ct.cloneWithWhen(this.#e.queryNode,ga({isMatched:!0},e,r))})}whenNotMatched(){return this.#r([])}whenNotMatchedAnd(...e){return this.#r(e)}whenNotMatchedAndRef(e,r,n){return this.#r([e,r,n],!0)}whenNotMatchedBySource(){return this.#r([],!1,!0)}whenNotMatchedBySourceAnd(...e){return this.#r(e,!1,!0)}whenNotMatchedBySourceAndRef(e,r,n){return this.#r([e,r,n],!0,!0)}returning(e){return new Pe({...this.#e,queryNode:q.cloneWithReturning(this.#e.queryNode,Qe(e))})}returningAll(e){return new Pe({...this.#e,queryNode:q.cloneWithReturning(this.#e.queryNode,Ze(e))})}output(e){return new Pe({...this.#e,queryNode:q.cloneWithOutput(this.#e.queryNode,Qe(e))})}outputAll(e){return new Pe({...this.#e,queryNode:q.cloneWithOutput(this.#e.queryNode,Ze(e))})}#r(e,r=!1,n=!1){const i={...this.#e,queryNode:ct.cloneWithWhen(this.#e.queryNode,ga({isMatched:!1,bySource:n},e,r))},s=n?ba:tf;return new s(i)}$call(e){return e(this)}$if(e,r){return e?r(this):new Pe({...this.#e})}toOperationNode(){return this.#e.executor.transformQuery(this.#e.queryNode,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){const e=this.compile(),r=await this.#e.executor.executeQuery(e),{adapter:n}=this.#e.executor,i=e.query;return i.returning&&n.supportsReturning||i.output&&n.supportsOutput?r.rows:[new ef(r.numAffectedRows)]}async executeTakeFirst(){const[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=mn){const r=await this.executeTakeFirst();if(r===void 0)throw yn(e)?new e(this.toOperationNode()):e(this.toOperationNode());return r}}class ba{#e;constructor(e){this.#e=o(e)}thenDelete(){return new Pe({...this.#e,queryNode:ct.cloneWithThen(this.#e.queryNode,rn("delete"))})}thenDoNothing(){return new Pe({...this.#e,queryNode:ct.cloneWithThen(this.#e.queryNode,rn("do nothing"))})}thenUpdate(e){return new Pe({...this.#e,queryNode:ct.cloneWithThen(this.#e.queryNode,rn(e(new re({queryId:this.#e.queryId,executor:ci,queryNode:Tr.createWithoutTable()}))))})}thenUpdateSet(...e){return this.thenUpdate(r=>r.set(...e))}}class tf{#e;constructor(e){this.#e=o(e)}thenDoNothing(){return new Pe({...this.#e,queryNode:ct.cloneWithThen(this.#e.queryNode,rn("do nothing"))})}thenInsertValues(e){const[r,n]=pc(e);return new Pe({...this.#e,queryNode:ct.cloneWithThen(this.#e.queryNode,rn(ve.cloneWith(ve.createWithoutInto(),{columns:r,values:n})))})}}class Wt{#e;constructor(e){this.#e=o(e)}selectFrom(e){return Ms({queryId:B(),executor:this.#e.executor,queryNode:Z.createFrom(Sr(e),this.#e.withNode)})}selectNoFrom(e){return Ms({queryId:B(),executor:this.#e.executor,queryNode:Z.cloneWithSelections(Z.create(this.#e.withNode),Qe(e))})}insertInto(e){return new Y({queryId:B(),executor:this.#e.executor,queryNode:ve.create(pe(e),this.#e.withNode)})}replaceInto(e){return new Y({queryId:B(),executor:this.#e.executor,queryNode:ve.create(pe(e),this.#e.withNode,!0)})}deleteFrom(e){return new ae({queryId:B(),executor:this.#e.executor,queryNode:Kr.create(Sr(e),this.#e.withNode)})}updateTable(e){return new re({queryId:B(),executor:this.#e.executor,queryNode:Tr.create(Sr(e),this.#e.withNode)})}mergeInto(e){return new Ct({queryId:B(),executor:this.#e.executor,queryNode:ct.create(Sc(e),this.#e.withNode)})}with(e,r){const n=wa(e,r);return new Wt({...this.#e,withNode:this.#e.withNode?In.cloneWithExpression(this.#e.withNode,n):In.create(n)})}withRecursive(e,r){const n=wa(e,r);return new Wt({...this.#e,withNode:this.#e.withNode?In.cloneWithExpression(this.#e.withNode,n):In.create(n,{recursive:!0})})}withPlugin(e){return new Wt({...this.#e,executor:this.#e.executor.withPlugin(e)})}withoutPlugins(){return new Wt({...this.#e,executor:this.#e.executor.withoutPlugins()})}withSchema(e){return new Wt({...this.#e,executor:this.#e.executor.withPluginAtFront(new Pr(e))})}}function rf(){return new Wt({executor:ci})}function nf(t,e){return new Xr({joinNode:ar.create(t,pn(e))})}function sf(){return new Zr({overNode:Us.create()})}function di(t,e){if(e.length===3)return af(t,e[0],e[1],e[2]);if(e.length===2)return of(t,e[0],e[1]);if(e.length===1)return uf(t,e[0]);throw new Error("not implemented")}function of(t,e,r){return r(nf(t,e)).toOperationNode()}function af(t,e,r,n){return ar.createWithOn(t,pn(e),dt(r,"=",n))}function uf(t,e){return ar.create(t,pn(e))}const cf=o({is(t){return t.kind==="OffsetNode"},create(t){return o({kind:"OffsetNode",offset:t})}}),df=o({is(t){return t.kind==="GroupByItemNode"},create(t){return o({kind:"GroupByItemNode",groupBy:t})}});function lf(t){return t=Ie(t)?t($r()):t,hn(t).map(df.create)}const vc=o({is(t){return t.kind==="SetOperationNode"},create(t,e,r){return o({kind:"SetOperationNode",operator:t,expression:e,all:r})}});function yr(t,e,r){return Ie(e)&&(e=e(mo())),At(e)||(e=[e]),e.map(n=>vc.create(t,fr(n),r))}class z{#e;constructor(e){this.#e=e}get expressionType(){}as(e){return new po(this,e)}or(...e){return new Yn(Dr.create(this.#e,Ae(e)))}and(...e){return new zn(Bt.create(this.#e,Ae(e)))}$castTo(){return new z(this.#e)}$notNull(){return new z(this.#e)}toOperationNode(){return this.#e}}class po{#e;#t;constructor(e,r){this.#e=e,this.#t=r}get expression(){return this.#e}get alias(){return this.#t}toOperationNode(){return xt.create(this.#e.toOperationNode(),Le(this.#t)?this.#t.toOperationNode():Q.create(this.#t))}}class Yn{#e;constructor(e){this.#e=e}get expressionType(){}as(e){return new po(this,e)}or(...e){return new Yn(Dr.create(this.#e,Ae(e)))}$castTo(){return new Yn(this.#e)}toOperationNode(){return gt.create(this.#e)}}class zn{#e;constructor(e){this.#e=e}get expressionType(){}as(e){return new po(this,e)}and(...e){return new zn(Bt.create(this.#e,Ae(e)))}$castTo(){return new zn(this.#e)}toOperationNode(){return gt.create(this.#e)}}const hf={is(t){return t.kind==="FetchNode"},create(t,e){return{kind:"FetchNode",rowCount:Xe.create(t),modifier:e}}};function ff(t,e){if(!Ir(t)&&!oi(t))throw new Error(`Invalid fetch row count: ${t}`);if(!pf(e))throw new Error(`Invalid fetch modifier: ${e}`);return hf.create(t,e)}function pf(t){return t==="only"||t==="with ties"}class F{#e;constructor(e){this.#e=o(e)}get expressionType(){}get isSelectQueryBuilder(){return!0}where(...e){return new F({...this.#e,queryNode:q.cloneWithWhere(this.#e.queryNode,Ae(e))})}whereRef(e,r,n){return new F({...this.#e,queryNode:q.cloneWithWhere(this.#e.queryNode,dt(e,r,n))})}having(...e){return new F({...this.#e,queryNode:Z.cloneWithHaving(this.#e.queryNode,Ae(e))})}havingRef(e,r,n){return new F({...this.#e,queryNode:Z.cloneWithHaving(this.#e.queryNode,dt(e,r,n))})}select(e){return new F({...this.#e,queryNode:Z.cloneWithSelections(this.#e.queryNode,Qe(e))})}distinctOn(e){return new F({...this.#e,queryNode:Z.cloneWithDistinctOn(this.#e.queryNode,hn(e))})}modifyFront(e){return new F({...this.#e,queryNode:Z.cloneWithFrontModifier(this.#e.queryNode,ht.createWithExpression(e.toOperationNode()))})}modifyEnd(e){return new F({...this.#e,queryNode:q.cloneWithEndModifier(this.#e.queryNode,ht.createWithExpression(e.toOperationNode()))})}distinct(){return new F({...this.#e,queryNode:Z.cloneWithFrontModifier(this.#e.queryNode,ht.create("Distinct"))})}forUpdate(e){return new F({...this.#e,queryNode:q.cloneWithEndModifier(this.#e.queryNode,ht.create("ForUpdate",e?Rn(e).map(pe):void 0))})}forShare(e){return new F({...this.#e,queryNode:q.cloneWithEndModifier(this.#e.queryNode,ht.create("ForShare",e?Rn(e).map(pe):void 0))})}forKeyShare(e){return new F({...this.#e,queryNode:q.cloneWithEndModifier(this.#e.queryNode,ht.create("ForKeyShare",e?Rn(e).map(pe):void 0))})}forNoKeyUpdate(e){return new F({...this.#e,queryNode:q.cloneWithEndModifier(this.#e.queryNode,ht.create("ForNoKeyUpdate",e?Rn(e).map(pe):void 0))})}skipLocked(){return new F({...this.#e,queryNode:q.cloneWithEndModifier(this.#e.queryNode,ht.create("SkipLocked"))})}noWait(){return new F({...this.#e,queryNode:q.cloneWithEndModifier(this.#e.queryNode,ht.create("NoWait"))})}selectAll(e){return new F({...this.#e,queryNode:Z.cloneWithSelections(this.#e.queryNode,Ze(e))})}innerJoin(...e){return this.#t("InnerJoin",e)}leftJoin(...e){return this.#t("LeftJoin",e)}rightJoin(...e){return this.#t("RightJoin",e)}fullJoin(...e){return this.#t("FullJoin",e)}crossJoin(...e){return this.#t("CrossJoin",e)}innerJoinLateral(...e){return this.#t("LateralInnerJoin",e)}leftJoinLateral(...e){return this.#t("LateralLeftJoin",e)}crossJoinLateral(...e){return this.#t("LateralCrossJoin",e)}crossApply(...e){return this.#t("CrossApply",e)}outerApply(...e){return this.#t("OuterApply",e)}#t(e,r){return new F({...this.#e,queryNode:q.cloneWithJoin(this.#e.queryNode,di(e,r))})}orderBy(...e){return new F({...this.#e,queryNode:q.cloneWithOrderByItems(this.#e.queryNode,ur(e))})}groupBy(e){return new F({...this.#e,queryNode:Z.cloneWithGroupByItems(this.#e.queryNode,lf(e))})}limit(e){return new F({...this.#e,queryNode:Z.cloneWithLimit(this.#e.queryNode,fo.create(ge(e)))})}offset(e){return new F({...this.#e,queryNode:Z.cloneWithOffset(this.#e.queryNode,cf.create(ge(e)))})}fetch(e,r="only"){return new F({...this.#e,queryNode:Z.cloneWithFetch(this.#e.queryNode,ff(e,r))})}top(e,r){return new F({...this.#e,queryNode:q.cloneWithTop(this.#e.queryNode,_r(e,r))})}union(e){return new F({...this.#e,queryNode:Z.cloneWithSetOperations(this.#e.queryNode,yr("union",e,!1))})}unionAll(e){return new F({...this.#e,queryNode:Z.cloneWithSetOperations(this.#e.queryNode,yr("union",e,!0))})}intersect(e){return new F({...this.#e,queryNode:Z.cloneWithSetOperations(this.#e.queryNode,yr("intersect",e,!1))})}intersectAll(e){return new F({...this.#e,queryNode:Z.cloneWithSetOperations(this.#e.queryNode,yr("intersect",e,!0))})}except(e){return new F({...this.#e,queryNode:Z.cloneWithSetOperations(this.#e.queryNode,yr("except",e,!1))})}exceptAll(e){return new F({...this.#e,queryNode:Z.cloneWithSetOperations(this.#e.queryNode,yr("except",e,!0))})}as(e){return new mf(this,e)}clearSelect(){return new F({...this.#e,queryNode:Z.cloneWithoutSelections(this.#e.queryNode)})}clearWhere(){return new F({...this.#e,queryNode:q.cloneWithoutWhere(this.#e.queryNode)})}clearLimit(){return new F({...this.#e,queryNode:Z.cloneWithoutLimit(this.#e.queryNode)})}clearOffset(){return new F({...this.#e,queryNode:Z.cloneWithoutOffset(this.#e.queryNode)})}clearOrderBy(){return new F({...this.#e,queryNode:q.cloneWithoutOrderBy(this.#e.queryNode)})}clearGroupBy(){return new F({...this.#e,queryNode:Z.cloneWithoutGroupBy(this.#e.queryNode)})}$call(e){return e(this)}$if(e,r){return e?r(this):new F({...this.#e})}$castTo(){return new F(this.#e)}$narrowType(){return new F(this.#e)}$assertType(){return new F(this.#e)}$asTuple(){return new z(this.toOperationNode())}$asScalar(){return new z(this.toOperationNode())}withPlugin(e){return new F({...this.#e,executor:this.#e.executor.withPlugin(e)})}toOperationNode(){return this.#e.executor.transformQuery(this.#e.queryNode,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){const e=this.compile();return(await this.#e.executor.executeQuery(e)).rows}async executeTakeFirst(){const[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=mn){const r=await this.executeTakeFirst();if(r===void 0)throw yn(e)?new e(this.toOperationNode()):e(this.toOperationNode());return r}async*stream(e=100){const r=this.compile(),n=this.#e.executor.stream(r,e);for await(const i of n)yield*i.rows}async explain(e,r){return await new F({...this.#e,queryNode:q.cloneWithExplain(this.#e.queryNode,e,r)}).execute()}}function Ms(t){return new F(t)}class mf{#e;#t;constructor(e,r){this.#e=e,this.#t=r}get expression(){return this.#e}get alias(){return this.#t}get isAliasedSelectQueryBuilder(){return!0}toOperationNode(){return xt.create(this.#e.toOperationNode(),Q.create(this.#t))}}const Ut=o({is(t){return t.kind==="AggregateFunctionNode"},create(t,e=[]){return o({kind:"AggregateFunctionNode",func:t,aggregated:e})},cloneWithDistinct(t){return o({...t,distinct:!0})},cloneWithOrderBy(t,e,r=!1){const n=r?"withinGroup":"orderBy";return o({...t,[n]:t[n]?Cr.cloneWithItems(t[n],e):Cr.create(e)})},cloneWithFilter(t,e){return o({...t,filter:t.filter?_e.cloneWithOperation(t.filter,"And",e):_e.create(e)})},cloneWithOrFilter(t,e){return o({...t,filter:t.filter?_e.cloneWithOperation(t.filter,"Or",e):_e.create(e)})},cloneWithOver(t,e){return o({...t,over:e})}}),va=o({is(t){return t.kind==="FunctionNode"},create(t,e){return o({kind:"FunctionNode",func:t,arguments:e})}});class Be{#e;constructor(e){this.#e=o(e)}get expressionType(){}as(e){return new yf(this,e)}distinct(){return new Be({...this.#e,aggregateFunctionNode:Ut.cloneWithDistinct(this.#e.aggregateFunctionNode)})}orderBy(...e){return new Be({...this.#e,aggregateFunctionNode:q.cloneWithOrderByItems(this.#e.aggregateFunctionNode,ur(e))})}clearOrderBy(){return new Be({...this.#e,aggregateFunctionNode:q.cloneWithoutOrderBy(this.#e.aggregateFunctionNode)})}withinGroupOrderBy(...e){return new Be({...this.#e,aggregateFunctionNode:Ut.cloneWithOrderBy(this.#e.aggregateFunctionNode,ur(e),!0)})}filterWhere(...e){return new Be({...this.#e,aggregateFunctionNode:Ut.cloneWithFilter(this.#e.aggregateFunctionNode,Ae(e))})}filterWhereRef(e,r,n){return new Be({...this.#e,aggregateFunctionNode:Ut.cloneWithFilter(this.#e.aggregateFunctionNode,dt(e,r,n))})}over(e){const r=sf();return new Be({...this.#e,aggregateFunctionNode:Ut.cloneWithOver(this.#e.aggregateFunctionNode,(e?e(r):r).toOperationNode())})}$call(e){return e(this)}$castTo(){return new Be(this.#e)}$notNull(){return new Be(this.#e)}toOperationNode(){return this.#e.aggregateFunctionNode}}class yf{#e;#t;constructor(e,r){this.#e=e,this.#t=r}get expression(){return this.#e}get alias(){return this.#t}toOperationNode(){return xt.create(this.#e.toOperationNode(),Q.create(this.#t))}}function Ec(){const t=(r,n)=>new z(va.create(r,hn(n??[]))),e=(r,n)=>new Be({aggregateFunctionNode:Ut.create(r,n?hn(n):void 0)});return Object.assign(t,{agg:e,avg(r){return e("avg",[r])},coalesce(...r){return t("coalesce",r)},count(r){return e("count",[r])},countAll(r){return new Be({aggregateFunctionNode:Ut.create("count",Ze(r))})},max(r){return e("max",[r])},min(r){return e("min",[r])},sum(r){return e("sum",[r])},any(r){return t("any",[r])},jsonAgg(r){return new Be({aggregateFunctionNode:Ut.create("json_agg",[Oe(r)?pe(r):r.toOperationNode()])})},toJson(r){return new z(va.create("to_json",[Oe(r)?pe(r):r.toOperationNode()]))}})}const wf=o({is(t){return t.kind==="UnaryOperationNode"},create(t,e){return o({kind:"UnaryOperationNode",operator:t,operand:e})}});function Nf(t,e){return wf.create(Jt.create(t),He(e))}const ut=o({is(t){return t.kind==="CaseNode"},create(t){return o({kind:"CaseNode",value:t})},cloneWithWhen(t,e){return o({...t,when:o(t.when?[...t.when,e]:[e])})},cloneWithThen(t,e){return o({...t,when:t.when?o([...t.when.slice(0,-1),cr.cloneWithResult(t.when[t.when.length-1],e)]):void 0})},cloneWith(t,e){return o({...t,...e})}});class Oc{#e;constructor(e){this.#e=o(e)}when(...e){return new Ac({...this.#e,node:ut.cloneWithWhen(this.#e.node,cr.create(Ae(e)))})}}class Ac{#e;constructor(e){this.#e=o(e)}then(e){return new gf({...this.#e,node:ut.cloneWithThen(this.#e.node,uo(e)?co(e):ge(e))})}}class gf{#e;constructor(e){this.#e=o(e)}when(...e){return new Ac({...this.#e,node:ut.cloneWithWhen(this.#e.node,cr.create(Ae(e)))})}else(e){return new bf({...this.#e,node:ut.cloneWith(this.#e.node,{else:uo(e)?co(e):ge(e)})})}end(){return new z(ut.cloneWith(this.#e.node,{isStatement:!1}))}endCase(){return new z(ut.cloneWith(this.#e.node,{isStatement:!0}))}}class bf{#e;constructor(e){this.#e=o(e)}end(){return new z(ut.cloneWith(this.#e.node,{isStatement:!1}))}endCase(){return new z(ut.cloneWith(this.#e.node,{isStatement:!0}))}}const Ea=o({is(t){return t.kind==="JSONPathLegNode"},create(t,e){return o({kind:"JSONPathLegNode",type:t,value:e})}});class js{#e;constructor(e){this.#e=e}at(e){return this.#t("ArrayLocation",e)}key(e){return this.#t("Member",e)}#t(e,r){return Vn.is(this.#e)?new fn(Vn.cloneWithTraversal(this.#e,zr.is(this.#e.traversal)?zr.cloneWithLeg(this.#e.traversal,Ea.create(e,r)):uc.cloneWithValue(this.#e.traversal,Xe.createImmediate(r)))):new fn(zr.cloneWithLeg(this.#e,Ea.create(e,r)))}}class fn extends js{#e;constructor(e){super(e),this.#e=e}get expressionType(){}as(e){return new vf(this,e)}$castTo(){return new fn(this.#e)}$notNull(){return new fn(this.#e)}toOperationNode(){return this.#e}}class vf{#e;#t;constructor(e,r){this.#e=e,this.#t=r}get expression(){return this.#e}get alias(){return this.#t}toOperationNode(){return xt.create(this.#e.toOperationNode(),Le(this.#t)?this.#t.toOperationNode():Q.create(this.#t))}}const Oa=o({is(t){return t.kind==="TupleNode"},create(t){return o({kind:"TupleNode",values:o(t)})}}),Ef=["varchar","char","text","integer","int2","int4","int8","smallint","bigint","boolean","real","double precision","float4","float8","decimal","numeric","binary","bytea","date","datetime","time","timetz","timestamp","timestamptz","serial","bigserial","uuid","json","jsonb","blob","varbinary","int4range","int4multirange","int8range","int8multirange","numrange","nummultirange","tsrange","tsmultirange","tstzrange","tstzmultirange","daterange","datemultirange"],Of=[/^varchar\(\d+\)$/,/^char\(\d+\)$/,/^decimal\(\d+, \d+\)$/,/^numeric\(\d+, \d+\)$/,/^binary\(\d+\)$/,/^datetime\(\d+\)$/,/^time\(\d+\)$/,/^timetz\(\d+\)$/,/^timestamp\(\d+\)$/,/^timestamptz\(\d+\)$/,/^varbinary\(\d+\)$/],Af=o({is(t){return t.kind==="DataTypeNode"},create(t){return o({kind:"DataTypeNode",dataType:t})}});function Tf(t){return!!(Ef.includes(t)||Of.some(e=>e.test(t)))}function dr(t){if(Le(t))return t.toOperationNode();if(Tf(t))return Af.create(t);throw new Error(`invalid column data type ${JSON.stringify(t)}`)}const Sf=o({is(t){return t.kind==="CastNode"},create(t,e){return o({kind:"CastNode",expression:t,dataType:e})}});function mo(t=ci){function e(i,s,u){return new z(lo(i,s,u))}function r(i,s){return new z(Nf(i,s))}const n=Object.assign(e,{fn:void 0,eb:void 0,selectFrom(i){return Ms({queryId:B(),executor:t,queryNode:Z.createFrom(Sr(i))})},case(i){return new Oc({node:ut.create(Et(i)?void 0:He(i))})},ref(i,s){return Et(s)?new z(St(i)):new js(Oh(i,s))},jsonPath(){return new js(zr.create())},table(i){return new z(pe(i))},val(i){return new z(ge(i))},refTuple(...i){return new z(Oa.create(i.map(He)))},tuple(...i){return new z(Oa.create(i.map(ge)))},lit(i){return new z(co(i))},unary:r,not(i){return r("not",i)},exists(i){return r("exists",i)},neg(i){return r("-",i)},between(i,s,u){return new z(kr.create(He(i),Jt.create("between"),Bt.create(ge(s),ge(u))))},betweenSymmetric(i,s,u){return new z(kr.create(He(i),Jt.create("between symmetric"),Bt.create(ge(s),ge(u))))},and(i){return At(i)?new z(Jn(i,"and")):new z(oa(i,"and"))},or(i){return At(i)?new z(Jn(i,"or")):new z(oa(i,"or"))},parens(...i){const s=Ae(i);return gt.is(s)?new z(s):new z(gt.create(s))},cast(i,s){return new z(Sf.create(He(i),dr(s)))},withSchema(i){return mo(t.withPluginAtFront(new Pr(i)))}});return n.fn=Ec(),n.eb=n,n}function $r(t){return mo()}function fr(t){if(Le(t))return t.toOperationNode();if(Ie(t))return t($r()).toOperationNode();throw new Error(`invalid expression: ${JSON.stringify(t)}`)}function Tc(t){if(Le(t))return t.toOperationNode();if(Ie(t))return t($r()).toOperationNode();throw new Error(`invalid aliased expression: ${JSON.stringify(t)}`)}function wn(t){return nc(t)||fh(t)||Ie(t)}class xf{#e;get table(){return this.#e}constructor(e){this.#e=e}as(e){return new Rf(this.#e,e)}}class Rf{#e;#t;get table(){return this.#e}get alias(){return this.#t}constructor(e,r){this.#e=e,this.#t=r}toOperationNode(){return xt.create(pe(this.#e),Q.create(this.#t))}}function If(t){return Ge(t)&&Le(t)&&Oe(t.table)&&Oe(t.alias)}function Sr(t){return At(t)?t.map(e=>pn(e)):[pn(t)]}function pn(t){return Oe(t)?Sc(t):If(t)?t.toOperationNode():Tc(t)}function Sc(t){const e=" as ";if(t.includes(e)){const[r,n]=t.split(e).map(xc);return xt.create(pe(r),Q.create(n))}else return pe(t)}function pe(t){if(t.includes(".")){const[r,n]=t.split(".").map(xc);return Nt.createWithSchema(r,n)}else return Nt.create(t)}function xc(t){return t.trim()}const Rc=o({is(t){return t.kind==="AddColumnNode"},create(t){return o({kind:"AddColumnNode",column:t})}}),ue=o({is(t){return t.kind==="ColumnDefinitionNode"},create(t,e){return o({kind:"ColumnDefinitionNode",column:we.create(t),dataType:e})},cloneWithFrontModifier(t,e){return o({...t,frontModifiers:t.frontModifiers?o([...t.frontModifiers,e]):[e]})},cloneWithEndModifier(t,e){return o({...t,endModifiers:t.endModifiers?o([...t.endModifiers,e]):[e]})},cloneWith(t,e){return o({...t,...e})}}),Ic=o({is(t){return t.kind==="DropColumnNode"},create(t){return o({kind:"DropColumnNode",column:we.create(t)})}}),kc=o({is(t){return t.kind==="RenameColumnNode"},create(t,e){return o({kind:"RenameColumnNode",column:we.create(t),renameTo:we.create(e)})}}),yo=o({is(t){return t.kind==="CheckConstraintNode"},create(t,e){return o({kind:"CheckConstraintNode",expression:t,name:e?Q.create(e):void 0})}}),kf=["no action","restrict","cascade","set null","set default"],_n=o({is(t){return t.kind==="ReferencesNode"},create(t,e){return o({kind:"ReferencesNode",table:t,columns:o([...e])})},cloneWithOnDelete(t,e){return o({...t,onDelete:e})},cloneWithOnUpdate(t,e){return o({...t,onUpdate:e})}});function Cc(t){return Le(t)?t.toOperationNode():Xe.createImmediate(t)}const kn=o({is(t){return t.kind==="GeneratedNode"},create(t){return o({kind:"GeneratedNode",...t})},createWithExpression(t){return o({kind:"GeneratedNode",always:!0,expression:t})},cloneWith(t,e){return o({...t,...e})}}),Cf=o({is(t){return t.kind==="DefaultValueNode"},create(t){return o({kind:"DefaultValueNode",defaultValue:t})}});function Kn(t){if(kf.includes(t))return t;throw new Error(`invalid OnModifyForeignAction ${t}`)}class ne{#e;constructor(e){this.#e=e}autoIncrement(){return new ne(ue.cloneWith(this.#e,{autoIncrement:!0}))}identity(){return new ne(ue.cloneWith(this.#e,{identity:!0}))}primaryKey(){return new ne(ue.cloneWith(this.#e,{primaryKey:!0}))}references(e){const r=St(e);if(!r.table||oo.is(r.column))throw new Error(`invalid call references('${e}'). The reference must have format table.column or schema.table.column`);return new ne(ue.cloneWith(this.#e,{references:_n.create(r.table,[r.column])}))}onDelete(e){if(!this.#e.references)throw new Error("on delete constraint can only be added for foreign keys");return new ne(ue.cloneWith(this.#e,{references:_n.cloneWithOnDelete(this.#e.references,Kn(e))}))}onUpdate(e){if(!this.#e.references)throw new Error("on update constraint can only be added for foreign keys");return new ne(ue.cloneWith(this.#e,{references:_n.cloneWithOnUpdate(this.#e.references,Kn(e))}))}unique(){return new ne(ue.cloneWith(this.#e,{unique:!0}))}notNull(){return new ne(ue.cloneWith(this.#e,{notNull:!0}))}unsigned(){return new ne(ue.cloneWith(this.#e,{unsigned:!0}))}defaultTo(e){return new ne(ue.cloneWith(this.#e,{defaultTo:Cf.create(Cc(e))}))}check(e){return new ne(ue.cloneWith(this.#e,{check:yo.create(e.toOperationNode())}))}generatedAlwaysAs(e){return new ne(ue.cloneWith(this.#e,{generated:kn.createWithExpression(e.toOperationNode())}))}generatedAlwaysAsIdentity(){return new ne(ue.cloneWith(this.#e,{generated:kn.create({identity:!0,always:!0})}))}generatedByDefaultAsIdentity(){return new ne(ue.cloneWith(this.#e,{generated:kn.create({identity:!0,byDefault:!0})}))}stored(){if(!this.#e.generated)throw new Error("stored() can only be called after generatedAlwaysAs");return new ne(ue.cloneWith(this.#e,{generated:kn.cloneWith(this.#e.generated,{stored:!0})}))}modifyFront(e){return new ne(ue.cloneWithFrontModifier(this.#e,e.toOperationNode()))}nullsNotDistinct(){return new ne(ue.cloneWith(this.#e,{nullsNotDistinct:!0}))}ifNotExists(){return new ne(ue.cloneWith(this.#e,{ifNotExists:!0}))}modifyEnd(e){return new ne(ue.cloneWithEndModifier(this.#e,e.toOperationNode()))}$call(e){return e(this)}toOperationNode(){return this.#e}}const Lc=o({is(t){return t.kind==="ModifyColumnNode"},create(t){return o({kind:"ModifyColumnNode",column:t})}}),Lt=o({is(t){return t.kind==="ForeignKeyConstraintNode"},create(t,e,r,n){return o({kind:"ForeignKeyConstraintNode",columns:t,references:_n.create(e,r),name:n?Q.create(n):void 0})},cloneWith(t,e){return o({...t,...e})}});class yt{#e;constructor(e){this.#e=e}onDelete(e){return new yt(Lt.cloneWith(this.#e,{onDelete:Kn(e)}))}onUpdate(e){return new yt(Lt.cloneWith(this.#e,{onUpdate:Kn(e)}))}deferrable(){return new yt(Lt.cloneWith(this.#e,{deferrable:!0}))}notDeferrable(){return new yt(Lt.cloneWith(this.#e,{deferrable:!1}))}initiallyDeferred(){return new yt(Lt.cloneWith(this.#e,{initiallyDeferred:!0}))}initiallyImmediate(){return new yt(Lt.cloneWith(this.#e,{initiallyDeferred:!1}))}$call(e){return e(this)}toOperationNode(){return this.#e}}const Pn=o({is(t){return t.kind==="AddConstraintNode"},create(t){return o({kind:"AddConstraintNode",constraint:t})}}),tr=o({is(t){return t.kind==="UniqueConstraintNode"},create(t,e,r){return o({kind:"UniqueConstraintNode",columns:o(t.map(we.create)),name:e?Q.create(e):void 0,nullsNotDistinct:r})},cloneWith(t,e){return o({...t,...e})}}),$n=o({is(t){return t.kind==="DropConstraintNode"},create(t){return o({kind:"DropConstraintNode",constraintName:Q.create(t)})},cloneWith(t,e){return o({...t,...e})}}),Br=o({is(t){return t.kind==="AlterColumnNode"},create(t,e,r){return o({kind:"AlterColumnNode",column:we.create(t),[e]:r})}});class Dc{#e;constructor(e){this.#e=e}setDataType(e){return new Jr(Br.create(this.#e,"dataType",dr(e)))}setDefault(e){return new Jr(Br.create(this.#e,"setDefault",Cc(e)))}dropDefault(){return new Jr(Br.create(this.#e,"dropDefault",!0))}setNotNull(){return new Jr(Br.create(this.#e,"setNotNull",!0))}dropNotNull(){return new Jr(Br.create(this.#e,"dropNotNull",!0))}$call(e){return e(this)}}class Jr{#e;constructor(e){this.#e=e}toOperationNode(){return this.#e}}class wr{#e;constructor(e){this.#e=o(e)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile())}}class Dt{#e;constructor(e){this.#e=o(e)}onDelete(e){return new Dt({...this.#e,constraintBuilder:this.#e.constraintBuilder.onDelete(e)})}onUpdate(e){return new Dt({...this.#e,constraintBuilder:this.#e.constraintBuilder.onUpdate(e)})}deferrable(){return new Dt({...this.#e,constraintBuilder:this.#e.constraintBuilder.deferrable()})}notDeferrable(){return new Dt({...this.#e,constraintBuilder:this.#e.constraintBuilder.notDeferrable()})}initiallyDeferred(){return new Dt({...this.#e,constraintBuilder:this.#e.constraintBuilder.initiallyDeferred()})}initiallyImmediate(){return new Dt({...this.#e,constraintBuilder:this.#e.constraintBuilder.initiallyImmediate()})}$call(e){return e(this)}toOperationNode(){return this.#e.executor.transformQuery(H.cloneWithTableProps(this.#e.node,{addConstraint:Pn.create(this.#e.constraintBuilder.toOperationNode())}),this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile())}}class xr{#e;constructor(e){this.#e=o(e)}ifExists(){return new xr({...this.#e,node:H.cloneWithTableProps(this.#e.node,{dropConstraint:$n.cloneWith(this.#e.node.dropConstraint,{ifExists:!0})})})}cascade(){return new xr({...this.#e,node:H.cloneWithTableProps(this.#e.node,{dropConstraint:$n.cloneWith(this.#e.node.dropConstraint,{modifier:"cascade"})})})}restrict(){return new xr({...this.#e,node:H.cloneWithTableProps(this.#e.node,{dropConstraint:$n.cloneWith(this.#e.node.dropConstraint,{modifier:"restrict"})})})}$call(e){return e(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile())}}const Ar=o({is(t){return t.kind==="PrimaryKeyConstraintNode"},create(t,e){return o({kind:"PrimaryKeyConstraintNode",columns:o(t.map(we.create)),name:e?Q.create(e):void 0})},cloneWith(t,e){return o({...t,...e})}}),Er=o({is(t){return t.kind==="AddIndexNode"},create(t){return o({kind:"AddIndexNode",name:Q.create(t)})},cloneWith(t,e){return o({...t,...e})},cloneWithColumns(t,e){return o({...t,columns:[...t.columns||[],...e]})}});class rr{#e;constructor(e){this.#e=o(e)}unique(){return new rr({...this.#e,node:H.cloneWithTableProps(this.#e.node,{addIndex:Er.cloneWith(this.#e.node.addIndex,{unique:!0})})})}column(e){return new rr({...this.#e,node:H.cloneWithTableProps(this.#e.node,{addIndex:Er.cloneWithColumns(this.#e.node.addIndex,[Bn(e)])})})}columns(e){return new rr({...this.#e,node:H.cloneWithTableProps(this.#e.node,{addIndex:Er.cloneWithColumns(this.#e.node.addIndex,e.map(Bn))})})}expression(e){return new rr({...this.#e,node:H.cloneWithTableProps(this.#e.node,{addIndex:Er.cloneWithColumns(this.#e.node.addIndex,[e.toOperationNode()])})})}using(e){return new rr({...this.#e,node:H.cloneWithTableProps(this.#e.node,{addIndex:Er.cloneWith(this.#e.node.addIndex,{using:ce.createWithSql(e)})})})}$call(e){return e(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile())}}class Mt{#e;constructor(e){this.#e=e}nullsNotDistinct(){return new Mt(tr.cloneWith(this.#e,{nullsNotDistinct:!0}))}deferrable(){return new Mt(tr.cloneWith(this.#e,{deferrable:!0}))}notDeferrable(){return new Mt(tr.cloneWith(this.#e,{deferrable:!1}))}initiallyDeferred(){return new Mt(tr.cloneWith(this.#e,{initiallyDeferred:!0}))}initiallyImmediate(){return new Mt(tr.cloneWith(this.#e,{initiallyDeferred:!1}))}$call(e){return e(this)}toOperationNode(){return this.#e}}class sr{#e;constructor(e){this.#e=e}deferrable(){return new sr(Ar.cloneWith(this.#e,{deferrable:!0}))}notDeferrable(){return new sr(Ar.cloneWith(this.#e,{deferrable:!1}))}initiallyDeferred(){return new sr(Ar.cloneWith(this.#e,{initiallyDeferred:!0}))}initiallyImmediate(){return new sr(Ar.cloneWith(this.#e,{initiallyDeferred:!1}))}$call(e){return e(this)}toOperationNode(){return this.#e}}class qc{#e;constructor(e){this.#e=e}$call(e){return e(this)}toOperationNode(){return this.#e}}const Lf=o({is(t){return t.kind==="RenameConstraintNode"},create(t,e){return o({kind:"RenameConstraintNode",oldName:Q.create(t),newName:Q.create(e)})}});class Df{#e;constructor(e){this.#e=o(e)}renameTo(e){return new wr({...this.#e,node:H.cloneWithTableProps(this.#e.node,{renameTo:pe(e)})})}setSchema(e){return new wr({...this.#e,node:H.cloneWithTableProps(this.#e.node,{setSchema:Q.create(e)})})}alterColumn(e,r){const n=r(new Dc(e));return new rt({...this.#e,node:H.cloneWithColumnAlteration(this.#e.node,n.toOperationNode())})}dropColumn(e){return new rt({...this.#e,node:H.cloneWithColumnAlteration(this.#e.node,Ic.create(e))})}renameColumn(e,r){return new rt({...this.#e,node:H.cloneWithColumnAlteration(this.#e.node,kc.create(e,r))})}addColumn(e,r,n=Je){const i=n(new ne(ue.create(e,dr(r))));return new rt({...this.#e,node:H.cloneWithColumnAlteration(this.#e.node,Rc.create(i.toOperationNode()))})}modifyColumn(e,r,n=Je){const i=n(new ne(ue.create(e,dr(r))));return new rt({...this.#e,node:H.cloneWithColumnAlteration(this.#e.node,Lc.create(i.toOperationNode()))})}addUniqueConstraint(e,r,n=Je){const i=n(new Mt(tr.create(r,e)));return new wr({...this.#e,node:H.cloneWithTableProps(this.#e.node,{addConstraint:Pn.create(i.toOperationNode())})})}addCheckConstraint(e,r,n=Je){const i=n(new qc(yo.create(r.toOperationNode(),e)));return new wr({...this.#e,node:H.cloneWithTableProps(this.#e.node,{addConstraint:Pn.create(i.toOperationNode())})})}addForeignKeyConstraint(e,r,n,i,s=Je){const u=s(new yt(Lt.create(r.map(we.create),pe(n),i.map(we.create),e)));return new Dt({...this.#e,constraintBuilder:u})}addPrimaryKeyConstraint(e,r,n=Je){const i=n(new sr(Ar.create(r,e)));return new wr({...this.#e,node:H.cloneWithTableProps(this.#e.node,{addConstraint:Pn.create(i.toOperationNode())})})}dropConstraint(e){return new xr({...this.#e,node:H.cloneWithTableProps(this.#e.node,{dropConstraint:$n.create(e)})})}renameConstraint(e,r){return new xr({...this.#e,node:H.cloneWithTableProps(this.#e.node,{renameConstraint:Lf.create(e,r)})})}addIndex(e){return new rr({...this.#e,node:H.cloneWithTableProps(this.#e.node,{addIndex:Er.create(e)})})}dropIndex(e){return new wr({...this.#e,node:H.cloneWithTableProps(this.#e.node,{dropIndex:Yr.create(e)})})}$call(e){return e(this)}}class rt{#e;constructor(e){this.#e=o(e)}alterColumn(e,r){const n=r(new Dc(e));return new rt({...this.#e,node:H.cloneWithColumnAlteration(this.#e.node,n.toOperationNode())})}dropColumn(e){return new rt({...this.#e,node:H.cloneWithColumnAlteration(this.#e.node,Ic.create(e))})}renameColumn(e,r){return new rt({...this.#e,node:H.cloneWithColumnAlteration(this.#e.node,kc.create(e,r))})}addColumn(e,r,n=Je){const i=n(new ne(ue.create(e,dr(r))));return new rt({...this.#e,node:H.cloneWithColumnAlteration(this.#e.node,Rc.create(i.toOperationNode()))})}modifyColumn(e,r,n=Je){const i=n(new ne(ue.create(e,dr(r))));return new rt({...this.#e,node:H.cloneWithColumnAlteration(this.#e.node,Lc.create(i.toOperationNode()))})}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile())}}class _c extends Nc{transformPrimitiveValueList(e){return ui.create(e.values.map(Xe.createImmediate))}transformValue(e){return Xe.createImmediate(e.value)}}class et{#e;constructor(e){this.#e=o(e)}ifNotExists(){return new et({...this.#e,node:ft.cloneWith(this.#e.node,{ifNotExists:!0})})}unique(){return new et({...this.#e,node:ft.cloneWith(this.#e.node,{unique:!0})})}nullsNotDistinct(){return new et({...this.#e,node:ft.cloneWith(this.#e.node,{nullsNotDistinct:!0})})}on(e){return new et({...this.#e,node:ft.cloneWith(this.#e.node,{table:pe(e)})})}column(e){return new et({...this.#e,node:ft.cloneWithColumns(this.#e.node,[Bn(e)])})}columns(e){return new et({...this.#e,node:ft.cloneWithColumns(this.#e.node,e.map(Bn))})}expression(e){return new et({...this.#e,node:ft.cloneWithColumns(this.#e.node,[e.toOperationNode()])})}using(e){return new et({...this.#e,node:ft.cloneWith(this.#e.node,{using:ce.createWithSql(e)})})}where(...e){const r=new _c;return new et({...this.#e,node:q.cloneWithWhere(this.#e.node,r.transformNode(Ae(e),this.#e.queryId))})}$call(e){return e(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile())}}class wo{#e;constructor(e){this.#e=o(e)}ifNotExists(){return new wo({...this.#e,node:rc.cloneWith(this.#e.node,{ifNotExists:!0})})}$call(e){return e(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile())}}function qf(t){if(hh.includes(t))return t;throw new Error(`invalid OnCommitAction ${t}`)}class Fe{#e;constructor(e){this.#e=o(e)}temporary(){return new Fe({...this.#e,node:je.cloneWith(this.#e.node,{temporary:!0})})}onCommit(e){return new Fe({...this.#e,node:je.cloneWith(this.#e.node,{onCommit:qf(e)})})}ifNotExists(){return new Fe({...this.#e,node:je.cloneWith(this.#e.node,{ifNotExists:!0})})}addColumn(e,r,n=Je){const i=n(new ne(ue.create(e,dr(r))));return new Fe({...this.#e,node:je.cloneWithColumn(this.#e.node,i.toOperationNode())})}addPrimaryKeyConstraint(e,r,n=Je){const i=n(new sr(Ar.create(r,e)));return new Fe({...this.#e,node:je.cloneWithConstraint(this.#e.node,i.toOperationNode())})}addUniqueConstraint(e,r,n=Je){const i=n(new Mt(tr.create(r,e)));return new Fe({...this.#e,node:je.cloneWithConstraint(this.#e.node,i.toOperationNode())})}addCheckConstraint(e,r,n=Je){const i=n(new qc(yo.create(r.toOperationNode(),e)));return new Fe({...this.#e,node:je.cloneWithConstraint(this.#e.node,i.toOperationNode())})}addForeignKeyConstraint(e,r,n,i,s=Je){const u=s(new yt(Lt.create(r.map(we.create),pe(n),i.map(we.create),e)));return new Fe({...this.#e,node:je.cloneWithConstraint(this.#e.node,u.toOperationNode())})}modifyFront(e){return new Fe({...this.#e,node:je.cloneWithFrontModifier(this.#e.node,e.toOperationNode())})}modifyEnd(e){return new Fe({...this.#e,node:je.cloneWithEndModifier(this.#e.node,e.toOperationNode())})}as(e){return new Fe({...this.#e,node:je.cloneWith(this.#e.node,{selectQuery:fr(e)})})}$call(e){return e(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile())}}class sn{#e;constructor(e){this.#e=o(e)}on(e){return new sn({...this.#e,node:Yr.cloneWith(this.#e.node,{table:pe(e)})})}ifExists(){return new sn({...this.#e,node:Yr.cloneWith(this.#e.node,{ifExists:!0})})}cascade(){return new sn({...this.#e,node:Yr.cloneWith(this.#e.node,{cascade:!0})})}$call(e){return e(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile())}}class Xn{#e;constructor(e){this.#e=o(e)}ifExists(){return new Xn({...this.#e,node:Ps.cloneWith(this.#e.node,{ifExists:!0})})}cascade(){return new Xn({...this.#e,node:Ps.cloneWith(this.#e.node,{cascade:!0})})}$call(e){return e(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile())}}class Zn{#e;constructor(e){this.#e=o(e)}ifExists(){return new Zn({...this.#e,node:$s.cloneWith(this.#e.node,{ifExists:!0})})}cascade(){return new Zn({...this.#e,node:$s.cloneWith(this.#e.node,{cascade:!0})})}$call(e){return e(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile())}}const qt=o({is(t){return t.kind==="CreateViewNode"},create(t){return o({kind:"CreateViewNode",name:Tt.create(t)})},cloneWith(t,e){return o({...t,...e})}});class _f{#e=new _c;transformQuery(e){return this.#e.transformNode(e.node,e.queryId)}transformResult(e){return Promise.resolve(e.result)}}class _t{#e;constructor(e){this.#e=o(e)}temporary(){return new _t({...this.#e,node:qt.cloneWith(this.#e.node,{temporary:!0})})}materialized(){return new _t({...this.#e,node:qt.cloneWith(this.#e.node,{materialized:!0})})}ifNotExists(){return new _t({...this.#e,node:qt.cloneWith(this.#e.node,{ifNotExists:!0})})}orReplace(){return new _t({...this.#e,node:qt.cloneWith(this.#e.node,{orReplace:!0})})}columns(e){return new _t({...this.#e,node:qt.cloneWith(this.#e.node,{columns:e.map(dc)})})}as(e){const r=e.withPlugin(new _f).toOperationNode();return new _t({...this.#e,node:qt.cloneWith(this.#e.node,{as:r})})}$call(e){return e(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile())}}const Wn=o({is(t){return t.kind==="DropViewNode"},create(t){return o({kind:"DropViewNode",name:Tt.create(t)})},cloneWith(t,e){return o({...t,...e})}});class on{#e;constructor(e){this.#e=o(e)}materialized(){return new on({...this.#e,node:Wn.cloneWith(this.#e.node,{materialized:!0})})}ifExists(){return new on({...this.#e,node:Wn.cloneWith(this.#e.node,{ifExists:!0})})}cascade(){return new on({...this.#e,node:Wn.cloneWith(this.#e.node,{cascade:!0})})}$call(e){return e(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile())}}const Pc=o({is(t){return t.kind==="CreateTypeNode"},create(t){return o({kind:"CreateTypeNode",name:t})},cloneWithEnum(t,e){return o({...t,enum:ui.create(e.map(Xe.createImmediate))})}});class No{#e;constructor(e){this.#e=o(e)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}asEnum(e){return new No({...this.#e,node:Pc.cloneWithEnum(this.#e.node,e)})}$call(e){return e(this)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile())}}const $c=o({is(t){return t.kind==="DropTypeNode"},create(t){return o({kind:"DropTypeNode",name:t})},cloneWith(t,e){return o({...t,...e})}});class go{#e;constructor(e){this.#e=o(e)}ifExists(){return new go({...this.#e,node:$c.cloneWith(this.#e.node,{ifExists:!0})})}$call(e){return e(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile())}}function Aa(t){if(t.includes(".")){const r=t.split(".").map(Pf);if(r.length===2)return Tt.createWithSchema(r[0],r[1]);throw new Error(`invalid schemable identifier ${t}`)}else return Tt.create(t)}function Pf(t){return t.trim()}const Un=o({is(t){return t.kind==="RefreshMaterializedViewNode"},create(t){return o({kind:"RefreshMaterializedViewNode",name:Tt.create(t)})},cloneWith(t,e){return o({...t,...e})}});class an{#e;constructor(e){this.#e=o(e)}concurrently(){return new an({...this.#e,node:Un.cloneWith(this.#e.node,{concurrently:!0,withNoData:!1})})}withData(){return new an({...this.#e,node:Un.cloneWith(this.#e.node,{withNoData:!1})})}withNoData(){return new an({...this.#e,node:Un.cloneWith(this.#e.node,{withNoData:!0,concurrently:!1})})}$call(e){return e(this)}toOperationNode(){return this.#e.executor.transformQuery(this.#e.node,this.#e.queryId)}compile(){return this.#e.executor.compileQuery(this.toOperationNode(),this.#e.queryId)}async execute(){await this.#e.executor.executeQuery(this.compile())}}class un{#e;constructor(e){this.#e=e}createTable(e){return new Fe({queryId:B(),executor:this.#e,node:je.create(pe(e))})}dropTable(e){return new Zn({queryId:B(),executor:this.#e,node:$s.create(pe(e))})}createIndex(e){return new et({queryId:B(),executor:this.#e,node:ft.create(e)})}dropIndex(e){return new sn({queryId:B(),executor:this.#e,node:Yr.create(e)})}createSchema(e){return new wo({queryId:B(),executor:this.#e,node:rc.create(e)})}dropSchema(e){return new Xn({queryId:B(),executor:this.#e,node:Ps.create(e)})}alterTable(e){return new Df({queryId:B(),executor:this.#e,node:H.create(pe(e))})}createView(e){return new _t({queryId:B(),executor:this.#e,node:qt.create(e)})}refreshMaterializedView(e){return new an({queryId:B(),executor:this.#e,node:Un.create(e)})}dropView(e){return new on({queryId:B(),executor:this.#e,node:Wn.create(e)})}createType(e){return new No({queryId:B(),executor:this.#e,node:Pc.create(Aa(e))})}dropType(e){return new go({queryId:B(),executor:this.#e,node:$c.create(Aa(e))})}withPlugin(e){return new un(this.#e.withPlugin(e))}withoutPlugins(){return new un(this.#e.withoutPlugins())}withSchema(e){return new un(this.#e.withPluginAtFront(new Pr(e)))}}class $f{ref(e){return new bh(e)}table(e){return new xf(e)}}class Wf{#e;constructor(e){this.#e=e}async provideConnection(e){const r=await this.#e.acquireConnection();try{return await e(r)}finally{await this.#e.releaseConnection(r)}}}class nr extends bc{#e;#t;#r;constructor(e,r,n,i=[]){super(i),this.#e=e,this.#t=r,this.#r=n}get adapter(){return this.#t}compileQuery(e,r){return this.#e.compileQuery(e,r)}provideConnection(e){return this.#r.provideConnection(e)}withPlugins(e){return new nr(this.#e,this.#t,this.#r,[...this.plugins,...e])}withPlugin(e){return new nr(this.#e,this.#t,this.#r,[...this.plugins,e])}withPluginAtFront(e){return new nr(this.#e,this.#t,this.#r,[e,...this.plugins])}withConnectionProvider(e){return new nr(this.#e,this.#t,e,[...this.plugins])}withoutPlugins(){return new nr(this.#e,this.#t,this.#r,[])}}function xi(){return typeof performance<"u"&&Ie(performance.now)?performance.now():Date.now()}class Uf{#e;#t;#r;#n;#i;#o=new WeakSet;constructor(e,r){this.#n=!1,this.#e=e,this.#t=r}async init(){if(this.#i)throw new Error("driver has already been destroyed");this.#r||(this.#r=this.#e.init().then(()=>{this.#n=!0}).catch(e=>(this.#r=void 0,Promise.reject(e)))),await this.#r}async acquireConnection(){if(this.#i)throw new Error("driver has already been destroyed");this.#n||await this.init();const e=await this.#e.acquireConnection();return this.#o.has(e)||(this.#u()&&this.#s(e),this.#o.add(e)),e}async releaseConnection(e){await this.#e.releaseConnection(e)}beginTransaction(e,r){return this.#e.beginTransaction(e,r)}commitTransaction(e){return this.#e.commitTransaction(e)}rollbackTransaction(e){return this.#e.rollbackTransaction(e)}savepoint(e,r,n){if(this.#e.savepoint)return this.#e.savepoint(e,r,n);throw new Error("The `savepoint` method is not supported by this driver")}rollbackToSavepoint(e,r,n){if(this.#e.rollbackToSavepoint)return this.#e.rollbackToSavepoint(e,r,n);throw new Error("The `rollbackToSavepoint` method is not supported by this driver")}releaseSavepoint(e,r,n){if(this.#e.releaseSavepoint)return this.#e.releaseSavepoint(e,r,n);throw new Error("The `releaseSavepoint` method is not supported by this driver")}async destroy(){this.#r&&(await this.#r,this.#i||(this.#i=this.#e.destroy().catch(e=>(this.#i=void 0,Promise.reject(e)))),await this.#i)}#u(){return this.#t.isLevelEnabled("query")||this.#t.isLevelEnabled("error")}#s(e){const r=e.executeQuery,n=e.streamQuery,i=this;e.executeQuery=async s=>{let u;const d=xi();try{return await r.call(e,s)}catch(c){throw u=c,await i.#a(c,s,d),c}finally{u||await i.#c(s,d)}},e.streamQuery=async function*(s,u){let d;const c=xi();try{for await(const h of n.call(e,s,u))yield h}catch(h){throw d=h,await i.#a(h,s,c),h}finally{d||await i.#c(s,c,!0)}}}async#a(e,r,n){await this.#t.error(()=>({level:"error",error:e,query:r,queryDurationMillis:this.#d(n)}))}async#c(e,r,n=!1){await this.#t.query(()=>({level:"query",isStream:n,query:e,queryDurationMillis:this.#d(r)}))}#d(e){return xi()-e}}const Mf=()=>{};class bo{#e;#t;constructor(e){this.#e=e}async provideConnection(e){for(;this.#t;)await this.#t.catch(Mf);return this.#t=this.#r(e).finally(()=>{this.#t=void 0}),this.#t}async#r(e){return await e(this.#e)}}const jf=["read only","read write"],Ff=["read uncommitted","read committed","repeatable read","serializable","snapshot"];function Wc(t){if(t.accessMode&&!jf.includes(t.accessMode))throw new Error(`invalid transaction access mode ${t.accessMode}`);if(t.isolationLevel&&!Ff.includes(t.isolationLevel))throw new Error(`invalid transaction isolation level ${t.isolationLevel}`)}o(["query","error"]);class Vf{#e;#t;constructor(e){Ie(e)?(this.#t=e,this.#e=o({query:!0,error:!0})):(this.#t=Bf,this.#e=o({query:e.includes("query"),error:e.includes("error")}))}isLevelEnabled(e){return this.#e[e]}async query(e){this.#e.query&&await this.#t(e())}async error(e){this.#e.error&&await this.#t(e())}}function Bf(t){if(t.level==="query"){const e=`kysely:query:${t.isStream?"stream:":""}`;console.log(`${e} ${t.query.sql}`),console.log(`${e} duration: ${t.queryDurationMillis.toFixed(1)}ms`)}else t.level==="error"&&(t.error instanceof Error?console.error(`kysely:error: ${t.error.stack??t.error.message}`):console.error(`kysely:error: ${JSON.stringify({error:t.error,query:t.query.sql,queryDurationMillis:t.queryDurationMillis})}`))}function Jf(t){return Ge(t)&&Ie(t.compile)}Symbol.asyncDispose??=Symbol("Symbol.asyncDispose");class bt extends Wt{#e;constructor(e){let r,n;if(Gf(e))r={executor:e.executor},n={...e};else{const i=e.dialect,s=i.createDriver(),u=i.createQueryCompiler(),d=i.createAdapter(),c=new Vf(e.log??[]),h=new Uf(s,c),l=new Wf(h),y=new nr(u,d,l,e.plugins??[]);r={executor:y},n={config:e,executor:y,dialect:i,driver:h}}super(r),this.#e=o(n)}get schema(){return new un(this.#e.executor)}get dynamic(){return new $f}get introspection(){return this.#e.dialect.createIntrospector(this.withoutPlugins())}case(e){return new Oc({node:ut.create(Et(e)?void 0:fr(e))})}get fn(){return Ec()}transaction(){return new ei({...this.#e})}startTransaction(){return new ti({...this.#e})}connection(){return new Hf({...this.#e})}withPlugin(e){return new bt({...this.#e,executor:this.#e.executor.withPlugin(e)})}withoutPlugins(){return new bt({...this.#e,executor:this.#e.executor.withoutPlugins()})}withSchema(e){return new bt({...this.#e,executor:this.#e.executor.withPluginAtFront(new Pr(e))})}withTables(){return new bt({...this.#e})}async destroy(){await this.#e.driver.destroy()}get isTransaction(){return!1}getExecutor(){return this.#e.executor}executeQuery(e,r){r!==void 0&&qr("Passing `queryId` in `db.executeQuery` is deprecated and will result in a compile-time error in the future.");const n=Jf(e)?e.compile():e;return this.getExecutor().executeQuery(n)}async[Symbol.asyncDispose](){await this.destroy()}}class or extends bt{#e;constructor(e){super(e),this.#e=e}get isTransaction(){return!0}transaction(){throw new Error("calling the transaction method for a Transaction is not supported")}connection(){throw new Error("calling the connection method for a Transaction is not supported")}async destroy(){throw new Error("calling the destroy method for a Transaction is not supported")}withPlugin(e){return new or({...this.#e,executor:this.#e.executor.withPlugin(e)})}withoutPlugins(){return new or({...this.#e,executor:this.#e.executor.withoutPlugins()})}withSchema(e){return new or({...this.#e,executor:this.#e.executor.withPluginAtFront(new Pr(e))})}withTables(){return new or({...this.#e})}}function Gf(t){return Ge(t)&&Ge(t.config)&&Ge(t.driver)&&Ge(t.executor)&&Ge(t.dialect)}class Hf{#e;constructor(e){this.#e=o(e)}async execute(e){return this.#e.executor.provideConnection(async r=>{const n=this.#e.executor.withConnectionProvider(new bo(r)),i=new bt({...this.#e,executor:n});return await e(i)})}}class ei{#e;constructor(e){this.#e=o(e)}setAccessMode(e){return new ei({...this.#e,accessMode:e})}setIsolationLevel(e){return new ei({...this.#e,isolationLevel:e})}async execute(e){const{isolationLevel:r,accessMode:n,...i}=this.#e,s={isolationLevel:r,accessMode:n};return Wc(s),this.#e.executor.provideConnection(async u=>{const d=this.#e.executor.withConnectionProvider(new bo(u)),c=new or({...i,executor:d});let h=!1;try{await this.#e.driver.beginTransaction(u,s),h=!0;const l=await e(c);return await this.#e.driver.commitTransaction(u),l}catch(l){throw h&&await this.#e.driver.rollbackTransaction(u),l}})}}class ti{#e;constructor(e){this.#e=o(e)}setAccessMode(e){return new ti({...this.#e,accessMode:e})}setIsolationLevel(e){return new ti({...this.#e,isolationLevel:e})}async execute(){const{isolationLevel:e,accessMode:r,...n}=this.#e,i={isolationLevel:e,accessMode:r};Wc(i);const s=await gc(this.#e.executor);return await this.#e.driver.beginTransaction(s.connection,i),new mt({...n,connection:s,executor:this.#e.executor.withConnectionProvider(new bo(s.connection))})}}class mt extends or{#e;#t;#r;constructor(e){const r={isCommitted:!1,isRolledBack:!1};e={...e,executor:new Pt(e.executor,r)};const{connection:n,...i}=e;super(i),this.#e=o(e),this.#r=r;const s=B();this.#t=u=>e.executor.compileQuery(u,s)}get isCommitted(){return this.#r.isCommitted}get isRolledBack(){return this.#r.isRolledBack}commit(){return ir(this.#r),new Gr(async()=>{await this.#e.driver.commitTransaction(this.#e.connection.connection),this.#r.isCommitted=!0,this.#e.connection.release()})}rollback(){return ir(this.#r),new Gr(async()=>{await this.#e.driver.rollbackTransaction(this.#e.connection.connection),this.#r.isRolledBack=!0,this.#e.connection.release()})}savepoint(e){return ir(this.#r),new Gr(async()=>(await this.#e.driver.savepoint?.(this.#e.connection.connection,e,this.#t),new mt({...this.#e})))}rollbackToSavepoint(e){return ir(this.#r),new Gr(async()=>(await this.#e.driver.rollbackToSavepoint?.(this.#e.connection.connection,e,this.#t),new mt({...this.#e})))}releaseSavepoint(e){return ir(this.#r),new Gr(async()=>(await this.#e.driver.releaseSavepoint?.(this.#e.connection.connection,e,this.#t),new mt({...this.#e})))}withPlugin(e){return new mt({...this.#e,executor:this.#e.executor.withPlugin(e)})}withoutPlugins(){return new mt({...this.#e,executor:this.#e.executor.withoutPlugins()})}withSchema(e){return new mt({...this.#e,executor:this.#e.executor.withPluginAtFront(new Pr(e))})}withTables(){return new mt({...this.#e})}}class Gr{#e;constructor(e){this.#e=e}async execute(){return await this.#e()}}function ir(t){if(t.isCommitted)throw new Error("Transaction is already committed");if(t.isRolledBack)throw new Error("Transaction is already rolled back")}class Pt{#e;#t;constructor(e,r){e instanceof Pt?this.#e=e.#e:this.#e=e,this.#t=r}get adapter(){return this.#e.adapter}get plugins(){return this.#e.plugins}transformQuery(e,r){return this.#e.transformQuery(e,r)}compileQuery(e,r){return this.#e.compileQuery(e,r)}provideConnection(e){return this.#e.provideConnection(e)}executeQuery(e){return ir(this.#t),this.#e.executeQuery(e)}stream(e,r){return ir(this.#t),this.#e.stream(e,r)}withConnectionProvider(e){return new Pt(this.#e.withConnectionProvider(e),this.#t)}withPlugin(e){return new Pt(this.#e.withPlugin(e),this.#t)}withPlugins(e){return new Pt(this.#e.withPlugins(e),this.#t)}withPluginAtFront(e){return new Pt(this.#e.withPluginAtFront(e),this.#t)}withoutPlugins(){return new Pt(this.#e.withoutPlugins(),this.#t)}}class cn{#e;constructor(e){this.#e=o(e)}get expressionType(){}get isRawBuilder(){return!0}as(e){return new Qf(this,e)}$castTo(){return new cn({...this.#e})}$notNull(){return new cn(this.#e)}withPlugin(e){return new cn({...this.#e,plugins:this.#e.plugins!==void 0?o([...this.#e.plugins,e]):o([e])})}toOperationNode(){return this.#r(this.#t())}compile(e){return this.#n(this.#t(e))}async execute(e){const r=this.#t(e);return r.executeQuery(this.#n(r))}#t(e){const r=e!==void 0?e.getExecutor():ci;return this.#e.plugins!==void 0?r.withPlugins(this.#e.plugins):r}#r(e){return e.transformQuery(this.#e.rawNode,this.#e.queryId)}#n(e){return e.compileQuery(this.#r(e),this.#e.queryId)}}function Rt(t){return new cn(t)}class Qf{#e;#t;constructor(e,r){this.#e=e,this.#t=r}get expression(){return this.#e}get alias(){return this.#t}get rawBuilder(){return this.#e}toOperationNode(){return xt.create(this.#e.toOperationNode(),Le(this.#t)?this.#t.toOperationNode():Q.create(this.#t))}}const te=Object.assign((t,...e)=>Rt({queryId:B(),rawNode:ce.create(t,e?.map(Ta)??[])}),{ref(t){return Rt({queryId:B(),rawNode:ce.createWithChild(St(t))})},val(t){return Rt({queryId:B(),rawNode:ce.createWithChild(ge(t))})},value(t){return this.val(t)},table(t){return Rt({queryId:B(),rawNode:ce.createWithChild(pe(t))})},id(...t){const e=new Array(t.length+1).fill(".");return e[0]="",e[e.length-1]="",Rt({queryId:B(),rawNode:ce.create(e,t.map(Q.create))})},lit(t){return Rt({queryId:B(),rawNode:ce.createWithChild(Xe.createImmediate(t))})},literal(t){return this.lit(t)},raw(t){return Rt({queryId:B(),rawNode:ce.createWithSql(t)})},join(t,e=te`, `){const r=new Array(Math.max(2*t.length-1,0)),n=e.toOperationNode();for(let i=0;i<t.length;++i)r[2*i]=Ta(t[i]),i!==t.length-1&&(r[2*i+1]=n);return Rt({queryId:B(),rawNode:ce.createWithChildren(r)})}});function Ta(t){return Le(t)?t.toOperationNode():ge(t)}class Yf{nodeStack=[];get parentNode(){return this.nodeStack[this.nodeStack.length-2]}#e=o({AliasNode:this.visitAlias.bind(this),ColumnNode:this.visitColumn.bind(this),IdentifierNode:this.visitIdentifier.bind(this),SchemableIdentifierNode:this.visitSchemableIdentifier.bind(this),RawNode:this.visitRaw.bind(this),ReferenceNode:this.visitReference.bind(this),SelectQueryNode:this.visitSelectQuery.bind(this),SelectionNode:this.visitSelection.bind(this),TableNode:this.visitTable.bind(this),FromNode:this.visitFrom.bind(this),SelectAllNode:this.visitSelectAll.bind(this),AndNode:this.visitAnd.bind(this),OrNode:this.visitOr.bind(this),ValueNode:this.visitValue.bind(this),ValueListNode:this.visitValueList.bind(this),PrimitiveValueListNode:this.visitPrimitiveValueList.bind(this),ParensNode:this.visitParens.bind(this),JoinNode:this.visitJoin.bind(this),OperatorNode:this.visitOperator.bind(this),WhereNode:this.visitWhere.bind(this),InsertQueryNode:this.visitInsertQuery.bind(this),DeleteQueryNode:this.visitDeleteQuery.bind(this),ReturningNode:this.visitReturning.bind(this),CreateTableNode:this.visitCreateTable.bind(this),AddColumnNode:this.visitAddColumn.bind(this),ColumnDefinitionNode:this.visitColumnDefinition.bind(this),DropTableNode:this.visitDropTable.bind(this),DataTypeNode:this.visitDataType.bind(this),OrderByNode:this.visitOrderBy.bind(this),OrderByItemNode:this.visitOrderByItem.bind(this),GroupByNode:this.visitGroupBy.bind(this),GroupByItemNode:this.visitGroupByItem.bind(this),UpdateQueryNode:this.visitUpdateQuery.bind(this),ColumnUpdateNode:this.visitColumnUpdate.bind(this),LimitNode:this.visitLimit.bind(this),OffsetNode:this.visitOffset.bind(this),OnConflictNode:this.visitOnConflict.bind(this),OnDuplicateKeyNode:this.visitOnDuplicateKey.bind(this),CreateIndexNode:this.visitCreateIndex.bind(this),DropIndexNode:this.visitDropIndex.bind(this),ListNode:this.visitList.bind(this),PrimaryKeyConstraintNode:this.visitPrimaryKeyConstraint.bind(this),UniqueConstraintNode:this.visitUniqueConstraint.bind(this),ReferencesNode:this.visitReferences.bind(this),CheckConstraintNode:this.visitCheckConstraint.bind(this),WithNode:this.visitWith.bind(this),CommonTableExpressionNode:this.visitCommonTableExpression.bind(this),CommonTableExpressionNameNode:this.visitCommonTableExpressionName.bind(this),HavingNode:this.visitHaving.bind(this),CreateSchemaNode:this.visitCreateSchema.bind(this),DropSchemaNode:this.visitDropSchema.bind(this),AlterTableNode:this.visitAlterTable.bind(this),DropColumnNode:this.visitDropColumn.bind(this),RenameColumnNode:this.visitRenameColumn.bind(this),AlterColumnNode:this.visitAlterColumn.bind(this),ModifyColumnNode:this.visitModifyColumn.bind(this),AddConstraintNode:this.visitAddConstraint.bind(this),DropConstraintNode:this.visitDropConstraint.bind(this),RenameConstraintNode:this.visitRenameConstraint.bind(this),ForeignKeyConstraintNode:this.visitForeignKeyConstraint.bind(this),CreateViewNode:this.visitCreateView.bind(this),RefreshMaterializedViewNode:this.visitRefreshMaterializedView.bind(this),DropViewNode:this.visitDropView.bind(this),GeneratedNode:this.visitGenerated.bind(this),DefaultValueNode:this.visitDefaultValue.bind(this),OnNode:this.visitOn.bind(this),ValuesNode:this.visitValues.bind(this),SelectModifierNode:this.visitSelectModifier.bind(this),CreateTypeNode:this.visitCreateType.bind(this),DropTypeNode:this.visitDropType.bind(this),ExplainNode:this.visitExplain.bind(this),DefaultInsertValueNode:this.visitDefaultInsertValue.bind(this),AggregateFunctionNode:this.visitAggregateFunction.bind(this),OverNode:this.visitOver.bind(this),PartitionByNode:this.visitPartitionBy.bind(this),PartitionByItemNode:this.visitPartitionByItem.bind(this),SetOperationNode:this.visitSetOperation.bind(this),BinaryOperationNode:this.visitBinaryOperation.bind(this),UnaryOperationNode:this.visitUnaryOperation.bind(this),UsingNode:this.visitUsing.bind(this),FunctionNode:this.visitFunction.bind(this),CaseNode:this.visitCase.bind(this),WhenNode:this.visitWhen.bind(this),JSONReferenceNode:this.visitJSONReference.bind(this),JSONPathNode:this.visitJSONPath.bind(this),JSONPathLegNode:this.visitJSONPathLeg.bind(this),JSONOperatorChainNode:this.visitJSONOperatorChain.bind(this),TupleNode:this.visitTuple.bind(this),MergeQueryNode:this.visitMergeQuery.bind(this),MatchedNode:this.visitMatched.bind(this),AddIndexNode:this.visitAddIndex.bind(this),CastNode:this.visitCast.bind(this),FetchNode:this.visitFetch.bind(this),TopNode:this.visitTop.bind(this),OutputNode:this.visitOutput.bind(this),OrActionNode:this.visitOrAction.bind(this),CollateNode:this.visitCollate.bind(this)});visitNode=e=>{this.nodeStack.push(e),this.#e[e.kind](e),this.nodeStack.pop()}}const zf=/'/g;class li extends Yf{#e="";#t=[];get numParameters(){return this.#t.length}compileQuery(e,r){return this.#e="",this.#t=[],this.nodeStack.splice(0,this.nodeStack.length),this.visitNode(e),o({query:e,queryId:r,sql:this.getSql(),parameters:[...this.#t]})}getSql(){return this.#e}visitSelectQuery(e){const r=this.parentNode!==void 0&&!gt.is(this.parentNode)&&!ve.is(this.parentNode)&&!je.is(this.parentNode)&&!qt.is(this.parentNode)&&!vc.is(this.parentNode);this.parentNode===void 0&&e.explain&&(this.visitNode(e.explain),this.append(" ")),r&&this.append("("),e.with&&(this.visitNode(e.with),this.append(" ")),this.append("select"),e.distinctOn&&(this.append(" "),this.compileDistinctOn(e.distinctOn)),e.frontModifiers?.length&&(this.append(" "),this.compileList(e.frontModifiers," ")),e.top&&(this.append(" "),this.visitNode(e.top)),e.selections&&(this.append(" "),this.compileList(e.selections)),e.from&&(this.append(" "),this.visitNode(e.from)),e.joins&&(this.append(" "),this.compileList(e.joins," ")),e.where&&(this.append(" "),this.visitNode(e.where)),e.groupBy&&(this.append(" "),this.visitNode(e.groupBy)),e.having&&(this.append(" "),this.visitNode(e.having)),e.setOperations&&(this.append(" "),this.compileList(e.setOperations," ")),e.orderBy&&(this.append(" "),this.visitNode(e.orderBy)),e.limit&&(this.append(" "),this.visitNode(e.limit)),e.offset&&(this.append(" "),this.visitNode(e.offset)),e.fetch&&(this.append(" "),this.visitNode(e.fetch)),e.endModifiers?.length&&(this.append(" "),this.compileList(this.sortSelectModifiers([...e.endModifiers])," ")),r&&this.append(")")}visitFrom(e){this.append("from "),this.compileList(e.froms)}visitSelection(e){this.visitNode(e.selection)}visitColumn(e){this.visitNode(e.column)}compileDistinctOn(e){this.append("distinct on ("),this.compileList(e),this.append(")")}compileList(e,r=", "){const n=e.length-1;for(let i=0;i<=n;i++)this.visitNode(e[i]),i<n&&this.append(r)}visitWhere(e){this.append("where "),this.visitNode(e.where)}visitHaving(e){this.append("having "),this.visitNode(e.having)}visitInsertQuery(e){const r=this.parentNode!==void 0&&!gt.is(this.parentNode)&&!ce.is(this.parentNode)&&!cr.is(this.parentNode);this.parentNode===void 0&&e.explain&&(this.visitNode(e.explain),this.append(" ")),r&&this.append("("),e.with&&(this.visitNode(e.with),this.append(" ")),this.append(e.replace?"replace":"insert"),e.ignore&&(qr("`InsertQueryNode.ignore` is deprecated. Use `InsertQueryNode.orAction` instead."),this.append(" ignore")),e.orAction&&(this.append(" "),this.visitNode(e.orAction)),e.top&&(this.append(" "),this.visitNode(e.top)),e.into&&(this.append(" into "),this.visitNode(e.into)),e.columns&&(this.append(" ("),this.compileList(e.columns),this.append(")")),e.output&&(this.append(" "),this.visitNode(e.output)),e.values&&(this.append(" "),this.visitNode(e.values)),e.defaultValues&&(this.append(" "),this.append("default values")),e.onConflict&&(this.append(" "),this.visitNode(e.onConflict)),e.onDuplicateKey&&(this.append(" "),this.visitNode(e.onDuplicateKey)),e.returning&&(this.append(" "),this.visitNode(e.returning)),r&&this.append(")"),e.endModifiers?.length&&(this.append(" "),this.compileList(e.endModifiers," "))}visitValues(e){this.append("values "),this.compileList(e.values)}visitDeleteQuery(e){const r=this.parentNode!==void 0&&!gt.is(this.parentNode)&&!ce.is(this.parentNode);this.parentNode===void 0&&e.explain&&(this.visitNode(e.explain),this.append(" ")),r&&this.append("("),e.with&&(this.visitNode(e.with),this.append(" ")),this.append("delete "),e.top&&(this.visitNode(e.top),this.append(" ")),this.visitNode(e.from),e.output&&(this.append(" "),this.visitNode(e.output)),e.using&&(this.append(" "),this.visitNode(e.using)),e.joins&&(this.append(" "),this.compileList(e.joins," ")),e.where&&(this.append(" "),this.visitNode(e.where)),e.orderBy&&(this.append(" "),this.visitNode(e.orderBy)),e.limit&&(this.append(" "),this.visitNode(e.limit)),e.returning&&(this.append(" "),this.visitNode(e.returning)),r&&this.append(")"),e.endModifiers?.length&&(this.append(" "),this.compileList(e.endModifiers," "))}visitReturning(e){this.append("returning "),this.compileList(e.selections)}visitAlias(e){this.visitNode(e.node),this.append(" as "),this.visitNode(e.alias)}visitReference(e){e.table&&(this.visitNode(e.table),this.append(".")),this.visitNode(e.column)}visitSelectAll(e){this.append("*")}visitIdentifier(e){this.append(this.getLeftIdentifierWrapper()),this.compileUnwrappedIdentifier(e),this.append(this.getRightIdentifierWrapper())}compileUnwrappedIdentifier(e){if(!Oe(e.name))throw new Error("a non-string identifier was passed to compileUnwrappedIdentifier.");this.append(this.sanitizeIdentifier(e.name))}visitAnd(e){this.visitNode(e.left),this.append(" and "),this.visitNode(e.right)}visitOr(e){this.visitNode(e.left),this.append(" or "),this.visitNode(e.right)}visitValue(e){e.immediate?this.appendImmediateValue(e.value):this.appendValue(e.value)}visitValueList(e){this.append("("),this.compileList(e.values),this.append(")")}visitTuple(e){this.append("("),this.compileList(e.values),this.append(")")}visitPrimitiveValueList(e){this.append("(");const{values:r}=e;for(let n=0;n<r.length;++n)this.appendValue(r[n]),n!==r.length-1&&this.append(", ");this.append(")")}visitParens(e){this.append("("),this.visitNode(e.node),this.append(")")}visitJoin(e){this.append(Xf[e.joinType]),this.append(" "),this.visitNode(e.table),e.on&&(this.append(" "),this.visitNode(e.on))}visitOn(e){this.append("on "),this.visitNode(e.on)}visitRaw(e){const{sqlFragments:r,parameters:n}=e;for(let i=0;i<r.length;++i)this.append(r[i]),n.length>i&&this.visitNode(n[i])}visitOperator(e){this.append(e.operator)}visitTable(e){this.visitNode(e.table)}visitSchemableIdentifier(e){e.schema&&(this.visitNode(e.schema),this.append(".")),this.visitNode(e.identifier)}visitCreateTable(e){this.append("create "),e.frontModifiers&&e.frontModifiers.length>0&&(this.compileList(e.frontModifiers," "),this.append(" ")),e.temporary&&this.append("temporary "),this.append("table "),e.ifNotExists&&this.append("if not exists "),this.visitNode(e.table),e.selectQuery?(this.append(" as "),this.visitNode(e.selectQuery)):(this.append(" ("),this.compileList([...e.columns,...e.constraints??[]]),this.append(")"),e.onCommit&&(this.append(" on commit "),this.append(e.onCommit)),e.endModifiers&&e.endModifiers.length>0&&(this.append(" "),this.compileList(e.endModifiers," ")))}visitColumnDefinition(e){e.ifNotExists&&this.append("if not exists "),this.visitNode(e.column),this.append(" "),this.visitNode(e.dataType),e.unsigned&&this.append(" unsigned"),e.frontModifiers&&e.frontModifiers.length>0&&(this.append(" "),this.compileList(e.frontModifiers," ")),e.generated&&(this.append(" "),this.visitNode(e.generated)),e.identity&&this.append(" identity"),e.defaultTo&&(this.append(" "),this.visitNode(e.defaultTo)),e.notNull&&this.append(" not null"),e.unique&&this.append(" unique"),e.nullsNotDistinct&&this.append(" nulls not distinct"),e.primaryKey&&this.append(" primary key"),e.autoIncrement&&(this.append(" "),this.append(this.getAutoIncrement())),e.references&&(this.append(" "),this.visitNode(e.references)),e.check&&(this.append(" "),this.visitNode(e.check)),e.endModifiers&&e.endModifiers.length>0&&(this.append(" "),this.compileList(e.endModifiers," "))}getAutoIncrement(){return"auto_increment"}visitReferences(e){this.append("references "),this.visitNode(e.table),this.append(" ("),this.compileList(e.columns),this.append(")"),e.onDelete&&(this.append(" on delete "),this.append(e.onDelete)),e.onUpdate&&(this.append(" on update "),this.append(e.onUpdate))}visitDropTable(e){this.append("drop table "),e.ifExists&&this.append("if exists "),this.visitNode(e.table),e.cascade&&this.append(" cascade")}visitDataType(e){this.append(e.dataType)}visitOrderBy(e){this.append("order by "),this.compileList(e.items)}visitOrderByItem(e){this.visitNode(e.orderBy),e.collation&&(this.append(" "),this.visitNode(e.collation)),e.direction&&(this.append(" "),this.visitNode(e.direction)),e.nulls&&(this.append(" nulls "),this.append(e.nulls))}visitGroupBy(e){this.append("group by "),this.compileList(e.items)}visitGroupByItem(e){this.visitNode(e.groupBy)}visitUpdateQuery(e){const r=this.parentNode!==void 0&&!gt.is(this.parentNode)&&!ce.is(this.parentNode)&&!cr.is(this.parentNode);if(this.parentNode===void 0&&e.explain&&(this.visitNode(e.explain),this.append(" ")),r&&this.append("("),e.with&&(this.visitNode(e.with),this.append(" ")),this.append("update "),e.top&&(this.visitNode(e.top),this.append(" ")),e.table&&(this.visitNode(e.table),this.append(" ")),this.append("set "),e.updates&&this.compileList(e.updates),e.output&&(this.append(" "),this.visitNode(e.output)),e.from&&(this.append(" "),this.visitNode(e.from)),e.joins){if(!e.from)throw new Error("Joins in an update query are only supported as a part of a PostgreSQL 'update set from join' query. If you want to create a MySQL 'update join set' query, see https://kysely.dev/docs/examples/update/my-sql-joins");this.append(" "),this.compileList(e.joins," ")}e.where&&(this.append(" "),this.visitNode(e.where)),e.orderBy&&(this.append(" "),this.visitNode(e.orderBy)),e.limit&&(this.append(" "),this.visitNode(e.limit)),e.returning&&(this.append(" "),this.visitNode(e.returning)),r&&this.append(")"),e.endModifiers?.length&&(this.append(" "),this.compileList(e.endModifiers," "))}visitColumnUpdate(e){this.visitNode(e.column),this.append(" = "),this.visitNode(e.value)}visitLimit(e){this.append("limit "),this.visitNode(e.limit)}visitOffset(e){this.append("offset "),this.visitNode(e.offset)}visitOnConflict(e){this.append("on conflict"),e.columns?(this.append(" ("),this.compileList(e.columns),this.append(")")):e.constraint?(this.append(" on constraint "),this.visitNode(e.constraint)):e.indexExpression&&(this.append(" ("),this.visitNode(e.indexExpression),this.append(")")),e.indexWhere&&(this.append(" "),this.visitNode(e.indexWhere)),e.doNothing===!0?this.append(" do nothing"):e.updates&&(this.append(" do update set "),this.compileList(e.updates),e.updateWhere&&(this.append(" "),this.visitNode(e.updateWhere)))}visitOnDuplicateKey(e){this.append("on duplicate key update "),this.compileList(e.updates)}visitCreateIndex(e){this.append("create "),e.unique&&this.append("unique "),this.append("index "),e.ifNotExists&&this.append("if not exists "),this.visitNode(e.name),e.table&&(this.append(" on "),this.visitNode(e.table)),e.using&&(this.append(" using "),this.visitNode(e.using)),e.columns&&(this.append(" ("),this.compileList(e.columns),this.append(")")),e.nullsNotDistinct&&this.append(" nulls not distinct"),e.where&&(this.append(" "),this.visitNode(e.where))}visitDropIndex(e){this.append("drop index "),e.ifExists&&this.append("if exists "),this.visitNode(e.name),e.table&&(this.append(" on "),this.visitNode(e.table)),e.cascade&&this.append(" cascade")}visitCreateSchema(e){this.append("create schema "),e.ifNotExists&&this.append("if not exists "),this.visitNode(e.schema)}visitDropSchema(e){this.append("drop schema "),e.ifExists&&this.append("if exists "),this.visitNode(e.schema),e.cascade&&this.append(" cascade")}visitPrimaryKeyConstraint(e){e.name&&(this.append("constraint "),this.visitNode(e.name),this.append(" ")),this.append("primary key ("),this.compileList(e.columns),this.append(")"),this.buildDeferrable(e)}buildDeferrable(e){e.deferrable!==void 0&&(e.deferrable?this.append(" deferrable"):this.append(" not deferrable")),e.initiallyDeferred!==void 0&&(e.initiallyDeferred?this.append(" initially deferred"):this.append(" initially immediate"))}visitUniqueConstraint(e){e.name&&(this.append("constraint "),this.visitNode(e.name),this.append(" ")),this.append("unique"),e.nullsNotDistinct&&this.append(" nulls not distinct"),this.append(" ("),this.compileList(e.columns),this.append(")"),this.buildDeferrable(e)}visitCheckConstraint(e){e.name&&(this.append("constraint "),this.visitNode(e.name),this.append(" ")),this.append("check ("),this.visitNode(e.expression),this.append(")")}visitForeignKeyConstraint(e){e.name&&(this.append("constraint "),this.visitNode(e.name),this.append(" ")),this.append("foreign key ("),this.compileList(e.columns),this.append(") "),this.visitNode(e.references),e.onDelete&&(this.append(" on delete "),this.append(e.onDelete)),e.onUpdate&&(this.append(" on update "),this.append(e.onUpdate)),this.buildDeferrable(e)}visitList(e){this.compileList(e.items)}visitWith(e){this.append("with "),e.recursive&&this.append("recursive "),this.compileList(e.expressions)}visitCommonTableExpression(e){this.visitNode(e.name),this.append(" as "),ln(e.materialized)&&(e.materialized||this.append("not "),this.append("materialized ")),this.visitNode(e.expression)}visitCommonTableExpressionName(e){this.visitNode(e.table),e.columns&&(this.append("("),this.compileList(e.columns),this.append(")"))}visitAlterTable(e){this.append("alter table "),this.visitNode(e.table),this.append(" "),e.renameTo&&(this.append("rename to "),this.visitNode(e.renameTo)),e.setSchema&&(this.append("set schema "),this.visitNode(e.setSchema)),e.addConstraint&&this.visitNode(e.addConstraint),e.dropConstraint&&this.visitNode(e.dropConstraint),e.renameConstraint&&this.visitNode(e.renameConstraint),e.columnAlterations&&this.compileColumnAlterations(e.columnAlterations),e.addIndex&&this.visitNode(e.addIndex),e.dropIndex&&this.visitNode(e.dropIndex)}visitAddColumn(e){this.append("add column "),this.visitNode(e.column)}visitRenameColumn(e){this.append("rename column "),this.visitNode(e.column),this.append(" to "),this.visitNode(e.renameTo)}visitDropColumn(e){this.append("drop column "),this.visitNode(e.column)}visitAlterColumn(e){this.append("alter column "),this.visitNode(e.column),this.append(" "),e.dataType&&(this.announcesNewColumnDataType()&&this.append("type "),this.visitNode(e.dataType),e.dataTypeExpression&&(this.append("using "),this.visitNode(e.dataTypeExpression))),e.setDefault&&(this.append("set default "),this.visitNode(e.setDefault)),e.dropDefault&&this.append("drop default"),e.setNotNull&&this.append("set not null"),e.dropNotNull&&this.append("drop not null")}visitModifyColumn(e){this.append("modify column "),this.visitNode(e.column)}visitAddConstraint(e){this.append("add "),this.visitNode(e.constraint)}visitDropConstraint(e){this.append("drop constraint "),e.ifExists&&this.append("if exists "),this.visitNode(e.constraintName),e.modifier==="cascade"?this.append(" cascade"):e.modifier==="restrict"&&this.append(" restrict")}visitRenameConstraint(e){this.append("rename constraint "),this.visitNode(e.oldName),this.append(" to "),this.visitNode(e.newName)}visitSetOperation(e){this.append(e.operator),this.append(" "),e.all&&this.append("all "),this.visitNode(e.expression)}visitCreateView(e){this.append("create "),e.orReplace&&this.append("or replace "),e.materialized&&this.append("materialized "),e.temporary&&this.append("temporary "),this.append("view "),e.ifNotExists&&this.append("if not exists "),this.visitNode(e.name),this.append(" "),e.columns&&(this.append("("),this.compileList(e.columns),this.append(") ")),e.as&&(this.append("as "),this.visitNode(e.as))}visitRefreshMaterializedView(e){this.append("refresh materialized view "),e.concurrently&&this.append("concurrently "),this.visitNode(e.name),e.withNoData?this.append(" with no data"):this.append(" with data")}visitDropView(e){this.append("drop "),e.materialized&&this.append("materialized "),this.append("view "),e.ifExists&&this.append("if exists "),this.visitNode(e.name),e.cascade&&this.append(" cascade")}visitGenerated(e){this.append("generated "),e.always&&this.append("always "),e.byDefault&&this.append("by default "),this.append("as "),e.identity&&this.append("identity"),e.expression&&(this.append("("),this.visitNode(e.expression),this.append(")")),e.stored&&this.append(" stored")}visitDefaultValue(e){this.append("default "),this.visitNode(e.defaultValue)}visitSelectModifier(e){e.rawModifier?this.visitNode(e.rawModifier):this.append(Kf[e.modifier]),e.of&&(this.append(" of "),this.compileList(e.of,", "))}visitCreateType(e){this.append("create type "),this.visitNode(e.name),e.enum&&(this.append(" as enum "),this.visitNode(e.enum))}visitDropType(e){this.append("drop type "),e.ifExists&&this.append("if exists "),this.visitNode(e.name)}visitExplain(e){this.append("explain"),(e.options||e.format)&&(this.append(" "),this.append(this.getLeftExplainOptionsWrapper()),e.options&&(this.visitNode(e.options),e.format&&this.append(this.getExplainOptionsDelimiter())),e.format&&(this.append("format"),this.append(this.getExplainOptionAssignment()),this.append(e.format)),this.append(this.getRightExplainOptionsWrapper()))}visitDefaultInsertValue(e){this.append("default")}visitAggregateFunction(e){this.append(e.func),this.append("("),e.distinct&&this.append("distinct "),this.compileList(e.aggregated),e.orderBy&&(this.append(" "),this.visitNode(e.orderBy)),this.append(")"),e.withinGroup&&(this.append(" within group ("),this.visitNode(e.withinGroup),this.append(")")),e.filter&&(this.append(" filter("),this.visitNode(e.filter),this.append(")")),e.over&&(this.append(" "),this.visitNode(e.over))}visitOver(e){this.append("over("),e.partitionBy&&(this.visitNode(e.partitionBy),e.orderBy&&this.append(" ")),e.orderBy&&this.visitNode(e.orderBy),this.append(")")}visitPartitionBy(e){this.append("partition by "),this.compileList(e.items)}visitPartitionByItem(e){this.visitNode(e.partitionBy)}visitBinaryOperation(e){this.visitNode(e.leftOperand),this.append(" "),this.visitNode(e.operator),this.append(" "),this.visitNode(e.rightOperand)}visitUnaryOperation(e){this.visitNode(e.operator),this.isMinusOperator(e.operator)||this.append(" "),this.visitNode(e.operand)}isMinusOperator(e){return Jt.is(e)&&e.operator==="-"}visitUsing(e){this.append("using "),this.compileList(e.tables)}visitFunction(e){this.append(e.func),this.append("("),this.compileList(e.arguments),this.append(")")}visitCase(e){this.append("case"),e.value&&(this.append(" "),this.visitNode(e.value)),e.when&&(this.append(" "),this.compileList(e.when," ")),e.else&&(this.append(" else "),this.visitNode(e.else)),this.append(" end"),e.isStatement&&this.append(" case")}visitWhen(e){this.append("when "),this.visitNode(e.condition),e.result&&(this.append(" then "),this.visitNode(e.result))}visitJSONReference(e){this.visitNode(e.reference),this.visitNode(e.traversal)}visitJSONPath(e){e.inOperator&&this.visitNode(e.inOperator),this.append("'$");for(const r of e.pathLegs)this.visitNode(r);this.append("'")}visitJSONPathLeg(e){const r=e.type==="ArrayLocation";this.append(r?"[":"."),this.append(String(e.value)),r&&this.append("]")}visitJSONOperatorChain(e){for(let r=0,n=e.values.length;r<n;r++)r===n-1?this.visitNode(e.operator):this.append("->"),this.visitNode(e.values[r])}visitMergeQuery(e){e.with&&(this.visitNode(e.with),this.append(" ")),this.append("merge "),e.top&&(this.visitNode(e.top),this.append(" ")),this.append("into "),this.visitNode(e.into),e.using&&(this.append(" "),this.visitNode(e.using)),e.whens&&(this.append(" "),this.compileList(e.whens," ")),e.returning&&(this.append(" "),this.visitNode(e.returning)),e.output&&(this.append(" "),this.visitNode(e.output)),e.endModifiers?.length&&(this.append(" "),this.compileList(e.endModifiers," "))}visitMatched(e){e.not&&this.append("not "),this.append("matched"),e.bySource&&this.append(" by source")}visitAddIndex(e){this.append("add "),e.unique&&this.append("unique "),this.append("index "),this.visitNode(e.name),e.columns&&(this.append(" ("),this.compileList(e.columns),this.append(")")),e.using&&(this.append(" using "),this.visitNode(e.using))}visitCast(e){this.append("cast("),this.visitNode(e.expression),this.append(" as "),this.visitNode(e.dataType),this.append(")")}visitFetch(e){this.append("fetch next "),this.visitNode(e.rowCount),this.append(` rows ${e.modifier}`)}visitOutput(e){this.append("output "),this.compileList(e.selections)}visitTop(e){this.append(`top(${e.expression})`),e.modifiers&&this.append(` ${e.modifiers}`)}visitOrAction(e){this.append(e.action)}visitCollate(e){this.append("collate "),this.visitNode(e.collation)}append(e){this.#e+=e}appendValue(e){this.addParameter(e),this.append(this.getCurrentParameterPlaceholder())}getLeftIdentifierWrapper(){return'"'}getRightIdentifierWrapper(){return'"'}getCurrentParameterPlaceholder(){return"$"+this.numParameters}getLeftExplainOptionsWrapper(){return"("}getExplainOptionAssignment(){return" "}getExplainOptionsDelimiter(){return", "}getRightExplainOptionsWrapper(){return")"}sanitizeIdentifier(e){const r=this.getLeftIdentifierWrapper(),n=this.getRightIdentifierWrapper();let i="";for(const s of e)i+=s,s===r?i+=r:s===n&&(i+=n);return i}sanitizeStringLiteral(e){return e.replace(zf,"''")}addParameter(e){this.#t.push(e)}appendImmediateValue(e){if(Oe(e))this.appendStringLiteral(e);else if(Ir(e)||ln(e)||oi(e))this.append(e.toString());else if(si(e))this.append("null");else if(tc(e))this.appendImmediateValue(e.toISOString());else throw new Error(`invalid immediate value ${e}`)}appendStringLiteral(e){this.append("'"),this.append(this.sanitizeStringLiteral(e)),this.append("'")}sortSelectModifiers(e){return e.sort((r,n)=>r.modifier&&n.modifier?Sa[r.modifier]-Sa[n.modifier]:1),o(e)}compileColumnAlterations(e){this.compileList(e)}announcesNewColumnDataType(){return!0}}const Kf=o({ForKeyShare:"for key share",ForNoKeyUpdate:"for no key update",ForUpdate:"for update",ForShare:"for share",NoWait:"nowait",SkipLocked:"skip locked",Distinct:"distinct"}),Sa=o({ForKeyShare:1,ForNoKeyUpdate:1,ForUpdate:1,ForShare:1,NoWait:2,SkipLocked:2,Distinct:0}),Xf=o({InnerJoin:"inner join",LeftJoin:"left join",RightJoin:"right join",FullJoin:"full join",CrossJoin:"cross join",LateralInnerJoin:"inner join lateral",LateralLeftJoin:"left join lateral",LateralCrossJoin:"cross join lateral",OuterApply:"outer apply",CrossApply:"cross apply",Using:"using"}),ze=o({raw(t,e=[]){return o({sql:t,query:ce.createWithSql(t),parameters:o(e),queryId:B()})}});class hi{get supportsCreateIfNotExists(){return!0}get supportsTransactionalDdl(){return!1}get supportsReturning(){return!1}get supportsOutput(){return!1}}function Ot(t,e){return ce.createWithChildren([ce.createWithSql(`${t} `),Q.create(e)])}class Zf{#e;#t=new tp;#r;#n;constructor(e){this.#e=o({...e})}async init(){this.#r=Ie(this.#e.database)?await this.#e.database():this.#e.database,this.#n=new ep(this.#r),this.#e.onCreateConnection&&await this.#e.onCreateConnection(this.#n)}async acquireConnection(){return await this.#t.lock(),this.#n}async beginTransaction(e){await e.executeQuery(ze.raw("begin"))}async commitTransaction(e){await e.executeQuery(ze.raw("commit"))}async rollbackTransaction(e){await e.executeQuery(ze.raw("rollback"))}async savepoint(e,r,n){await e.executeQuery(n(Ot("savepoint",r),B()))}async rollbackToSavepoint(e,r,n){await e.executeQuery(n(Ot("rollback to",r),B()))}async releaseSavepoint(e,r,n){await e.executeQuery(n(Ot("release",r),B()))}async releaseConnection(){this.#t.unlock()}async destroy(){this.#r?.close()}}class ep{#e;constructor(e){this.#e=e}executeQuery(e){const{sql:r,parameters:n}=e,i=this.#e.prepare(r);if(i.reader)return Promise.resolve({rows:i.all(n)});const{changes:s,lastInsertRowid:u}=i.run(n);return Promise.resolve({numAffectedRows:s!=null?BigInt(s):void 0,insertId:u!=null?BigInt(u):void 0,rows:[]})}async*streamQuery(e,r){const{sql:n,parameters:i,query:s}=e,u=this.#e.prepare(n);if(Z.is(s)){const d=u.iterate(i);for(const c of d)yield{rows:[c]}}else throw new Error("Sqlite driver only supports streaming of select queries")}}class tp{#e;#t;async lock(){for(;this.#e;)await this.#e;this.#e=new Promise(e=>{this.#t=e})}unlock(){const e=this.#t;this.#e=void 0,this.#t=void 0,e?.()}}const rp=/"/g;class np extends li{visitOrAction(e){this.append("or "),this.append(e.action)}getCurrentParameterPlaceholder(){return"?"}getLeftExplainOptionsWrapper(){return""}getRightExplainOptionsWrapper(){return""}getLeftIdentifierWrapper(){return'"'}getRightIdentifierWrapper(){return'"'}getAutoIncrement(){return"autoincrement"}sanitizeIdentifier(e){return e.replace(rp,'""')}visitDefaultInsertValue(e){this.append("null")}}const Nn="kysely_migration",fi="kysely_migration_lock";o({__noMigrations__:!0});class ip{#e;constructor(e){this.#e=e}async getSchemas(){return[]}async getTables(e={withInternalKyselyTables:!1}){return await this.#r(e)}async getMetadata(e){return{tables:await this.getTables(e)}}#t(e,r){let n=e.selectFrom("sqlite_master").where("type","in",["table","view"]).where("name","not like","sqlite_%").select(["name","sql","type"]).orderBy("name");return r.withInternalKyselyTables||(n=n.where("name","!=",Nn).where("name","!=",fi)),n}async#r(e){const r=await this.#t(this.#e,e).execute(),n=await this.#e.with("table_list",s=>this.#t(s,e)).selectFrom(["table_list as tl",te`pragma_table_info(tl.name)`.as("p")]).select(["tl.name as table","p.cid","p.name","p.type","p.notnull","p.dflt_value","p.pk"]).orderBy("tl.name").orderBy("p.cid").execute(),i={};for(const s of n)i[s.table]??=[],i[s.table].push(s);return r.map(({name:s,sql:u,type:d})=>{let c=u?.split(/[\(\),]/)?.find(l=>l.toLowerCase().includes("autoincrement"))?.trimStart()?.split(/\s+/)?.[0]?.replace(/["`]/g,"");const h=i[s]??[];if(!c){const l=h.filter(y=>y.pk>0);l.length===1&&l[0].type.toLowerCase()==="integer"&&(c=l[0].name)}return{name:s,isView:d==="view",columns:h.map(l=>({name:l.name,dataType:l.type,isNullable:!l.notnull,isAutoIncrementing:l.name===c,hasDefaultValue:l.dflt_value!=null,comment:void 0}))}})}}class sp extends hi{get supportsTransactionalDdl(){return!1}get supportsReturning(){return!0}async acquireMigrationLock(e,r){}async releaseMigrationLock(e,r){}}class Uc{#e;constructor(e){this.#e=o({...e})}createDriver(){return new Zf(this.#e)}createQueryCompiler(){return new np}createAdapter(){return new sp}createIntrospector(e){return new ip(e)}}const op=/"/g;class ap extends li{sanitizeIdentifier(e){return e.replace(op,'""')}}class up{#e;constructor(e){this.#e=e}async getSchemas(){return(await this.#e.selectFrom("pg_catalog.pg_namespace").select("nspname").$castTo().execute()).map(r=>({name:r.nspname}))}async getTables(e={withInternalKyselyTables:!1}){let r=this.#e.selectFrom("pg_catalog.pg_attribute as a").innerJoin("pg_catalog.pg_class as c","a.attrelid","c.oid").innerJoin("pg_catalog.pg_namespace as ns","c.relnamespace","ns.oid").innerJoin("pg_catalog.pg_type as typ","a.atttypid","typ.oid").innerJoin("pg_catalog.pg_namespace as dtns","typ.typnamespace","dtns.oid").select(["a.attname as column","a.attnotnull as not_null","a.atthasdef as has_default","c.relname as table","c.relkind as table_type","ns.nspname as schema","typ.typname as type","dtns.nspname as type_schema",te`col_description(a.attrelid, a.attnum)`.as("column_description"),te`pg_get_serial_sequence(quote_ident(ns.nspname) || '.' || quote_ident(c.relname), a.attname)`.as("auto_incrementing")]).where("c.relkind","in",["r","v","p"]).where("ns.nspname","!~","^pg_").where("ns.nspname","!=","information_schema").where("ns.nspname","!=","crdb_internal").where(te`has_schema_privilege(ns.nspname, 'USAGE')`).where("a.attnum",">=",0).where("a.attisdropped","!=",!0).orderBy("ns.nspname").orderBy("c.relname").orderBy("a.attnum").$castTo();e.withInternalKyselyTables||(r=r.where("c.relname","!=",Nn).where("c.relname","!=",fi));const n=await r.execute();return this.#t(n)}async getMetadata(e){return{tables:await this.getTables(e)}}#t(e){return e.reduce((r,n)=>{let i=r.find(s=>s.name===n.table&&s.schema===n.schema);return i||(i=o({name:n.table,isView:n.table_type==="v",schema:n.schema,columns:[]}),r.push(i)),i.columns.push(o({name:n.column,dataType:n.type,dataTypeSchema:n.type_schema,isNullable:!n.not_null,isAutoIncrementing:n.auto_incrementing!==null,hasDefaultValue:n.has_default,comment:n.column_description??void 0})),r},[])}}const cp=BigInt("3853314791062309107");class dp extends hi{get supportsTransactionalDdl(){return!0}get supportsReturning(){return!0}async acquireMigrationLock(e,r){await te`select pg_advisory_xact_lock(${te.lit(cp)})`.execute(e)}async releaseMigrationLock(e,r){}}function vo(t,e){if(lp(t)&&e.stack){const r=e.stack.split(`
`).slice(1).join(`
`);return t.stack+=`
${r}`,t}return t}function lp(t){return Ge(t)&&Oe(t.stack)}const Mc=Symbol();class hp{#e;#t=new WeakMap;#r;constructor(e){this.#e=o({...e})}async init(){this.#r=Ie(this.#e.pool)?await this.#e.pool():this.#e.pool}async acquireConnection(){const e=await this.#n();let r=this.#t.get(e);return r||(r=new pp(e),this.#t.set(e,r),this.#e?.onCreateConnection&&await this.#e.onCreateConnection(r)),this.#e?.onReserveConnection&&await this.#e.onReserveConnection(r),r}async#n(){return new Promise((e,r)=>{this.#r.getConnection(async(n,i)=>{n?r(n):e(i)})})}async beginTransaction(e,r){if(r.isolationLevel||r.accessMode){const n=[];r.isolationLevel&&n.push(`isolation level ${r.isolationLevel}`),r.accessMode&&n.push(r.accessMode);const i=`set transaction ${n.join(", ")}`;await e.executeQuery(ze.raw(i))}await e.executeQuery(ze.raw("begin"))}async commitTransaction(e){await e.executeQuery(ze.raw("commit"))}async rollbackTransaction(e){await e.executeQuery(ze.raw("rollback"))}async savepoint(e,r,n){await e.executeQuery(n(Ot("savepoint",r),B()))}async rollbackToSavepoint(e,r,n){await e.executeQuery(n(Ot("rollback to",r),B()))}async releaseSavepoint(e,r,n){await e.executeQuery(n(Ot("release savepoint",r),B()))}async releaseConnection(e){e[Mc]()}async destroy(){return new Promise((e,r)=>{this.#r.end(n=>{n?r(n):e()})})}}function fp(t){return Ge(t)&&"insertId"in t&&"affectedRows"in t}class pp{#e;constructor(e){this.#e=e}async executeQuery(e){try{const r=await this.#t(e);if(fp(r)){const{insertId:n,affectedRows:i,changedRows:s}=r;return{insertId:n!=null&&n.toString()!=="0"?BigInt(n):void 0,numAffectedRows:i!=null?BigInt(i):void 0,numChangedRows:s!=null?BigInt(s):void 0,rows:[]}}else if(Array.isArray(r))return{rows:r};return{rows:[]}}catch(r){throw vo(r,new Error)}}#t(e){return new Promise((r,n)=>{this.#e.query(e.sql,e.parameters,(i,s)=>{i?n(i):r(s)})})}async*streamQuery(e,r){const n=this.#e.query(e.sql,e.parameters).stream({objectMode:!0});try{for await(const i of n)yield{rows:[i]}}catch(i){if(i&&typeof i=="object"&&"code"in i&&i.code==="ERR_STREAM_PREMATURE_CLOSE")return;throw i}}[Mc](){this.#e.release()}}const mp=/`/g;class yp extends li{getCurrentParameterPlaceholder(){return"?"}getLeftExplainOptionsWrapper(){return""}getExplainOptionAssignment(){return"="}getExplainOptionsDelimiter(){return" "}getRightExplainOptionsWrapper(){return""}getLeftIdentifierWrapper(){return"`"}getRightIdentifierWrapper(){return"`"}sanitizeIdentifier(e){return e.replace(mp,"``")}visitCreateIndex(e){this.append("create "),e.unique&&this.append("unique "),this.append("index "),e.ifNotExists&&this.append("if not exists "),this.visitNode(e.name),e.using&&(this.append(" using "),this.visitNode(e.using)),e.table&&(this.append(" on "),this.visitNode(e.table)),e.columns&&(this.append(" ("),this.compileList(e.columns),this.append(")")),e.where&&(this.append(" "),this.visitNode(e.where))}}class wp{#e;constructor(e){this.#e=e}async getSchemas(){return(await this.#e.selectFrom("information_schema.schemata").select("schema_name").$castTo().execute()).map(r=>({name:r.SCHEMA_NAME}))}async getTables(e={withInternalKyselyTables:!1}){let r=this.#e.selectFrom("information_schema.columns as columns").innerJoin("information_schema.tables as tables",i=>i.onRef("columns.TABLE_CATALOG","=","tables.TABLE_CATALOG").onRef("columns.TABLE_SCHEMA","=","tables.TABLE_SCHEMA").onRef("columns.TABLE_NAME","=","tables.TABLE_NAME")).select(["columns.COLUMN_NAME","columns.COLUMN_DEFAULT","columns.TABLE_NAME","columns.TABLE_SCHEMA","tables.TABLE_TYPE","columns.IS_NULLABLE","columns.DATA_TYPE","columns.EXTRA","columns.COLUMN_COMMENT"]).where("columns.TABLE_SCHEMA","=",te`database()`).orderBy("columns.TABLE_NAME").orderBy("columns.ORDINAL_POSITION").$castTo();e.withInternalKyselyTables||(r=r.where("columns.TABLE_NAME","!=",Nn).where("columns.TABLE_NAME","!=",fi));const n=await r.execute();return this.#t(n)}async getMetadata(e){return{tables:await this.getTables(e)}}#t(e){return e.reduce((r,n)=>{let i=r.find(s=>s.name===n.TABLE_NAME);return i||(i=o({name:n.TABLE_NAME,isView:n.TABLE_TYPE==="VIEW",schema:n.TABLE_SCHEMA,columns:[]}),r.push(i)),i.columns.push(o({name:n.COLUMN_NAME,dataType:n.DATA_TYPE,isNullable:n.IS_NULLABLE==="YES",isAutoIncrementing:n.EXTRA.toLowerCase().includes("auto_increment"),hasDefaultValue:n.COLUMN_DEFAULT!==null,comment:n.COLUMN_COMMENT===""?void 0:n.COLUMN_COMMENT})),r},[])}}const xa="ea586330-2c93-47c8-908d-981d9d270f9d",Np=3600;class gp extends hi{get supportsTransactionalDdl(){return!1}get supportsReturning(){return!1}async acquireMigrationLock(e,r){await te`select get_lock(${te.lit(xa)}, ${te.lit(Np)})`.execute(e)}async releaseMigrationLock(e,r){await te`select release_lock(${te.lit(xa)})`.execute(e)}}class jc{#e;constructor(e){this.#e=e}createDriver(){return new hp(this.#e)}createQueryCompiler(){return new yp}createAdapter(){return new gp}createIntrospector(e){return new wp(e)}}const Fc=Symbol();class bp{#e;#t=new WeakMap;#r;constructor(e){this.#e=o({...e})}async init(){this.#r=Ie(this.#e.pool)?await this.#e.pool():this.#e.pool}async acquireConnection(){const e=await this.#r.connect();let r=this.#t.get(e);return r||(r=new vp(e,{cursor:this.#e.cursor??null}),this.#t.set(e,r),this.#e.onCreateConnection&&await this.#e.onCreateConnection(r)),this.#e.onReserveConnection&&await this.#e.onReserveConnection(r),r}async beginTransaction(e,r){if(r.isolationLevel||r.accessMode){let n="start transaction";r.isolationLevel&&(n+=` isolation level ${r.isolationLevel}`),r.accessMode&&(n+=` ${r.accessMode}`),await e.executeQuery(ze.raw(n))}else await e.executeQuery(ze.raw("begin"))}async commitTransaction(e){await e.executeQuery(ze.raw("commit"))}async rollbackTransaction(e){await e.executeQuery(ze.raw("rollback"))}async savepoint(e,r,n){await e.executeQuery(n(Ot("savepoint",r),B()))}async rollbackToSavepoint(e,r,n){await e.executeQuery(n(Ot("rollback to",r),B()))}async releaseSavepoint(e,r,n){await e.executeQuery(n(Ot("release",r),B()))}async releaseConnection(e){e[Fc]()}async destroy(){if(this.#r){const e=this.#r;this.#r=void 0,await e.end()}}}class vp{#e;#t;constructor(e,r){this.#e=e,this.#t=r}async executeQuery(e){try{const{command:r,rowCount:n,rows:i}=await this.#e.query(e.sql,[...e.parameters]);return{numAffectedRows:r==="INSERT"||r==="UPDATE"||r==="DELETE"||r==="MERGE"?BigInt(n):void 0,rows:i??[]}}catch(r){throw vo(r,new Error)}}async*streamQuery(e,r){if(!this.#t.cursor)throw new Error("'cursor' is not present in your postgres dialect config. It's required to make streaming work in postgres.");if(!Number.isInteger(r)||r<=0)throw new Error("chunkSize must be a positive integer");const n=this.#e.query(new this.#t.cursor(e.sql,e.parameters.slice()));try{for(;;){const i=await n.read(r);if(i.length===0)break;yield{rows:i}}}finally{await n.close()}}[Fc](){this.#e.release()}}class Vc{#e;constructor(e){this.#e=e}createDriver(){return new bp(this.#e)}createQueryCompiler(){return new ap}createAdapter(){return new dp}createIntrospector(e){return new up(e)}}class Ep extends hi{get supportsCreateIfNotExists(){return!1}get supportsTransactionalDdl(){return!0}get supportsOutput(){return!0}async acquireMigrationLock(e){await te`exec sp_getapplock @DbPrincipal = ${te.lit("dbo")}, @Resource = ${te.lit(Nn)}, @LockMode = ${te.lit("Exclusive")}`.execute(e)}async releaseMigrationLock(){}}const Bc=Symbol(),Jc=Symbol(),Gc=Symbol();class Op{#e;#t;constructor(e){this.#e=o({...e});const{tarn:r,tedious:n,validateConnections:i}=this.#e,{validateConnections:s,...u}=r.options;this.#t=new r.Pool({...u,create:async()=>{const d=await n.connectionFactory();return await new Ap(d,n).connect()},destroy:async d=>{await d[Jc]()},validate:i===!1||s===!1?void 0:d=>d[Gc]()})}async init(){}async acquireConnection(){return await this.#t.acquire().promise}async beginTransaction(e,r){await e.beginTransaction(r)}async commitTransaction(e){await e.commitTransaction()}async rollbackTransaction(e){await e.rollbackTransaction()}async savepoint(e,r){await e.savepoint(r)}async rollbackToSavepoint(e,r){await e.rollbackTransaction(r)}async releaseConnection(e){(this.#e.resetConnectionsOnRelease||this.#e.tedious.resetConnectionOnRelease)&&await e[Bc](),this.#t.release(e)}async destroy(){await this.#t.destroy()}}class Ap{#e;#t;#r;constructor(e,r){this.#e=e,this.#t=!1,this.#r=r}async beginTransaction(e){const{isolationLevel:r}=e;await new Promise((n,i)=>this.#e.beginTransaction(s=>{s?i(s):n(void 0)},r?wc(8):void 0,r?this.#n(r):void 0))}async commitTransaction(){await new Promise((e,r)=>this.#e.commitTransaction(n=>{n?r(n):e(void 0)}))}async connect(){const{promise:e,reject:r,resolve:n}=new nn;this.#e.connect(s=>{if(s)return r(s);n()}),this.#e.on("error",s=>{s instanceof Error&&"code"in s&&s.code==="ESOCKET"&&(this.#t=!0),console.error(s),r(s)});function i(){r(new Error("The connection ended without ever completing the connection"))}return this.#e.once("end",i),await e,this.#e.off("end",i),this}async executeQuery(e){try{const r=new nn,n=new Ri({compiledQuery:e,tedious:this.#r,onDone:r});this.#e.execSql(n.request);const{rowCount:i,rows:s}=await r.promise;return{numAffectedRows:i!==void 0?BigInt(i):void 0,rows:s}}catch(r){throw vo(r,new Error)}}async rollbackTransaction(e){await new Promise((r,n)=>this.#e.rollbackTransaction(i=>{i?n(i):r(void 0)},e))}async savepoint(e){await new Promise((r,n)=>this.#e.saveTransaction(i=>{i?n(i):r(void 0)},e))}async*streamQuery(e,r){if(!Number.isInteger(r)||r<=0)throw new Error("chunkSize must be a positive integer");const n=new Ri({compiledQuery:e,streamChunkSize:r,tedious:this.#r});this.#e.execSql(n.request);try{for(;;){const i=await n.readChunk();if(i.length===0||(yield{rows:i},i.length<r))break}}finally{await this.#i(n)}}#n(e){const{ISOLATION_LEVEL:r}=this.#r,i={"read committed":r.READ_COMMITTED,"read uncommitted":r.READ_UNCOMMITTED,"repeatable read":r.REPEATABLE_READ,serializable:r.SERIALIZABLE,snapshot:r.SNAPSHOT}[e];if(i===void 0)throw new Error(`Unknown isolation level: ${e}`);return i}#i(e){return new Promise(r=>{e.request.once("requestCompleted",r),this.#e.cancel()||(e.request.off("requestCompleted",r),r())})}[Jc](){return"closed"in this.#e&&this.#e.closed?Promise.resolve():new Promise(e=>{this.#e.once("end",e),this.#e.close()})}async[Bc](){await new Promise((e,r)=>{this.#e.reset(n=>{if(n)return r(n);e()})})}async[Gc](){if(this.#t||this.#o())return!1;try{const e=new nn,r=new Ri({compiledQuery:ze.raw("select 1"),onDone:e,tedious:this.#r});return this.#e.execSql(r.request),await e.promise,!0}catch{return!1}}#o(){return"closed"in this.#e&&!!this.#e.closed}}class Ri{#e;#t;#r;#n;#i;#o;constructor(e){const{compiledQuery:r,onDone:n,streamChunkSize:i,tedious:s}=e;if(this.#t=[],this.#r=i,this.#n={},this.#i=s,n){const u="onDone";this.#n[u]=(d,c)=>{if(d!=="chunkReady"){if(delete this.#n[u],d==="error")return n.reject(c);n.resolve({rowCount:this.#o,rows:this.#t})}}}this.#e=new this.#i.Request(r.sql,(u,d)=>{if(u)return Object.values(this.#n).forEach(c=>c("error",u instanceof AggregateError?u.errors:u));this.#o=d}),this.#u(r.parameters),this.#s()}get request(){return this.#e}readChunk(){const e=this.readChunk.name;return new Promise((r,n)=>{this.#n[e]=(i,s)=>{if(delete this.#n[e],i==="error")return n(s);r(this.#t.splice(0,this.#r))},this.#e.resume()})}#u(e){for(let r=0;r<e.length;r++){const n=e[r];this.#e.addParameter(String(r+1),this.#a(n),n)}}#s(){const e=this.#r?()=>{this.#r<=this.#t.length&&(this.#e.pause(),Object.values(this.#n).forEach(n=>n("chunkReady")))}:()=>{},r=n=>{const i={};for(const s of n)i[s.metadata.colName]=s.value;this.#t.push(i),e()};this.#e.on("row",r),this.#e.once("requestCompleted",()=>{Object.values(this.#n).forEach(n=>n("completed")),this.#e.off("row",r)})}#a(e){return si(e)||Et(e)||Oe(e)?this.#i.TYPES.NVarChar:oi(e)||Ir(e)&&e%1===0?e<-2147483648||e>2147483647?this.#i.TYPES.BigInt:this.#i.TYPES.Int:Ir(e)?this.#i.TYPES.Float:ln(e)?this.#i.TYPES.Bit:tc(e)?this.#i.TYPES.DateTime:lh(e)?this.#i.TYPES.VarBinary:this.#i.TYPES.NVarChar}}class Tp{#e;constructor(e){this.#e=e}async getSchemas(){return await this.#e.selectFrom("sys.schemas").select("name").execute()}async getTables(e={withInternalKyselyTables:!1}){const r=await this.#e.selectFrom("sys.tables as tables").leftJoin("sys.schemas as table_schemas","table_schemas.schema_id","tables.schema_id").innerJoin("sys.columns as columns","columns.object_id","tables.object_id").innerJoin("sys.types as types","types.user_type_id","columns.user_type_id").leftJoin("sys.schemas as type_schemas","type_schemas.schema_id","types.schema_id").leftJoin("sys.extended_properties as comments",i=>i.onRef("comments.major_id","=","tables.object_id").onRef("comments.minor_id","=","columns.column_id").on("comments.name","=","MS_Description")).$if(!e.withInternalKyselyTables,i=>i.where("tables.name","!=",Nn).where("tables.name","!=",fi)).select(["tables.name as table_name",i=>i.ref("tables.type").$castTo().as("table_type"),"table_schemas.name as table_schema_name","columns.default_object_id as column_default_object_id","columns.generated_always_type_desc as column_generated_always_type","columns.is_computed as column_is_computed","columns.is_identity as column_is_identity","columns.is_nullable as column_is_nullable","columns.is_rowguidcol as column_is_rowguidcol","columns.name as column_name","types.is_nullable as type_is_nullable","types.name as type_name","type_schemas.name as type_schema_name","comments.value as column_comment"]).unionAll(this.#e.selectFrom("sys.views as views").leftJoin("sys.schemas as view_schemas","view_schemas.schema_id","views.schema_id").innerJoin("sys.columns as columns","columns.object_id","views.object_id").innerJoin("sys.types as types","types.user_type_id","columns.user_type_id").leftJoin("sys.schemas as type_schemas","type_schemas.schema_id","types.schema_id").leftJoin("sys.extended_properties as comments",i=>i.onRef("comments.major_id","=","views.object_id").onRef("comments.minor_id","=","columns.column_id").on("comments.name","=","MS_Description")).select(["views.name as table_name","views.type as table_type","view_schemas.name as table_schema_name","columns.default_object_id as column_default_object_id","columns.generated_always_type_desc as column_generated_always_type","columns.is_computed as column_is_computed","columns.is_identity as column_is_identity","columns.is_nullable as column_is_nullable","columns.is_rowguidcol as column_is_rowguidcol","columns.name as column_name","types.is_nullable as type_is_nullable","types.name as type_name","type_schemas.name as type_schema_name","comments.value as column_comment"])).orderBy("table_schema_name").orderBy("table_name").orderBy("column_name").execute(),n={};for(const i of r){const s=`${i.table_schema_name}.${i.table_name}`;(n[s]=n[s]||o({columns:[],isView:i.table_type==="V ",name:i.table_name,schema:i.table_schema_name??void 0})).columns.push(o({dataType:i.type_name,dataTypeSchema:i.type_schema_name??void 0,hasDefaultValue:i.column_default_object_id>0||i.column_generated_always_type!=="NOT_APPLICABLE"||i.column_is_identity||i.column_is_computed||i.column_is_rowguidcol,isAutoIncrementing:i.column_is_identity,isNullable:i.column_is_nullable&&i.type_is_nullable,name:i.column_name,comment:i.column_comment??void 0}))}return Object.values(n)}async getMetadata(e){return{tables:await this.getTables(e)}}}const Sp=/^[a-z0-9_]$/i;class xp extends li{getCurrentParameterPlaceholder(){return`@${this.numParameters}`}visitOffset(e){super.visitOffset(e),this.append(" rows")}compileColumnAlterations(e){const r={};for(const i of e)r[i.kind]||(r[i.kind]=[]),r[i.kind].push(i);let n=!0;r.AddColumnNode&&(this.append("add "),this.compileList(r.AddColumnNode),n=!1),r.AlterColumnNode&&(n||this.append(", "),this.compileList(r.AlterColumnNode)),r.DropColumnNode&&(n||this.append(", "),this.append("drop column "),this.compileList(r.DropColumnNode)),r.ModifyColumnNode&&(n||this.append(", "),this.compileList(r.ModifyColumnNode)),r.RenameColumnNode&&(n||this.append(", "),this.compileList(r.RenameColumnNode))}visitAddColumn(e){this.visitNode(e.column)}visitDropColumn(e){this.visitNode(e.column)}visitMergeQuery(e){super.visitMergeQuery(e),this.append(";")}visitCollate(e){this.append("collate ");const{name:r}=e.collation;for(const n of r)if(!Sp.test(n))throw new Error(`Invalid collation: ${r}`);this.append(r)}announcesNewColumnDataType(){return!1}}class Rp{#e;constructor(e){this.#e=e}createDriver(){return new Op(this.#e)}createQueryCompiler(){return new xp}createAdapter(){return new Ep}createIntrospector(e){return new Tp(e)}}function Eo(t){if(!t)return null;if("dialect"in t)return Eo(t.dialect);if("createDriver"in t){if(t instanceof Uc)return"sqlite";if(t instanceof jc)return"mysql";if(t instanceof Vc)return"postgres";if(t instanceof Rp)return"mssql"}return"aggregate"in t?"sqlite":"getConnection"in t?"mysql":"connect"in t?"postgres":"fileControl"in t||"open"in t&&"close"in t&&"prepare"in t?"sqlite":null}const Ip=async t=>{const e=t.database;if(!e)return{kysely:null,databaseType:null,transaction:void 0};if("db"in e)return{kysely:e.db,databaseType:e.type,transaction:e.transaction};if("dialect"in e)return{kysely:new bt({dialect:e.dialect}),databaseType:e.type,transaction:e.transaction};let r;const n=Eo(e);if("createDriver"in e&&(r=e),"aggregate"in e&&!("createSession"in e)&&(r=new Uc({database:e})),"getConnection"in e&&(r=new jc(e)),"connect"in e&&(r=new Vc({pool:e})),"fileControl"in e){const{BunSqliteDialect:i}=await Rr(async()=>{const{BunSqliteDialect:s}=await import("./bun-sqlite-dialect-C3P_ISb5-BAbVJ2ug.js");return{BunSqliteDialect:s}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21]));r=new i({database:e})}if("createSession"in e&&typeof window>"u"){let i;try{({DatabaseSync:i}=await import("node:sqlite"))}catch(s){if(s!==null&&typeof s=="object"&&"code"in s&&s.code!=="ERR_UNKNOWN_BUILTIN_MODULE")throw s}if(i&&e instanceof i){const{NodeSqliteDialect:s}=await Rr(async()=>{const{NodeSqliteDialect:u}=await import("./node-sqlite-dialect-D6w8Ekdz-BOQCjX4i.js");return{NodeSqliteDialect:u}},__vite__mapDeps([22,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21]));r=new s({database:e})}}return{kysely:r?new bt({dialect:r}):null,databaseType:n,transaction:void 0}},lr=t=>{const e=(t.plugins??[]).reduce((h,l)=>{const y=l.schema;if(!y)return h;for(const[f,m]of Object.entries(y))h[f]={fields:{...h[f]?.fields,...m.fields},modelName:m.modelName||f};return h},{}),r=t.rateLimit?.storage==="database",n={rateLimit:{modelName:t.rateLimit?.modelName||"rateLimit",fields:{key:{type:"string",fieldName:t.rateLimit?.fields?.key||"key"},count:{type:"number",fieldName:t.rateLimit?.fields?.count||"count"},lastRequest:{type:"number",bigint:!0,fieldName:t.rateLimit?.fields?.lastRequest||"lastRequest"}}}},{user:i,session:s,account:u,...d}=e,c={session:{modelName:t.session?.modelName||"session",fields:{expiresAt:{type:"date",required:!0,fieldName:t.session?.fields?.expiresAt||"expiresAt"},token:{type:"string",required:!0,fieldName:t.session?.fields?.token||"token",unique:!0},createdAt:{type:"date",required:!0,fieldName:t.session?.fields?.createdAt||"createdAt",defaultValue:()=>new Date},updatedAt:{type:"date",required:!0,fieldName:t.session?.fields?.updatedAt||"updatedAt",onUpdate:()=>new Date},ipAddress:{type:"string",required:!1,fieldName:t.session?.fields?.ipAddress||"ipAddress"},userAgent:{type:"string",required:!1,fieldName:t.session?.fields?.userAgent||"userAgent"},userId:{type:"string",fieldName:t.session?.fields?.userId||"userId",references:{model:t.user?.modelName||"user",field:"id",onDelete:"cascade"},required:!0,index:!0},...s?.fields,...t.session?.additionalFields},order:2}};return{user:{modelName:t.user?.modelName||"user",fields:{name:{type:"string",required:!0,fieldName:t.user?.fields?.name||"name",sortable:!0},email:{type:"string",unique:!0,required:!0,fieldName:t.user?.fields?.email||"email",sortable:!0},emailVerified:{type:"boolean",defaultValue:!1,required:!0,fieldName:t.user?.fields?.emailVerified||"emailVerified",input:!1},image:{type:"string",required:!1,fieldName:t.user?.fields?.image||"image"},createdAt:{type:"date",defaultValue:()=>new Date,required:!0,fieldName:t.user?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",defaultValue:()=>new Date,onUpdate:()=>new Date,required:!0,fieldName:t.user?.fields?.updatedAt||"updatedAt"},...i?.fields,...t.user?.additionalFields},order:1},...!t.secondaryStorage||t.session?.storeSessionInDatabase?c:{},account:{modelName:t.account?.modelName||"account",fields:{accountId:{type:"string",required:!0,fieldName:t.account?.fields?.accountId||"accountId"},providerId:{type:"string",required:!0,fieldName:t.account?.fields?.providerId||"providerId"},userId:{type:"string",references:{model:t.user?.modelName||"user",field:"id",onDelete:"cascade"},required:!0,fieldName:t.account?.fields?.userId||"userId",index:!0},accessToken:{type:"string",required:!1,fieldName:t.account?.fields?.accessToken||"accessToken"},refreshToken:{type:"string",required:!1,fieldName:t.account?.fields?.refreshToken||"refreshToken"},idToken:{type:"string",required:!1,fieldName:t.account?.fields?.idToken||"idToken"},accessTokenExpiresAt:{type:"date",required:!1,fieldName:t.account?.fields?.accessTokenExpiresAt||"accessTokenExpiresAt"},refreshTokenExpiresAt:{type:"date",required:!1,fieldName:t.account?.fields?.refreshTokenExpiresAt||"refreshTokenExpiresAt"},scope:{type:"string",required:!1,fieldName:t.account?.fields?.scope||"scope"},password:{type:"string",required:!1,fieldName:t.account?.fields?.password||"password"},createdAt:{type:"date",required:!0,fieldName:t.account?.fields?.createdAt||"createdAt",defaultValue:()=>new Date},updatedAt:{type:"date",required:!0,fieldName:t.account?.fields?.updatedAt||"updatedAt",onUpdate:()=>new Date},...u?.fields,...t.account?.additionalFields},order:3},verification:{modelName:t.verification?.modelName||"verification",fields:{identifier:{type:"string",required:!0,fieldName:t.verification?.fields?.identifier||"identifier",index:!0},value:{type:"string",required:!0,fieldName:t.verification?.fields?.value||"value"},expiresAt:{type:"date",required:!0,fieldName:t.verification?.fields?.expiresAt||"expiresAt"},createdAt:{type:"date",required:!0,defaultValue:()=>new Date,fieldName:t.verification?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",required:!0,defaultValue:()=>new Date,onUpdate:()=>new Date,fieldName:t.verification?.fields?.updatedAt||"updatedAt"}},order:4},...d,...r?n:{}}},Wr=({usePlural:t,schema:e})=>n=>{if(t&&n.charAt(n.length-1)==="s"){let s=n.slice(0,-1),u=e[s]?s:void 0;if(u||(u=Object.entries(e).find(([d,c])=>c.modelName===s)?.[0]),u)return u}let i=e[n]?n:void 0;if(i||(i=Object.entries(e).find(([s,u])=>u.modelName===n)?.[0]),!i)throw new Ce(`Model "${n}" not found in schema`);return i},Oo=({schema:t,usePlural:e})=>{const r=Wr({schema:t,usePlural:e});return({field:i,model:s})=>{if(i==="id"||i==="_id")return"id";const u=r(s);let d=t[u]?.fields[i];if(!d){const c=Object.entries(t[u].fields).find(([h,l])=>l.fieldName===i);c&&(d=c[1],i=c[0])}if(!d)throw new Ce(`Field ${i} not found in model ${u}`);return i}},Hc=({schema:t,usePlural:e})=>{const r=Wr({schema:t,usePlural:e}),n=Oo({schema:t,usePlural:e});function i({model:s,field:u}){const d=r(s),c=n({model:d,field:u});return t[d]?.fields[c]?.fieldName||c}return i},Qc=({usePlural:t,schema:e})=>{const r=Wr({schema:e,usePlural:t});return i=>{const s=r(i);return e&&e[s]&&e[s].modelName!==i?t?`${e[s].modelName}s`:e[s].modelName:t?`${i}s`:i}};async function kp(t,e){let r;if(t.database)typeof t.database=="function"?r=t.database(t):r=await e(t);else{const n=lr(t),i=Object.keys(n).reduce((u,d)=>(u[d]=[],u),{}),{memoryAdapter:s}=await Rr(async()=>{const{memoryAdapter:u}=await import("./index-DGf9FXR5.js");return{memoryAdapter:u}},__vite__mapDeps([23,11,1,12,2,3,4,5,6,7,8,9,10,13,14,15,16,17,18,19,20,21]));r=s(i)(t)}return r.transaction||(tt.warn("Adapter does not correctly implement transaction function, patching it automatically. Please update your adapter implementation."),r.transaction=async n=>n(r)),r}async function Cp(t){return kp(t,async e=>{const{createKyselyAdapter:r}=await Rr(async()=>{const{createKyselyAdapter:d}=await import("./index-C758adAn.js");return{createKyselyAdapter:d}},__vite__mapDeps([24,11,1,12,2,3,4,5,6,7,8,9,10,13,14,15,16,17,18,19,20,21])),{kysely:n,databaseType:i,transaction:s}=await r(e);if(!n)throw new Ce("Failed to initialize database adapter");const{kyselyAdapter:u}=await Rr(async()=>{const{kyselyAdapter:d}=await import("./index-C758adAn.js");return{kyselyAdapter:d}},__vite__mapDeps([24,11,1,12,2,3,4,5,6,7,8,9,10,13,14,15,16,17,18,19,20,21]));return u(n,{type:i||"sqlite",debugLogs:e.database&&"debugLogs"in e.database?e.database.debugLogs:!1,transaction:s})(e)})}function Lp(t,e){const r=e.hooks;async function n(c,h,l){const y=await br();let f=c;for(const p of r||[]){const w=p[h]?.create?.before;if(w){const A=await w(f,y);if(A===!1)return null;typeof A=="object"&&"data"in A&&(f={...f,...A.data})}}const m=l?await l.fn(f):null,v=!l||l.executeMainFn?await(await ee(t)).create({model:h,data:f,forceAllowId:!0}):m;for(const p of r||[]){const w=p[h]?.create?.after;w&&await w(v,y)}return v}async function i(c,h,l,y){const f=await br();let m=c;for(const w of r||[]){const A=w[l]?.update?.before;if(A){const D=await A(c,f);if(D===!1)return null;typeof D=="object"&&"data"in D&&(m={...m,...D.data})}}const v=y?await y.fn(m):null,p=!y||y.executeMainFn?await(await ee(t)).update({model:l,update:m,where:h}):v;for(const w of r||[]){const A=w[l]?.update?.after;A&&await A(p,f)}return p}async function s(c,h,l,y){const f=await br();let m=c;for(const w of r||[]){const A=w[l]?.update?.before;if(A){const D=await A(c,f);if(D===!1)return null;typeof D=="object"&&"data"in D&&(m={...m,...D.data})}}const v=y?await y.fn(m):null,p=!y||y.executeMainFn?await(await ee(t)).updateMany({model:l,update:m,where:h}):v;for(const w of r||[]){const A=w[l]?.update?.after;A&&await A(p,f)}return p}async function u(c,h,l){const y=await br();let f=null;try{f=(await(await ee(t)).findMany({model:h,where:c,limit:1}))[0]||null}catch{}if(f)for(const p of r||[]){const w=p[h]?.delete?.before;if(w&&await w(f,y)===!1)return null}const m=l?await l.fn(c):null,v=!l||l.executeMainFn?await(await ee(t)).delete({model:h,where:c}):m;if(f)for(const p of r||[]){const w=p[h]?.delete?.after;w&&await w(f,y)}return v}async function d(c,h,l){const y=await br();let f=[];try{f=await(await ee(t)).findMany({model:h,where:c})}catch{}for(const p of f)for(const w of r||[]){const A=w[h]?.delete?.before;if(A&&await A(p,y)===!1)return null}const m=l?await l.fn(c):null,v=!l||l.executeMainFn?await(await ee(t)).deleteMany({model:h,where:c}):m;for(const p of f)for(const w of r||[]){const A=w[h]?.delete?.after;A&&await A(p,y)}return v}return{createWithHooks:n,updateWithHooks:i,updateManyWithHooks:s,deleteWithHooks:u,deleteManyWithHooks:d}}const Yc=(t,e)=>{const r=e.logger,n=e.options,i=n.secondaryStorage,s=n.session?.expiresIn||3600*24*7,{createWithHooks:u,updateWithHooks:d,updateManyWithHooks:c,deleteWithHooks:h,deleteManyWithHooks:l}=Lp(t,e);async function y(f){if(!i)return;const m=await i.get(`active-sessions-${f.id}`);if(!m)return;const v=Date.now(),p=(Me(m)||[]).filter(w=>w.expiresAt>v);await Promise.all(p.map(async({token:w})=>{const A=await i.get(w);if(!A)return;const D=Me(A);if(!D)return;const W=Math.max(Math.floor(new Date(D.session.expiresAt).getTime()-v)/1e3,0);await i.set(w,JSON.stringify({session:D.session,user:f}),Math.floor(W))}))}return{createOAuthUser:async(f,m)=>kd(t,async()=>{const v=await u({createdAt:new Date,updatedAt:new Date,...f},"user",void 0);return{user:v,account:await u({...m,userId:v.id,createdAt:new Date,updatedAt:new Date},"account",void 0)}}),createUser:async f=>await u({createdAt:new Date,updatedAt:new Date,...f,email:f.email?.toLowerCase()},"user",void 0),createAccount:async f=>await u({createdAt:new Date,updatedAt:new Date,...f},"account",void 0),listSessions:async f=>{if(i){const m=await i.get(`active-sessions-${f}`);if(!m)return[];const v=Me(m)||[],p=Date.now(),w=v.filter(D=>D.expiresAt>p),A=[];for(const D of w){const W=await i.get(D.token);if(W){const T=Me(W);if(!T)return[];const b=bi(e.options,{...T.session,expiresAt:new Date(T.session.expiresAt)});A.push(b)}}return A}return await(await ee(t)).findMany({model:"session",where:[{field:"userId",value:f}]})},listUsers:async(f,m,v,p)=>await(await ee(t)).findMany({model:"user",limit:f,offset:m,sortBy:v,where:p}),countTotalUsers:async f=>{const m=await(await ee(t)).count({model:"user",where:f});return typeof m=="string"?parseInt(m):m},deleteUser:async f=>{i&&await i.delete(`active-sessions-${f}`),(!i||n.session?.storeSessionInDatabase)&&await l([{field:"userId",value:f}],"session",void 0),await l([{field:"userId",value:f}],"account",void 0),await h([{field:"id",value:f}],"user",void 0)},createSession:async(f,m,v,p)=>{const w=await br().catch(()=>null),A=w?.headers||w?.request?.headers,{id:D,...W}=v||{},T=Rd(w?.context.options??n,{}),b={ipAddress:(w?.request||w?.headers)&&Id(w?.request||w?.headers,w?.context.options)||"",userAgent:A?.get("user-agent")||"",...W,expiresAt:m?Mn(3600*24,"sec"):Mn(s,"sec"),userId:f,token:Vs(32),createdAt:new Date,updatedAt:new Date,...T,...p?W:{}};return await u(b,"session",i?{fn:async N=>{const S=await i.get(`active-sessions-${f}`);let E=[];const k=Date.now();S&&(E=Me(S)||[],E=E.filter(g=>g.expiresAt>k));const R=E.sort((g,I)=>g.expiresAt-I.expiresAt);let j=R.at(-1)?.expiresAt;R.push({token:b.token,expiresAt:b.expiresAt.getTime()}),(!j||j<b.expiresAt.getTime())&&(j=b.expiresAt.getTime());const M=Math.max(Math.floor((j-k)/1e3),0);M>0&&await i.set(`active-sessions-${f}`,JSON.stringify(R),M);const P=await t.findOne({model:"user",where:[{field:"id",value:f}]}),O=Math.max(Math.floor((b.expiresAt.getTime()-k)/1e3),0);return O>0&&await i.set(b.token,JSON.stringify({session:N,user:P}),O),N},executeMainFn:n.session?.storeSessionInDatabase}:void 0)},findSession:async f=>{if(i){const w=await i.get(f);if(!w&&!n.session?.storeSessionInDatabase)return null;if(w){const A=Me(w);return A?{session:bi(e.options,{...A.session,expiresAt:new Date(A.session.expiresAt),createdAt:new Date(A.session.createdAt),updatedAt:new Date(A.session.updatedAt)}),user:Ts(e.options,{...A.user,createdAt:new Date(A.user.createdAt),updatedAt:new Date(A.user.updatedAt)})}:null}}const m=await(await ee(t)).findOne({model:"session",where:[{value:f,field:"token"}],join:{user:!0}});if(!m)return null;const{user:v,...p}=m;return v?{session:bi(e.options,p),user:Ts(e.options,v)}:null},findSessions:async f=>{if(i){const v=[];for(const p of f){const w=await i.get(p);if(w){const A=Me(w);if(!A)return[];const D={session:{...A.session,expiresAt:new Date(A.session.expiresAt)},user:{...A.user,createdAt:new Date(A.user.createdAt),updatedAt:new Date(A.user.updatedAt)}};v.push(D)}}return v}const m=await(await ee(t)).findMany({model:"session",where:[{field:"token",value:f,operator:"in"}],join:{user:!0}});return m.length?m.some(v=>!v.user)?[]:m.map(v=>{const{user:p,...w}=v;return{session:w,user:p}}):[]},updateSession:async(f,m)=>await d(m,[{field:"token",value:f}],"session",i?{async fn(v){const p=await i.get(f);let w=null;if(p){const A=Me(p);return A?(w={...A.session,...v},w):null}else return null},executeMainFn:n.session?.storeSessionInDatabase}:void 0),deleteSession:async f=>{if(i){const m=await i.get(f);if(m){const{session:v}=Me(m)??{};if(!v){r.error("Session not found in secondary storage");return}const p=v.userId,w=await i.get(`active-sessions-${p}`);if(w){let A=Me(w)||[];const D=Date.now(),W=A.filter(b=>b.expiresAt>D&&b.token!==f),T=W.sort((b,N)=>b.expiresAt-N.expiresAt).at(-1)?.expiresAt;W.length>0&&T&&T>Date.now()?await i.set(`active-sessions-${p}`,JSON.stringify(W),Math.floor((T-D)/1e3)):await i.delete(`active-sessions-${p}`)}else r.error("Active sessions list not found in secondary storage")}if(await i.delete(f),!n.session?.storeSessionInDatabase||e.options.session?.preserveSessionInDatabase)return}await(await ee(t)).delete({model:"session",where:[{field:"token",value:f}]})},deleteAccounts:async f=>{await l([{field:"userId",value:f}],"account",void 0)},deleteAccount:async f=>{await h([{field:"id",value:f}],"account",void 0)},deleteSessions:async f=>{if(i){if(typeof f=="string"){const m=await i.get(`active-sessions-${f}`),v=m?Me(m):[];if(!v)return;for(const p of v)await i.delete(p.token)}else for(const m of f)await i.get(m)&&await i.delete(m);if(!n.session?.storeSessionInDatabase||e.options.session?.preserveSessionInDatabase)return}await l([{field:Array.isArray(f)?"token":"userId",value:f,operator:Array.isArray(f)?"in":void 0}],"session",void 0)},findOAuthUser:async(f,m,v)=>{const p=await(await ee(t)).findMany({model:"account",where:[{value:m,field:"accountId"}],join:{user:!0}}).then(w=>w.find(A=>A.providerId===v));if(p){if(p.user)return{user:p.user,accounts:[p]};{const w=await(await ee(t)).findOne({model:"user",where:[{value:f.toLowerCase(),field:"email"}]});return w?{user:w,accounts:[p]}:null}}else{const w=await(await ee(t)).findOne({model:"user",where:[{value:f.toLowerCase(),field:"email"}]});return w?{user:w,accounts:await(await ee(t)).findMany({model:"account",where:[{value:w.id,field:"userId"}]})||[]}:null}},findUserByEmail:async(f,m)=>{const v=await(await ee(t)).findOne({model:"user",where:[{value:f.toLowerCase(),field:"email"}],join:{...m?.includeAccounts?{account:!0}:{}}});if(!v)return null;const{account:p,...w}=v;return{user:w,accounts:p??[]}},findUserById:async f=>f?await(await ee(t)).findOne({model:"user",where:[{field:"id",value:f}]}):null,linkAccount:async f=>await u({createdAt:new Date,updatedAt:new Date,...f},"account",void 0),updateUser:async(f,m)=>{const v=await d(m,[{field:"id",value:f}],"user",void 0);return await y(v),await y(v),v},updateUserByEmail:async(f,m)=>{const v=await d(m,[{field:"email",value:f.toLowerCase()}],"user",void 0);return await y(v),await y(v),v},updatePassword:async(f,m)=>{await c({password:m},[{field:"userId",value:f},{field:"providerId",value:"credential"}],"account",void 0)},findAccounts:async f=>await(await ee(t)).findMany({model:"account",where:[{field:"userId",value:f}]}),findAccount:async f=>await(await ee(t)).findOne({model:"account",where:[{field:"accountId",value:f}]}),findAccountByProviderId:async(f,m)=>await(await ee(t)).findOne({model:"account",where:[{field:"accountId",value:f},{field:"providerId",value:m}]}),findAccountByUserId:async f=>await(await ee(t)).findMany({model:"account",where:[{field:"userId",value:f}]}),updateAccount:async(f,m)=>await d(m,[{field:"id",value:f}],"account",void 0),createVerificationValue:async f=>await u({createdAt:new Date,updatedAt:new Date,...f},"verification",void 0),findVerificationValue:async f=>{const m=await(await ee(t)).findMany({model:"verification",where:[{field:"identifier",value:f}],sortBy:{field:"createdAt",direction:"desc"},limit:1});return n.verification?.disableCleanup||await(await ee(t)).deleteMany({model:"verification",where:[{field:"expiresAt",value:new Date,operator:"lt"}]}),m[0]},deleteVerificationValue:async f=>{await(await ee(t)).delete({model:"verification",where:[{field:"id",value:f}]})},deleteVerificationByIdentifier:async f=>{await(await ee(t)).delete({model:"verification",where:[{field:"identifier",value:f}]})},updateVerificationValue:async(f,m)=>await d(m,[{field:"id",value:f}],"verification",void 0)}};function Dp(t){const e=lr(t);let r={};for(const n in e){const i=e[n],s=i.fields;let u={};if(Object.entries(s).forEach(([d,c])=>{if(u[c.fieldName||d]=c,c.references){const h=e[c.references.model];h&&(u[c.fieldName||d].references={...c.references,model:h.modelName,field:c.references.field})}}),r[i.modelName]){r[i.modelName].fields={...r[i.modelName].fields,...u};continue}r[i.modelName]={fields:u,order:i.order||1/0}}return r}const qp={postgres:{string:["character varying","varchar","text","uuid"],number:["int4","integer","bigint","smallint","numeric","real","double precision"],boolean:["bool","boolean"],date:["timestamptz","timestamp","date"],json:["json","jsonb"]},mysql:{string:["varchar","text","uuid"],number:["integer","int","bigint","smallint","decimal","float","double"],boolean:["boolean","tinyint"],date:["timestamp","datetime","date"],json:["json"]},sqlite:{string:["TEXT"],number:["INTEGER","REAL"],boolean:["INTEGER","BOOLEAN"],date:["DATE","INTEGER"],json:["TEXT"]},mssql:{string:["varchar","nvarchar","uniqueidentifier"],number:["int","bigint","smallint","decimal","float","double"],boolean:["bit","smallint"],date:["datetime2","date","datetime"],json:["varchar","nvarchar"]}};function _p(t,e,r){function n(s){return s.toLowerCase().split("(")[0].trim()}if(e==="string[]"||e==="number[]")return t.toLowerCase().includes("json");const i=qp[r];return(Array.isArray(e)?i.string.map(s=>s.toLowerCase()):i[e].map(s=>s.toLowerCase())).includes(n(t))}async function Pp(t){try{const e=await te`SHOW search_path`.execute(t);if(e.rows[0]?.search_path)return e.rows[0].search_path.split(",").map(r=>r.trim()).map(r=>r.replace(/^["']|["']$/g,"")).filter(r=>!r.startsWith("$"))[0]||"public"}catch{}return"public"}async function $p(t){const e=Dp(t),r=Pu(t.logger);let{kysely:n,databaseType:i}=await Ip(t);i||(r.warn("Could not determine database type, defaulting to sqlite. Please provide a type in the database options to avoid this."),i="sqlite"),n||(r.error("Only kysely adapter is supported for migrations. You can use `generate` command to generate the schema, if you're using a different adapter."),process.exit(1));let s="public";if(i==="postgres"){s=await Pp(n),r.debug(`PostgreSQL migration: Using schema '${s}' (from search_path)`);try{(await te`
				SELECT schema_name 
				FROM information_schema.schemata 
				WHERE schema_name = ${s}
			`.execute(n)).rows[0]||r.warn(`Schema '${s}' does not exist. Tables will be inspected from available schemas. Consider creating the schema first or checking your database configuration.`)}catch(T){r.debug(`Could not verify schema existence: ${T instanceof Error?T.message:String(T)}`)}}const u=await n.introspection.getTables();let d=u;if(i==="postgres")try{const T=await te`
				SELECT table_name 
				FROM information_schema.tables 
				WHERE table_schema = ${s}
				AND table_type = 'BASE TABLE'
			`.execute(n),b=new Set(T.rows.map(N=>N.table_name));d=u.filter(N=>N.schema===s&&b.has(N.name)),r.debug(`Found ${d.length} table(s) in schema '${s}': ${d.map(N=>N.name).join(", ")||"(none)"}`)}catch(T){r.warn(`Could not filter tables by schema. Using all discovered tables. Error: ${T instanceof Error?T.message:String(T)}`)}const c=[],h=[];for(const[T,b]of Object.entries(e)){const N=d.find(E=>E.name===T);if(!N){const E=c.findIndex(j=>j.table===T),k={table:T,fields:b.fields,order:b.order||1/0},R=c.findIndex(j=>(j.order||1/0)>k.order);R===-1?E===-1?c.push(k):c[E].fields={...c[E].fields,...b.fields}:c.splice(R,0,k);continue}let S={};for(const[E,k]of Object.entries(b.fields)){const R=N.columns.find(j=>j.name===E);if(!R){S[E]=k;continue}_p(R.dataType,k.type,i)||r.warn(`Field ${E} in table ${T} has a different type in the database. Expected ${k.type} but got ${R.dataType}.`)}Object.keys(S).length>0&&h.push({table:T,fields:S,order:b.order||1/0})}const l=[],y=t.advanced?.database?.generateId==="uuid",f=t.advanced?.database?.useNumberId||t.advanced?.database?.generateId==="serial";function m(T,b){const N=T.type,S={string:{sqlite:"text",postgres:"text",mysql:T.unique?"varchar(255)":T.references?"varchar(36)":T.sortable||T.index?"varchar(255)":"text",mssql:T.unique||T.sortable?"varchar(255)":T.references?"varchar(36)":"varchar(8000)"},boolean:{sqlite:"integer",postgres:"boolean",mysql:"boolean",mssql:"smallint"},number:{sqlite:T.bigint?"bigint":"integer",postgres:T.bigint?"bigint":"integer",mysql:T.bigint?"bigint":"integer",mssql:T.bigint?"bigint":"integer"},date:{sqlite:"date",postgres:"timestamptz",mysql:"timestamp(3)",mssql:te`datetime2(3)`},json:{sqlite:"text",postgres:"jsonb",mysql:"json",mssql:"varchar(8000)"},id:{postgres:f?te`integer GENERATED BY DEFAULT AS IDENTITY`:y?"uuid":"text",mysql:f?"integer":"varchar(36)",mssql:f?"integer":"varchar(36)",sqlite:f?"integer":"text"},foreignKeyId:{postgres:f?"integer":y?"uuid":"text",mysql:f?"integer":"varchar(36)",mssql:f?"integer":"varchar(36)",sqlite:f?"integer":"text"}};if(b==="id"||T.references?.field==="id")return b==="id"?S.id[i]:S.foreignKeyId[i];if(i==="sqlite"&&(N==="string[]"||N==="number[]"))return"text";if(N==="string[]"||N==="number[]")return"jsonb";if(Array.isArray(N))return"text";if(!(N in S))throw new Error(`Unsupported field type '${String(N)}' for field '${b}'. Allowed types are: string, number, boolean, date, string[], number[]. If you need to store structured data, store it as a JSON string (type: "string") or split it into primitive fields. See https://better-auth.com/docs/advanced/schema#additional-fields`);return S[N][i||"sqlite"]}const v=Qc({schema:lr(t),usePlural:!1}),p=Hc({schema:lr(t),usePlural:!1});function w(T,b){try{return`${v(T)}.${p({model:T,field:b})}`}catch{return`${T}.${b}`}}if(h.length)for(const T of h)for(const[b,N]of Object.entries(T.fields)){const S=m(N,b);let E=n.schema.alterTable(T.table);if(N.index){const R=n.schema.alterTable(T.table).addIndex(`${T.table}_${b}_idx`);l.push(R)}let k=E.addColumn(b,S,R=>(R=N.required!==!1?R.notNull():R,N.references&&(R=R.references(w(N.references.model,N.references.field)).onDelete(N.references.onDelete||"cascade")),N.unique&&(R=R.unique()),N.type==="date"&&typeof N.defaultValue=="function"&&(i==="postgres"||i==="mysql"||i==="mssql")&&(i==="mysql"?R=R.defaultTo(te`CURRENT_TIMESTAMP(3)`):R=R.defaultTo(te`CURRENT_TIMESTAMP`)),R));l.push(k)}let A=[];if(t.advanced?.database?.useNumberId&&r.warn("`useNumberId` is deprecated. Please use `generateId` with `serial` instead."),c.length)for(const T of c){const b=m({type:f?"number":"string"},"id");let N=n.schema.createTable(T.table).addColumn("id",b,S=>f?i==="postgres"||i==="sqlite"?S.primaryKey().notNull():i==="mssql"?S.identity().primaryKey().notNull():S.autoIncrement().primaryKey().notNull():y&&i==="postgres"?S.primaryKey().defaultTo(te`pg_catalog.gen_random_uuid()`).notNull():S.primaryKey().notNull());for(const[S,E]of Object.entries(T.fields)){const k=m(E,S);if(N=N.addColumn(S,k,R=>(R=E.required!==!1?R.notNull():R,E.references&&(R=R.references(w(E.references.model,E.references.field)).onDelete(E.references.onDelete||"cascade")),E.unique&&(R=R.unique()),E.type==="date"&&typeof E.defaultValue=="function"&&(i==="postgres"||i==="mysql"||i==="mssql")&&(i==="mysql"?R=R.defaultTo(te`CURRENT_TIMESTAMP(3)`):R=R.defaultTo(te`CURRENT_TIMESTAMP`)),R)),E.index){let R=n.schema.createIndex(`${T.table}_${S}_${E.unique?"uidx":"idx"}`).on(T.table).columns([S]);A.push(E.unique?R.unique():R)}}l.push(N)}if(A.length)for(const T of A)l.push(T);async function D(){for(const T of l)await T.execute()}async function W(){return l.map(T=>T.compile().sql).join(`;

`)+";"}return{toBeCreated:c,toBeAdded:h,runMigrations:D,compileMigrations:W}}async function Wp(t,e){const r=(await e.context.internalAdapter.findAccounts(t))?.find(i=>i.providerId==="credential"),n=r?.password;if(!r||!n||!e.body.password)throw new V("BAD_REQUEST",{message:"No password credential found"});if(!await e.context.password.verify({hash:n,password:e.body.password}))throw new V("BAD_REQUEST",{message:"Invalid password"});return!0}var Up=Object.defineProperty,Mp=Object.defineProperties,jp=Object.getOwnPropertyDescriptors,Ra=Object.getOwnPropertySymbols,Fp=Object.prototype.hasOwnProperty,Vp=Object.prototype.propertyIsEnumerable,Ia=(t,e,r)=>e in t?Up(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,zt=(t,e)=>{for(var r in e||(e={}))Fp.call(e,r)&&Ia(t,r,e[r]);if(Ra)for(var r of Ra(e))Vp.call(e,r)&&Ia(t,r,e[r]);return t},Kt=(t,e)=>Mp(t,jp(e)),Bp=class extends Error{constructor(t,e,r){super(e||t.toString(),{cause:r}),this.status=t,this.statusText=e,this.error=r}},Jp=async(t,e)=>{var r,n,i,s,u,d;let c=e||{};const h={onRequest:[e?.onRequest],onResponse:[e?.onResponse],onSuccess:[e?.onSuccess],onError:[e?.onError],onRetry:[e?.onRetry]};if(!e||!e?.plugins)return{url:t,options:c,hooks:h};for(const l of e?.plugins||[]){if(l.init){const y=await((r=l.init)==null?void 0:r.call(l,t.toString(),e));c=y.options||c,t=y.url}h.onRequest.push((n=l.hooks)==null?void 0:n.onRequest),h.onResponse.push((i=l.hooks)==null?void 0:i.onResponse),h.onSuccess.push((s=l.hooks)==null?void 0:s.onSuccess),h.onError.push((u=l.hooks)==null?void 0:u.onError),h.onRetry.push((d=l.hooks)==null?void 0:d.onRetry)}return{url:t,options:c,hooks:h}},ka=class{constructor(t){this.options=t}shouldAttemptRetry(t,e){return this.options.shouldRetry?Promise.resolve(t<this.options.attempts&&this.options.shouldRetry(e)):Promise.resolve(t<this.options.attempts)}getDelay(){return this.options.delay}},Gp=class{constructor(t){this.options=t}shouldAttemptRetry(t,e){return this.options.shouldRetry?Promise.resolve(t<this.options.attempts&&this.options.shouldRetry(e)):Promise.resolve(t<this.options.attempts)}getDelay(t){return Math.min(this.options.maxDelay,this.options.baseDelay*2**t)}};function Hp(t){if(typeof t=="number")return new ka({type:"linear",attempts:t,delay:1e3});switch(t.type){case"linear":return new ka(t);case"exponential":return new Gp(t);default:throw new Error("Invalid retry strategy")}}var Qp=async t=>{const e={},r=async n=>typeof n=="function"?await n():n;if(t?.auth){if(t.auth.type==="Bearer"){const n=await r(t.auth.token);if(!n)return e;e.authorization=`Bearer ${n}`}else if(t.auth.type==="Basic"){const n=r(t.auth.username),i=r(t.auth.password);if(!n||!i)return e;e.authorization=`Basic ${btoa(`${n}:${i}`)}`}else if(t.auth.type==="Custom"){const n=r(t.auth.value);if(!n)return e;e.authorization=`${r(t.auth.prefix)} ${n}`}}return e},Yp=/^application\/(?:[\w!#$%&*.^`~-]*\+)?json(;.+)?$/i;function zp(t){const e=t.headers.get("content-type"),r=new Set(["image/svg","application/xml","application/xhtml","application/html"]);if(!e)return"json";const n=e.split(";").shift()||"";return Yp.test(n)?"json":r.has(n)||n.startsWith("text/")?"text":"blob"}function Kp(t){try{return JSON.parse(t),!0}catch{return!1}}function zc(t){if(t===void 0)return!1;const e=typeof t;return e==="string"||e==="number"||e==="boolean"||e===null?!0:e!=="object"?!1:Array.isArray(t)?!0:t.buffer?!1:t.constructor&&t.constructor.name==="Object"||typeof t.toJSON=="function"}function Ca(t){try{return JSON.parse(t)}catch{return t}}function La(t){return typeof t=="function"}function Xp(t){if(t?.customFetchImpl)return t.customFetchImpl;if(typeof globalThis<"u"&&La(globalThis.fetch))return globalThis.fetch;if(typeof window<"u"&&La(window.fetch))return window.fetch;throw new Error("No fetch implementation found")}async function Zp(t){const e=new Headers(t?.headers),r=await Qp(t);for(const[n,i]of Object.entries(r||{}))e.set(n,i);if(!e.has("content-type")){const n=em(t?.body);n&&e.set("content-type",n)}return e}function em(t){return zc(t)?"application/json":null}function tm(t){if(!t?.body)return null;const e=new Headers(t?.headers);if(zc(t.body)&&!e.has("content-type")){for(const[r,n]of Object.entries(t?.body))n instanceof Date&&(t.body[r]=n.toISOString());return JSON.stringify(t.body)}return t.body}function rm(t,e){var r;if(e?.method)return e.method.toUpperCase();if(t.startsWith("@")){const n=(r=t.split("@")[1])==null?void 0:r.split("/")[0];return Xc.includes(n)?n.toUpperCase():e?.body?"POST":"GET"}return e?.body?"POST":"GET"}function nm(t,e){let r;return!t?.signal&&t?.timeout&&(r=setTimeout(()=>e?.abort(),t?.timeout)),{abortTimeout:r,clearTimeout:()=>{r&&clearTimeout(r)}}}var im=class Kc extends Error{constructor(e,r){super(r||JSON.stringify(e,null,2)),this.issues=e,Object.setPrototypeOf(this,Kc.prototype)}};async function sm(t,e){let r=await t["~standard"].validate(e);if(r.issues)throw new im(r.issues);return r.value}var Xc=["get","post","put","patch","delete"];function om(t,e){let{baseURL:r,params:n,query:i}=e||{query:{},params:{},baseURL:""},s=t.startsWith("http")?t.split("/").slice(0,3).join("/"):r||"";if(t.startsWith("@")){const y=t.toString().split("@")[1].split("/")[0];Xc.includes(y)&&(t=t.replace(`@${y}/`,"/"))}s.endsWith("/")||(s+="/");let[u,d]=t.replace(s,"").split("?");const c=new URLSearchParams(d);for(const[y,f]of Object.entries(i||{}))f!=null&&c.set(y,String(f));if(n)if(Array.isArray(n)){const y=u.split("/").filter(f=>f.startsWith(":"));for(const[f,m]of y.entries()){const v=n[f];u=u.replace(m,v)}}else for(const[y,f]of Object.entries(n))u=u.replace(`:${y}`,String(f));u=u.split("/").map(encodeURIComponent).join("/"),u.startsWith("/")&&(u=u.slice(1));let h=c.toString();return h=h.length>0?`?${h}`.replace(/\+/g,"%20"):"",s.startsWith("http")?new URL(`${u}${h}`,s):`${s}${u}${h}`}var Zc=async(t,e)=>{var r,n,i,s,u,d,c,h;const{hooks:l,url:y,options:f}=await Jp(t,e),m=Xp(f),v=new AbortController,p=(r=f.signal)!=null?r:v.signal,w=om(y,f),A=tm(f),D=await Zp(f),W=rm(y,f);let T=Kt(zt({},f),{url:w,headers:D,body:A,method:W,signal:p});for(const P of l.onRequest)if(P){const O=await P(T);O instanceof Object&&(T=O)}("pipeTo"in T&&typeof T.pipeTo=="function"||typeof((n=e?.body)==null?void 0:n.pipe)=="function")&&("duplex"in T||(T.duplex="half"));const{clearTimeout:b}=nm(f,v);let N=await m(T.url,T);b();const S={response:N,request:T};for(const P of l.onResponse)if(P){const O=await P(Kt(zt({},S),{response:(i=e?.hookOptions)!=null&&i.cloneResponse?N.clone():N}));O instanceof Response?N=O:O instanceof Object&&(N=O.response)}if(N.ok){if(!(T.method!=="HEAD"))return{data:"",error:null};const O=zp(N),g={data:"",response:N,request:T};if(O==="json"||O==="text"){const I=await N.text(),_=await((s=T.jsonParser)!=null?s:Ca)(I);g.data=_}else g.data=await N[O]();T?.output&&T.output&&!T.disableValidation&&(g.data=await sm(T.output,g.data));for(const I of l.onSuccess)I&&await I(Kt(zt({},g),{response:(u=e?.hookOptions)!=null&&u.cloneResponse?N.clone():N}));return e?.throw?g.data:{data:g.data,error:null}}const E=(d=e?.jsonParser)!=null?d:Ca,k=await N.text(),R=Kp(k),j=R?await E(k):null,M={response:N,responseText:k,request:T,error:Kt(zt({},j),{status:N.status,statusText:N.statusText})};for(const P of l.onError)P&&await P(Kt(zt({},M),{response:(c=e?.hookOptions)!=null&&c.cloneResponse?N.clone():N}));if(e?.retry){const P=Hp(e.retry),O=(h=e.retryAttempt)!=null?h:0;if(await P.shouldAttemptRetry(O,N)){for(const I of l.onRetry)I&&await I(S);const g=P.getDelay(O);return await new Promise(I=>setTimeout(I,g)),await Zc(t,Kt(zt({},e),{retryAttempt:O+1}))}}if(e?.throw)throw new Bp(N.status,N.statusText,R?j:k);return{data:null,error:Kt(zt({},j),{status:N.status,statusText:N.statusText})}};function am(t,e){return{database:e?.database,adapter:e?.adapter,emailVerification:{sendVerificationEmail:!!t.emailVerification?.sendVerificationEmail,sendOnSignUp:!!t.emailVerification?.sendOnSignUp,sendOnSignIn:!!t.emailVerification?.sendOnSignIn,autoSignInAfterVerification:!!t.emailVerification?.autoSignInAfterVerification,expiresIn:t.emailVerification?.expiresIn,onEmailVerification:!!t.emailVerification?.onEmailVerification,afterEmailVerification:!!t.emailVerification?.afterEmailVerification},emailAndPassword:{enabled:!!t.emailAndPassword?.enabled,disableSignUp:!!t.emailAndPassword?.disableSignUp,requireEmailVerification:!!t.emailAndPassword?.requireEmailVerification,maxPasswordLength:t.emailAndPassword?.maxPasswordLength,minPasswordLength:t.emailAndPassword?.minPasswordLength,sendResetPassword:!!t.emailAndPassword?.sendResetPassword,resetPasswordTokenExpiresIn:t.emailAndPassword?.resetPasswordTokenExpiresIn,onPasswordReset:!!t.emailAndPassword?.onPasswordReset,password:{hash:!!t.emailAndPassword?.password?.hash,verify:!!t.emailAndPassword?.password?.verify},autoSignIn:!!t.emailAndPassword?.autoSignIn,revokeSessionsOnPasswordReset:!!t.emailAndPassword?.revokeSessionsOnPasswordReset},socialProviders:Object.keys(t.socialProviders||{}).map(r=>{const n=t.socialProviders?.[r];return n?{id:r,mapProfileToUser:!!n.mapProfileToUser,disableDefaultScope:!!n.disableDefaultScope,disableIdTokenSignIn:!!n.disableIdTokenSignIn,disableImplicitSignUp:n.disableImplicitSignUp,disableSignUp:n.disableSignUp,getUserInfo:!!n.getUserInfo,overrideUserInfoOnSignIn:!!n.overrideUserInfoOnSignIn,prompt:n.prompt,verifyIdToken:!!n.verifyIdToken,scope:n.scope,refreshAccessToken:!!n.refreshAccessToken}:{}}),plugins:t.plugins?.map(r=>r.id.toString()),user:{modelName:t.user?.modelName,fields:t.user?.fields,additionalFields:t.user?.additionalFields,changeEmail:{enabled:t.user?.changeEmail?.enabled,sendChangeEmailVerification:!!t.user?.changeEmail?.sendChangeEmailVerification}},verification:{modelName:t.verification?.modelName,disableCleanup:t.verification?.disableCleanup,fields:t.verification?.fields},session:{modelName:t.session?.modelName,additionalFields:t.session?.additionalFields,cookieCache:{enabled:t.session?.cookieCache?.enabled,maxAge:t.session?.cookieCache?.maxAge,strategy:t.session?.cookieCache?.strategy},disableSessionRefresh:t.session?.disableSessionRefresh,expiresIn:t.session?.expiresIn,fields:t.session?.fields,freshAge:t.session?.freshAge,preserveSessionInDatabase:t.session?.preserveSessionInDatabase,storeSessionInDatabase:t.session?.storeSessionInDatabase,updateAge:t.session?.updateAge},account:{modelName:t.account?.modelName,fields:t.account?.fields,encryptOAuthTokens:t.account?.encryptOAuthTokens,updateAccountOnSignIn:t.account?.updateAccountOnSignIn,accountLinking:{enabled:t.account?.accountLinking?.enabled,trustedProviders:t.account?.accountLinking?.trustedProviders,updateUserInfoOnLink:t.account?.accountLinking?.updateUserInfoOnLink,allowUnlinkingAll:t.account?.accountLinking?.allowUnlinkingAll}},hooks:{after:!!t.hooks?.after,before:!!t.hooks?.before},secondaryStorage:!!t.secondaryStorage,advanced:{cookiePrefix:!!t.advanced?.cookiePrefix,cookies:!!t.advanced?.cookies,crossSubDomainCookies:{domain:!!t.advanced?.crossSubDomainCookies?.domain,enabled:t.advanced?.crossSubDomainCookies?.enabled,additionalCookies:t.advanced?.crossSubDomainCookies?.additionalCookies},database:{useNumberId:!!t.advanced?.database?.useNumberId||t.advanced?.database?.generateId==="serial",generateId:t.advanced?.database?.generateId,defaultFindManyLimit:t.advanced?.database?.defaultFindManyLimit},useSecureCookies:t.advanced?.useSecureCookies,ipAddress:{disableIpTracking:t.advanced?.ipAddress?.disableIpTracking,ipAddressHeaders:t.advanced?.ipAddress?.ipAddressHeaders},disableCSRFCheck:t.advanced?.disableCSRFCheck,cookieAttributes:{expires:t.advanced?.defaultCookieAttributes?.expires,secure:t.advanced?.defaultCookieAttributes?.secure,sameSite:t.advanced?.defaultCookieAttributes?.sameSite,domain:!!t.advanced?.defaultCookieAttributes?.domain,path:t.advanced?.defaultCookieAttributes?.path,httpOnly:t.advanced?.defaultCookieAttributes?.httpOnly}},trustedOrigins:t.trustedOrigins?.length,rateLimit:{storage:t.rateLimit?.storage,modelName:t.rateLimit?.modelName,window:t.rateLimit?.window,customStorage:!!t.rateLimit?.customStorage,enabled:t.rateLimit?.enabled,max:t.rateLimit?.max},onAPIError:{errorURL:t.onAPIError?.errorURL,onError:!!t.onAPIError?.onError,throw:t.onAPIError?.throw},logger:{disabled:t.logger?.disabled,level:t.logger?.level,log:!!t.logger?.log},databaseHooks:{user:{create:{after:!!t.databaseHooks?.user?.create?.after,before:!!t.databaseHooks?.user?.create?.before},update:{after:!!t.databaseHooks?.user?.update?.after,before:!!t.databaseHooks?.user?.update?.before}},session:{create:{after:!!t.databaseHooks?.session?.create?.after,before:!!t.databaseHooks?.session?.create?.before},update:{after:!!t.databaseHooks?.session?.update?.after,before:!!t.databaseHooks?.session?.update?.before}},account:{create:{after:!!t.databaseHooks?.account?.create?.after,before:!!t.databaseHooks?.account?.create?.before},update:{after:!!t.databaseHooks?.account?.update?.after,before:!!t.databaseHooks?.account?.update?.before}},verification:{create:{after:!!t.databaseHooks?.verification?.create?.after,before:!!t.databaseHooks?.verification?.create?.before},update:{after:!!t.databaseHooks?.verification?.update?.after,before:!!t.databaseHooks?.verification?.update?.before}}}}}let jt;async function ed(){if(jt)return jt;try{const t=typeof process<"u"&&typeof process.cwd=="function"?process.cwd():"";if(!t)return;const e=s=>Function("mm","return import(mm)")(s),[{default:r},{default:n}]=await Promise.all([e("fs/promises"),e("path")]),i=await r.readFile(n.join(t,"package.json"),"utf-8");return jt=JSON.parse(i),jt}catch{}}async function td(t){if(jt)return jt.dependencies?.[t]||jt.devDependencies?.[t]||jt.peerDependencies?.[t];try{const e=typeof process<"u"&&typeof process.cwd=="function"?process.cwd():"";if(!e)throw new Error("no-cwd");const r=d=>Function("mm","return import(mm)")(d),[{default:n},{default:i}]=await Promise.all([r("fs/promises"),r("path")]),s=i.join(e,"node_modules",t,"package.json"),u=await n.readFile(s,"utf-8");return JSON.parse(u).version||await Da(t)||void 0}catch{}return await Da(t)}async function Da(t){const e=await ed();if(e)return{...e.dependencies,...e.devDependencies,...e.peerDependencies}[t]}async function um(){return(await ed())?.name}const cm={pg:"postgresql",mysql:"mysql",mariadb:"mariadb",sqlite3:"sqlite","better-sqlite3":"sqlite","@prisma/client":"prisma",mongoose:"mongodb",mongodb:"mongodb","drizzle-orm":"drizzle"};async function dm(){for(const[t,e]of Object.entries(cm)){const r=await td(t);if(r)return{name:e,version:r}}}const lm={next:"next",nuxt:"nuxt","@remix-run/server-runtime":"remix",astro:"astro","@sveltejs/kit":"sveltekit","solid-start":"solid-start","tanstack-start":"tanstack-start",hono:"hono",express:"express",elysia:"elysia",expo:"expo"};async function hm(){for(const[t,e]of Object.entries(lm)){const r=await td(t);if(r)return{name:e,version:r}}}function fm(){const t=ke.npm_config_user_agent;if(!t)return;const e=t.split(" ")[0],r=e.lastIndexOf("/"),n=e.substring(0,r);return{name:n==="npminstall"?"cnpm":n,version:e.substring(r+1)}}const Lr=t=>Function("mm","return import(mm)")(t);function hr(){const t=(...e)=>e.some(r=>!!ke[r]);return t("CF_PAGES","CF_PAGES_URL","CF_ACCOUNT_ID")||typeof navigator<"u"&&navigator.userAgent==="Cloudflare-Workers"?"cloudflare":t("VERCEL","VERCEL_URL","VERCEL_ENV")?"vercel":t("NETLIFY","NETLIFY_URL")?"netlify":t("RENDER","RENDER_URL","RENDER_INTERNAL_HOSTNAME","RENDER_SERVICE_ID")?"render":t("AWS_LAMBDA_FUNCTION_NAME","AWS_EXECUTION_ENV","LAMBDA_TASK_ROOT")?"aws":t("GOOGLE_CLOUD_FUNCTION_NAME","GOOGLE_CLOUD_PROJECT","GCP_PROJECT","K_SERVICE")?"gcp":t("AZURE_FUNCTION_NAME","FUNCTIONS_WORKER_RUNTIME","WEBSITE_INSTANCE_ID","WEBSITE_SITE_NAME")?"azure":t("DENO_DEPLOYMENT_ID","DENO_REGION")?"deno-deploy":t("FLY_APP_NAME","FLY_REGION","FLY_ALLOC_ID")?"fly-io":t("RAILWAY_STATIC_URL","RAILWAY_ENVIRONMENT_NAME")?"railway":t("DYNO","HEROKU_APP_NAME")?"heroku":t("DO_DEPLOYMENT_ID","DO_APP_NAME","DIGITALOCEAN")?"digitalocean":t("KOYEB","KOYEB_DEPLOYMENT_ID","KOYEB_APP_NAME")?"koyeb":null}async function pm(){try{if(hr()==="cloudflare")return"cloudflare";const t=await Lr("os"),e=t.cpus();return{deploymentVendor:hr(),systemPlatform:t.platform(),systemRelease:t.release(),systemArchitecture:t.arch(),cpuCount:e.length,cpuModel:e.length?e[0].model:null,cpuSpeed:e.length?e[0].speed:null,memory:t.totalmem(),isWSL:await wm(),isDocker:await rd(),isTTY:typeof process<"u"&&process.stdout?process.stdout.isTTY:null}}catch{return{systemPlatform:null,systemRelease:null,systemArchitecture:null,cpuCount:null,cpuModel:null,cpuSpeed:null,memory:null,isWSL:null,isDocker:null,isTTY:null}}}let Ii;async function mm(){if(hr()==="cloudflare")return!1;try{return(await Lr("fs")).statSync("/.dockerenv"),!0}catch{return!1}}async function ym(){if(hr()==="cloudflare")return!1;try{return(await Lr("fs")).readFileSync("/proc/self/cgroup","utf8").includes("docker")}catch{return!1}}async function rd(){return hr()==="cloudflare"?!1:(Ii===void 0&&(Ii=await mm()||await ym()),Ii)}async function wm(){try{if(hr()==="cloudflare"||typeof process>"u"||process?.platform!=="linux")return!1;const t=await Lr("fs");return(await Lr("os")).release().toLowerCase().includes("microsoft")?!await qa():t.readFileSync("/proc/version","utf8").toLowerCase().includes("microsoft")?!await qa():!1}catch{return!1}}let ki;const Nm=async()=>{if(hr()==="cloudflare")return!1;try{return(await Lr("fs")).statSync("/run/.containerenv"),!0}catch{return!1}};async function qa(){return ki===void 0&&(ki=await Nm()||await rd()),ki}function gm(){return ke.CI!=="false"&&("BUILD_ID"in ke||"BUILD_NUMBER"in ke||"CI"in ke||"CI_APP_ID"in ke||"CI_BUILD_ID"in ke||"CI_BUILD_NUMBER"in ke||"CI_NAME"in ke||"CONTINUOUS_INTEGRATION"in ke||"RUN_ID"in ke)}function bm(){return typeof Deno<"u"?{name:"deno",version:Deno?.version?.deno??null}:typeof Bun<"u"?{name:"bun",version:Bun?.version??null}:typeof process<"u"&&process?.versions?.node?{name:"node",version:process.versions.node??null}:{name:"edge",version:null}}function vm(){return Ld("NODE_ENV")==="production"?"production":gm()?"ci":ri()?"test":"development"}async function _a(t){const e=await $u("SHA-256").digest(t);return Dd.encode(e)}const Em=t=>qd("a-z","A-Z","0-9")(t);let It=null;async function Pa(t){if(It)return It;const e=await um();return e?(It=await _a(t?t+e:e),It):t?(It=await _a(t),It):(It=Em(32),It)}async function Om(t,e){const r=t.telemetry?.debug||Po("BETTER_AUTH_TELEMETRY_DEBUG",!1),n=Cd.BETTER_AUTH_TELEMETRY_ENDPOINT,i=async c=>{e?.customTrack?await e.customTrack(c).catch(tt.error):r?tt.info("telemetry event",JSON.stringify(c,null,2)):await Zc(n,{method:"POST",body:c}).catch(tt.error)},u=await(async()=>{const c=t.telemetry?.enabled!==void 0?t.telemetry.enabled:!1;return(Po("BETTER_AUTH_TELEMETRY",!1)||c)&&(e?.skipTestCheck||!ri())})();let d;return u&&(d=await Pa(t.baseURL),i({type:"init",payload:{config:am(t,e),runtime:bm(),database:await dm(),framework:await hm(),environment:vm(),systemInfo:await pm(),packageManager:fm()},anonymousId:d})),{publish:async c=>{u&&(d||(d=await Pa(t.baseURL)),await i({type:c.type,payload:c.payload,anonymousId:d}))}}}const nd="better-auth-secret-12345678901234567890";function id(t){return!!t&&(typeof t=="object"||typeof t=="function")&&typeof t.then=="function"}async function Am(t){let e=t.options;const r=e.plugins||[];let n=t;const i=[];for(const s of r)if(s.init){let u=s.init(n),d;if(id(u)?d=await u:d=u,typeof d=="object"){if(d.options){const{databaseHooks:c,...h}=d.options;c&&i.push(c),e=Wu(e,h)}d.context&&(n={...n,...d.context})}}return i.push(e.databaseHooks),n.internalAdapter=Yc(n.adapter,{options:e,logger:n.logger,hooks:i.filter(s=>s!==void 0),generateId:n.generateId}),n.options=e,{context:n}}function Tm(t){const e=[];return t.advanced?.crossSubDomainCookies?.enabled,e}function Sm(t){const e=Bs(t.baseURL,t.basePath);if(!e)return[];const r=[new URL(e).origin];t.trustedOrigins&&Array.isArray(t.trustedOrigins)&&r.push(...t.trustedOrigins);const n=ke.BETTER_AUTH_TRUSTED_ORIGINS;if(n&&r.push(...n.split(",")),r.filter(i=>!i).length)throw new Ce("A provided trusted origin is invalid, make sure your trusted origins list is properly defined.");return r}function xm(t){const e=new Set(t).size;return e===0?0:Math.log2(Math.pow(e,t.length))}function Rm(t,e){const r=t===nd;if(!ri()){if(r&&Uu)throw new Ce("You are using the default secret. Please set `BETTER_AUTH_SECRET` in your environment variables or pass `secret` in your auth config.");if(t.length<32)throw new Ce("Invalid BETTER_AUTH_SECRET: must be at least 32 characters long for adequate security. Generate one with `npx @better-auth/cli secret` or `openssl rand -base64 32`.");xm(t)<120&&e.warn("[better-auth] Warning: your BETTER_AUTH_SECRET appears low-entropy. Use a randomly generated secret for production.")}}async function Im(t,e,r){e.database||(e=Wu(e,{session:{cookieCache:{enabled:!0,strategy:"jwe",refreshCache:!0}},account:{storeStateStrategy:"cookie",storeAccountCookie:!0}}));const n=e.plugins||[],i=Tm(e),s=Pu(e.logger),u=Bs(e.baseURL,e.basePath),d=e.secret||ke.BETTER_AUTH_SECRET||ke.AUTH_SECRET||nd;Rm(d,s),e={...e,secret:d,baseURL:u?new URL(u).origin:"",basePath:e.basePath||"/api/auth",plugins:n.concat(i)},Ud(e,s);const c=Md(e),h=lr(e),l=Object.entries(e.socialProviders||{}).map(([p,w])=>{if(w==null||w.enabled===!1)return null;w.clientId||s.warn(`Social provider ${p} is missing clientId or clientSecret`);const A=jd[p](w);return A.disableImplicitSignUp=w.disableImplicitSignUp,A}).filter(p=>p!==null),y=({model:p,size:w})=>typeof e.advanced?.generateId=="function"?e.advanced.generateId({model:p,size:w}):typeof e?.advanced?.database?.generateId=="function"?e.advanced.database.generateId({model:p,size:w}):Vs(w),{publish:f}=await Om(e,{adapter:t.id,database:typeof e.database=="function"?"adapter":r(e.database)}),m=Am({appName:e.appName||"Better Auth",socialProviders:l,options:e,oauthConfig:{storeStateStrategy:e.account?.storeStateStrategy||"database",skipStateCookieCheck:!!e.account?.skipStateCookieCheck},tables:h,trustedOrigins:Sm(e),baseURL:u||"",sessionConfig:{updateAge:e.session?.updateAge!==void 0?e.session.updateAge:1440*60,expiresIn:e.session?.expiresIn||3600*24*7,freshAge:e.session?.freshAge===void 0?3600*24:e.session.freshAge,cookieRefreshCache:(()=>{const p=e.session?.cookieCache?.refreshCache,w=e.session?.cookieCache?.maxAge||300;return p===!1||p===void 0?!1:p===!0?{enabled:!0,updateAge:Math.floor(w*.2)}:{enabled:!0,updateAge:p.updateAge!==void 0?p.updateAge:Math.floor(w*.2)}})()},secret:d,rateLimit:{...e.rateLimit,enabled:e.rateLimit?.enabled??Uu,window:e.rateLimit?.window||10,max:e.rateLimit?.max||100,storage:e.rateLimit?.storage||(e.secondaryStorage?"secondary-storage":"memory")},authCookies:c,logger:s,generateId:y,session:null,secondaryStorage:e.secondaryStorage,password:{hash:e.emailAndPassword?.password?.hash||Bd,verify:e.emailAndPassword?.password?.verify||Vd,config:{minPasswordLength:e.emailAndPassword?.minPasswordLength||8,maxPasswordLength:e.emailAndPassword?.maxPasswordLength||128},checkPassword:Wp},setNewSession(p){this.newSession=p},newSession:null,adapter:t,internalAdapter:Yc(t,{options:e,logger:s,hooks:e.databaseHooks?[e.databaseHooks]:[]}),createAuthCookie:Fd(e),async runMigrations(){throw new Ce("runMigrations will be set by the specific init implementation")},publishTelemetry:f,skipCSRFCheck:!!e.advanced?.disableCSRFCheck,skipOriginCheck:e.advanced?.disableOriginCheck!==void 0?e.advanced.disableOriginCheck:!!ri()});let v;return id(m)?{context:v}=await m:{context:v}=m,v}const km=(t,e)=>{const r=e(t),{api:n}=_d(r,t);return{handler:async i=>{const s=await r,u=s.options.basePath||"/api/auth";if(!s.options.baseURL){const c=Bs(void 0,u,i,void 0,s.options.advanced?.trustedProxyHeaders);if(c)s.baseURL=c,s.options.baseURL=Pd(s.baseURL)||void 0;else throw new Ce("Could not get base URL from request. Please provide a valid base URL.")}s.trustedOrigins=[...t.trustedOrigins?Array.isArray(t.trustedOrigins)?t.trustedOrigins:await t.trustedOrigins(i):[],s.options.baseURL];const{handler:d}=$d(s,t);return Wd(s.adapter,()=>d(i))},api:n,options:t,$context:r,$ERROR_CODES:{...t.plugins?.reduce((i,s)=>s.$ERROR_CODES?{...i,...s.$ERROR_CODES}:i,{}),...vr}}},Cm=async t=>{const e=await Cp(t),n=await Im(e,t,i=>Eo(i)||"unknown");return n.runMigrations=async function(){if(!t.database||"updateMany"in t.database)throw new Ce("Database is not provided or it's an adapter. Migrations are only supported with a database instance.");const{runMigrations:i}=await $p(t);await i()},n},Lm=t=>km(t,Cm),Dm=async t=>{const e=t.context.returned;return e?e instanceof Response?e.status!==200?null:await e.clone().json():e instanceof V?null:e:null},me=Gd({FAILED_TO_CREATE_USER:"Failed to create user",USER_ALREADY_EXISTS:"User already exists.",USER_ALREADY_EXISTS_USE_ANOTHER_EMAIL:"User already exists. Use another email.",YOU_CANNOT_BAN_YOURSELF:"You cannot ban yourself",YOU_ARE_NOT_ALLOWED_TO_CHANGE_USERS_ROLE:"You are not allowed to change users role",YOU_ARE_NOT_ALLOWED_TO_CREATE_USERS:"You are not allowed to create users",YOU_ARE_NOT_ALLOWED_TO_LIST_USERS:"You are not allowed to list users",YOU_ARE_NOT_ALLOWED_TO_LIST_USERS_SESSIONS:"You are not allowed to list users sessions",YOU_ARE_NOT_ALLOWED_TO_BAN_USERS:"You are not allowed to ban users",YOU_ARE_NOT_ALLOWED_TO_IMPERSONATE_USERS:"You are not allowed to impersonate users",YOU_ARE_NOT_ALLOWED_TO_REVOKE_USERS_SESSIONS:"You are not allowed to revoke users sessions",YOU_ARE_NOT_ALLOWED_TO_DELETE_USERS:"You are not allowed to delete users",YOU_ARE_NOT_ALLOWED_TO_SET_USERS_PASSWORD:"You are not allowed to set users password",BANNED_USER:"You have been banned from this application",YOU_ARE_NOT_ALLOWED_TO_GET_USER:"You are not allowed to get user",NO_DATA_TO_UPDATE:"No data to update",YOU_ARE_NOT_ALLOWED_TO_UPDATE_USERS:"You are not allowed to update users",YOU_CANNOT_REMOVE_YOURSELF:"You cannot remove yourself",YOU_ARE_NOT_ALLOWED_TO_SET_NON_EXISTENT_VALUE:"You are not allowed to set a non-existent role value"}),qm={user:{fields:{role:{type:"string",required:!1,input:!1},banned:{type:"boolean",defaultValue:!1,required:!1,input:!1},banReason:{type:"string",required:!1,input:!1},banExpires:{type:"date",required:!1,input:!1}}},session:{fields:{impersonatedBy:{type:"string",required:!1}}}};function Ci(t){return Array.isArray(t)?t.join(","):t}const _m=t=>{const e={defaultRole:"user",adminRoles:["admin"],bannedUserMessage:"You have been banned from this application. Please contact support if you believe this is an error.",...t},r=Ft(async n=>{const i=await En(n);if(!i)throw new V("UNAUTHORIZED");return{session:i}});return{id:"admin",init(){return{options:{databaseHooks:{user:{create:{async before(n){return{data:{role:"user",...n}}}}},session:{create:{async before(n,i){if(!i)return;const s=await i.context.internalAdapter.findUserById(n.userId);if(s.banned){if(s.banExpires&&new Date(s.banExpires).getTime()<Date.now()){await i.context.internalAdapter.updateUser(n.userId,{banned:!1,banReason:null,banExpires:null});return}if(i&&(i.path.startsWith("/callback")||i.path.startsWith("/oauth2/callback"))){const u=i.context.options.onAPIError?.errorURL||`${i.context.baseURL}/error`;throw i.redirect(`${u}?error=banned&error_description=${e.bannedUserMessage}`)}throw new V("FORBIDDEN",{message:e.bannedUserMessage,code:"BANNED_USER"})}}}}}}}},hooks:{after:[{matcher(n){return n.path==="/list-sessions"},handler:Ft(async n=>{const i=await Dm(n);if(!i)return;const s=i.filter(u=>!u.impersonatedBy);return n.json(s)})}]},endpoints:{setRole:ye("/admin/set-role",{method:"POST",body:Se({userId:st().meta({description:"The user id"}),role:vi([he().meta({description:"The role to set. `admin` or `user` by default"}),An(he().meta({description:"The roles to set. `admin` or `user` by default"}))]).meta({description:"The role to set, this can be a string or an array of strings. Eg: `admin` or `[admin, user]`"})}),requireHeaders:!0,use:[r],metadata:{openapi:{operationId:"setUserRole",summary:"Set the role of a user",description:"Set the role of a user",responses:{200:{description:"User role updated",content:{"application/json":{schema:{type:"object",properties:{user:{$ref:"#/components/schemas/User"}}}}}}}},$Infer:{body:{}}}},async n=>{if(!qe({userId:n.context.session.user.id,role:n.context.session.user.role,options:e,permissions:{user:["set-role"]}}))throw new V("FORBIDDEN",{message:me.YOU_ARE_NOT_ALLOWED_TO_CHANGE_USERS_ROLE});const i=e.roles;if(i){const u=Array.isArray(n.body.role)?n.body.role:[n.body.role];for(const d of u)if(!i[d])throw new V("BAD_REQUEST",{message:me.YOU_ARE_NOT_ALLOWED_TO_SET_NON_EXISTENT_VALUE})}const s=await n.context.internalAdapter.updateUser(n.body.userId,{role:Ci(n.body.role)});return n.json({user:s})}),getUser:ye("/admin/get-user",{method:"GET",query:Se({id:he().meta({description:"The id of the User"})}),use:[r],metadata:{openapi:{operationId:"getUser",summary:"Get an existing user",description:"Get an existing user",responses:{200:{description:"User",content:{"application/json":{schema:{type:"object",properties:{user:{$ref:"#/components/schemas/User"}}}}}}}}}},async n=>{const{id:i}=n.query;if(!qe({userId:n.context.session.user.id,role:n.context.session.user.role,options:e,permissions:{user:["get"]}}))throw n.error("FORBIDDEN",{message:me.YOU_ARE_NOT_ALLOWED_TO_GET_USER,code:"YOU_ARE_NOT_ALLOWED_TO_GET_USER"});const s=await n.context.internalAdapter.findUserById(i);if(!s)throw new V("NOT_FOUND",{message:vr.USER_NOT_FOUND});return Ts(n.context.options,s)}),createUser:ye("/admin/create-user",{method:"POST",body:Se({email:he().meta({description:"The email of the user"}),password:he().meta({description:"The password of the user"}),name:he().meta({description:"The name of the user"}),role:vi([he().meta({description:"The role of the user"}),An(he().meta({description:"The roles of user"}))]).optional().meta({description:'A string or array of strings representing the roles to apply to the new user. Eg: "user"'}),data:On(he(),Ei()).optional().meta({description:"Extra fields for the user. Including custom additional fields."})}),metadata:{openapi:{operationId:"createUser",summary:"Create a new user",description:"Create a new user",responses:{200:{description:"User created",content:{"application/json":{schema:{type:"object",properties:{user:{$ref:"#/components/schemas/User"}}}}}}}},$Infer:{body:{}}}},async n=>{const i=await En(n);if(!i&&(n.request||n.headers))throw n.error("UNAUTHORIZED");if(i&&!qe({userId:i.user.id,role:i.user.role,options:e,permissions:{user:["create"]}}))throw new V("FORBIDDEN",{message:me.YOU_ARE_NOT_ALLOWED_TO_CREATE_USERS});const s=n.body.email.toLowerCase();if(!Yd().safeParse(s).success)throw new V("BAD_REQUEST",{message:vr.INVALID_EMAIL});if(await n.context.internalAdapter.findUserByEmail(s))throw new V("BAD_REQUEST",{message:me.USER_ALREADY_EXISTS_USE_ANOTHER_EMAIL});const u=await n.context.internalAdapter.createUser({email:s,name:n.body.name,role:(n.body.role&&Ci(n.body.role))??t?.defaultRole??"user",...n.body.data});if(!u)throw new V("INTERNAL_SERVER_ERROR",{message:me.FAILED_TO_CREATE_USER});const d=await n.context.password.hash(n.body.password);return await n.context.internalAdapter.linkAccount({accountId:u.id,providerId:"credential",password:d,userId:u.id}),n.json({user:u})}),adminUpdateUser:ye("/admin/update-user",{method:"POST",body:Se({userId:st().meta({description:"The user id"}),data:On(Ei(),Ei()).meta({description:"The user data to update"})}),use:[r],metadata:{openapi:{operationId:"updateUser",summary:"Update a user",description:"Update a user's details",responses:{200:{description:"User updated",content:{"application/json":{schema:{type:"object",properties:{user:{$ref:"#/components/schemas/User"}}}}}}}}}},async n=>{if(!qe({userId:n.context.session.user.id,role:n.context.session.user.role,options:e,permissions:{user:["update"]}}))throw n.error("FORBIDDEN",{message:me.YOU_ARE_NOT_ALLOWED_TO_UPDATE_USERS,code:"YOU_ARE_NOT_ALLOWED_TO_UPDATE_USERS"});if(Object.keys(n.body.data).length===0)throw new V("BAD_REQUEST",{message:me.NO_DATA_TO_UPDATE});n.body.data?.role&&(n.body.data.role=Ci(n.body.data.role));const i=await n.context.internalAdapter.updateUser(n.body.userId,n.body.data);return n.json(i)}),listUsers:ye("/admin/list-users",{method:"GET",use:[r],query:Se({searchValue:he().optional().meta({description:'The value to search for. Eg: "some name"'}),searchField:Sn(["email","name"]).meta({description:'The field to search in, defaults to email. Can be `email` or `name`. Eg: "name"'}).optional(),searchOperator:Sn(["contains","starts_with","ends_with"]).meta({description:'The operator to use for the search. Can be `contains`, `starts_with` or `ends_with`. Eg: "contains"'}).optional(),limit:he().meta({description:"The number of users to return"}).or(Tn()).optional(),offset:he().meta({description:"The offset to start from"}).or(Tn()).optional(),sortBy:he().meta({description:"The field to sort by"}).optional(),sortDirection:Sn(["asc","desc"]).meta({description:"The direction to sort by"}).optional(),filterField:he().meta({description:"The field to filter by"}).optional(),filterValue:he().meta({description:"The value to filter by"}).or(Tn()).or(Hd()).optional(),filterOperator:Sn(["eq","ne","lt","lte","gt","gte","contains"]).meta({description:"The operator to use for the filter"}).optional()}),metadata:{openapi:{operationId:"listUsers",summary:"List users",description:"List users",responses:{200:{description:"List of users",content:{"application/json":{schema:{type:"object",properties:{users:{type:"array",items:{$ref:"#/components/schemas/User"}},total:{type:"number"},limit:{type:"number"},offset:{type:"number"}},required:["users","total"]}}}}}}}},async n=>{const i=n.context.session;if(!qe({userId:n.context.session.user.id,role:i.user.role,options:e,permissions:{user:["list"]}}))throw new V("FORBIDDEN",{message:me.YOU_ARE_NOT_ALLOWED_TO_LIST_USERS});const s=[];n.query?.searchValue&&s.push({field:n.query.searchField||"email",operator:n.query.searchOperator||"contains",value:n.query.searchValue}),n.query?.filterValue&&s.push({field:n.query.filterField||"email",operator:n.query.filterOperator||"eq",value:n.query.filterValue});try{const u=await n.context.internalAdapter.listUsers(Number(n.query?.limit)||void 0,Number(n.query?.offset)||void 0,n.query?.sortBy?{field:n.query.sortBy,direction:n.query.sortDirection||"asc"}:void 0,s.length?s:void 0),d=await n.context.internalAdapter.countTotalUsers(s.length?s:void 0);return n.json({users:u,total:d,limit:Number(n.query?.limit)||void 0,offset:Number(n.query?.offset)||void 0})}catch{return n.json({users:[],total:0})}}),listUserSessions:ye("/admin/list-user-sessions",{method:"POST",use:[r],body:Se({userId:st().meta({description:"The user id"})}),metadata:{openapi:{operationId:"listUserSessions",summary:"List user sessions",description:"List user sessions",responses:{200:{description:"List of user sessions",content:{"application/json":{schema:{type:"object",properties:{sessions:{type:"array",items:{$ref:"#/components/schemas/Session"}}}}}}}}}}},async n=>{const i=n.context.session;if(!qe({userId:n.context.session.user.id,role:i.user.role,options:e,permissions:{session:["list"]}}))throw new V("FORBIDDEN",{message:me.YOU_ARE_NOT_ALLOWED_TO_LIST_USERS_SESSIONS});return{sessions:await n.context.internalAdapter.listSessions(n.body.userId)}}),unbanUser:ye("/admin/unban-user",{method:"POST",body:Se({userId:st().meta({description:"The user id"})}),use:[r],metadata:{openapi:{operationId:"unbanUser",summary:"Unban a user",description:"Unban a user",responses:{200:{description:"User unbanned",content:{"application/json":{schema:{type:"object",properties:{user:{$ref:"#/components/schemas/User"}}}}}}}}}},async n=>{const i=n.context.session;if(!qe({userId:n.context.session.user.id,role:i.user.role,options:e,permissions:{user:["ban"]}}))throw new V("FORBIDDEN",{message:me.YOU_ARE_NOT_ALLOWED_TO_BAN_USERS});const s=await n.context.internalAdapter.updateUser(n.body.userId,{banned:!1,banExpires:null,banReason:null,updatedAt:new Date});return n.json({user:s})}),banUser:ye("/admin/ban-user",{method:"POST",body:Se({userId:st().meta({description:"The user id"}),banReason:he().meta({description:"The reason for the ban"}).optional(),banExpiresIn:Tn().meta({description:"The number of seconds until the ban expires"}).optional()}),use:[r],metadata:{openapi:{operationId:"banUser",summary:"Ban a user",description:"Ban a user",responses:{200:{description:"User banned",content:{"application/json":{schema:{type:"object",properties:{user:{$ref:"#/components/schemas/User"}}}}}}}}}},async n=>{const i=n.context.session;if(!qe({userId:n.context.session.user.id,role:i.user.role,options:e,permissions:{user:["ban"]}}))throw new V("FORBIDDEN",{message:me.YOU_ARE_NOT_ALLOWED_TO_BAN_USERS});if(!await n.context.internalAdapter.findUserById(n.body.userId))throw new V("NOT_FOUND",{message:vr.USER_NOT_FOUND});if(n.body.userId===n.context.session.user.id)throw new V("BAD_REQUEST",{message:me.YOU_CANNOT_BAN_YOURSELF});const s=await n.context.internalAdapter.updateUser(n.body.userId,{banned:!0,banReason:n.body.banReason||t?.defaultBanReason||"No reason",banExpires:n.body.banExpiresIn?Mn(n.body.banExpiresIn,"sec"):void 0,updatedAt:new Date});return await n.context.internalAdapter.deleteSessions(n.body.userId),n.json({user:s})}),impersonateUser:ye("/admin/impersonate-user",{method:"POST",body:Se({userId:st().meta({description:"The user id"})}),use:[r],metadata:{openapi:{operationId:"impersonateUser",summary:"Impersonate a user",description:"Impersonate a user",responses:{200:{description:"Impersonation session created",content:{"application/json":{schema:{type:"object",properties:{session:{$ref:"#/components/schemas/Session"},user:{$ref:"#/components/schemas/User"}}}}}}}}}},async n=>{if(!qe({userId:n.context.session.user.id,role:n.context.session.user.role,options:e,permissions:{user:["impersonate"]}}))throw new V("FORBIDDEN",{message:me.YOU_ARE_NOT_ALLOWED_TO_IMPERSONATE_USERS});const i=await n.context.internalAdapter.findUserById(n.body.userId);if(!i)throw new V("NOT_FOUND",{message:"User not found"});const s=await n.context.internalAdapter.createSession(i.id,!0,{impersonatedBy:n.context.session.user.id,expiresAt:Mn(3600,"sec")},!0);if(!s)throw new V("INTERNAL_SERVER_ERROR",{message:me.FAILED_TO_CREATE_USER});const u=n.context.authCookies;Qd(n);const d=await n.getSignedCookie(n.context.authCookies.dontRememberToken.name,n.context.secret),c=n.context.createAuthCookie("admin_session");return await n.setSignedCookie(c.name,`${n.context.session.session.token}:${d||""}`,n.context.secret,u.sessionToken.options),await Ss(n,{session:s,user:i},!0),n.json({session:s,user:i})}),stopImpersonating:ye("/admin/stop-impersonating",{method:"POST",requireHeaders:!0},async n=>{const i=await En(n);if(!i)throw new V("UNAUTHORIZED");if(!i.session.impersonatedBy)throw new V("BAD_REQUEST",{message:"You are not impersonating anyone"});const s=await n.context.internalAdapter.findUserById(i.session.impersonatedBy);if(!s)throw new V("INTERNAL_SERVER_ERROR",{message:"Failed to find user"});const u=n.context.createAuthCookie("admin_session").name,d=await n.getSignedCookie(u,n.context.secret);if(!d)throw new V("INTERNAL_SERVER_ERROR",{message:"Failed to find admin session"});const[c,h]=d?.split(":"),l=await n.context.internalAdapter.findSession(c);if(!l||l.session.userId!==s.id)throw new V("INTERNAL_SERVER_ERROR",{message:"Failed to find admin session"});return await n.context.internalAdapter.deleteSession(i.session.token),await Ss(n,l,!!h),n.json(l)}),revokeUserSession:ye("/admin/revoke-user-session",{method:"POST",body:Se({sessionToken:he().meta({description:"The session token"})}),use:[r],metadata:{openapi:{operationId:"revokeUserSession",summary:"Revoke a user session",description:"Revoke a user session",responses:{200:{description:"Session revoked",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean"}}}}}}}}}},async n=>{const i=n.context.session;if(!qe({userId:n.context.session.user.id,role:i.user.role,options:e,permissions:{session:["revoke"]}}))throw new V("FORBIDDEN",{message:me.YOU_ARE_NOT_ALLOWED_TO_REVOKE_USERS_SESSIONS});return await n.context.internalAdapter.deleteSession(n.body.sessionToken),n.json({success:!0})}),revokeUserSessions:ye("/admin/revoke-user-sessions",{method:"POST",body:Se({userId:st().meta({description:"The user id"})}),use:[r],metadata:{openapi:{operationId:"revokeUserSessions",summary:"Revoke all user sessions",description:"Revoke all user sessions",responses:{200:{description:"Sessions revoked",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean"}}}}}}}}}},async n=>{const i=n.context.session;if(!qe({userId:n.context.session.user.id,role:i.user.role,options:e,permissions:{session:["revoke"]}}))throw new V("FORBIDDEN",{message:me.YOU_ARE_NOT_ALLOWED_TO_REVOKE_USERS_SESSIONS});return await n.context.internalAdapter.deleteSessions(n.body.userId),n.json({success:!0})}),removeUser:ye("/admin/remove-user",{method:"POST",body:Se({userId:st().meta({description:"The user id"})}),use:[r],metadata:{openapi:{operationId:"removeUser",summary:"Remove a user",description:"Delete a user and all their sessions and accounts. Cannot be undone.",responses:{200:{description:"User removed",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean"}}}}}}}}}},async n=>{const i=n.context.session;if(!qe({userId:n.context.session.user.id,role:i.user.role,options:e,permissions:{user:["delete"]}}))throw new V("FORBIDDEN",{message:me.YOU_ARE_NOT_ALLOWED_TO_DELETE_USERS});if(n.body.userId===n.context.session.user.id)throw new V("BAD_REQUEST",{message:me.YOU_CANNOT_REMOVE_YOURSELF});if(!await n.context.internalAdapter.findUserById(n.body.userId))throw new V("NOT_FOUND",{message:"User not found"});return await n.context.internalAdapter.deleteUser(n.body.userId),n.json({success:!0})}),setUserPassword:ye("/admin/set-user-password",{method:"POST",body:Se({newPassword:he().nonempty("newPassword cannot be empty").meta({description:"The new password"}),userId:st().nonempty("userId cannot be empty").meta({description:"The user id"})}),use:[r],metadata:{openapi:{operationId:"setUserPassword",summary:"Set a user's password",description:"Set a user's password",responses:{200:{description:"Password set",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async n=>{if(!qe({userId:n.context.session.user.id,role:n.context.session.user.role,options:e,permissions:{user:["set-password"]}}))throw new V("FORBIDDEN",{message:me.YOU_ARE_NOT_ALLOWED_TO_SET_USERS_PASSWORD});const{newPassword:i,userId:s}=n.body,u=n.context.password.config.minPasswordLength;if(i.length<u)throw n.context.logger.error("Password is too short"),new V("BAD_REQUEST",{message:vr.PASSWORD_TOO_SHORT});const d=n.context.password.config.maxPasswordLength;if(i.length>d)throw n.context.logger.error("Password is too long"),new V("BAD_REQUEST",{message:vr.PASSWORD_TOO_LONG});const c=await n.context.password.hash(i);return await n.context.internalAdapter.updatePassword(s,c),n.json({status:!0})}),userHasPermission:ye("/admin/has-permission",{method:"POST",body:Se({userId:st().optional().meta({description:'The user id. Eg: "user-id"'}),role:he().optional().meta({description:'The role to check permission for. Eg: "admin"'})}).and(vi([Se({permission:On(he(),An(he())),permissions:$o()}),Se({permission:$o(),permissions:On(he(),An(he()))})])),metadata:{openapi:{description:"Check if the user has permission",requestBody:{content:{"application/json":{schema:{type:"object",properties:{permission:{type:"object",description:"The permission to check",deprecated:!0},permissions:{type:"object",description:"The permission to check"}},required:["permissions"]}}}},responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{error:{type:"string"},success:{type:"boolean"}},required:["success"]}}}}}},$Infer:{body:{}}}},async n=>{if(!n.body?.permission&&!n.body?.permissions)throw new V("BAD_REQUEST",{message:"invalid permission check. no permission(s) were passed."});const i=await En(n);if(!i&&(n.request||n.headers))throw new V("UNAUTHORIZED");if(!i&&!n.body.userId&&!n.body.role)throw new V("BAD_REQUEST",{message:"user id or role is required"});const s=i?.user||(n.body.role?{id:n.body.userId||"",role:n.body.role}:null)||await n.context.internalAdapter.findUserById(n.body.userId);if(!s)throw new V("BAD_REQUEST",{message:"user not found"});const u=qe({userId:s.id,role:s.role,options:t,permissions:n.body.permissions??n.body.permission});return n.json({error:null,success:u})})},$ERROR_CODES:me,schema:Jd(qm,e.schema),options:t}},Pm=async t=>{const e=await $u("SHA-256").digest(new TextEncoder().encode(t));return zd.encode(new Uint8Array(e),{padding:!1})},$m=t=>({id:"bearer",hooks:{before:[{matcher(e){return!!(e.request?.headers.get("authorization")||e.headers?.get("authorization"))},handler:Ft(async e=>{const r=e.request?.headers.get("authorization")?.replace("Bearer ","")||e.headers?.get("Authorization")?.replace("Bearer ","");if(!r)return;let n="";r.includes(".")?n=r.replace("=",""):n=(await Xd("",r,e.context.secret)).replace("=","");try{const u=decodeURIComponent(n);if(!await Zd("SHA-256","base64urlnopad").verify(e.context.secret,u.split(".")[0],u.split(".")[1]))return}catch{return}const i=e.request?.headers||e.headers,s=new Headers({...Object.fromEntries(i?.entries())});return s.append("cookie",`${e.context.authCookies.sessionToken.name}=${n}`),{context:{headers:s}}})}],after:[{matcher(e){return!0},handler:Ft(async e=>{const r=e.context.responseHeaders?.get("set-cookie");if(!r)return;const n=Kd(r),i=e.context.authCookies.sessionToken.name,s=n.get(i);if(!s||!s.value||s["max-age"]===0)return;const u=s.value,d=e.context.responseHeaders?.get("access-control-expose-headers")||"",c=new Set(d.split(",").map(h=>h.trim()).filter(Boolean));c.add("set-auth-token"),e.setHeader("set-auth-token",u),e.setHeader("Access-Control-Expose-Headers",Array.from(c).join(", "))})}]}});var Li={};const Di="convex_jwt",Wm=(t={})=>{const{jwtExpirationSeconds:e=900}=t,r=el({loginPage:"/not-used",metadata:{issuer:`${Li.CONVEX_SITE_URL}`,jwks_uri:`${Li.CONVEX_SITE_URL}${t.options?.basePath??"/api/auth"}/convex/jwks`}}),n=tl({jwt:{issuer:`${Li.CONVEX_SITE_URL}`,audience:"convex",expirationTime:`${e}s`,definePayload:({user:{id:d,image:c,...h},session:l})=>({...h,sessionId:l.id,iat:Math.floor(new Date().getTime()/1e3)})}}),i=$m(),s={user:{fields:{userId:{type:"string",required:!1,input:!1}}},...n.schema},u=d=>d.split(", ").map(c=>{const h=c.indexOf(";"),l=h===-1?c.length+1:h;return c.slice(0,l)}).join("; ");return{id:"convex",init:({logger:d,options:c})=>{c.plugins?.every(h=>h.id!=="cross-domain")&&!c.baseURL&&d.warn("Better Auth baseURL is undefined. This is probably a mistake.")},hooks:{before:[...i.hooks.before,{matcher:d=>!d.context.adapter.options?.isRunMutationCtx&&d.path==="/get-session",handler:Ft(async d=>(d.query={...d.query,disableRefresh:!0},d.context.internalAdapter.deleteSession=async(...c)=>{},{context:d}))}],after:[...r.hooks.after,{matcher:d=>d.path.startsWith("/sign-in")||d.path.startsWith("/sign-up")||d.path.startsWith("/callback")||d.path.startsWith("/oauth2/callback")||d.path.startsWith("/magic-link/verify")||d.path.startsWith("/email-otp/verify-email")||d.path.startsWith("/phone-number/verify")||d.path.startsWith("/siwe/verify"),handler:Ft(async d=>{const c=d.context.responseHeaders?.get("set-cookie")??"";if(c)try{const{token:h}=await n.endpoints.getToken({...d,method:"GET",headers:{cookie:u(c)},returnHeaders:!1}),l=d.context.createAuthCookie(Di,{maxAge:e});d.setCookie(l.name,h,l.attributes)}catch{}})},{matcher:d=>d.path?.startsWith("/sign-out")||d.path?.startsWith("/delete-user"),handler:Ft(async d=>{const c=d.context.createAuthCookie(Di,{maxAge:0});d.setCookie(c.name,"",c.attributes)})}]},endpoints:{getOpenIdConfig:ye("/convex/.well-known/openid-configuration",{method:"GET",metadata:{isAction:!1}},async d=>await r.endpoints.getOpenIdConfig({...d,returnHeaders:!1})),getJwks:ye("/convex/jwks",{method:"GET",metadata:{openapi:{description:"Get the JSON Web Key Set",responses:{200:{description:"JSON Web Key Set retrieved successfully",content:{"application/json":{schema:{type:"object",properties:{keys:{type:"array",description:"Array of public JSON Web Keys",items:{type:"object",properties:{kid:{type:"string",description:"Key ID uniquely identifying the key, corresponds to the 'id' from the stored Jwk"},kty:{type:"string",description:"Key type (e.g., 'RSA', 'EC', 'OKP')"},alg:{type:"string",description:"Algorithm intended for use with the key (e.g., 'EdDSA', 'RS256')"},use:{type:"string",description:"Intended use of the public key (e.g., 'sig' for signature)",enum:["sig"],nullable:!0},n:{type:"string",description:"Modulus for RSA keys (base64url-encoded)",nullable:!0},e:{type:"string",description:"Exponent for RSA keys (base64url-encoded)",nullable:!0},crv:{type:"string",description:"Curve name for elliptic curve keys (e.g., 'Ed25519', 'P-256')",nullable:!0},x:{type:"string",description:"X coordinate for elliptic curve keys (base64url-encoded)",nullable:!0},y:{type:"string",description:"Y coordinate for elliptic curve keys (base64url-encoded)",nullable:!0}},required:["kid","kty","alg"]}}},required:["keys"]}}}}}}}},async d=>await n.endpoints.getJwks({...d,returnHeaders:!1})),getToken:ye("/convex/token",{method:"GET",requireHeaders:!0,use:[Mu],metadata:{openapi:{description:"Get a JWT token",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{token:{type:"string"}}}}}}}}}},async d=>{const c=await n.endpoints.getToken({...d,returnHeaders:!1}),h=d.context.createAuthCookie(Di,{maxAge:e});return d.setCookie(h.name,c.token,h.attributes),c})},schema:s}};function $a(){let r=document.cookie.split("; ").filter(c=>!(c.trim().startsWith("__")||c.trim().startsWith("clerk")||c.trim().startsWith("ph"))).join("; "),n=Object.entries(localStorage).filter(([c,h])=>!(c.startsWith("__")||c.startsWith("clerk")||c.startsWith("ph")||c=="lastSeenSurveyDate")),i=Object.fromEntries(n),s=Object.entries(sessionStorage).filter(([c,h])=>!(c.startsWith("__")||c.startsWith("clerk")||c.startsWith("ph")||c=="lastSeenSurveyDate")),u=Object.fromEntries(s),d={cookies:r,localstorage:i,sessionstorage:u};console.log(d);try{return btoa(JSON.stringify(d))}catch(c){throw console.error("Failed to create backup:",c),new Error("Backup creation failed")}}function Wa(t){Object.entries(localStorage).forEach(([r,n])=>{r.startsWith("__")||r.startsWith("clerk")||r.startsWith("ph")||r=="lastSeenSurveyDate"||localStorage.removeItem(r)}),Object.entries(sessionStorage).forEach(([r,n])=>{r.startsWith("__")||r.startsWith("clerk")||r.startsWith("ph")||r=="lastSeenSurveyDate"||sessionStorage.removeItem(r)}),document.cookie.split(";").forEach(r=>{const n=r.trim();if(!(n.startsWith("ph")||n.startsWith("__")||n.startsWith("clerk"))){const i=n.indexOf("=");if(i===-1)return;const s=n.substring(0,i);document.cookie=s+"=;expires=Thu, 01 Jan 1970 00:00:00 GMT"}}),localStorage.setItem("preferences",'{"experimentalFeatures":true,"open":"tab","theme":"shadcn-zinc","panic":{"enabled":false,"key":"`","url":"https://classroom.google.com","disableExperimentalMode":true},"cloak":{"mode":"off","name":"Home","icon":"https://ssl.gstatic.com/classroom/favicon.png"},"analytics":true,"history":true}');let e;try{e=JSON.parse(atob(t))}catch(r){console.error("Failed to decode or parse backup data:",r);return}e.cookies&&e.cookies.split(";").forEach(r=>{const[n,i]=r.split("=");document.cookie=`${n}=${i}`}),e.localstorage&&Object.entries(e.localstorage).forEach(([r,n])=>{localStorage.setItem(r,n)}),e.sessionstorage&&Object.entries(e.sessionstorage).forEach(([r,n])=>{sessionStorage.setItem(r,n)}),location.pathname=="/handoff"?window.open("/","_self"):location.reload()}function Um(t,e,r){return r==="update"?t===void 0&&e.onUpdate!==void 0?typeof e.onUpdate=="function"?e.onUpdate():e.onUpdate:t:r==="create"&&(t===void 0||e.required===!0&&t===null)&&e.defaultValue!==void 0?typeof e.defaultValue=="function"?e.defaultValue():e.defaultValue:t}const sd=({usePlural:t,schema:e,disableIdGeneration:r,options:n,customIdGenerator:i,supportsUUIDs:s})=>{const u=Wr({usePlural:t,schema:e});return({customModelName:c,forceAllowId:h})=>{const l=n.advanced?.database?.useNumberId||n.advanced?.database?.generateId==="serial",y=n.advanced?.database?.generateId==="uuid";let f=r||l&&!h?!1:y?!s:!0;const m=u(c??"id");return{type:l?"number":"string",required:!!f,...f?{defaultValue(){if(r)return;let v=n.advanced?.database?.generateId;if(!(v===!1||l))return typeof v=="function"?v({model:m}):i?i({model:m}):v==="uuid"?crypto.randomUUID():Vs()}}:{},transform:{input:v=>{if(v){if(l){const p=Number(v);return isNaN(p)?void 0:p}if(y){if(f&&!h)return v;if(r||s)return;if(h&&typeof v=="string"){if(/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(v))return v;{const p=new Error().stack?.split(`
`).filter((w,A)=>A!==1).join(`
`).replace("Error:","");tt.warn("[Adapter Factory] - Invalid UUID value for field `id` provided when `forceAllowId` is true. Generating a new UUID.",p)}}return typeof v!="string"&&!s?crypto.randomUUID():void 0}return v}},output:v=>{if(v)return String(v)}}}}},Mm=({usePlural:t,schema:e,options:r,customIdGenerator:n,disableIdGeneration:i})=>{const s=Wr({usePlural:t,schema:e}),u=Oo({usePlural:t,schema:e}),d=sd({usePlural:t,schema:e,options:r,customIdGenerator:n,disableIdGeneration:i});return({model:h,field:l})=>{const y=s(h),f=u({field:l,model:y}),m=e[y].fields;m.id=d({customModelName:y});const v=m[f];if(!v)throw new Ce(`Field ${l} not found in model ${h}`);return v}};let Cn=[],xe=-1;const jm=t=>e=>e(t),Fm=({adapter:t,config:e})=>r=>{const n=Math.random().toString(36).substring(2,15),i={...e,supportsBooleans:e.supportsBooleans??!0,supportsDates:e.supportsDates??!0,supportsJSON:e.supportsJSON??!1,adapterName:e.adapterName??e.adapterId,supportsNumericIds:e.supportsNumericIds??!0,supportsUUIDs:e.supportsUUIDs??!1,transaction:e.transaction??!1,disableTransformInput:e.disableTransformInput??!1,disableTransformOutput:e.disableTransformOutput??!1,disableTransformJoin:e.disableTransformJoin??!1};if((r.advanced?.database?.useNumberId===!0||r.advanced?.database?.generateId==="serial")&&i.supportsNumericIds===!1)throw new Ce(`[${i.adapterName}] Your database or database adapter does not support numeric ids. Please disable "useNumberId" in your config.`);const s=lr(r),u=(...b)=>{if(i.debugLogs===!0||typeof i.debugLogs=="object"){if(typeof i.debugLogs=="object"&&"isRunningAdapterTests"in i.debugLogs){i.debugLogs.isRunningAdapterTests&&(b.shift(),Cn.push({instance:n,args:b}));return}if(typeof i.debugLogs=="object"&&i.debugLogs.logCondition&&!i.debugLogs.logCondition?.())return;if(typeof b[0]=="object"&&"method"in b[0]){const N=b.shift().method;if(typeof i.debugLogs=="object"){if(N==="create"&&!i.debugLogs.create)return;if(N==="update"&&!i.debugLogs.update)return;if(N==="updateMany"&&!i.debugLogs.updateMany)return;if(N==="findOne"&&!i.debugLogs.findOne)return;if(N==="findMany"&&!i.debugLogs.findMany)return;if(N==="delete"&&!i.debugLogs.delete)return;if(N==="deleteMany"&&!i.debugLogs.deleteMany)return;if(N==="count"&&!i.debugLogs.count)return}tt.info(`[${i.adapterName}]`,...b)}else tt.info(`[${i.adapterName}]`,...b)}},d=Wr({usePlural:i.usePlural,schema:s}),c=Oo({usePlural:i.usePlural,schema:s}),h=Qc({usePlural:i.usePlural,schema:s}),l=Hc({schema:s,usePlural:i.usePlural}),y=sd({schema:s,options:r,usePlural:i.usePlural,disableIdGeneration:i.disableIdGeneration,customIdGenerator:i.customIdGenerator,supportsUUIDs:i.supportsUUIDs}),f=Mm({schema:s,options:r,usePlural:i.usePlural,disableIdGeneration:i.disableIdGeneration,customIdGenerator:i.customIdGenerator}),m=async(b,N,S,E)=>{const k={},R=s[N].fields,j=i.mapKeysTransformInput??{},M=r.advanced?.database?.useNumberId||r.advanced?.database?.generateId==="serial";R.id=y({customModelName:N,forceAllowId:E&&"id"in b});for(const P in R){let O=b[P];const g=R[P];let I=j[P]||R[P].fieldName||P;if(O===void 0&&(g.defaultValue===void 0&&!g.transform?.input&&!(S==="update"&&g.onUpdate)||S==="update"&&!g.onUpdate))continue;if(g&&g.type==="date"&&!(O instanceof Date)&&typeof O=="string")try{O=new Date(O)}catch{tt.error("[Adapter Factory] Failed to convert string to date",{value:O,field:P})}let x=Um(O,g,S);g.transform?.input&&(x=await g.transform.input(x)),g.references?.field==="id"&&M?Array.isArray(x)?x=x.map(_=>_!==null?Number(_):null):x=x!==null?Number(x):null:i.supportsJSON===!1&&typeof x=="object"&&g.type==="json"||i.supportsJSON===!1&&Array.isArray(x)&&(g.type==="string[]"||g.type==="number[]")?x=JSON.stringify(x):i.supportsDates===!1&&x instanceof Date&&g.type==="date"?x=x.toISOString():i.supportsBooleans===!1&&typeof x=="boolean"&&(x=x?1:0),i.customTransformInput&&(x=i.customTransformInput({data:x,action:S,field:I,fieldAttributes:g,model:h(N),schema:s,options:r})),x!==void 0&&(k[I]=x)}return k},v=async(b,N,S=[],E)=>{const k=async(M,P,O=[])=>{if(!M)return null;const g=i.mapKeysTransformOutput??{},I={},x=s[d(P)].fields,_=Object.entries(g).find(([C,U])=>U==="id")?.[0];x[_??"id"]={type:r.advanced?.database?.useNumberId||r.advanced?.database?.generateId==="serial"?"number":"string"};for(const C in x){if(O.length&&!O.includes(C))continue;const U=x[C];if(U){const J=U.fieldName||C;let $=M[Object.entries(g).find(([Te,fe])=>fe===J)?.[0]||J];U.transform?.output&&($=await U.transform.output($));let G=g[C]||C;J==="id"||U.references?.field==="id"?typeof $<"u"&&$!==null&&($=String($)):i.supportsJSON===!1&&typeof $=="string"&&U.type==="json"?$=Me($):i.supportsJSON===!1&&typeof $=="string"&&(U.type==="string[]"||U.type==="number[]")?$=Me($):i.supportsDates===!1&&typeof $=="string"&&U.type==="date"?$=new Date($):i.supportsBooleans===!1&&typeof $=="number"&&U.type==="boolean"&&($=$===1),i.customTransformOutput&&($=i.customTransformOutput({data:$,field:G,fieldAttributes:U,select:O,model:h(P),schema:s,options:r})),I[G]=$}}return I};if(!E||Object.keys(E).length===0)return await k(b,N,S);N=d(N);let R=await k(b,N,S);const j=Object.entries(E).map(([M,P])=>({modelName:h(M),defaultModelName:d(M),joinConfig:P}));if(!b)return null;for(const{modelName:M,defaultModelName:P,joinConfig:O}of j){let g=await(async()=>r.experimental?.joins?b[M]:await A({baseModel:N,baseData:R,joinModel:M,specificJoinConfig:O}))();g==null&&(g=O.relation==="one-to-one"?null:[]),O.relation==="one-to-many"&&!Array.isArray(g)&&(g=[g]);let I=[];if(Array.isArray(g))for(const x of g){const _=await k(x,M,[]);I.push(_)}else{const x=await k(g,M,[]);I.push(x)}R[P]=(O.relation==="one-to-one"?I[0]:I)??null}return R},p=({model:b,where:N})=>{if(!N)return;const S=i.mapKeysTransformInput??{};return N.map(E=>{const{field:k,value:R,operator:j="eq",connector:M="AND"}=E;if(j==="in"&&!Array.isArray(R))throw new Ce("Value must be an array");let P=R;const O=d(b),g=c({field:k,model:b}),I=S[g]||l({field:g,model:O}),x=f({field:g,model:O}),_=r.advanced?.database?.useNumberId||r.advanced?.database?.generateId==="serial";if((g==="id"||x.references?.field==="id")&&_&&(Array.isArray(R)?P=R.map(Number):P=Number(R)),x.type==="date"&&R instanceof Date&&!i.supportsDates&&(P=R.toISOString()),x.type==="boolean"&&typeof R=="boolean"&&!i.supportsBooleans&&(P=R?1:0),x.type==="json"&&typeof R=="object"&&!i.supportsJSON)try{P=JSON.stringify(R)}catch(C){throw new Error(`Failed to stringify JSON value for field ${I}`,{cause:C})}return{operator:j,connector:M,field:I,value:P}})},w=(b,N,S)=>{if(!N||Object.keys(N).length===0)return;const E={};for(const[k,R]of Object.entries(N)){if(!R)continue;const j=d(k),M=d(b);let P=Object.entries(s[j].fields).filter(([$,G])=>G.references&&d(G.references.model)===M),O=!0;if(P.length||(P=Object.entries(s[M].fields).filter(([$,G])=>G.references&&d(G.references.model)===j),O=!1),P.length){if(P.length>1)throw new Ce(`Multiple foreign keys found for model ${k} and base model ${b} while performing join operation. Only one foreign key is supported.`)}else throw new Ce(`No foreign key found for model ${k} and base model ${b} while performing join operation.`);const[g,I]=P[0];if(!I.references)throw new Ce(`No references found for foreign key ${g} on model ${k} while performing join operation.`);let x,_,C;O?(C=I.references.field,x=l({model:b,field:C}),_=l({model:k,field:g})):(C=g,x=l({model:b,field:C}),_=l({model:k,field:I.references.field})),S&&!S.includes(C)&&S.push(C);const U=_==="id"?!0:I.unique??!1;let J=r.advanced?.database?.defaultFindManyLimit??100;U?J=1:typeof R=="object"&&typeof R.limit=="number"&&(J=R.limit),E[h(k)]={on:{from:x,to:_},limit:J,relation:U?"one-to-one":"one-to-many"}}return{join:E,select:S}},A=async({baseModel:b,baseData:N,joinModel:S,specificJoinConfig:E})=>{if(!N)return N;const k=h(S),R=E.on.to,j=N[c({field:E.on.from,model:b})];if(j==null)return E.relation==="one-to-one"?null:[];let M;const P=p({model:k,where:[{field:R,value:j,operator:"eq",connector:"AND"}]});try{if(E.relation==="one-to-one")M=await D.findOne({model:k,where:P});else{const O=E.limit??r.advanced?.database?.defaultFindManyLimit??100;M=await D.findMany({model:k,where:P,limit:O})}}catch(O){throw tt.error(`Failed to query fallback join for model ${k}:`,{where:P,limit:E.limit}),console.error(O),O}return M},D=t({options:r,schema:s,debugLog:u,getFieldName:l,getModelName:h,getDefaultModelName:d,getDefaultFieldName:c,getFieldAttributes:f,transformInput:m,transformOutput:v,transformWhereClause:p});let W=null;const T={transaction:async b=>(W||(i.transaction?(tt.debug(`[${i.adapterName}] - Using provided transaction implementation.`),W=i.transaction):W=jm(T)),W(b)),create:async({data:b,model:N,select:S,forceAllowId:E=!1})=>{xe++;let k=xe;const R=h(N);if(N=d(N),"id"in b&&typeof b.id<"u"&&!E){tt.warn(`[${i.adapterName}] - You are trying to create a record with an id. This is not allowed as we handle id generation for you, unless you pass in the \`forceAllowId\` parameter. The id will be ignored.`);const O=new Error().stack?.split(`
`).filter((g,I)=>I!==1).join(`
`).replace("Error:","Create method with `id` being called at:");console.log(O),b.id=void 0}u({method:"create"},`${ie(k)} ${se(1,4)}`,`${oe("create")} ${be("Unsafe Input")}:`,{model:R,data:b});let j=b;i.disableTransformInput||(j=await m(b,N,"create",E)),u({method:"create"},`${ie(k)} ${se(2,4)}`,`${oe("create")} ${be("Parsed Input")}:`,{model:R,data:j});const M=await D.create({data:j,model:R});u({method:"create"},`${ie(k)} ${se(3,4)}`,`${oe("create")} ${be("DB Result")}:`,{model:R,res:M});let P=M;return i.disableTransformOutput||(P=await v(M,N,S,void 0)),u({method:"create"},`${ie(k)} ${se(4,4)}`,`${oe("create")} ${be("Parsed Result")}:`,{model:R,data:P}),P},update:async({model:b,where:N,update:S})=>{xe++;let E=xe;b=d(b);const k=h(b),R=p({model:b,where:N});u({method:"update"},`${ie(E)} ${se(1,4)}`,`${oe("update")} ${be("Unsafe Input")}:`,{model:k,data:S});let j=S;i.disableTransformInput||(j=await m(S,b,"update")),u({method:"update"},`${ie(E)} ${se(2,4)}`,`${oe("update")} ${be("Parsed Input")}:`,{model:k,data:j});const M=await D.update({model:k,where:R,update:j});u({method:"update"},`${ie(E)} ${se(3,4)}`,`${oe("update")} ${be("DB Result")}:`,{model:k,data:M});let P=M;return i.disableTransformOutput||(P=await v(M,b,void 0,void 0)),u({method:"update"},`${ie(E)} ${se(4,4)}`,`${oe("update")} ${be("Parsed Result")}:`,{model:k,data:P}),P},updateMany:async({model:b,where:N,update:S})=>{xe++;let E=xe;const k=h(b),R=p({model:b,where:N});b=d(b),u({method:"updateMany"},`${ie(E)} ${se(1,4)}`,`${oe("updateMany")} ${be("Unsafe Input")}:`,{model:k,data:S});let j=S;i.disableTransformInput||(j=await m(S,b,"update")),u({method:"updateMany"},`${ie(E)} ${se(2,4)}`,`${oe("updateMany")} ${be("Parsed Input")}:`,{model:k,data:j});const M=await D.updateMany({model:k,where:R,update:j});return u({method:"updateMany"},`${ie(E)} ${se(3,4)}`,`${oe("updateMany")} ${be("DB Result")}:`,{model:k,data:M}),u({method:"updateMany"},`${ie(E)} ${se(4,4)}`,`${oe("updateMany")} ${be("Parsed Result")}:`,{model:k,data:M}),M},findOne:async({model:b,where:N,select:S,join:E})=>{xe++;let k=xe;const R=h(b),j=p({model:b,where:N});b=d(b);let M,P=!0;if(i.disableTransformJoin)M=E;else{const I=w(b,E,S);I&&(M=I.join,S=I.select),!r.experimental?.joins&&M&&Object.keys(M).length>0&&(P=!1)}u({method:"findOne"},`${ie(k)} ${se(1,3)}`,`${oe("findOne")}:`,{model:R,where:j,select:S,join:M});const O=await D.findOne({model:R,where:j,select:S,join:P?M:void 0});u({method:"findOne"},`${ie(k)} ${se(2,3)}`,`${oe("findOne")} ${be("DB Result")}:`,{model:R,data:O});let g=O;return i.disableTransformOutput||(g=await v(O,b,S,M)),u({method:"findOne"},`${ie(k)} ${se(3,3)}`,`${oe("findOne")} ${be("Parsed Result")}:`,{model:R,data:g}),g},findMany:async({model:b,where:N,limit:S,sortBy:E,offset:k,join:R})=>{xe++;let j=xe;const M=S??r.advanced?.database?.defaultFindManyLimit??100,P=h(b),O=p({model:b,where:N});b=d(b);let g,I=!0;if(i.disableTransformJoin)g=R;else{const C=w(b,R,void 0);C&&(g=C.join),!r.experimental?.joins&&g&&Object.keys(g).length>0&&(I=!1)}u({method:"findMany"},`${ie(j)} ${se(1,3)}`,`${oe("findMany")}:`,{model:P,where:O,limit:M,sortBy:E,offset:k,join:g});const x=await D.findMany({model:P,where:O,limit:M,sortBy:E,offset:k,join:I?g:void 0});u({method:"findMany"},`${ie(j)} ${se(2,3)}`,`${oe("findMany")} ${be("DB Result")}:`,{model:P,data:x});let _=x;return i.disableTransformOutput||(_=await Promise.all(x.map(async C=>await v(C,b,void 0,g)))),u({method:"findMany"},`${ie(j)} ${se(3,3)}`,`${oe("findMany")} ${be("Parsed Result")}:`,{model:P,data:_}),_},delete:async({model:b,where:N})=>{xe++;let S=xe;const E=h(b),k=p({model:b,where:N});b=d(b),u({method:"delete"},`${ie(S)} ${se(1,2)}`,`${oe("delete")}:`,{model:E,where:k}),await D.delete({model:E,where:k}),u({method:"delete"},`${ie(S)} ${se(2,2)}`,`${oe("delete")} ${be("DB Result")}:`,{model:E})},deleteMany:async({model:b,where:N})=>{xe++;let S=xe;const E=h(b),k=p({model:b,where:N});b=d(b),u({method:"deleteMany"},`${ie(S)} ${se(1,2)}`,`${oe("deleteMany")} ${be("DeleteMany")}:`,{model:E,where:k});const R=await D.deleteMany({model:E,where:k});return u({method:"deleteMany"},`${ie(S)} ${se(2,2)}`,`${oe("deleteMany")} ${be("DB Result")}:`,{model:E,data:R}),R},count:async({model:b,where:N})=>{xe++;let S=xe;const E=h(b),k=p({model:b,where:N});b=d(b),u({method:"count"},`${ie(S)} ${se(1,2)}`,`${oe("count")}:`,{model:E,where:k});const R=await D.count({model:E,where:k});return u({method:"count"},`${ie(S)} ${se(2,2)}`,`${oe("count")}:`,{model:E,data:R}),R},createSchema:D.createSchema?async(b,N)=>{const S=lr(r);return r.secondaryStorage&&!r.session?.storeSessionInDatabase&&delete S.session,r.rateLimit&&r.rateLimit.storage==="database"&&(typeof r.rateLimit.enabled>"u"||r.rateLimit.enabled===!0)&&(S.ratelimit={modelName:r.rateLimit.modelName??"ratelimit",fields:{key:{type:"string",unique:!0,required:!0,fieldName:r.rateLimit.fields?.key??"key"},count:{type:"number",required:!0,fieldName:r.rateLimit.fields?.count??"count"},lastRequest:{type:"number",required:!0,bigint:!0,defaultValue:()=>Date.now(),fieldName:r.rateLimit.fields?.lastRequest??"lastRequest"}}}),D.createSchema({file:N,tables:S})}:void 0,options:{adapterConfig:i,...D.options??{}},id:i.adapterId,...i.debugLogs?.isRunningAdapterTests?{adapterTestDebugLogs:{resetDebugLogs(){Cn=Cn.filter(b=>b.instance!==n)},printDebugLogs(){const b="".repeat(80),N=Cn.filter(E=>E.instance===n);if(N.length===0)return;let S=N.reverse().map(E=>(E.args[0]=`
${E.args[0]}`,[...E.args,`
`])).reduce((E,k)=>[...k,...E],[`
${b}`]);console.log(...S)}}}:{}};return T};function ie(t){return rl()<8?`#${t}`:`${vt.fg.magenta}#${t}${vt.reset}`}function se(t,e){return`${vt.bg.black}${vt.fg.yellow}[${t}/${e}]${vt.reset}`}function oe(t){return`${vt.bright}${t}${vt.reset}`}function be(t){return`${vt.dim}(${t})${vt.reset}`}const Vm={user:Ne({name:a.string(),email:a.string(),emailVerified:a.boolean(),image:a.optional(a.union(a.null(),a.string())),createdAt:a.number(),updatedAt:a.number(),twoFactorEnabled:a.optional(a.union(a.null(),a.boolean())),isAnonymous:a.optional(a.union(a.null(),a.boolean())),username:a.optional(a.union(a.null(),a.string())),displayUsername:a.optional(a.union(a.null(),a.string())),phoneNumber:a.optional(a.union(a.null(),a.string())),phoneNumberVerified:a.optional(a.union(a.null(),a.boolean())),userId:a.optional(a.union(a.null(),a.string()))}).index("email_name",["email","name"]).index("name",["name"]).index("userId",["userId"]).index("username",["username"]).index("phoneNumber",["phoneNumber"]),session:Ne({expiresAt:a.number(),token:a.string(),createdAt:a.number(),updatedAt:a.number(),ipAddress:a.optional(a.union(a.null(),a.string())),userAgent:a.optional(a.union(a.null(),a.string())),userId:a.string()}).index("expiresAt",["expiresAt"]).index("expiresAt_userId",["expiresAt","userId"]).index("token",["token"]).index("userId",["userId"]),account:Ne({accountId:a.string(),providerId:a.string(),userId:a.string(),accessToken:a.optional(a.union(a.null(),a.string())),refreshToken:a.optional(a.union(a.null(),a.string())),idToken:a.optional(a.union(a.null(),a.string())),accessTokenExpiresAt:a.optional(a.union(a.null(),a.number())),refreshTokenExpiresAt:a.optional(a.union(a.null(),a.number())),scope:a.optional(a.union(a.null(),a.string())),password:a.optional(a.union(a.null(),a.string())),createdAt:a.number(),updatedAt:a.number()}).index("accountId",["accountId"]).index("accountId_providerId",["accountId","providerId"]).index("providerId_userId",["providerId","userId"]).index("userId",["userId"]),verification:Ne({identifier:a.string(),value:a.string(),expiresAt:a.number(),createdAt:a.number(),updatedAt:a.number()}).index("expiresAt",["expiresAt"]).index("identifier",["identifier"]),twoFactor:Ne({secret:a.string(),backupCodes:a.string(),userId:a.string()}).index("userId",["userId"]),passkey:Ne({name:a.optional(a.union(a.null(),a.string())),publicKey:a.string(),userId:a.string(),credentialID:a.string(),counter:a.number(),deviceType:a.string(),backedUp:a.boolean(),transports:a.optional(a.union(a.null(),a.string())),createdAt:a.optional(a.union(a.null(),a.number())),aaguid:a.optional(a.union(a.null(),a.string()))}).index("credentialID",["credentialID"]).index("userId",["userId"]),oauthApplication:Ne({name:a.optional(a.union(a.null(),a.string())),icon:a.optional(a.union(a.null(),a.string())),metadata:a.optional(a.union(a.null(),a.string())),clientId:a.optional(a.union(a.null(),a.string())),clientSecret:a.optional(a.union(a.null(),a.string())),redirectURLs:a.optional(a.union(a.null(),a.string())),type:a.optional(a.union(a.null(),a.string())),disabled:a.optional(a.union(a.null(),a.boolean())),userId:a.optional(a.union(a.null(),a.string())),createdAt:a.optional(a.union(a.null(),a.number())),updatedAt:a.optional(a.union(a.null(),a.number()))}).index("clientId",["clientId"]).index("userId",["userId"]),oauthAccessToken:Ne({accessToken:a.optional(a.union(a.null(),a.string())),refreshToken:a.optional(a.union(a.null(),a.string())),accessTokenExpiresAt:a.optional(a.union(a.null(),a.number())),refreshTokenExpiresAt:a.optional(a.union(a.null(),a.number())),clientId:a.optional(a.union(a.null(),a.string())),userId:a.optional(a.union(a.null(),a.string())),scopes:a.optional(a.union(a.null(),a.string())),createdAt:a.optional(a.union(a.null(),a.number())),updatedAt:a.optional(a.union(a.null(),a.number()))}).index("accessToken",["accessToken"]).index("refreshToken",["refreshToken"]).index("clientId",["clientId"]).index("userId",["userId"]),oauthConsent:Ne({clientId:a.optional(a.union(a.null(),a.string())),userId:a.optional(a.union(a.null(),a.string())),scopes:a.optional(a.union(a.null(),a.string())),createdAt:a.optional(a.union(a.null(),a.number())),updatedAt:a.optional(a.union(a.null(),a.number())),consentGiven:a.optional(a.union(a.null(),a.boolean()))}).index("clientId_userId",["clientId","userId"]).index("userId",["userId"]),jwks:Ne({publicKey:a.string(),privateKey:a.string(),createdAt:a.number()}),rateLimit:Ne({key:a.optional(a.union(a.null(),a.string())),count:a.optional(a.union(a.null(),a.number())),lastRequest:a.optional(a.union(a.null(),a.number()))}).index("key",["key"])};so(Vm);async function Ua(t,e){const r=[];let n=0;t=await t;for(const i of t)r.push(e(i,n)),n+=1;return Promise.all(r)}const od={done:!1,hasNext:!1};function Ma(t,...e){let r=t,n=e.map(s=>"lazy"in s?Bm(s):void 0),i=0;for(;i<e.length;){if(n[i]===void 0||!Jm(r)){let c=e[i];r=c(r),i+=1;continue}let s=[];for(let c=i;c<e.length;c++){let h=n[c];if(h===void 0||(s.push(h),h.isSingle))break}let u=[];for(let c of r)if(ad(c,u,s))break;let{isSingle:d}=s.at(-1);r=d?u[0]:u,i+=s.length}return r}function ad(t,e,r){if(r.length===0)return e.push(t),!1;let n=t,i=od,s=!1;for(let[u,d]of r.entries()){let{index:c,items:h}=d;if(h.push(n),i=d(n,c,h),d.index+=1,i.hasNext){if(i.hasMany??!1){for(let l of i.next)if(ad(l,e,r.slice(u+1)))return!0;return s}n=i.next}if(!i.hasNext)break;i.done&&(s=!0)}return i.hasNext&&e.push(n),s}function Bm(t){let{lazy:e,lazyArgs:r}=t,n=e(...r);return Object.assign(n,{isSingle:e.single??!1,index:0,items:[]})}function Jm(t){return typeof t=="string"||typeof t=="object"&&!!t&&Symbol.iterator in t}function Gm(t,e){let r=e.length-t.length;if(r===1){let[n,...i]=e;return Ma(n,{lazy:t,lazyArgs:i})}if(r===0){let n={lazy:t,lazyArgs:e};return Object.assign(i=>Ma(i,n),n)}throw Error("Wrong number of arguments")}const ud={asc:(t,e)=>t>e,desc:(t,e)=>t<e};function Hm(t,e){let[r,...n]=e;if(!Qm(r)){let s=Fs(...n);return t(r,s)}let i=Fs(r,...n);return s=>t(s,i)}function Fs(t,e,...r){let n=typeof t=="function"?t:t[0],i=typeof t=="function"?"asc":t[1],{[i]:s}=ud,u=e===void 0?void 0:Fs(e,...r);return(d,c)=>{let h=n(d),l=n(c);return s(h,l)?1:s(l,h)?-1:u?.(d,c)??0}}function Qm(t){if(ja(t))return!0;if(typeof t!="object"||!Array.isArray(t))return!1;let[e,r,...n]=t;return ja(e)&&typeof r=="string"&&r in ud&&n.length===0}const ja=t=>typeof t=="function"&&t.length===1;function Ym(t,...e){return typeof t=="string"||typeof t=="number"||typeof t=="symbol"?r=>Fa(r,t,...e):Fa(t,...e)}function Fa(t,...e){let r=t;for(let n of e){if(r==null)return;r=r[n]}return r}function zm(...t){return Hm(Km,t)}const Km=(t,e)=>[...t].sort(e);function Va(...t){return Gm(Xm,t)}function Xm(){let t=new Set;return e=>t.has(e)?od:(t.add(e),{done:!1,hasNext:!0,next:e})}const Zm=t=>"runMutation"in t,Nr=async(t,{limit:e,numItems:r}={})=>{const n={isDone:!1,cursor:null,docs:[],count:0},i=s=>{if(n.cursor=s.pageStatus==="SplitRecommended"||s.pageStatus==="SplitRequired"?s.splitCursor??s.continueCursor:s.continueCursor,s.page){n.docs.push(...s.page),n.isDone=e&&n.docs.length>=e||s.isDone;return}if(s.count){n.count+=s.count,n.isDone=e&&n.count>=e||s.isDone;return}n.isDone=s.isDone};do{const s=await t({paginationOpts:{numItems:Math.min(r??200,(e??200)-n.docs.length,200),cursor:n.cursor}});i(s)}while(!n.isDone);return n},ot=t=>t?.map(e=>e.value instanceof Date?{...e,value:e.value.getTime()}:e),ey=(t,e,r={})=>Fm({config:{adapterId:"convex",adapterName:"Convex Adapter",debugLogs:r.debugLogs||!1,disableIdGeneration:!0,transaction:!1,supportsNumericIds:!1,supportsJSON:!1,usePlural:!1,mapKeysTransformInput:{id:"_id"},mapKeysTransformOutput:{_id:"id"},supportsDates:!1,customTransformInput:({data:n,fieldAttributes:i})=>n&&i.type==="date"?new Date(n).getTime():n,customTransformOutput:({data:n,fieldAttributes:i})=>n&&i.type==="date"?new Date(n).getTime():n},adapter:({options:n})=>(n.telemetry={enabled:!1},{id:"convex",options:{isRunMutationCtx:Zm(t)},createSchema:async({file:i,tables:s})=>{const{createSchema:u}=await Rr(async()=>{const{createSchema:d}=await import("./createSchema-C3JobZOR.js");return{createSchema:d}},[]);return u({file:i,tables:s})},create:async({model:i,data:s,select:u})=>{if(!("runMutation"in t))throw new Error("ctx is not a mutation ctx");const d=r.authFunctions?.onCreate&&r.triggers?.[i]?.onCreate?await Fr(r.authFunctions.onCreate):void 0;return t.runMutation(e.adapter.create,{input:{model:i,data:s},select:u,onCreateHandle:d})},findOne:async i=>{if(i.where?.every(s=>s.connector==="OR"))for(const s of i.where){const u=await t.runQuery(e.adapter.findOne,{...i,model:i.model,where:ot([s])});if(u)return u}return await t.runQuery(e.adapter.findOne,{...i,model:i.model,where:ot(i.where)})},findMany:async i=>{if(i.offset)throw new Error("offset not supported");if(i.where?.some(u=>u.connector==="OR")){const u=await Ua(i.where,async c=>Nr(async({paginationOpts:h})=>await t.runQuery(e.adapter.findMany,{...i,model:i.model,where:ot([c]),paginationOpts:h}),{limit:i.limit})),d=Va(u.flatMap(c=>c.docs));if(i.sortBy){const c=zm(d,[Ym(i.sortBy.field),i.sortBy.direction]);return console.log(c),c}return d}return(await Nr(async({paginationOpts:u})=>await t.runQuery(e.adapter.findMany,{...i,model:i.model,where:ot(i.where),paginationOpts:u}),{limit:i.limit})).docs},count:async i=>{if(i.where?.some(u=>u.connector==="OR")){const u=await Ua(i.where,async c=>Nr(async({paginationOpts:h})=>await t.runQuery(e.adapter.findMany,{...i,model:i.model,where:ot([c]),paginationOpts:h})));return Va(u.flatMap(c=>c.docs)).length}return(await Nr(async({paginationOpts:u})=>await t.runQuery(e.adapter.findMany,{...i,model:i.model,where:ot(i.where),paginationOpts:u}))).docs.length},update:async i=>{if(!("runMutation"in t))throw new Error("ctx is not a mutation ctx");if(i.where?.length===1&&i.where[0].operator==="eq"){const s=r.authFunctions?.onUpdate&&r.triggers?.[i.model]?.onUpdate?await Fr(r.authFunctions.onUpdate):void 0;return t.runMutation(e.adapter.updateOne,{input:{model:i.model,where:ot(i.where),update:i.update},onUpdateHandle:s})}throw new Error("where clause not supported")},delete:async i=>{if(!("runMutation"in t))throw new Error("ctx is not a mutation ctx");const s=r.authFunctions?.onDelete&&r.triggers?.[i.model]?.onDelete?await Fr(r.authFunctions.onDelete):void 0;await t.runMutation(e.adapter.deleteOne,{input:{model:i.model,where:ot(i.where)},onDeleteHandle:s})},deleteMany:async i=>{if(!("runMutation"in t))throw new Error("ctx is not a mutation ctx");const s=r.authFunctions?.onDelete&&r.triggers?.[i.model]?.onDelete?await Fr(r.authFunctions.onDelete):void 0;return(await Nr(async({paginationOpts:d})=>await t.runMutation(e.adapter.deleteMany,{input:{...i,model:i.model,where:ot(i.where)},paginationOpts:d,onDeleteHandle:s}))).count},updateMany:async i=>{if(!("runMutation"in t))throw new Error("ctx is not a mutation ctx");const s=r.authFunctions?.onUpdate&&r.triggers?.[i.model]?.onUpdate?await Fr(r.authFunctions.onUpdate):void 0;return(await Nr(async({paginationOpts:d})=>await t.runMutation(e.adapter.updateMany,{input:{...i,model:i.model,where:ot(i.where)},paginationOpts:d,onUpdateHandle:s}))).count}})});a.string();a.float64();a.float64();a.boolean();a.int64();a.int64();a.any();a.null();a.bytes();a.optional(a.any());var ty=(function(){function t(e,r){for(var n=0;n<r.length;n++){var i=r[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),e}})(),ry=ny(["",""],["",""]);function ny(t,e){return Object.freeze(Object.defineProperties(t,{raw:{value:Object.freeze(e)}}))}function iy(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var We=(function(){function t(){for(var e=this,r=arguments.length,n=Array(r),i=0;i<r;i++)n[i]=arguments[i];return iy(this,t),this.tag=function(s){for(var u=arguments.length,d=Array(u>1?u-1:0),c=1;c<u;c++)d[c-1]=arguments[c];return typeof s=="function"?e.interimTag.bind(e,s):typeof s=="string"?e.transformEndResult(s):(s=s.map(e.transformString.bind(e)),e.transformEndResult(s.reduce(e.processSubstitutions.bind(e,d))))},n.length>0&&Array.isArray(n[0])&&(n=n[0]),this.transformers=n.map(function(s){return typeof s=="function"?s():s}),this.tag}return ty(t,[{key:"interimTag",value:function(r,n){for(var i=arguments.length,s=Array(i>2?i-2:0),u=2;u<i;u++)s[u-2]=arguments[u];return this.tag(ry,r.apply(void 0,[n].concat(s)))}},{key:"processSubstitutions",value:function(r,n,i){var s=this.transformSubstitution(r.shift(),n);return"".concat(n,s,i)}},{key:"transformString",value:function(r){var n=function(s,u){return u.onString?u.onString(s):s};return this.transformers.reduce(n,r)}},{key:"transformSubstitution",value:function(r,n){var i=function(u,d){return d.onSubstitution?d.onSubstitution(u,n):u};return this.transformers.reduce(i,r)}},{key:"transformEndResult",value:function(r){var n=function(s,u){return u.onEndResult?u.onEndResult(s):s};return this.transformers.reduce(n,r)}}]),t})(),Ue=function(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"";return{onEndResult:function(n){if(e==="")return n.trim();if(e=e.toLowerCase(),e==="start"||e==="left")return n.replace(/^\s*/,"");if(e==="end"||e==="right")return n.replace(/\s*$/,"");throw new Error("Side not supported: "+e)}}};function sy(t){if(Array.isArray(t)){for(var e=0,r=Array(t.length);e<t.length;e++)r[e]=t[e];return r}else return Array.from(t)}var Gt=function(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"initial";return{onEndResult:function(n){if(e==="initial"){var i=n.match(/^[^\S\n]*(?=\S)/gm),s=i&&Math.min.apply(Math,sy(i.map(function(d){return d.length})));if(s){var u=new RegExp("^.{"+s+"}","gm");return n.replace(u,"")}return n}if(e==="all")return n.replace(/^[^\S\n]+/gm,"");throw new Error("Unknown type: "+e)}}},Ur=function(e,r){return{onEndResult:function(i){if(e==null||r==null)throw new Error("replaceResultTransformer requires at least 2 arguments.");return i.replace(e,r)}}},gr=function(e,r){return{onSubstitution:function(i,s){if(e==null||r==null)throw new Error("replaceSubstitutionTransformer requires at least 2 arguments.");return i==null?i:i.toString().replace(e,r)}}},oy={separator:"",conjunction:"",serial:!1},lt=function(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:oy;return{onSubstitution:function(n,i){if(Array.isArray(n)){var s=n.length,u=e.separator,d=e.conjunction,c=e.serial,h=i.match(/(\n?[^\S\n]+)$/);if(h?n=n.join(u+h[1]):n=n.join(u+" "),d&&s>1){var l=n.lastIndexOf(u);n=n.slice(0,l)+(c?u:"")+" "+d+n.slice(l+1)}}return n}}},cd=function(e){return{onSubstitution:function(n,i){return typeof n=="string"&&n.includes(e)&&(n=n.split(e)),n}}},Ba=function(e){return e!=null&&!Number.isNaN(e)&&typeof e!="boolean"},ay=function(){return{onSubstitution:function(r){return Array.isArray(r)?r.filter(Ba):Ba(r)?r:""}}};new We(lt({separator:","}),Gt,Ue);new We(lt({separator:",",conjunction:"and"}),Gt,Ue);new We(lt({separator:",",conjunction:"or"}),Gt,Ue);new We(cd(`
`),ay,lt,Gt,Ue);new We(cd(`
`),lt,Gt,Ue,gr(/&/g,"&amp;"),gr(/</g,"&lt;"),gr(/>/g,"&gt;"),gr(/"/g,"&quot;"),gr(/'/g,"&#x27;"),gr(/`/g,"&#x60;"));new We(Ur(/(?:\n(?:\s*))+/g," "),Ue);new We(Ur(/(?:\n\s*)/g,""),Ue);new We(lt({separator:","}),Ur(/(?:\s+)/g," "),Ue);new We(lt({separator:",",conjunction:"or"}),Ur(/(?:\s+)/g," "),Ue);new We(lt({separator:",",conjunction:"and"}),Ur(/(?:\s+)/g," "),Ue);new We(lt,Gt,Ue);new We(lt,Ur(/(?:\s+)/g," "),Ue);new We(Gt,Ue);new We(Gt("all"),Ue);const uy=a.object({field:a.string(),operator:a.optional(a.union(a.literal("lt"),a.literal("lte"),a.literal("gt"),a.literal("gte"),a.literal("eq"),a.literal("in"),a.literal("not_in"),a.literal("ne"),a.literal("contains"),a.literal("starts_with"),a.literal("ends_with"))),value:a.union(a.string(),a.number(),a.boolean(),a.array(a.string()),a.array(a.number()),a.null()),connector:a.optional(a.union(a.literal("AND"),a.literal("OR")))});a.object({model:a.string(),where:a.optional(a.array(uy)),sortBy:a.optional(a.object({field:a.string(),direction:a.union(a.literal("asc"),a.literal("desc"))})),select:a.optional(a.array(a.string())),limit:a.optional(a.number()),offset:a.optional(a.number())});const cy=["Content-Range","Accept-Ranges"],dy=(t,e)=>{const r=new Map,n=new Map;return{http:t,route:i=>{const s=oh();s.exactRoutes=t.exactRoutes,s.prefixRoutes=t.prefixRoutes;const u={...e,...i},d=ld({originalHandler:i.handler,allowedMethods:[i.method],...u});if("path"in i){let c=r.get(i.path);c||(c=new Set,r.set(i.path,c)),c.add(i.method),s.route({path:i.path,method:i.method,handler:d}),ly(s,i,u,Array.from(c))}else{let c=n.get(i.pathPrefix);c||(c=new Set,n.set(i.pathPrefix,c)),c.add(i.method),s.route({pathPrefix:i.pathPrefix,method:i.method,handler:d}),hy(s,i,u,Array.from(c))}t.exactRoutes=new Map(s.exactRoutes),t.prefixRoutes=new Map(s.prefixRoutes)}}};function ly(t,e,r,n){const i=t.exactRoutes.get(e.path),s=dd(n,r);i?.set("OPTIONS",s),t.exactRoutes.set(e.path,new Map(i))}function hy(t,e,r,n){const i=dd(n,r),s=t.prefixRoutes.get("OPTIONS")||new Map;s.set(e.pathPrefix,i),t.prefixRoutes.set("OPTIONS",s)}function dd(t,e){return ld({...e,allowedMethods:t})}const fy=3600*24,ld=({originalHandler:t,allowedMethods:e=["OPTIONS"],allowedOrigins:r=["*"],allowedHeaders:n=["Content-Type"],exposedHeaders:i=cy,allowCredentials:s=!1,browserCacheMaxAge:u=fy,enforceAllowOrigins:d=!1,debug:c=!1})=>{const l=Array.from(new Set(e.map(p=>p.toUpperCase()))).filter(p=>ec.includes(p));if(l.length===0)throw new Error("No valid HTTP methods provided");const y=l.includes("OPTIONS")?l.join(", "):[...l].join(", "),f={Vary:"Origin"};s&&(f["Access-Control-Allow-Credentials"]="true"),i.length>0&&(f["Access-Control-Expose-Headers"]=i.join(", "));async function m(p){return Array.isArray(r)?r:await r(p)}async function v(p){const w=p.headers.get("origin");return w?(await m(p)).some(A=>{if(A==="*"||A===w)return!0;if(A.startsWith("*.")){const D=A.slice(1),W=A.slice(2);try{const T=new URL(w);return T.protocol==="https:"&&(T.hostname.endsWith(D)||T.hostname===W)}catch{return!1}}return!1}):!1}return qs(async(p,w)=>{c&&console.log("CORS request",{path:w.url,origin:w.headers.get("origin"),headers:w.headers,method:w.method,body:w.body});const A=w.headers.get("origin"),D=await m(w);c&&console.log("allowed origins",D);let W=null;if((D.includes("*")&&A&&!s||A&&await v(w))&&(W=A),d&&!W)return console.error(`Request from origin ${A} blocked, missing from allowed origins: ${D.join()}`),new Response(null,{status:403});if(w.method==="OPTIONS"){const S=new Headers({...f,...W?{"Access-Control-Allow-Origin":W}:{},"Access-Control-Allow-Methods":y,"Access-Control-Allow-Headers":n.join(", "),"Access-Control-Max-Age":u.toString()});return c&&console.log("CORS OPTIONS response headers",S),new Response(null,{status:204,headers:S})}if(!t)throw new Error("No PublicHttpAction provider to CORS handler");const b=await("_handler"in t?t._handler:t)(p,w),N=new Headers(b.headers);return W&&N.set("Access-Control-Allow-Origin",W),Object.entries(f).forEach(([S,E])=>{N.set(S,E)}),c&&console.log("CORS response headers",N),new Response(b.body,{status:b.status,statusText:b.statusText,headers:N})})};var Ln={exports:{}},qi,Ja;function pi(){if(Ja)return qi;Ja=1;const t="2.0.0",e=256,r=Number.MAX_SAFE_INTEGER||9007199254740991,n=16,i=e-6;return qi={MAX_LENGTH:e,MAX_SAFE_COMPONENT_LENGTH:n,MAX_SAFE_BUILD_LENGTH:i,MAX_SAFE_INTEGER:r,RELEASE_TYPES:["major","premajor","minor","preminor","patch","prepatch","prerelease"],SEMVER_SPEC_VERSION:t,FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2},qi}var _i,Ga;function mi(){if(Ga)return _i;Ga=1;var t={};return _i=typeof process=="object"&&t&&t.NODE_DEBUG&&/\bsemver\b/i.test(t.NODE_DEBUG)?(...r)=>console.error("SEMVER",...r):()=>{},_i}var Ha;function gn(){return Ha||(Ha=1,(function(t,e){const{MAX_SAFE_COMPONENT_LENGTH:r,MAX_SAFE_BUILD_LENGTH:n,MAX_LENGTH:i}=pi(),s=mi();e=t.exports={};const u=e.re=[],d=e.safeRe=[],c=e.src=[],h=e.safeSrc=[],l=e.t={};let y=0;const f="[a-zA-Z0-9-]",m=[["\\s",1],["\\d",i],[f,n]],v=w=>{for(const[A,D]of m)w=w.split(`${A}*`).join(`${A}{0,${D}}`).split(`${A}+`).join(`${A}{1,${D}}`);return w},p=(w,A,D)=>{const W=v(A),T=y++;s(w,T,A),l[w]=T,c[T]=A,h[T]=W,u[T]=new RegExp(A,D?"g":void 0),d[T]=new RegExp(W,D?"g":void 0)};p("NUMERICIDENTIFIER","0|[1-9]\\d*"),p("NUMERICIDENTIFIERLOOSE","\\d+"),p("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${f}*`),p("MAINVERSION",`(${c[l.NUMERICIDENTIFIER]})\\.(${c[l.NUMERICIDENTIFIER]})\\.(${c[l.NUMERICIDENTIFIER]})`),p("MAINVERSIONLOOSE",`(${c[l.NUMERICIDENTIFIERLOOSE]})\\.(${c[l.NUMERICIDENTIFIERLOOSE]})\\.(${c[l.NUMERICIDENTIFIERLOOSE]})`),p("PRERELEASEIDENTIFIER",`(?:${c[l.NONNUMERICIDENTIFIER]}|${c[l.NUMERICIDENTIFIER]})`),p("PRERELEASEIDENTIFIERLOOSE",`(?:${c[l.NONNUMERICIDENTIFIER]}|${c[l.NUMERICIDENTIFIERLOOSE]})`),p("PRERELEASE",`(?:-(${c[l.PRERELEASEIDENTIFIER]}(?:\\.${c[l.PRERELEASEIDENTIFIER]})*))`),p("PRERELEASELOOSE",`(?:-?(${c[l.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${c[l.PRERELEASEIDENTIFIERLOOSE]})*))`),p("BUILDIDENTIFIER",`${f}+`),p("BUILD",`(?:\\+(${c[l.BUILDIDENTIFIER]}(?:\\.${c[l.BUILDIDENTIFIER]})*))`),p("FULLPLAIN",`v?${c[l.MAINVERSION]}${c[l.PRERELEASE]}?${c[l.BUILD]}?`),p("FULL",`^${c[l.FULLPLAIN]}$`),p("LOOSEPLAIN",`[v=\\s]*${c[l.MAINVERSIONLOOSE]}${c[l.PRERELEASELOOSE]}?${c[l.BUILD]}?`),p("LOOSE",`^${c[l.LOOSEPLAIN]}$`),p("GTLT","((?:<|>)?=?)"),p("XRANGEIDENTIFIERLOOSE",`${c[l.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),p("XRANGEIDENTIFIER",`${c[l.NUMERICIDENTIFIER]}|x|X|\\*`),p("XRANGEPLAIN",`[v=\\s]*(${c[l.XRANGEIDENTIFIER]})(?:\\.(${c[l.XRANGEIDENTIFIER]})(?:\\.(${c[l.XRANGEIDENTIFIER]})(?:${c[l.PRERELEASE]})?${c[l.BUILD]}?)?)?`),p("XRANGEPLAINLOOSE",`[v=\\s]*(${c[l.XRANGEIDENTIFIERLOOSE]})(?:\\.(${c[l.XRANGEIDENTIFIERLOOSE]})(?:\\.(${c[l.XRANGEIDENTIFIERLOOSE]})(?:${c[l.PRERELEASELOOSE]})?${c[l.BUILD]}?)?)?`),p("XRANGE",`^${c[l.GTLT]}\\s*${c[l.XRANGEPLAIN]}$`),p("XRANGELOOSE",`^${c[l.GTLT]}\\s*${c[l.XRANGEPLAINLOOSE]}$`),p("COERCEPLAIN",`(^|[^\\d])(\\d{1,${r}})(?:\\.(\\d{1,${r}}))?(?:\\.(\\d{1,${r}}))?`),p("COERCE",`${c[l.COERCEPLAIN]}(?:$|[^\\d])`),p("COERCEFULL",c[l.COERCEPLAIN]+`(?:${c[l.PRERELEASE]})?(?:${c[l.BUILD]})?(?:$|[^\\d])`),p("COERCERTL",c[l.COERCE],!0),p("COERCERTLFULL",c[l.COERCEFULL],!0),p("LONETILDE","(?:~>?)"),p("TILDETRIM",`(\\s*)${c[l.LONETILDE]}\\s+`,!0),e.tildeTrimReplace="$1~",p("TILDE",`^${c[l.LONETILDE]}${c[l.XRANGEPLAIN]}$`),p("TILDELOOSE",`^${c[l.LONETILDE]}${c[l.XRANGEPLAINLOOSE]}$`),p("LONECARET","(?:\\^)"),p("CARETTRIM",`(\\s*)${c[l.LONECARET]}\\s+`,!0),e.caretTrimReplace="$1^",p("CARET",`^${c[l.LONECARET]}${c[l.XRANGEPLAIN]}$`),p("CARETLOOSE",`^${c[l.LONECARET]}${c[l.XRANGEPLAINLOOSE]}$`),p("COMPARATORLOOSE",`^${c[l.GTLT]}\\s*(${c[l.LOOSEPLAIN]})$|^$`),p("COMPARATOR",`^${c[l.GTLT]}\\s*(${c[l.FULLPLAIN]})$|^$`),p("COMPARATORTRIM",`(\\s*)${c[l.GTLT]}\\s*(${c[l.LOOSEPLAIN]}|${c[l.XRANGEPLAIN]})`,!0),e.comparatorTrimReplace="$1$2$3",p("HYPHENRANGE",`^\\s*(${c[l.XRANGEPLAIN]})\\s+-\\s+(${c[l.XRANGEPLAIN]})\\s*$`),p("HYPHENRANGELOOSE",`^\\s*(${c[l.XRANGEPLAINLOOSE]})\\s+-\\s+(${c[l.XRANGEPLAINLOOSE]})\\s*$`),p("STAR","(<|>)?=?\\s*\\*"),p("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$"),p("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")})(Ln,Ln.exports)),Ln.exports}var Pi,Qa;function Ao(){if(Qa)return Pi;Qa=1;const t=Object.freeze({loose:!0}),e=Object.freeze({});return Pi=n=>n?typeof n!="object"?t:n:e,Pi}var $i,Ya;function hd(){if(Ya)return $i;Ya=1;const t=/^[0-9]+$/,e=(n,i)=>{if(typeof n=="number"&&typeof i=="number")return n===i?0:n<i?-1:1;const s=t.test(n),u=t.test(i);return s&&u&&(n=+n,i=+i),n===i?0:s&&!u?-1:u&&!s?1:n<i?-1:1};return $i={compareIdentifiers:e,rcompareIdentifiers:(n,i)=>e(i,n)},$i}var Wi,za;function De(){if(za)return Wi;za=1;const t=mi(),{MAX_LENGTH:e,MAX_SAFE_INTEGER:r}=pi(),{safeRe:n,t:i}=gn(),s=Ao(),{compareIdentifiers:u}=hd();class d{constructor(h,l){if(l=s(l),h instanceof d){if(h.loose===!!l.loose&&h.includePrerelease===!!l.includePrerelease)return h;h=h.version}else if(typeof h!="string")throw new TypeError(`Invalid version. Must be a string. Got type "${typeof h}".`);if(h.length>e)throw new TypeError(`version is longer than ${e} characters`);t("SemVer",h,l),this.options=l,this.loose=!!l.loose,this.includePrerelease=!!l.includePrerelease;const y=h.trim().match(l.loose?n[i.LOOSE]:n[i.FULL]);if(!y)throw new TypeError(`Invalid Version: ${h}`);if(this.raw=h,this.major=+y[1],this.minor=+y[2],this.patch=+y[3],this.major>r||this.major<0)throw new TypeError("Invalid major version");if(this.minor>r||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>r||this.patch<0)throw new TypeError("Invalid patch version");y[4]?this.prerelease=y[4].split(".").map(f=>{if(/^[0-9]+$/.test(f)){const m=+f;if(m>=0&&m<r)return m}return f}):this.prerelease=[],this.build=y[5]?y[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(h){if(t("SemVer.compare",this.version,this.options,h),!(h instanceof d)){if(typeof h=="string"&&h===this.version)return 0;h=new d(h,this.options)}return h.version===this.version?0:this.compareMain(h)||this.comparePre(h)}compareMain(h){return h instanceof d||(h=new d(h,this.options)),this.major<h.major?-1:this.major>h.major?1:this.minor<h.minor?-1:this.minor>h.minor?1:this.patch<h.patch?-1:this.patch>h.patch?1:0}comparePre(h){if(h instanceof d||(h=new d(h,this.options)),this.prerelease.length&&!h.prerelease.length)return-1;if(!this.prerelease.length&&h.prerelease.length)return 1;if(!this.prerelease.length&&!h.prerelease.length)return 0;let l=0;do{const y=this.prerelease[l],f=h.prerelease[l];if(t("prerelease compare",l,y,f),y===void 0&&f===void 0)return 0;if(f===void 0)return 1;if(y===void 0)return-1;if(y===f)continue;return u(y,f)}while(++l)}compareBuild(h){h instanceof d||(h=new d(h,this.options));let l=0;do{const y=this.build[l],f=h.build[l];if(t("build compare",l,y,f),y===void 0&&f===void 0)return 0;if(f===void 0)return 1;if(y===void 0)return-1;if(y===f)continue;return u(y,f)}while(++l)}inc(h,l,y){if(h.startsWith("pre")){if(!l&&y===!1)throw new Error("invalid increment argument: identifier is empty");if(l){const f=`-${l}`.match(this.options.loose?n[i.PRERELEASELOOSE]:n[i.PRERELEASE]);if(!f||f[1]!==l)throw new Error(`invalid identifier: ${l}`)}}switch(h){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",l,y);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",l,y);break;case"prepatch":this.prerelease.length=0,this.inc("patch",l,y),this.inc("pre",l,y);break;case"prerelease":this.prerelease.length===0&&this.inc("patch",l,y),this.inc("pre",l,y);break;case"release":if(this.prerelease.length===0)throw new Error(`version ${this.raw} is not a prerelease`);this.prerelease.length=0;break;case"major":(this.minor!==0||this.patch!==0||this.prerelease.length===0)&&this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":(this.patch!==0||this.prerelease.length===0)&&this.minor++,this.patch=0,this.prerelease=[];break;case"patch":this.prerelease.length===0&&this.patch++,this.prerelease=[];break;case"pre":{const f=Number(y)?1:0;if(this.prerelease.length===0)this.prerelease=[f];else{let m=this.prerelease.length;for(;--m>=0;)typeof this.prerelease[m]=="number"&&(this.prerelease[m]++,m=-2);if(m===-1){if(l===this.prerelease.join(".")&&y===!1)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(f)}}if(l){let m=[l,f];y===!1&&(m=[l]),u(this.prerelease[0],l)===0?isNaN(this.prerelease[1])&&(this.prerelease=m):this.prerelease=m}break}default:throw new Error(`invalid increment argument: ${h}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}}return Wi=d,Wi}var Ui,Ka;function Mr(){if(Ka)return Ui;Ka=1;const t=De();return Ui=(r,n,i=!1)=>{if(r instanceof t)return r;try{return new t(r,n)}catch(s){if(!i)return null;throw s}},Ui}var Mi,Xa;function py(){if(Xa)return Mi;Xa=1;const t=Mr();return Mi=(r,n)=>{const i=t(r,n);return i?i.version:null},Mi}var ji,Za;function my(){if(Za)return ji;Za=1;const t=Mr();return ji=(r,n)=>{const i=t(r.trim().replace(/^[=v]+/,""),n);return i?i.version:null},ji}var Fi,eu;function yy(){if(eu)return Fi;eu=1;const t=De();return Fi=(r,n,i,s,u)=>{typeof i=="string"&&(u=s,s=i,i=void 0);try{return new t(r instanceof t?r.version:r,i).inc(n,s,u).version}catch{return null}},Fi}var Vi,tu;function wy(){if(tu)return Vi;tu=1;const t=Mr();return Vi=(r,n)=>{const i=t(r,null,!0),s=t(n,null,!0),u=i.compare(s);if(u===0)return null;const d=u>0,c=d?i:s,h=d?s:i,l=!!c.prerelease.length;if(!!h.prerelease.length&&!l){if(!h.patch&&!h.minor)return"major";if(h.compareMain(c)===0)return h.minor&&!h.patch?"minor":"patch"}const f=l?"pre":"";return i.major!==s.major?f+"major":i.minor!==s.minor?f+"minor":i.patch!==s.patch?f+"patch":"prerelease"},Vi}var Bi,ru;function Ny(){if(ru)return Bi;ru=1;const t=De();return Bi=(r,n)=>new t(r,n).major,Bi}var Ji,nu;function gy(){if(nu)return Ji;nu=1;const t=De();return Ji=(r,n)=>new t(r,n).minor,Ji}var Gi,iu;function by(){if(iu)return Gi;iu=1;const t=De();return Gi=(r,n)=>new t(r,n).patch,Gi}var Hi,su;function vy(){if(su)return Hi;su=1;const t=Mr();return Hi=(r,n)=>{const i=t(r,n);return i&&i.prerelease.length?i.prerelease:null},Hi}var Qi,ou;function nt(){if(ou)return Qi;ou=1;const t=De();return Qi=(r,n,i)=>new t(r,i).compare(new t(n,i)),Qi}var Yi,au;function Ey(){if(au)return Yi;au=1;const t=nt();return Yi=(r,n,i)=>t(n,r,i),Yi}var zi,uu;function Oy(){if(uu)return zi;uu=1;const t=nt();return zi=(r,n)=>t(r,n,!0),zi}var Ki,cu;function To(){if(cu)return Ki;cu=1;const t=De();return Ki=(r,n,i)=>{const s=new t(r,i),u=new t(n,i);return s.compare(u)||s.compareBuild(u)},Ki}var Xi,du;function Ay(){if(du)return Xi;du=1;const t=To();return Xi=(r,n)=>r.sort((i,s)=>t(i,s,n)),Xi}var Zi,lu;function Ty(){if(lu)return Zi;lu=1;const t=To();return Zi=(r,n)=>r.sort((i,s)=>t(s,i,n)),Zi}var es,hu;function yi(){if(hu)return es;hu=1;const t=nt();return es=(r,n,i)=>t(r,n,i)>0,es}var ts,fu;function So(){if(fu)return ts;fu=1;const t=nt();return ts=(r,n,i)=>t(r,n,i)<0,ts}var rs,pu;function fd(){if(pu)return rs;pu=1;const t=nt();return rs=(r,n,i)=>t(r,n,i)===0,rs}var ns,mu;function pd(){if(mu)return ns;mu=1;const t=nt();return ns=(r,n,i)=>t(r,n,i)!==0,ns}var is,yu;function xo(){if(yu)return is;yu=1;const t=nt();return is=(r,n,i)=>t(r,n,i)>=0,is}var ss,wu;function Ro(){if(wu)return ss;wu=1;const t=nt();return ss=(r,n,i)=>t(r,n,i)<=0,ss}var os,Nu;function md(){if(Nu)return os;Nu=1;const t=fd(),e=pd(),r=yi(),n=xo(),i=So(),s=Ro();return os=(d,c,h,l)=>{switch(c){case"===":return typeof d=="object"&&(d=d.version),typeof h=="object"&&(h=h.version),d===h;case"!==":return typeof d=="object"&&(d=d.version),typeof h=="object"&&(h=h.version),d!==h;case"":case"=":case"==":return t(d,h,l);case"!=":return e(d,h,l);case">":return r(d,h,l);case">=":return n(d,h,l);case"<":return i(d,h,l);case"<=":return s(d,h,l);default:throw new TypeError(`Invalid operator: ${c}`)}},os}var as,gu;function Sy(){if(gu)return as;gu=1;const t=De(),e=Mr(),{safeRe:r,t:n}=gn();return as=(s,u)=>{if(s instanceof t)return s;if(typeof s=="number"&&(s=String(s)),typeof s!="string")return null;u=u||{};let d=null;if(!u.rtl)d=s.match(u.includePrerelease?r[n.COERCEFULL]:r[n.COERCE]);else{const m=u.includePrerelease?r[n.COERCERTLFULL]:r[n.COERCERTL];let v;for(;(v=m.exec(s))&&(!d||d.index+d[0].length!==s.length);)(!d||v.index+v[0].length!==d.index+d[0].length)&&(d=v),m.lastIndex=v.index+v[1].length+v[2].length;m.lastIndex=-1}if(d===null)return null;const c=d[2],h=d[3]||"0",l=d[4]||"0",y=u.includePrerelease&&d[5]?`-${d[5]}`:"",f=u.includePrerelease&&d[6]?`+${d[6]}`:"";return e(`${c}.${h}.${l}${y}${f}`,u)},as}var us,bu;function xy(){if(bu)return us;bu=1;class t{constructor(){this.max=1e3,this.map=new Map}get(r){const n=this.map.get(r);if(n!==void 0)return this.map.delete(r),this.map.set(r,n),n}delete(r){return this.map.delete(r)}set(r,n){if(!this.delete(r)&&n!==void 0){if(this.map.size>=this.max){const s=this.map.keys().next().value;this.delete(s)}this.map.set(r,n)}return this}}return us=t,us}var cs,vu;function it(){if(vu)return cs;vu=1;const t=/\s+/g;class e{constructor(g,I){if(I=i(I),g instanceof e)return g.loose===!!I.loose&&g.includePrerelease===!!I.includePrerelease?g:new e(g.raw,I);if(g instanceof s)return this.raw=g.value,this.set=[[g]],this.formatted=void 0,this;if(this.options=I,this.loose=!!I.loose,this.includePrerelease=!!I.includePrerelease,this.raw=g.trim().replace(t," "),this.set=this.raw.split("||").map(x=>this.parseRange(x.trim())).filter(x=>x.length),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){const x=this.set[0];if(this.set=this.set.filter(_=>!p(_[0])),this.set.length===0)this.set=[x];else if(this.set.length>1){for(const _ of this.set)if(_.length===1&&w(_[0])){this.set=[_];break}}}this.formatted=void 0}get range(){if(this.formatted===void 0){this.formatted="";for(let g=0;g<this.set.length;g++){g>0&&(this.formatted+="||");const I=this.set[g];for(let x=0;x<I.length;x++)x>0&&(this.formatted+=" "),this.formatted+=I[x].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(g){const x=((this.options.includePrerelease&&m)|(this.options.loose&&v))+":"+g,_=n.get(x);if(_)return _;const C=this.options.loose,U=C?c[h.HYPHENRANGELOOSE]:c[h.HYPHENRANGE];g=g.replace(U,M(this.options.includePrerelease)),u("hyphen replace",g),g=g.replace(c[h.COMPARATORTRIM],l),u("comparator trim",g),g=g.replace(c[h.TILDETRIM],y),u("tilde trim",g),g=g.replace(c[h.CARETTRIM],f),u("caret trim",g);let J=g.split(" ").map(fe=>D(fe,this.options)).join(" ").split(/\s+/).map(fe=>j(fe,this.options));C&&(J=J.filter(fe=>(u("loose invalid filter",fe,this.options),!!fe.match(c[h.COMPARATORLOOSE])))),u("range list",J);const $=new Map,G=J.map(fe=>new s(fe,this.options));for(const fe of G){if(p(fe))return[fe];$.set(fe.value,fe)}$.size>1&&$.has("")&&$.delete("");const Te=[...$.values()];return n.set(x,Te),Te}intersects(g,I){if(!(g instanceof e))throw new TypeError("a Range is required");return this.set.some(x=>A(x,I)&&g.set.some(_=>A(_,I)&&x.every(C=>_.every(U=>C.intersects(U,I)))))}test(g){if(!g)return!1;if(typeof g=="string")try{g=new d(g,this.options)}catch{return!1}for(let I=0;I<this.set.length;I++)if(P(this.set[I],g,this.options))return!0;return!1}}cs=e;const r=xy(),n=new r,i=Ao(),s=wi(),u=mi(),d=De(),{safeRe:c,t:h,comparatorTrimReplace:l,tildeTrimReplace:y,caretTrimReplace:f}=gn(),{FLAG_INCLUDE_PRERELEASE:m,FLAG_LOOSE:v}=pi(),p=O=>O.value==="<0.0.0-0",w=O=>O.value==="",A=(O,g)=>{let I=!0;const x=O.slice();let _=x.pop();for(;I&&x.length;)I=x.every(C=>_.intersects(C,g)),_=x.pop();return I},D=(O,g)=>(O=O.replace(c[h.BUILD],""),u("comp",O,g),O=N(O,g),u("caret",O),O=T(O,g),u("tildes",O),O=E(O,g),u("xrange",O),O=R(O,g),u("stars",O),O),W=O=>!O||O.toLowerCase()==="x"||O==="*",T=(O,g)=>O.trim().split(/\s+/).map(I=>b(I,g)).join(" "),b=(O,g)=>{const I=g.loose?c[h.TILDELOOSE]:c[h.TILDE];return O.replace(I,(x,_,C,U,J)=>{u("tilde",O,x,_,C,U,J);let $;return W(_)?$="":W(C)?$=`>=${_}.0.0 <${+_+1}.0.0-0`:W(U)?$=`>=${_}.${C}.0 <${_}.${+C+1}.0-0`:J?(u("replaceTilde pr",J),$=`>=${_}.${C}.${U}-${J} <${_}.${+C+1}.0-0`):$=`>=${_}.${C}.${U} <${_}.${+C+1}.0-0`,u("tilde return",$),$})},N=(O,g)=>O.trim().split(/\s+/).map(I=>S(I,g)).join(" "),S=(O,g)=>{u("caret",O,g);const I=g.loose?c[h.CARETLOOSE]:c[h.CARET],x=g.includePrerelease?"-0":"";return O.replace(I,(_,C,U,J,$)=>{u("caret",O,_,C,U,J,$);let G;return W(C)?G="":W(U)?G=`>=${C}.0.0${x} <${+C+1}.0.0-0`:W(J)?C==="0"?G=`>=${C}.${U}.0${x} <${C}.${+U+1}.0-0`:G=`>=${C}.${U}.0${x} <${+C+1}.0.0-0`:$?(u("replaceCaret pr",$),C==="0"?U==="0"?G=`>=${C}.${U}.${J}-${$} <${C}.${U}.${+J+1}-0`:G=`>=${C}.${U}.${J}-${$} <${C}.${+U+1}.0-0`:G=`>=${C}.${U}.${J}-${$} <${+C+1}.0.0-0`):(u("no pr"),C==="0"?U==="0"?G=`>=${C}.${U}.${J}${x} <${C}.${U}.${+J+1}-0`:G=`>=${C}.${U}.${J}${x} <${C}.${+U+1}.0-0`:G=`>=${C}.${U}.${J} <${+C+1}.0.0-0`),u("caret return",G),G})},E=(O,g)=>(u("replaceXRanges",O,g),O.split(/\s+/).map(I=>k(I,g)).join(" ")),k=(O,g)=>{O=O.trim();const I=g.loose?c[h.XRANGELOOSE]:c[h.XRANGE];return O.replace(I,(x,_,C,U,J,$)=>{u("xRange",O,x,_,C,U,J,$);const G=W(C),Te=G||W(U),fe=Te||W(J),jr=fe;return _==="="&&jr&&(_=""),$=g.includePrerelease?"-0":"",G?_===">"||_==="<"?x="<0.0.0-0":x="*":_&&jr?(Te&&(U=0),J=0,_===">"?(_=">=",Te?(C=+C+1,U=0,J=0):(U=+U+1,J=0)):_==="<="&&(_="<",Te?C=+C+1:U=+U+1),_==="<"&&($="-0"),x=`${_+C}.${U}.${J}${$}`):Te?x=`>=${C}.0.0${$} <${+C+1}.0.0-0`:fe&&(x=`>=${C}.${U}.0${$} <${C}.${+U+1}.0-0`),u("xRange return",x),x})},R=(O,g)=>(u("replaceStars",O,g),O.trim().replace(c[h.STAR],"")),j=(O,g)=>(u("replaceGTE0",O,g),O.trim().replace(c[g.includePrerelease?h.GTE0PRE:h.GTE0],"")),M=O=>(g,I,x,_,C,U,J,$,G,Te,fe,jr)=>(W(x)?I="":W(_)?I=`>=${x}.0.0${O?"-0":""}`:W(C)?I=`>=${x}.${_}.0${O?"-0":""}`:U?I=`>=${I}`:I=`>=${I}${O?"-0":""}`,W(G)?$="":W(Te)?$=`<${+G+1}.0.0-0`:W(fe)?$=`<${G}.${+Te+1}.0-0`:jr?$=`<=${G}.${Te}.${fe}-${jr}`:O?$=`<${G}.${Te}.${+fe+1}-0`:$=`<=${$}`,`${I} ${$}`.trim()),P=(O,g,I)=>{for(let x=0;x<O.length;x++)if(!O[x].test(g))return!1;if(g.prerelease.length&&!I.includePrerelease){for(let x=0;x<O.length;x++)if(u(O[x].semver),O[x].semver!==s.ANY&&O[x].semver.prerelease.length>0){const _=O[x].semver;if(_.major===g.major&&_.minor===g.minor&&_.patch===g.patch)return!0}return!1}return!0};return cs}var ds,Eu;function wi(){if(Eu)return ds;Eu=1;const t=Symbol("SemVer ANY");class e{static get ANY(){return t}constructor(l,y){if(y=r(y),l instanceof e){if(l.loose===!!y.loose)return l;l=l.value}l=l.trim().split(/\s+/).join(" "),u("comparator",l,y),this.options=y,this.loose=!!y.loose,this.parse(l),this.semver===t?this.value="":this.value=this.operator+this.semver.version,u("comp",this)}parse(l){const y=this.options.loose?n[i.COMPARATORLOOSE]:n[i.COMPARATOR],f=l.match(y);if(!f)throw new TypeError(`Invalid comparator: ${l}`);this.operator=f[1]!==void 0?f[1]:"",this.operator==="="&&(this.operator=""),f[2]?this.semver=new d(f[2],this.options.loose):this.semver=t}toString(){return this.value}test(l){if(u("Comparator.test",l,this.options.loose),this.semver===t||l===t)return!0;if(typeof l=="string")try{l=new d(l,this.options)}catch{return!1}return s(l,this.operator,this.semver,this.options)}intersects(l,y){if(!(l instanceof e))throw new TypeError("a Comparator is required");return this.operator===""?this.value===""?!0:new c(l.value,y).test(this.value):l.operator===""?l.value===""?!0:new c(this.value,y).test(l.semver):(y=r(y),y.includePrerelease&&(this.value==="<0.0.0-0"||l.value==="<0.0.0-0")||!y.includePrerelease&&(this.value.startsWith("<0.0.0")||l.value.startsWith("<0.0.0"))?!1:!!(this.operator.startsWith(">")&&l.operator.startsWith(">")||this.operator.startsWith("<")&&l.operator.startsWith("<")||this.semver.version===l.semver.version&&this.operator.includes("=")&&l.operator.includes("=")||s(this.semver,"<",l.semver,y)&&this.operator.startsWith(">")&&l.operator.startsWith("<")||s(this.semver,">",l.semver,y)&&this.operator.startsWith("<")&&l.operator.startsWith(">")))}}ds=e;const r=Ao(),{safeRe:n,t:i}=gn(),s=md(),u=mi(),d=De(),c=it();return ds}var ls,Ou;function Ni(){if(Ou)return ls;Ou=1;const t=it();return ls=(r,n,i)=>{try{n=new t(n,i)}catch{return!1}return n.test(r)},ls}var hs,Au;function Ry(){if(Au)return hs;Au=1;const t=it();return hs=(r,n)=>new t(r,n).set.map(i=>i.map(s=>s.value).join(" ").trim().split(" ")),hs}var fs,Tu;function Iy(){if(Tu)return fs;Tu=1;const t=De(),e=it();return fs=(n,i,s)=>{let u=null,d=null,c=null;try{c=new e(i,s)}catch{return null}return n.forEach(h=>{c.test(h)&&(!u||d.compare(h)===-1)&&(u=h,d=new t(u,s))}),u},fs}var ps,Su;function ky(){if(Su)return ps;Su=1;const t=De(),e=it();return ps=(n,i,s)=>{let u=null,d=null,c=null;try{c=new e(i,s)}catch{return null}return n.forEach(h=>{c.test(h)&&(!u||d.compare(h)===1)&&(u=h,d=new t(u,s))}),u},ps}var ms,xu;function Cy(){if(xu)return ms;xu=1;const t=De(),e=it(),r=yi();return ms=(i,s)=>{i=new e(i,s);let u=new t("0.0.0");if(i.test(u)||(u=new t("0.0.0-0"),i.test(u)))return u;u=null;for(let d=0;d<i.set.length;++d){const c=i.set[d];let h=null;c.forEach(l=>{const y=new t(l.semver.version);switch(l.operator){case">":y.prerelease.length===0?y.patch++:y.prerelease.push(0),y.raw=y.format();case"":case">=":(!h||r(y,h))&&(h=y);break;case"<":case"<=":break;default:throw new Error(`Unexpected operation: ${l.operator}`)}}),h&&(!u||r(u,h))&&(u=h)}return u&&i.test(u)?u:null},ms}var ys,Ru;function Ly(){if(Ru)return ys;Ru=1;const t=it();return ys=(r,n)=>{try{return new t(r,n).range||"*"}catch{return null}},ys}var ws,Iu;function Io(){if(Iu)return ws;Iu=1;const t=De(),e=wi(),{ANY:r}=e,n=it(),i=Ni(),s=yi(),u=So(),d=Ro(),c=xo();return ws=(l,y,f,m)=>{l=new t(l,m),y=new n(y,m);let v,p,w,A,D;switch(f){case">":v=s,p=d,w=u,A=">",D=">=";break;case"<":v=u,p=c,w=s,A="<",D="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(i(l,y,m))return!1;for(let W=0;W<y.set.length;++W){const T=y.set[W];let b=null,N=null;if(T.forEach(S=>{S.semver===r&&(S=new e(">=0.0.0")),b=b||S,N=N||S,v(S.semver,b.semver,m)?b=S:w(S.semver,N.semver,m)&&(N=S)}),b.operator===A||b.operator===D||(!N.operator||N.operator===A)&&p(l,N.semver))return!1;if(N.operator===D&&w(l,N.semver))return!1}return!0},ws}var Ns,ku;function Dy(){if(ku)return Ns;ku=1;const t=Io();return Ns=(r,n,i)=>t(r,n,">",i),Ns}var gs,Cu;function qy(){if(Cu)return gs;Cu=1;const t=Io();return gs=(r,n,i)=>t(r,n,"<",i),gs}var bs,Lu;function _y(){if(Lu)return bs;Lu=1;const t=it();return bs=(r,n,i)=>(r=new t(r,i),n=new t(n,i),r.intersects(n,i)),bs}var vs,Du;function Py(){if(Du)return vs;Du=1;const t=Ni(),e=nt();return vs=(r,n,i)=>{const s=[];let u=null,d=null;const c=r.sort((f,m)=>e(f,m,i));for(const f of c)t(f,n,i)?(d=f,u||(u=f)):(d&&s.push([u,d]),d=null,u=null);u&&s.push([u,null]);const h=[];for(const[f,m]of s)f===m?h.push(f):!m&&f===c[0]?h.push("*"):m?f===c[0]?h.push(`<=${m}`):h.push(`${f} - ${m}`):h.push(`>=${f}`);const l=h.join(" || "),y=typeof n.raw=="string"?n.raw:String(n);return l.length<y.length?l:n},vs}var Es,qu;function $y(){if(qu)return Es;qu=1;const t=it(),e=wi(),{ANY:r}=e,n=Ni(),i=nt(),s=(y,f,m={})=>{if(y===f)return!0;y=new t(y,m),f=new t(f,m);let v=!1;e:for(const p of y.set){for(const w of f.set){const A=c(p,w,m);if(v=v||A!==null,A)continue e}if(v)return!1}return!0},u=[new e(">=0.0.0-0")],d=[new e(">=0.0.0")],c=(y,f,m)=>{if(y===f)return!0;if(y.length===1&&y[0].semver===r){if(f.length===1&&f[0].semver===r)return!0;m.includePrerelease?y=u:y=d}if(f.length===1&&f[0].semver===r){if(m.includePrerelease)return!0;f=d}const v=new Set;let p,w;for(const E of y)E.operator===">"||E.operator===">="?p=h(p,E,m):E.operator==="<"||E.operator==="<="?w=l(w,E,m):v.add(E.semver);if(v.size>1)return null;let A;if(p&&w){if(A=i(p.semver,w.semver,m),A>0)return null;if(A===0&&(p.operator!==">="||w.operator!=="<="))return null}for(const E of v){if(p&&!n(E,String(p),m)||w&&!n(E,String(w),m))return null;for(const k of f)if(!n(E,String(k),m))return!1;return!0}let D,W,T,b,N=w&&!m.includePrerelease&&w.semver.prerelease.length?w.semver:!1,S=p&&!m.includePrerelease&&p.semver.prerelease.length?p.semver:!1;N&&N.prerelease.length===1&&w.operator==="<"&&N.prerelease[0]===0&&(N=!1);for(const E of f){if(b=b||E.operator===">"||E.operator===">=",T=T||E.operator==="<"||E.operator==="<=",p){if(S&&E.semver.prerelease&&E.semver.prerelease.length&&E.semver.major===S.major&&E.semver.minor===S.minor&&E.semver.patch===S.patch&&(S=!1),E.operator===">"||E.operator===">="){if(D=h(p,E,m),D===E&&D!==p)return!1}else if(p.operator===">="&&!n(p.semver,String(E),m))return!1}if(w){if(N&&E.semver.prerelease&&E.semver.prerelease.length&&E.semver.major===N.major&&E.semver.minor===N.minor&&E.semver.patch===N.patch&&(N=!1),E.operator==="<"||E.operator==="<="){if(W=l(w,E,m),W===E&&W!==w)return!1}else if(w.operator==="<="&&!n(w.semver,String(E),m))return!1}if(!E.operator&&(w||p)&&A!==0)return!1}return!(p&&T&&!w&&A!==0||w&&b&&!p&&A!==0||S||N)},h=(y,f,m)=>{if(!y)return f;const v=i(y.semver,f.semver,m);return v>0?y:v<0||f.operator===">"&&y.operator===">="?f:y},l=(y,f,m)=>{if(!y)return f;const v=i(y.semver,f.semver,m);return v<0?y:v>0||f.operator==="<"&&y.operator==="<="?f:y};return Es=s,Es}var Os,_u;function Wy(){if(_u)return Os;_u=1;const t=gn(),e=pi(),r=De(),n=hd(),i=Mr(),s=py(),u=my(),d=yy(),c=wy(),h=Ny(),l=gy(),y=by(),f=vy(),m=nt(),v=Ey(),p=Oy(),w=To(),A=Ay(),D=Ty(),W=yi(),T=So(),b=fd(),N=pd(),S=xo(),E=Ro(),k=md(),R=Sy(),j=wi(),M=it(),P=Ni(),O=Ry(),g=Iy(),I=ky(),x=Cy(),_=Ly(),C=Io(),U=Dy(),J=qy(),$=_y(),G=Py(),Te=$y();return Os={parse:i,valid:s,clean:u,inc:d,diff:c,major:h,minor:l,patch:y,prerelease:f,compare:m,rcompare:v,compareLoose:p,compareBuild:w,sort:A,rsort:D,gt:W,lt:T,eq:b,neq:N,gte:S,lte:E,cmp:k,coerce:R,Comparator:j,Range:M,satisfies:P,toComparators:O,maxSatisfying:g,minSatisfying:I,minVersion:x,validRange:_,outside:C,gtr:U,ltr:J,intersects:$,simplifyRange:G,subset:Te,SemVer:r,re:t.re,src:t.src,tokens:t.t,SEMVER_SPEC_VERSION:e.SEMVER_SPEC_VERSION,RELEASE_TYPES:e.RELEASE_TYPES,compareIdentifiers:n.compareIdentifiers,rcompareIdentifiers:n.rcompareIdentifiers},Os}var Uy=Wy();const My=wd(Uy);var jy={};const yd=t=>t({},{optionsOnly:!0});if(My.lt($e,"1.25.0"))throw new Error("Convex version must be at least 1.25.0");const Fy=(t,e)=>{const r=async i=>{const s=await i.auth.getUserIdentity();if(!s)return;const u=await i.runQuery(t.adapter.findOne,{model:"user",where:[{field:"_id",value:s.subject}]});if(u)return u},n=async i=>{const s=await i.auth.getUserIdentity();if(!s)return new Headers;const u=await i.runQuery(t.adapter.findOne,{model:"session",where:[{field:"_id",value:s.sessionId}]});return new Headers({...u?.token?{authorization:`Bearer ${u.token}`}:{},...u?.ipAddress?{"x-forwarded-for":u.ipAddress}:{}})};return{component:t,adapter:i=>ey(i,t,{...e,debugLogs:e?.verbose}),getAuth:async(i,s)=>({auth:i(s),headers:await n(s)}),getHeaders:n,safeGetAuthUser:r,getAuthUser:async i=>{const s=await r(i);if(!s)throw new Error("Unauthenticated");return s},getAnyUserById:async(i,s)=>await i.runQuery(t.adapter.findOne,{model:"user",where:[{field:"_id",value:s}]}),setUserId:async(i,s,u)=>{await i.runMutation(t.adapter.updateOne,{input:{model:"user",where:[{field:"_id",value:s}],update:{userId:u}}})},migrationGetUser:async(i,s)=>await i.runQuery(t.adapter.findOne,{model:"user",where:[{field:"userId",value:s}]}),migrationRemoveUserId:async(i,s)=>{if(!t.adapter.migrationRemoveUserId)throw new Error("migrationRemoveUserId not found");await i.runMutation(t.adapter.migrationRemoveUserId,{userId:s})},triggersApi:()=>({onCreate:Ai({args:{doc:a.any(),model:a.string()},handler:async(i,s)=>{await e?.triggers?.[s.model]?.onCreate?.(i,s.doc)}}),onUpdate:Ai({args:{oldDoc:a.any(),newDoc:a.any(),model:a.string()},handler:async(i,s)=>{await e?.triggers?.[s.model]?.onUpdate?.(i,s.newDoc,s.oldDoc)}}),onDelete:Ai({args:{doc:a.any(),model:a.string()},handler:async(i,s)=>{await e?.triggers?.[s.model]?.onDelete?.(i,s.doc)}})}),registerRoutes:(i,s,u={})=>{const d=yd(s),c=d.options.basePath??"/api/auth",h=qs(async(v,p)=>{e?.verbose&&(console.log("options.baseURL",d.options.baseURL),console.log("request headers",p.headers));const A=await s(v).handler(p);return e?.verbose&&console.log("response headers",A.headers),A});if(i.lookup("/.well-known/openid-configuration","GET")||i.route({path:"/.well-known/openid-configuration",method:"GET",handler:qs(async()=>{const v=`${jy.CONVEX_SITE_URL}${c}/convex/.well-known/openid-configuration`;return Response.redirect(v)})}),!u.cors){i.route({pathPrefix:`${c}/`,method:"GET",handler:h}),i.route({pathPrefix:`${c}/`,method:"POST",handler:h});return}const y=typeof u.cors=="boolean"?{allowedOrigins:[],allowedHeaders:[],exposedHeaders:[]}:u.cors;let f;const m=dy(i,{allowedOrigins:async v=>(f=f??(await d.$context).options.trustedOrigins??[],(Array.isArray(f)?f:await f(v)).map(w=>w.endsWith("*")&&w.length>1?w.slice(0,-1):w).concat(y.allowedOrigins??[])),allowCredentials:!0,allowedHeaders:["Content-Type","Better-Auth-Cookie","Authorization"].concat(y.allowedHeaders??[]),exposedHeaders:["Set-Better-Auth-Cookie"].concat(y.exposedHeaders??[]),debug:e?.verbose,enforceAllowOrigins:!1});m.route({pathPrefix:`${c}/`,method:"GET",handler:h}),m.route({pathPrefix:`${c}/`,method:"POST",handler:h})}}},Vy=th,By=t=>{const e={storeToken:"plain",...t};async function r(n,i){return e.storeToken==="hashed"?await Pm(i):typeof e.storeToken=="object"&&"type"in e.storeToken&&e.storeToken.type==="custom-hasher"?await e.storeToken.hash(i):i}return{id:"one-time-token",endpoints:{generateOneTimeToken:ye("/one-time-token/generate",{method:"GET",use:[Mu]},async n=>{if(e?.disableClientRequest&&n.request)throw n.error("BAD_REQUEST",{message:"Client requests are disabled"});const i=n.context.session,s=e?.generateToken?await e.generateToken(i,n):nl(32),u=new Date(Date.now()+(e?.expiresIn??3)*60*1e3),d=await r(n,s);return await n.context.internalAdapter.createVerificationValue({value:i.session.token,identifier:`one-time-token:${d}`,expiresAt:u}),n.json({token:s})}),loginWithOTT:ye("/sign-in/ott",{method:"POST",body:Mo({token:jo().describe('The token to verify. Eg: "some-token"')})},async n=>{const{token:i}=n.body,s=await r(n,i),u=await n.context.internalAdapter.findVerificationValue(`one-time-token:${s}`);if(!u)throw n.error("BAD_REQUEST",{message:"Invalid token"});if(await n.context.internalAdapter.deleteVerificationValue(u.id),u.expiresAt<new Date)throw n.error("BAD_REQUEST",{message:"Token expired"});const d=await n.context.internalAdapter.findSession(u.value);if(!d)throw n.error("BAD_REQUEST",{message:"Session not found"});const c=await n.context.internalAdapter.createSession(d.user.id,n,!1);return c?(await Ss(n,{session:c,user:d.user}),n.json({token:c.token,user:d.user})):n.json(null,{status:400,body:{message:"Could not create session"}})}),verifyOneTimeToken:ye("/one-time-token/verify",{method:"POST",body:Mo({token:jo().describe('The token to verify. Eg: "some-token"')})},async n=>{const{token:i}=n.body,s=await r(n,i),u=await n.context.internalAdapter.findVerificationValue(`one-time-token:${s}`);if(!u)throw n.error("BAD_REQUEST",{message:"Invalid token"});if(await n.context.internalAdapter.deleteVerificationValue(u.id),u.expiresAt<new Date)throw n.error("BAD_REQUEST",{message:"Token expired"});const d=await n.context.internalAdapter.findSession(u.value);if(!d)throw n.error("BAD_REQUEST",{message:"Session not found"});return n.json(d)})}}},Jy={user:Ne({name:a.string(),email:a.string(),emailVerified:a.boolean(),image:a.optional(a.union(a.null(),a.string())),createdAt:a.number(),updatedAt:a.number(),userId:a.optional(a.union(a.null(),a.string())),role:a.optional(a.union(a.null(),a.string())),banned:a.optional(a.union(a.null(),a.boolean())),banReason:a.optional(a.union(a.null(),a.string())),banExpires:a.optional(a.union(a.null(),a.number()))}).index("email_name",["email","name"]).index("name",["name"]).index("userId",["userId"]),session:Ne({expiresAt:a.number(),token:a.string(),createdAt:a.number(),updatedAt:a.number(),ipAddress:a.optional(a.union(a.null(),a.string())),userAgent:a.optional(a.union(a.null(),a.string())),userId:a.string(),impersonatedBy:a.optional(a.union(a.null(),a.string()))}).index("expiresAt",["expiresAt"]).index("expiresAt_userId",["expiresAt","userId"]).index("token",["token"]).index("userId",["userId"]),account:Ne({accountId:a.string(),providerId:a.string(),userId:a.string(),accessToken:a.optional(a.union(a.null(),a.string())),refreshToken:a.optional(a.union(a.null(),a.string())),idToken:a.optional(a.union(a.null(),a.string())),accessTokenExpiresAt:a.optional(a.union(a.null(),a.number())),refreshTokenExpiresAt:a.optional(a.union(a.null(),a.number())),scope:a.optional(a.union(a.null(),a.string())),password:a.optional(a.union(a.null(),a.string())),createdAt:a.number(),updatedAt:a.number()}).index("accountId",["accountId"]).index("accountId_providerId",["accountId","providerId"]).index("providerId_userId",["providerId","userId"]).index("userId",["userId"]),verification:Ne({identifier:a.string(),value:a.string(),expiresAt:a.number(),createdAt:a.number(),updatedAt:a.number()}).index("expiresAt",["expiresAt"]).index("identifier",["identifier"]),jwks:Ne({publicKey:a.string(),privateKey:a.string(),createdAt:a.number()}),rateLimit:Ne({key:a.optional(a.union(a.null(),a.string())),count:a.optional(a.union(a.null(),a.number())),lastRequest:a.optional(a.union(a.null(),a.number()))}).index("key",["key"]),ratelimit:Ne({key:a.string(),count:a.number(),lastRequest:a.number()}).index("key",["key"])},Gy=so(Jy);var Xt={};const Hy=Xt.PUBLIC_CONVEX_SITE_URL,Qy=Sd.auth,ko=Fy(xd.betterAuth,{local:{schema:Gy},authFunctions:Qy,triggers:{user:{onDelete:async(t,e)=>{if(!e?.userId)return;const r=await t.db.query("backups").withIndex("by_user",n=>n.eq("userId",e.userId)).collect();for(const n of r)await t.db.delete(n._id)}}}}),Yy=(t,{optionsOnly:e}={optionsOnly:!1})=>Lm({logger:{disabled:e},baseURL:Hy,trustedOrigins:["*"],database:ko.adapter(t),emailAndPassword:{enabled:!1},plugins:[Wm(),By(),_m(),{id:"disable-state-check",hooks:{before:[{matcher(){return!0},handler:Ft(async r=>({context:{context:{oauthConfig:{skipStateCookieCheck:!0}}}}))}]}}],socialProviders:{github:{clientId:Xt.GITHUB_CLIENT_ID,clientSecret:Xt.GITHUB_CLIENT_SECRET},google:{clientId:Xt.GOOGLE_CLIENT_ID,clientSecret:Xt.GOOGLE_CLIENT_SECRET},discord:{clientId:Xt.DISCORD_CLIENT_ID,clientSecret:Xt.DISCORD_CLIENT_SECRET}},advanced:{defaultCookieAttributes:{sameSite:"none",secure:!0,partitioned:!0}},user:{deleteUser:{enabled:!0}},account:{accountLinking:{enabled:!0,allowDifferentEmails:!0}},rateLimit:{window:10,max:100,enabled:!0,storage:"database"}});Vy({args:{},handler:async t=>ko.safeGetAuthUser(t)});ko.triggersApi();yd(Yy);async function lw(){if(!hl())throw gd(null,{status:404})}const hw=Nd(function(){const[e,r]=bn.useState(""),[n,i]=bn.useState(""),[s,u]=bn.useState(""),d=dl(Ht.backups.getBackups),c=Uo(Ht.backups.createBackup).withOptimisticUpdate((m,v)=>{const{data:p,name:w,backupKey:A}=v,D=m.getQuery(Ht.backups.getBackups);if(D?.success&&D.backups!==void 0){const W=Date.now(),T={_id:crypto.randomUUID(),_creationTime:W,name:w,data:p,version:1,userId:"",backupKey:A};m.setQuery(Ht.backups.getBackups,{},{success:!0,backups:[T,...D.backups]})}}),h=il.useSession(),l=ll(),y=Uo(Ht.backups.deleteBackup).withOptimisticUpdate((m,v)=>{const{id:p}=v,w=m.getQuery(Ht.backups.getBackups);if(w?.success&&w.backups!==void 0){const A=w.backups.filter(D=>D._id!==p);m.setQuery(Ht.backups.getBackups,{},{success:!0,backups:A})}});bn.useEffect(()=>{r($a())},[]);const f=async()=>{if(!s.trim()){Qt.error("Please enter a backup name");return}const m=crypto.randomUUID(),v=s;u(""),Qt.promise(c({data:$a(),name:v,backupKey:m}).then(p=>{if(p?.success)return p;throw new Error(p?.error||"Failed to create backup")}),{loading:"Creating backup...",success:"Backup created",error:p=>p.message||"Failed to create backup"})};return L.jsxs("div",{className:"max-w-4xl mx-auto w-full p-4 flex flex-col gap-4",children:[L.jsx("h1",{className:"text-4xl",children:"Backups"}),L.jsxs(Co,{children:[L.jsx(Lo,{children:L.jsx(Do,{children:"Local Backup"})}),L.jsxs(qo,{className:"flex flex-col gap-4",children:[L.jsxs("div",{className:"flex flex-col gap-2",children:[L.jsx("h2",{className:"font-bold",children:"Export"}),L.jsxs("div",{className:"flex flex-row gap-3",children:[L.jsx(gi,{disabled:!0,value:e}),L.jsx(pr,{size:"icon",onClick:()=>{navigator.clipboard.writeText(e).then(()=>{Qt.success("Backup copied to clipboard")}).catch(m=>{Qt.error("Failed to copy backup to clipboard")})},children:L.jsx(sl,{})})]})]}),L.jsxs("div",{className:"flex flex-col gap-2",children:[L.jsx("h2",{className:"font-bold",children:"Restore"}),L.jsx("p",{className:"text-sm text-muted-foreground",children:"This will overwrite your current data."}),L.jsxs("div",{className:"flex flex-row gap-3",children:[L.jsx(gi,{value:n,onChange:m=>i(m.target.value)}),L.jsx(pr,{disabled:n.length===0,onClick:()=>{Wa(n)},children:"Restore"})]})]})]})]}),h.data?.user&&L.jsx(_o,{mode:"popLayout",initial:!1,children:l.isLoading||!d?.success?L.jsxs(vn.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},transition:{ease:Vr},className:"flex flex-col gap-2",children:[L.jsx(xn,{className:"h-10 w-[150px]"}),L.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:[L.jsx(xn,{className:"h-24 w-full rounded-xl"}),L.jsx(xn,{className:"h-24 w-full rounded-xl"}),L.jsx(xn,{className:"h-24 w-full rounded-xl"})]})]},"loading"):L.jsxs(vn.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},transition:{ease:Vr},className:"flex flex-col gap-2",children:[L.jsx("h2",{className:"text-2xl",children:"Cloud Backups"}),L.jsxs(Co,{children:[L.jsx(Lo,{children:L.jsx(Do,{children:"Create Backup"})}),L.jsx(qo,{children:L.jsxs("div",{className:"flex flex-row gap-2",children:[L.jsx(gi,{value:s,onChange:m=>u(m.target.value),onKeyDown:m=>{m.key==="Enter"&&s.trim()&&f()},autoFocus:!0,placeholder:"Backup Name"}),L.jsx(pr,{size:"icon",onClick:f,disabled:!s.trim(),children:L.jsx(ol,{})})]})})]}),L.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:L.jsx(_o,{mode:"popLayout",initial:!1,children:d?.success&&d?.backups&&d.backups.length>0?d.backups.map(m=>L.jsxs(vn.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},transition:{ease:Vr},layout:!0,className:"flex flex-col gap-2 bg-card rounded-xl p-4 border",children:[L.jsx("h3",{className:"text-lg",children:m.name}),L.jsxs("p",{className:"text-sm text-muted-foreground",children:["Created at"," ",new Date(m._creationTime).toLocaleString()]}),L.jsx("div",{className:"grow"}),L.jsxs("div",{className:"flex flex-row gap-2 justify-end",children:[L.jsxs(Fo,{children:[L.jsx(Vo,{asChild:!0,children:L.jsx(pr,{variant:"destructive",size:"icon",children:L.jsx(al,{})})}),L.jsxs(Bo,{children:[L.jsxs(Jo,{children:[L.jsx(Go,{children:"Delete Backup"}),L.jsx(Ho,{children:"Are you sure you want to delete this backup?"})]}),L.jsxs(Qo,{children:[L.jsx(Yo,{children:"Cancel"}),L.jsx(zo,{onClick:()=>{Qt.promise(new Promise(async(v,p)=>{const w=await y({id:m._id});w?.success?v(!0):p(w?.error)}),{loading:"Deleting backup...",success:"Backup deleted",error:"Failed to delete backup"})},children:"Delete"})]})]})]}),L.jsx(pr,{variant:"outline",size:"icon",onClick:()=>{navigator.clipboard.writeText(m.data).then(()=>{Qt.success("Backup copied to clipboard")}).catch(v=>{Qt.error("Failed to copy backup to clipboard")})},children:L.jsx(ul,{})}),L.jsxs(Fo,{children:[L.jsx(Vo,{asChild:!0,children:L.jsxs(pr,{children:[L.jsx(Wo,{}),"Restore"]})}),L.jsxs(Bo,{children:[L.jsxs(Jo,{children:[L.jsx(Go,{children:"Restore Backup"}),L.jsx(Ho,{children:"Are you sure you want to restore this backup? This will overwrite your current data."})]}),L.jsxs(Qo,{children:[L.jsx(Yo,{children:"Cancel"}),L.jsx(zo,{onClick:()=>{Wa(m.data)},children:"Restore"})]})]})]})]})]},m.backupKey)):L.jsx(vn.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1,transition:{ease:Vr,delay:.2}},exit:{opacity:0,scale:.95,transition:{ease:Vr}},className:"md:col-span-2",children:L.jsx(bd,{children:L.jsxs(vd,{children:[L.jsx(Ed,{variant:"icon",children:L.jsx(Wo,{className:"size-6"})}),L.jsx(Od,{children:"No backups yet"}),L.jsx(Ad,{children:"Create your first backup to get started. Your backups will appear here."})]})})},"empty-state")})})]},"loaded")})]})});export{ze as C,li as D,Nn as a,fi as b,Fm as c,Ip as d,lw as e,Eo as g,hw as p,te as s};
