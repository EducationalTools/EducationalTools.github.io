import"./CWj6FrbW.js";import{k as Be,p as R,i as w,e as v,a as m,c as C,g as p,u as M,f as B,d as fe,j as F,r as ge,am as W,ao as ye,av as We,ab as ie,l as qe,m as Ee,s as bt,b as je,t as Je,J as wt}from"./Cd13tLbQ.js";import{a as k,m as oe,u as ae,n as _e}from"./1ScPFJNN.js";import{i as O}from"./C1R1Yb0q.js";import{b as Ke,h as He,s as ze,c as Xe}from"./C6bjgBV9.js";import{p as X,r as $,d as St,c as Ye}from"./DfCpWMhL.js";import{c as Ge,b as Y,m as Ze}from"./CxTyhMz9.js";import{g as kt,h as Rt}from"./Cr68Ji2L.js";import{a as Ct,o as Te}from"./CVdRVHo9.js";import{I as et}from"./CPBS4AKp.js";import{s as Ae}from"./NNoFateq.js";const _t=!0;var Tt=B("<div><!></div>");function Fr(s,e){const t=Be();R(e,!0);let r=X(e,"id",19,()=>Ge(t)),n=X(e,"ref",15,null),i=X(e,"level",3,2),o=$(e,["$$slots","$$events","$$legacy","id","ref","child","children","level"]);const a=kt.create({id:Y.with(()=>r()),level:Y.with(()=>i()),ref:Y.with(()=>n(),d=>n(d))}),c=M(()=>Ze(o,a.props));var h=w(),u=v(h);{var g=d=>{var f=w(),y=v(f);k(y,()=>e.child,()=>({props:p(c)})),m(d,f)},l=d=>{var f=Tt();Ke(f,()=>({...p(c)}));var y=fe(f);k(y,()=>e.children??F),ge(f),m(d,f)};O(u,d=>{e.child?d(g):d(l,!1)})}m(s,h),C()}var At=B("<div><!></div>");function Dr(s,e){const t=Be();R(e,!0);let r=X(e,"id",19,()=>Ge(t)),n=X(e,"ref",15,null),i=$(e,["$$slots","$$events","$$legacy","id","children","child","ref"]);const o=Rt.create({id:Y.with(()=>r()),ref:Y.with(()=>n(),l=>n(l))}),a=M(()=>Ze(i,o.props));var c=w(),h=v(c);{var u=l=>{var d=w(),f=v(d);k(f,()=>e.child,()=>({props:p(a)})),m(l,d)},g=l=>{var d=At();Ke(d,()=>({...p(a)}));var f=fe(d);k(f,()=>e.children??F),ge(d),m(l,d)};O(h,l=>{e.child?l(u):l(g,!1)})}m(s,c),C()}const tt="$$_clerk",j=()=>{const s=W(tt);if(!s)throw new Error("No Clerk data was found in Svelte context. Did you forget to wrap your component with ClerkProvider?");return s},Ur=s=>{ye(tt,s)};function It(s,e){R(e,!0);const t=j();var r=w(),n=v(r);{var i=o=>{var a=w(),c=v(a);k(c,()=>e.children,()=>t.clerk),m(o,a)};O(n,o=>{t.isLoaded&&o(i)})}m(s,r),C()}var qt=B("<div></div>"),Et=B("<!> <!>",1);function Mt(s,e){R(e,!0);const t=$(e,["$$slots","$$events","$$legacy","children"]);let r=qe(null),n=qe(!1),i=We(t);const o=j();ye("$$_userButton",{addCustomMenuItem(u,g){i.customMenuItems=[...i.customMenuItems||[],g]},addCustomPage(u){var g;i.userProfileProps={...i.userProfileProps,customPages:[...((g=i.userProfileProps)==null?void 0:g.customPages)||[],u]}}}),ie(()=>{p(r)&&o.clerk&&(p(n)?o.clerk.__unstable__updateProps({node:p(r),props:i}):(o.clerk.mountUserButton(p(r),t),Ee(n,!0)))}),Ct(()=>{var u;p(n)&&((u=o.clerk)==null||u.unmountUserButton(p(r)))});var a=Et(),c=v(a);It(c,{children:(u,g)=>{var l=qt();St(l,d=>Ee(r,d),()=>p(r)),m(u,l)},$$slots:{default:!0}});var h=bt(c,2);k(h,()=>e.children??F),m(s,a),C()}function ce(s,e){var t=w(),r=v(t);k(r,()=>e.children),m(s,t)}function xt(s,e){R(e,!0);const{addCustomMenuItem:t}=W("$$_userButtonMenuItems"),r=$(e,["$$slots","$$events","$$legacy"]);Te(()=>{if(e.label==="manageAccount"||e.label==="signOut"){t("action",{label:e.label});return}const{label:n,onclick:i,open:o,labelIcon:a}=r;let c;t("action",{label:n,mountIcon(h){c=oe(ce,{target:h,props:{children:a}})},unmountIcon(){c&&ae(c)},...i?{onClick:i}:{open:o.startsWith("/")?o:`/${o}`}})}),C()}function Ot(s,e){R(e,!0);const{addCustomMenuItem:t}=W("$$_userButtonMenuItems");Te(()=>{let r;t("link",{label:e.label,mountIcon(n){r=oe(ce,{target:n,props:{children:e.labelIcon}})},unmountIcon(){r&&ae(r)},href:e.href})}),C()}function Pt(s,e){R(e,!0);const t=W("$$_userButton");ye("$$_userButtonMenuItems",t);var r=w(),n=v(r);k(n,()=>e.children),m(s,r),C()}function Lt(s,e){R(e,!0);const{addCustomPage:t}=W("$$_userButton");Te(()=>{let r,n;t({label:e.label,url:e.url,mountIcon(i){r=oe(ce,{target:i,props:{children:e.labelIcon}})},unmountIcon(){r&&ae(r)},mount(i){n=oe(ce,{target:i,props:{children:e.children}})},unmount(){n&&ae(n)}})}),C()}Object.assign(Mt,{MenuItems:Pt,Action:xt,Link:Ot,UserProfilePage:Lt});function Nr(s,e){R(e,!0);const t=j();var r=w(),n=v(r);{var i=o=>{var a=w(),c=v(a);k(c,()=>e.children),m(o,a)};O(n,o=>{t.auth.userId&&o(i)})}m(s,r),C()}function Qr(s,e){R(e,!0);const t=j();var r=w(),n=v(r);{var i=o=>{var a=w(),c=v(a);k(c,()=>e.children),m(o,a)};O(n,o=>{t.auth.userId===null&&o(i)})}m(s,r),C()}var $t=B('<button type="button"><!></button>');function Br(s,e){R(e,!0);const t=$(e,["$$slots","$$events","$$legacy","mode","children","style","class","asChild"]),r=j();function n(){if(r.clerk){if(e.mode==="modal"){r.clerk.openSignIn(t);return}r.clerk.redirectToSignIn({...t,signInFallbackRedirectUrl:e.fallbackRedirectUrl,signInForceRedirectUrl:e.forceRedirectUrl})}}var i=w(),o=v(i);{var a=h=>{var u=w(),g=v(u);k(g,()=>e.children??F,()=>({signIn:n})),m(h,u)},c=h=>{var u=$t();u.__click=n;var g=fe(u);{var l=f=>{var y=w(),T=v(y);k(T,()=>e.children,()=>({signIn:n})),m(f,y)},d=f=>{var y=Je("Sign in");m(f,y)};O(g,f=>{e.children?f(l):f(d,!1)})}ge(u),je(()=>{He(u,e.style),ze(u,1,Xe(e.class))}),m(h,u)};O(o,h=>{e.asChild?h(a):h(c,!1)})}m(s,i),C()}_e(["click"]);var Vt=B('<button type="button"><!></button>');function Wr(s,e){R(e,!0);const t=$(e,["$$slots","$$events","$$legacy","mode","children","style","class","asChild"]),r=j();function n(){if(r.clerk){if(e.mode==="modal"){r.clerk.openSignUp(t);return}r.clerk.redirectToSignUp({...t,signUpFallbackRedirectUrl:e.fallbackRedirectUrl,signUpForceRedirectUrl:e.forceRedirectUrl})}}var i=w(),o=v(i);{var a=h=>{var u=w(),g=v(u);k(g,()=>e.children??F,()=>({signUp:n})),m(h,u)},c=h=>{var u=Vt();u.__click=n;var g=fe(u);{var l=f=>{var y=w(),T=v(y);k(T,()=>e.children,()=>({signUp:n})),m(f,y)},d=f=>{var y=Je("Sign up");m(f,y)};O(g,f=>{e.children?f(l):f(d,!1)})}ge(u),je(()=>{He(u,e.style),ze(u,1,Xe(e.class))}),m(h,u)};O(o,h=>{e.asChild?h(a):h(c,!1)})}m(s,i),C()}_e(["click"]);_e(["click"]);var Ft=(s,e="5.74.0")=>{if(s)return s;const t=Dt(e);return t?t==="snapshot"?"5.74.0":t:Ut(e)},Dt=s=>{var e;return(e=s.trim().replace(/^v/,"").match(/-(.+?)(\.|$)/))==null?void 0:e[1]},Ut=s=>s.trim().replace(/^v/,"").split(".")[0];function Nt(s){return s?Qt(s)||st(s):!0}function Qt(s){return/^http(s)?:\/\//.test(s||"")}function st(s){return s.startsWith("/")}function Bt(s){return s?st(s)?new URL(s,window.location.origin).toString():s:""}var Wt=[".lcl.dev",".stg.dev",".lclstage.dev",".stgstage.dev",".dev.lclclerk.com",".stg.lclclerk.com",".accounts.lclclerk.com","accountsstage.dev","accounts.dev"];function jt(s){if(!s)return"";let e;if(s.match(/^(clerk\.)+\w*$/))e=/(clerk\.)*(?=clerk\.)/;else{if(s.match(/\.clerk.accounts/))return s;e=/^(clerk\.)*/gi}return`clerk.${s.replace(e,"")}`}var Jt={initialDelay:125,maxDelayBetweenRetries:0,factor:2,shouldRetry:(s,e)=>e<5,retryImmediately:!1,jitter:!0},Kt=100,rt=async s=>new Promise(e=>setTimeout(e,s)),nt=(s,e)=>e?s*(1+Math.random()):s,Ht=s=>{let e=0;const t=()=>{const r=s.initialDelay,n=s.factor;let i=r*Math.pow(n,e);return i=nt(i,s.jitter),Math.min(s.maxDelayBetweenRetries||i,i)};return async()=>{await rt(t()),e++}},zt=async(s,e={})=>{let t=0;const{shouldRetry:r,initialDelay:n,maxDelayBetweenRetries:i,factor:o,retryImmediately:a,jitter:c}={...Jt,...e},h=Ht({initialDelay:n,maxDelayBetweenRetries:i,factor:o,jitter:c});for(;;)try{return await s()}catch(u){if(t++,!r(u,t))throw u;a&&t===1?await rt(nt(Kt,c)):await h()}},Xt="loadScript cannot be called when document does not exist",Yt="loadScript cannot be called without a src";async function Gt(s="",e){const{async:t,defer:r,beforeLoad:n,crossOrigin:i,nonce:o}=e||{};return zt(()=>new Promise((c,h)=>{s||h(new Error(Yt)),(!document||!document.body)&&h(Xt);const u=document.createElement("script");i&&u.setAttribute("crossorigin",i),u.async=t||!1,u.defer=r||!1,u.addEventListener("load",()=>{u.remove(),c(u)}),u.addEventListener("error",()=>{u.remove(),h()}),u.src=s,u.nonce=o,n==null||n(u),document.body.appendChild(u)}),{shouldRetry:(c,h)=>h<=5})}var Zt=Object.freeze({InvalidProxyUrlErrorMessage:"The proxyUrl passed to Clerk is invalid. The expected value for proxyUrl is an absolute URL or a relative path with a leading '/'. (key={{url}})",InvalidPublishableKeyErrorMessage:"The publishableKey passed to Clerk is invalid. You can get your Publishable key at https://dashboard.clerk.com/last-active?path=api-keys. (key={{key}})",MissingPublishableKeyErrorMessage:"Missing publishableKey. You can get your key at https://dashboard.clerk.com/last-active?path=api-keys.",MissingSecretKeyErrorMessage:"Missing secretKey. You can get your key at https://dashboard.clerk.com/last-active?path=api-keys.",MissingClerkProvider:"{{source}} can only be used within the <ClerkProvider /> component. Learn more: https://clerk.com/docs/components/clerk-provider"});function es({packageName:s,customMessages:e}){let t=s;function r(i,o){if(!o)return`${t}: ${i}`;let a=i;const c=i.matchAll(/{{([a-zA-Z0-9-_]+)}}/g);for(const h of c){const u=(o[h[1]]||"").toString();a=a.replace(`{{${h[1]}}}`,u)}return`${t}: ${a}`}const n={...Zt,...e};return{setPackageName({packageName:i}){return typeof i=="string"&&(t=i),this},setMessages({customMessages:i}){return Object.assign(n,i||{}),this},throwInvalidPublishableKeyError(i){throw new Error(r(n.InvalidPublishableKeyErrorMessage,i))},throwInvalidProxyUrl(i){throw new Error(r(n.InvalidProxyUrlErrorMessage,i))},throwMissingPublishableKeyError(){throw new Error(r(n.MissingPublishableKeyErrorMessage))},throwMissingSecretKeyError(){throw new Error(r(n.MissingSecretKeyErrorMessage))},throwMissingClerkProviderError(i){throw new Error(r(n.MissingClerkProvider,i))},throw(i){throw new Error(r(i))}}}var it=s=>typeof atob<"u"&&typeof atob=="function"?atob(s):typeof global<"u"&&global.Buffer?new global.Buffer(s,"base64").toString():s,ot="pk_live_",ts="pk_test_";function at(s){if(!s.endsWith("$"))return!1;const e=s.slice(0,-1);return e.includes("$")?!1:e.includes(".")}function Me(s,e={}){if(s=s||"",!s||!xe(s)){if(e.fatal&&!s)throw new Error("Publishable key is missing. Ensure that your publishable key is correctly configured. Double-check your environment configuration for your keys, or access them here: https://dashboard.clerk.com/last-active?path=api-keys");if(e.fatal&&!xe(s))throw new Error("Publishable key not valid.");return null}const t=s.startsWith(ot)?"production":"development";let r;try{r=it(s.split("_")[2])}catch{if(e.fatal)throw new Error("Publishable key not valid: Failed to decode key.");return null}if(!at(r)){if(e.fatal)throw new Error("Publishable key not valid: Decoded key has invalid format.");return null}let n=r.slice(0,-1);return e.proxyUrl?n=e.proxyUrl:t!=="development"&&e.domain&&e.isSatellite&&(n=`clerk.${e.domain}`),{instanceType:t,frontendApi:n}}function xe(s=""){try{if(!(s.startsWith(ot)||s.startsWith(ts)))return!1;const t=s.split("_");if(t.length!==3)return!1;const r=t[2];if(!r)return!1;const n=it(r);return at(n)}catch{return!1}}function ss(){const s=new Map;return{isDevOrStagingUrl:e=>{if(!e)return!1;const t=typeof e=="string"?e:e.hostname;let r=s.get(t);return r===void 0&&(r=Wt.some(n=>t.endsWith(n)),s.set(t,r)),r}}}var Oe="Clerk: Failed to load Clerk",{isDevOrStagingUrl:rs}=ss(),ct=es({packageName:"@clerk/shared"});function jr(s){ct.setPackageName({packageName:s})}var Jr=async s=>{const e=document.querySelector("script[data-clerk-js-script]");if(e)return new Promise((t,r)=>{e.addEventListener("load",()=>{t(e)}),e.addEventListener("error",()=>{r(Oe)})});if(!(s!=null&&s.publishableKey)){ct.throwMissingPublishableKeyError();return}return Gt(ns(s),{async:!0,crossOrigin:"anonymous",nonce:s.nonce,beforeLoad:os(s)}).catch(()=>{throw new Error(Oe)})},ns=s=>{var u,g;const{clerkJSUrl:e,clerkJSVariant:t,clerkJSVersion:r,proxyUrl:n,domain:i,publishableKey:o}=s;if(e)return e;let a="";n&&Nt(n)?a=Bt(n).replace(/http(s)?:\/\//,""):i&&!rs(((u=Me(o))==null?void 0:u.frontendApi)||"")?a=jt(i):a=((g=Me(o))==null?void 0:g.frontendApi)||"";const c=t?`${t.replace(/\.+$/,"")}.`:"",h=Ft(r);return`https://${a}/npm/@clerk/clerk-js@${h}/dist/clerk.${c}browser.js`},is=s=>{const e={};return s.publishableKey&&(e["data-clerk-publishable-key"]=s.publishableKey),s.proxyUrl&&(e["data-clerk-proxy-url"]=s.proxyUrl),s.domain&&(e["data-clerk-domain"]=s.domain),s.nonce&&(e.nonce=s.nonce),e},os=s=>e=>{const t=is(s);for(const r in t)e.setAttribute(r,t[r])};function Kr(s,e){R(e,!0);/**
 * @license @lucide/svelte v0.525.0 - ISC
 *
 * ISC License
 *
 * Copyright (c) for portions of Lucide are held by Cole Bemis 2013-2022 as part of Feather (MIT). All other copyright (c) for Lucide are held by Lucide Contributors 2022.
 *
 * Permission to use, copy, modify, and/or distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 *
 */let t=$(e,["$$slots","$$events","$$legacy"]);const r=[["circle",{cx:"12",cy:"12",r:"10"}],["path",{d:"M12 16v-4"}],["path",{d:"M12 8h.01"}]];et(s,Ye({name:"info"},()=>t,{get iconNode(){return r},children:(n,i)=>{var o=w(),a=v(o);k(a,()=>e.children??F),m(n,o)},$$slots:{default:!0}})),C()}function Hr(s,e){R(e,!0);/**
 * @license @lucide/svelte v0.525.0 - ISC
 *
 * ISC License
 *
 * Copyright (c) for portions of Lucide are held by Cole Bemis 2013-2022 as part of Feather (MIT). All other copyright (c) for Lucide are held by Lucide Contributors 2022.
 *
 * Permission to use, copy, modify, and/or distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 *
 */let t=$(e,["$$slots","$$events","$$legacy"]);const r=[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"}]];et(s,Ye({name:"clipboard"},()=>t,{get iconNode(){return r},children:(n,i)=>{var o=w(),a=v(o);k(a,()=>e.children??F),m(n,o)},$$slots:{default:!0}})),C()}const Pe="1.25.4";var E=[],I=[],as=Uint8Array,me="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var D=0,cs=me.length;D<cs;++D)E[D]=me[D],I[me.charCodeAt(D)]=D;I[45]=62;I[95]=63;function us(s){var e=s.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=s.indexOf("=");t===-1&&(t=e);var r=t===e?0:4-t%4;return[t,r]}function hs(s,e,t){return(e+t)*3/4-t}function ee(s){var e,t=us(s),r=t[0],n=t[1],i=new as(hs(s,r,n)),o=0,a=n>0?r-4:r,c;for(c=0;c<a;c+=4)e=I[s.charCodeAt(c)]<<18|I[s.charCodeAt(c+1)]<<12|I[s.charCodeAt(c+2)]<<6|I[s.charCodeAt(c+3)],i[o++]=e>>16&255,i[o++]=e>>8&255,i[o++]=e&255;return n===2&&(e=I[s.charCodeAt(c)]<<2|I[s.charCodeAt(c+1)]>>4,i[o++]=e&255),n===1&&(e=I[s.charCodeAt(c)]<<10|I[s.charCodeAt(c+1)]<<4|I[s.charCodeAt(c+2)]>>2,i[o++]=e>>8&255,i[o++]=e&255),i}function ls(s){return E[s>>18&63]+E[s>>12&63]+E[s>>6&63]+E[s&63]}function ds(s,e,t){for(var r,n=[],i=e;i<t;i+=3)r=(s[i]<<16&16711680)+(s[i+1]<<8&65280)+(s[i+2]&255),n.push(ls(r));return n.join("")}function te(s){for(var e,t=s.length,r=t%3,n=[],i=16383,o=0,a=t-r;o<a;o+=i)n.push(ds(s,o,o+i>a?a:o+i));return r===1?(e=s[t-1],n.push(E[e>>2]+E[e<<4&63]+"==")):r===2&&(e=(s[t-2]<<8)+s[t-1],n.push(E[e>>10]+E[e>>4&63]+E[e<<2&63]+"=")),n.join("")}function P(s){if(s===void 0)return{};if(!ht(s))throw new Error(`The arguments to a Convex function must be an object. Received: ${s}`);return s}function ut(s){if(typeof s>"u")throw new Error("Client created with undefined deployment address. If you used an environment variable, check that it's set.");if(typeof s!="string")throw new Error(`Invalid deployment address: found ${s}".`);if(!(s.startsWith("http:")||s.startsWith("https:")))throw new Error(`Invalid deployment address: Must start with "https://" or "http://". Found "${s}".`);try{new URL(s)}catch{throw new Error(`Invalid deployment address: "${s}" is not a valid URL. If you believe this URL is correct, use the \`skipConvexDeploymentUrlCheck\` option to bypass this.`)}if(s.endsWith(".convex.site"))throw new Error(`Invalid deployment address: "${s}" ends with .convex.site, which is used for HTTP Actions. Convex deployment URLs typically end with .convex.cloud? If you believe this URL is correct, use the \`skipConvexDeploymentUrlCheck\` option to bypass this.`)}function ht(s){var n;const e=typeof s=="object",t=Object.getPrototypeOf(s),r=t===null||t===Object.prototype||((n=t==null?void 0:t.constructor)==null?void 0:n.name)==="Object";return e&&r}const lt=!0,N=BigInt("-9223372036854775808"),Ie=BigInt("9223372036854775807"),Se=BigInt("0"),fs=BigInt("8"),gs=BigInt("256");function dt(s){return Number.isNaN(s)||!Number.isFinite(s)||Object.is(s,-0)}function ys(s){s<Se&&(s-=N+N);let e=s.toString(16);e.length%2===1&&(e="0"+e);const t=new Uint8Array(new ArrayBuffer(8));let r=0;for(const n of e.match(/.{2}/g).reverse())t.set([parseInt(n,16)],r++),s>>=fs;return te(t)}function ms(s){const e=ee(s);if(e.byteLength!==8)throw new Error(`Received ${e.byteLength} bytes, expected 8 for $integer`);let t=Se,r=Se;for(const n of e)t+=BigInt(n)*gs**r,r++;return t>Ie&&(t+=N+N),t}function ps(s){if(s<N||Ie<s)throw new Error(`BigInt ${s} does not fit into a 64-bit signed integer.`);const e=new ArrayBuffer(8);return new DataView(e).setBigInt64(0,s,!0),te(new Uint8Array(e))}function vs(s){const e=ee(s);if(e.byteLength!==8)throw new Error(`Received ${e.byteLength} bytes, expected 8 for $integer`);return new DataView(e.buffer).getBigInt64(0,!0)}const bs=DataView.prototype.setBigInt64?ps:ys,ws=DataView.prototype.getBigInt64?vs:ms,Le=1024;function ft(s){if(s.length>Le)throw new Error(`Field name ${s} exceeds maximum field name length ${Le}.`);if(s.startsWith("$"))throw new Error(`Field name ${s} starts with a '$', which is reserved.`);for(let e=0;e<s.length;e+=1){const t=s.charCodeAt(e);if(t<32||t>=127)throw new Error(`Field name ${s} has invalid character '${s[e]}': Field names can only contain non-control ASCII characters`)}}function Q(s){if(s===null||typeof s=="boolean"||typeof s=="number"||typeof s=="string")return s;if(Array.isArray(s))return s.map(r=>Q(r));if(typeof s!="object")throw new Error(`Unexpected type of ${s}`);const e=Object.entries(s);if(e.length===1){const r=e[0][0];if(r==="$bytes"){if(typeof s.$bytes!="string")throw new Error(`Malformed $bytes field on ${s}`);return ee(s.$bytes).buffer}if(r==="$integer"){if(typeof s.$integer!="string")throw new Error(`Malformed $integer field on ${s}`);return ws(s.$integer)}if(r==="$float"){if(typeof s.$float!="string")throw new Error(`Malformed $float field on ${s}`);const n=ee(s.$float);if(n.byteLength!==8)throw new Error(`Received ${n.byteLength} bytes, expected 8 for $float`);const o=new DataView(n.buffer).getFloat64(0,lt);if(!dt(o))throw new Error(`Float ${o} should be encoded as a number`);return o}if(r==="$set")throw new Error("Received a Set which is no longer supported as a Convex type.");if(r==="$map")throw new Error("Received a Map which is no longer supported as a Convex type.")}const t={};for(const[r,n]of Object.entries(s))ft(r),t[r]=Q(n);return t}function G(s){return JSON.stringify(s,(e,t)=>t===void 0?"undefined":typeof t=="bigint"?`${t.toString()}n`:t)}function ke(s,e,t,r){var o;if(s===void 0){const a=t&&` (present at path ${t} in original object ${G(e)})`;throw new Error(`undefined is not a valid Convex value${a}. To learn about Convex's supported types, see https://docs.convex.dev/using/types.`)}if(s===null)return s;if(typeof s=="bigint"){if(s<N||Ie<s)throw new Error(`BigInt ${s} does not fit into a 64-bit signed integer.`);return{$integer:bs(s)}}if(typeof s=="number")if(dt(s)){const a=new ArrayBuffer(8);return new DataView(a).setFloat64(0,s,lt),{$float:te(new Uint8Array(a))}}else return s;if(typeof s=="boolean"||typeof s=="string")return s;if(s instanceof ArrayBuffer)return{$bytes:te(new Uint8Array(s))};if(Array.isArray(s))return s.map((a,c)=>ke(a,e,t+`[${c}]`));if(s instanceof Set)throw new Error(pe(t,"Set",[...s],e));if(s instanceof Map)throw new Error(pe(t,"Map",[...s],e));if(!ht(s)){const a=(o=s==null?void 0:s.constructor)==null?void 0:o.name,c=a?`${a} `:"";throw new Error(pe(t,c,s,e))}const n={},i=Object.entries(s);i.sort(([a,c],[h,u])=>a===h?0:a<h?-1:1);for(const[a,c]of i)c!==void 0&&(ft(a),n[a]=ke(c,e,t+`.${a}`));return n}function pe(s,e,t,r){return s?`${e}${G(t)} is not a supported Convex type (present at path ${s} in original object ${G(r)}). To learn about Convex's supported types, see https://docs.convex.dev/using/types.`:`${e}${G(t)} is not a supported Convex type.`}function x(s){return ke(s,s,"")}var Ss=Object.defineProperty,ks=(s,e,t)=>e in s?Ss(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,ve=(s,e,t)=>ks(s,typeof e!="symbol"?e+"":e,t),$e,Ve;const Rs=Symbol.for("ConvexError");class Re extends(Ve=Error,$e=Rs,Ve){constructor(e){super(typeof e=="string"?e:G(e)),ve(this,"name","ConvexError"),ve(this,"data"),ve(this,$e,!0),this.data=e}}var Cs=Object.defineProperty,_s=(s,e,t)=>e in s?Cs(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Fe=(s,e,t)=>_s(s,typeof e!="symbol"?e+"":e,t);const Ts="color:rgb(0, 145, 255)";function gt(s){switch(s){case"query":return"Q";case"mutation":return"M";case"action":return"A";case"any":return"?"}}class yt{constructor(e){Fe(this,"_onLogLineFuncs"),Fe(this,"_verbose"),this._onLogLineFuncs={},this._verbose=e.verbose}addLogLineListener(e){let t=Math.random().toString(36).substring(2,15);for(let r=0;r<10&&this._onLogLineFuncs[t]!==void 0;r++)t=Math.random().toString(36).substring(2,15);return this._onLogLineFuncs[t]=e,()=>{delete this._onLogLineFuncs[t]}}logVerbose(...e){if(this._verbose)for(const t of Object.values(this._onLogLineFuncs))t("debug",`${new Date().toISOString()}`,...e)}log(...e){for(const t of Object.values(this._onLogLineFuncs))t("info",...e)}warn(...e){for(const t of Object.values(this._onLogLineFuncs))t("warn",...e)}error(...e){for(const t of Object.values(this._onLogLineFuncs))t("error",...e)}}function As(s){const e=new yt(s);return e.addLogLineListener((t,...r)=>{switch(t){case"debug":console.debug(...r);break;case"info":console.log(...r);break;case"warn":console.warn(...r);break;case"error":console.error(...r);break;default:console.log(...r)}}),e}function Is(s){return new yt(s)}function ue(s,e,t,r,n){const i=gt(t);if(typeof n=="object"&&(n=`ConvexError ${JSON.stringify(n.errorData,null,2)}`),e==="info"){const o=n.match(/^\[.*?\] /);if(o===null){s.error(`[CONVEX ${i}(${r})] Could not parse console.log`);return}const a=n.slice(1,o[0].length-2),c=n.slice(o[0].length);s.log(`%c[CONVEX ${i}(${r})] [${a}]`,Ts,c)}else s.error(`[CONVEX ${i}(${r})] ${n}`)}function qs(s,e){const t=`[CONVEX FATAL ERROR] ${e}`;return s.error(t),new Error(t)}function U(s,e,t){return`[CONVEX ${gt(s)}(${e})] ${t.errorMessage}
  Called by client`}function Ce(s,e){return e.data=s.errorData,e}function he(s){const e=s.split(":");let t,r;return e.length===1?(t=e[0],r="default"):(t=e.slice(0,e.length-1).join(":"),r=e[e.length-1]),t.endsWith(".js")&&(t=t.slice(0,-3)),`${t}:${r}`}function V(s,e){return JSON.stringify({udfPath:he(s),args:x(e)})}var Es=Object.defineProperty,Ms=(s,e,t)=>e in s?Es(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,q=(s,e,t)=>Ms(s,typeof e!="symbol"?e+"":e,t);class xs{constructor(){q(this,"nextQueryId"),q(this,"querySetVersion"),q(this,"querySet"),q(this,"queryIdToToken"),q(this,"identityVersion"),q(this,"auth"),q(this,"outstandingQueriesOlderThanRestart"),q(this,"outstandingAuthOlderThanRestart"),q(this,"paused"),q(this,"pendingQuerySetModifications"),this.nextQueryId=0,this.querySetVersion=0,this.identityVersion=0,this.querySet=new Map,this.queryIdToToken=new Map,this.outstandingQueriesOlderThanRestart=new Set,this.outstandingAuthOlderThanRestart=!1,this.paused=!1,this.pendingQuerySetModifications=new Map}hasSyncedPastLastReconnect(){return this.outstandingQueriesOlderThanRestart.size===0&&!this.outstandingAuthOlderThanRestart}markAuthCompletion(){this.outstandingAuthOlderThanRestart=!1}subscribe(e,t,r,n){const i=he(e),o=V(i,t),a=this.querySet.get(o);if(a!==void 0)return a.numSubscribers+=1,{queryToken:o,modification:null,unsubscribe:()=>this.removeSubscriber(o)};{const c=this.nextQueryId++,h={id:c,canonicalizedUdfPath:i,args:t,numSubscribers:1,journal:r,componentPath:n};this.querySet.set(o,h),this.queryIdToToken.set(c,o);const u=this.querySetVersion,g=this.querySetVersion+1,l={type:"Add",queryId:c,udfPath:i,args:[x(t)],journal:r,componentPath:n};return this.paused?this.pendingQuerySetModifications.set(c,l):this.querySetVersion=g,{queryToken:o,modification:{type:"ModifyQuerySet",baseVersion:u,newVersion:g,modifications:[l]},unsubscribe:()=>this.removeSubscriber(o)}}}transition(e){for(const t of e.modifications)switch(t.type){case"QueryUpdated":case"QueryFailed":{this.outstandingQueriesOlderThanRestart.delete(t.queryId);const r=t.journal;if(r!==void 0){const n=this.queryIdToToken.get(t.queryId);n!==void 0&&(this.querySet.get(n).journal=r)}break}case"QueryRemoved":{this.outstandingQueriesOlderThanRestart.delete(t.queryId);break}default:throw new Error(`Invalid modification ${t.type}`)}}queryId(e,t){const r=he(e),n=V(r,t),i=this.querySet.get(n);return i!==void 0?i.id:null}isCurrentOrNewerAuthVersion(e){return e>=this.identityVersion}setAuth(e){this.auth={tokenType:"User",value:e};const t=this.identityVersion;return this.paused||(this.identityVersion=t+1),{type:"Authenticate",baseVersion:t,...this.auth}}setAdminAuth(e,t){const r={tokenType:"Admin",value:e,impersonating:t};this.auth=r;const n=this.identityVersion;return this.paused||(this.identityVersion=n+1),{type:"Authenticate",baseVersion:n,...r}}clearAuth(){this.auth=void 0,this.markAuthCompletion();const e=this.identityVersion;return this.paused||(this.identityVersion=e+1),{type:"Authenticate",tokenType:"None",baseVersion:e}}hasAuth(){return!!this.auth}isNewAuth(e){var t;return((t=this.auth)==null?void 0:t.value)!==e}queryPath(e){const t=this.queryIdToToken.get(e);return t?this.querySet.get(t).canonicalizedUdfPath:null}queryArgs(e){const t=this.queryIdToToken.get(e);return t?this.querySet.get(t).args:null}queryToken(e){return this.queryIdToToken.get(e)??null}queryJournal(e){var t;return(t=this.querySet.get(e))==null?void 0:t.journal}restart(e){this.unpause(),this.outstandingQueriesOlderThanRestart.clear();const t=[];for(const i of this.querySet.values()){const o={type:"Add",queryId:i.id,udfPath:i.canonicalizedUdfPath,args:[x(i.args)],journal:i.journal,componentPath:i.componentPath};t.push(o),e.has(i.id)||this.outstandingQueriesOlderThanRestart.add(i.id)}this.querySetVersion=1;const r={type:"ModifyQuerySet",baseVersion:0,newVersion:1,modifications:t};if(!this.auth)return this.identityVersion=0,[r,void 0];this.outstandingAuthOlderThanRestart=!0;const n={type:"Authenticate",baseVersion:0,...this.auth};return this.identityVersion=1,[r,n]}pause(){this.paused=!0}resume(){const e=this.pendingQuerySetModifications.size>0?{type:"ModifyQuerySet",baseVersion:this.querySetVersion,newVersion:++this.querySetVersion,modifications:Array.from(this.pendingQuerySetModifications.values())}:void 0,t=this.auth!==void 0?{type:"Authenticate",baseVersion:this.identityVersion++,...this.auth}:void 0;return this.unpause(),[e,t]}unpause(){this.paused=!1,this.pendingQuerySetModifications.clear()}removeSubscriber(e){const t=this.querySet.get(e);if(t.numSubscribers>1)return t.numSubscribers-=1,null;{this.querySet.delete(e),this.queryIdToToken.delete(t.id),this.outstandingQueriesOlderThanRestart.delete(t.id);const r=this.querySetVersion,n=this.querySetVersion+1,i={type:"Remove",queryId:t.id};return this.paused?this.pendingQuerySetModifications.has(t.id)?this.pendingQuerySetModifications.delete(t.id):this.pendingQuerySetModifications.set(t.id,i):this.querySetVersion=n,{type:"ModifyQuerySet",baseVersion:r,newVersion:n,modifications:[i]}}}}var Os=Object.defineProperty,Ps=(s,e,t)=>e in s?Os(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,re=(s,e,t)=>Ps(s,typeof e!="symbol"?e+"":e,t);class Ls{constructor(e,t){this.logger=e,this.markConnectionStateDirty=t,re(this,"inflightRequests"),re(this,"requestsOlderThanRestart"),re(this,"inflightMutationsCount",0),re(this,"inflightActionsCount",0),this.inflightRequests=new Map,this.requestsOlderThanRestart=new Set}request(e,t){const r=new Promise(n=>{const i=t?"Requested":"NotSent";this.inflightRequests.set(e.requestId,{message:e,status:{status:i,requestedAt:new Date,onResult:n}}),e.type==="Mutation"?this.inflightMutationsCount++:e.type==="Action"&&this.inflightActionsCount++});return this.markConnectionStateDirty(),r}onResponse(e){const t=this.inflightRequests.get(e.requestId);if(t===void 0||t.status.status==="Completed")return null;const r=t.message.type==="Mutation"?"mutation":"action",n=t.message.udfPath;for(const c of e.logLines)ue(this.logger,"info",r,n,c);const i=t.status;let o,a;if(e.success)o={success:!0,logLines:e.logLines,value:Q(e.result)},a=()=>i.onResult(o);else{const c=e.result,{errorData:h}=e;ue(this.logger,"error",r,n,c),o={success:!1,errorMessage:c,errorData:h!==void 0?Q(h):void 0,logLines:e.logLines},a=()=>i.onResult(o)}return e.type==="ActionResponse"||!e.success?(a(),this.inflightRequests.delete(e.requestId),this.requestsOlderThanRestart.delete(e.requestId),t.message.type==="Action"?this.inflightActionsCount--:t.message.type==="Mutation"&&this.inflightMutationsCount--,this.markConnectionStateDirty(),{requestId:e.requestId,result:o}):(t.status={status:"Completed",result:o,ts:e.ts,onResolve:a},null)}removeCompleted(e){const t=new Map;for(const[r,n]of this.inflightRequests.entries()){const i=n.status;i.status==="Completed"&&i.ts.lessThanOrEqual(e)&&(i.onResolve(),t.set(r,i.result),n.message.type==="Mutation"?this.inflightMutationsCount--:n.message.type==="Action"&&this.inflightActionsCount--,this.inflightRequests.delete(r),this.requestsOlderThanRestart.delete(r))}return t.size>0&&this.markConnectionStateDirty(),t}restart(){this.requestsOlderThanRestart=new Set(this.inflightRequests.keys());const e=[];for(const[t,r]of this.inflightRequests){if(r.status.status==="NotSent"){r.status.status="Requested",e.push(r.message);continue}if(r.message.type==="Mutation")e.push(r.message);else if(r.message.type==="Action"){if(this.inflightRequests.delete(t),this.requestsOlderThanRestart.delete(t),this.inflightActionsCount--,r.status.status==="Completed")throw new Error("Action should never be in 'Completed' state");r.status.onResult({success:!1,errorMessage:"Connection lost while action was in flight",logLines:[]})}}return this.markConnectionStateDirty(),e}resume(){const e=[];for(const[,t]of this.inflightRequests)if(t.status.status==="NotSent"){t.status.status="Requested",e.push(t.message);continue}return e}hasIncompleteRequests(){for(const e of this.inflightRequests.values())if(e.status.status==="Requested")return!0;return!1}hasInflightRequests(){return this.inflightRequests.size>0}hasSyncedPastLastReconnect(){return this.requestsOlderThanRestart.size===0}timeOfOldestInflightRequest(){if(this.inflightRequests.size===0)return null;let e=Date.now();for(const t of this.inflightRequests.values())t.status.status!=="Completed"&&t.status.requestedAt.getTime()<e&&(e=t.status.requestedAt.getTime());return new Date(e)}inflightMutations(){return this.inflightMutationsCount}inflightActions(){return this.inflightActionsCount}}const le=Symbol.for("functionName"),$s=Symbol.for("toReferencePath");function Vs(s){return s[$s]??null}function Fs(s){return s.startsWith("function://")}function Ds(s){let e;if(typeof s=="string")Fs(s)?e={functionHandle:s}:e={name:s};else if(s[le])e={name:s[le]};else{const t=Vs(s);if(!t)throw new Error(`${s} is not a functionReference`);e={reference:t}}return e}function L(s){const e=Ds(s);if(e.name===void 0)throw e.functionHandle!==void 0?new Error(`Expected function reference like "api.file.func" or "internal.file.func", but received function handle ${e.functionHandle}`):e.reference!==void 0?new Error(`Expected function reference in the current component like "api.file.func" or "internal.file.func", but received reference ${e.reference}`):new Error(`Expected function reference like "api.file.func" or "internal.file.func", but received ${JSON.stringify(e)}`);if(typeof s=="string")return s;const t=s[le];if(!t)throw new Error(`${s} is not a functionReference`);return t}function mt(s=[]){const e={get(t,r){if(typeof r=="string"){const n=[...s,r];return mt(n)}else if(r===le){if(s.length<2){const o=["api",...s].join(".");throw new Error(`API path is expected to be of the form \`api.moduleName.functionName\`. Found: \`${o}\``)}const n=s.slice(0,-1).join("/"),i=s[s.length-1];return i==="default"?n:n+":"+i}else return r===Symbol.toStringTag?"FunctionReference":void 0}};return new Proxy({},e)}const zr=mt();var Us=Object.defineProperty,Ns=(s,e,t)=>e in s?Us(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,de=(s,e,t)=>Ns(s,typeof e!="symbol"?e+"":e,t);class se{constructor(e){de(this,"queryResults"),de(this,"modifiedQueries"),this.queryResults=e,this.modifiedQueries=[]}getQuery(e,...t){const r=P(t[0]),n=L(e),i=this.queryResults.get(V(n,r));if(i!==void 0)return se.queryValue(i.result)}getAllQueries(e){const t=[],r=L(e);for(const n of this.queryResults.values())n.udfPath===he(r)&&t.push({args:n.args,value:se.queryValue(n.result)});return t}setQuery(e,t,r){const n=P(t),i=L(e),o=V(i,n);let a;r===void 0?a=void 0:a={success:!0,value:r,logLines:[]};const c={udfPath:i,args:n,result:a};this.queryResults.set(o,c),this.modifiedQueries.push(o)}static queryValue(e){if(e!==void 0)return e.success?e.value:void 0}}class Qs{constructor(){de(this,"queryResults"),de(this,"optimisticUpdates"),this.queryResults=new Map,this.optimisticUpdates=[]}ingestQueryResultsFromServer(e,t){this.optimisticUpdates=this.optimisticUpdates.filter(o=>!t.has(o.mutationId));const r=this.queryResults;this.queryResults=new Map(e);const n=new se(this.queryResults);for(const o of this.optimisticUpdates)o.update(n);const i=[];for(const[o,a]of this.queryResults){const c=r.get(o);(c===void 0||c.result!==a.result)&&i.push(o)}return i}applyOptimisticUpdate(e,t){this.optimisticUpdates.push({update:e,mutationId:t});const r=new se(this.queryResults);return e(r),r.modifiedQueries}rawQueryResult(e){return this.queryResults.get(e)}queryResult(e){const t=this.queryResults.get(e);if(t===void 0)return;const r=t.result;if(r!==void 0){if(r.success)return r.value;throw r.errorData!==void 0?Ce(r,new Re(U("query",t.udfPath,r))):new Error(U("query",t.udfPath,r))}}hasQueryResult(e){return this.queryResults.get(e)!==void 0}queryLogs(e){var r;const t=this.queryResults.get(e);return(r=t==null?void 0:t.result)==null?void 0:r.logLines}}var Bs=Object.defineProperty,Ws=(s,e,t)=>e in s?Bs(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,be=(s,e,t)=>Ws(s,typeof e!="symbol"?e+"":e,t);class _{constructor(e,t){be(this,"low"),be(this,"high"),be(this,"__isUnsignedLong__"),this.low=e|0,this.high=t|0,this.__isUnsignedLong__=!0}static isLong(e){return(e&&e.__isUnsignedLong__)===!0}static fromBytesLE(e){return new _(e[0]|e[1]<<8|e[2]<<16|e[3]<<24,e[4]|e[5]<<8|e[6]<<16|e[7]<<24)}toBytesLE(){const e=this.high,t=this.low;return[t&255,t>>>8&255,t>>>16&255,t>>>24,e&255,e>>>8&255,e>>>16&255,e>>>24]}static fromNumber(e){return isNaN(e)||e<0?De:e>=js?Js:new _(e%Z|0,e/Z|0)}toString(){return(BigInt(this.high)*BigInt(Z)+BigInt(this.low)).toString()}equals(e){return _.isLong(e)||(e=_.fromValue(e)),this.high>>>31===1&&e.high>>>31===1?!1:this.high===e.high&&this.low===e.low}notEquals(e){return!this.equals(e)}comp(e){return _.isLong(e)||(e=_.fromValue(e)),this.equals(e)?0:e.high>>>0>this.high>>>0||e.high===this.high&&e.low>>>0>this.low>>>0?-1:1}lessThanOrEqual(e){return this.comp(e)<=0}static fromValue(e){return typeof e=="number"?_.fromNumber(e):new _(e.low,e.high)}}const De=new _(0,0),Ue=65536,Z=Ue*Ue,js=Z*Z,Js=new _(-1,-1);var Ks=Object.defineProperty,Hs=(s,e,t)=>e in s?Ks(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,ne=(s,e,t)=>Hs(s,typeof e!="symbol"?e+"":e,t);class Ne{constructor(e,t){ne(this,"version"),ne(this,"remoteQuerySet"),ne(this,"queryPath"),ne(this,"logger"),this.version={querySet:0,ts:_.fromNumber(0),identity:0},this.remoteQuerySet=new Map,this.queryPath=e,this.logger=t}transition(e){const t=e.startVersion;if(this.version.querySet!==t.querySet||this.version.ts.notEquals(t.ts)||this.version.identity!==t.identity)throw new Error(`Invalid start version: ${t.ts.toString()}:${t.querySet}`);for(const r of e.modifications)switch(r.type){case"QueryUpdated":{const n=this.queryPath(r.queryId);if(n)for(const o of r.logLines)ue(this.logger,"info","query",n,o);const i=Q(r.value??null);this.remoteQuerySet.set(r.queryId,{success:!0,value:i,logLines:r.logLines});break}case"QueryFailed":{const n=this.queryPath(r.queryId);if(n)for(const o of r.logLines)ue(this.logger,"info","query",n,o);const{errorData:i}=r;this.remoteQuerySet.set(r.queryId,{success:!1,errorMessage:r.errorMessage,errorData:i!==void 0?Q(i):void 0,logLines:r.logLines});break}case"QueryRemoved":{this.remoteQuerySet.delete(r.queryId);break}default:throw new Error(`Invalid modification ${r.type}`)}this.version=e.endVersion}remoteQueryResults(){return this.remoteQuerySet}timestamp(){return this.version.ts}}function we(s){const e=ee(s);return _.fromBytesLE(Array.from(e))}function zs(s){const e=new Uint8Array(s.toBytesLE());return te(e)}function Xs(s){switch(s.type){case"FatalError":case"AuthError":case"ActionResponse":case"Ping":return{...s};case"MutationResponse":return s.success?{...s,ts:we(s.ts)}:{...s};case"Transition":return{...s,startVersion:{...s.startVersion,ts:we(s.startVersion.ts)},endVersion:{...s.endVersion,ts:we(s.endVersion.ts)}}}}function Ys(s){switch(s.type){case"Authenticate":case"ModifyQuerySet":case"Mutation":case"Action":case"Event":return{...s};case"Connect":return s.maxObservedTimestamp!==void 0?{...s,maxObservedTimestamp:zs(s.maxObservedTimestamp)}:{...s,maxObservedTimestamp:void 0}}}var Gs=Object.defineProperty,Zs=(s,e,t)=>e in s?Gs(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,S=(s,e,t)=>Zs(s,typeof e!="symbol"?e+"":e,t);const er=1e3,tr=1001,sr=1005,rr=4040,pt={InternalServerError:{timeout:1e3},SubscriptionsWorkerFullError:{timeout:3e3},TooManyConcurrentRequests:{timeout:3e3},CommitterFullError:{timeout:3e3},AwsTooManyRequestsException:{timeout:3e3},ExecuteFullError:{timeout:3e3},SystemTimeoutError:{timeout:3e3},ExpiredInQueue:{timeout:3e3},VectorIndexesUnavailable:{timeout:1e3},SearchIndexesUnavailable:{timeout:1e3},VectorIndexTooLarge:{timeout:3e3},SearchIndexTooLarge:{timeout:3e3},TooManyWritesInTimePeriod:{timeout:3e3}};function nr(s){if(s===void 0)return"Unknown";for(const e of Object.keys(pt))if(s.startsWith(e))return e;return"Unknown"}class ir{constructor(e,t,r,n,i){this.markConnectionStateDirty=i,S(this,"socket"),S(this,"connectionCount"),S(this,"_hasEverConnected",!1),S(this,"lastCloseReason"),S(this,"defaultInitialBackoff"),S(this,"maxBackoff"),S(this,"retries"),S(this,"serverInactivityThreshold"),S(this,"reconnectDueToServerInactivityTimeout"),S(this,"uri"),S(this,"onOpen"),S(this,"onResume"),S(this,"onMessage"),S(this,"webSocketConstructor"),S(this,"logger"),S(this,"onServerDisconnectError"),this.webSocketConstructor=r,this.socket={state:"disconnected"},this.connectionCount=0,this.lastCloseReason="InitialConnect",this.defaultInitialBackoff=1e3,this.maxBackoff=16e3,this.retries=0,this.serverInactivityThreshold=3e4,this.reconnectDueToServerInactivityTimeout=null,this.uri=e,this.onOpen=t.onOpen,this.onResume=t.onResume,this.onMessage=t.onMessage,this.onServerDisconnectError=t.onServerDisconnectError,this.logger=n,this.connect()}setSocketState(e){this.socket=e,this._logVerbose(`socket state changed: ${this.socket.state}, paused: ${"paused"in this.socket?this.socket.paused:void 0}`),this.markConnectionStateDirty()}connect(){if(this.socket.state==="terminated")return;if(this.socket.state!=="disconnected"&&this.socket.state!=="stopped")throw new Error("Didn't start connection from disconnected state: "+this.socket.state);const e=new this.webSocketConstructor(this.uri);this._logVerbose("constructed WebSocket"),this.setSocketState({state:"connecting",ws:e,paused:"no"}),this.resetServerInactivityTimeout(),e.onopen=()=>{if(this.logger.logVerbose("begin ws.onopen"),this.socket.state!=="connecting")throw new Error("onopen called with socket not in connecting state");this.setSocketState({state:"ready",ws:e,paused:this.socket.paused==="yes"?"uninitialized":"no"}),this.resetServerInactivityTimeout(),this.socket.paused==="no"&&(this._hasEverConnected=!0,this.onOpen({connectionCount:this.connectionCount,lastCloseReason:this.lastCloseReason})),this.lastCloseReason!=="InitialConnect"&&this.logger.log("WebSocket reconnected"),this.connectionCount+=1,this.lastCloseReason=null},e.onerror=t=>{const r=t.message;this.logger.log(`WebSocket error: ${r}`)},e.onmessage=t=>{this.resetServerInactivityTimeout();const r=Xs(JSON.parse(t.data));this._logVerbose(`received ws message with type ${r.type}`),this.onMessage(r).hasSyncedPastLastReconnect&&(this.retries=0,this.markConnectionStateDirty())},e.onclose=t=>{if(this._logVerbose("begin ws.onclose"),this.lastCloseReason===null&&(this.lastCloseReason=t.reason??"OnCloseInvoked"),t.code!==er&&t.code!==tr&&t.code!==sr&&t.code!==rr){let n=`WebSocket closed with code ${t.code}`;t.reason&&(n+=`: ${t.reason}`),this.logger.log(n),this.onServerDisconnectError&&t.reason&&this.onServerDisconnectError(n)}const r=nr(t.reason);this.scheduleReconnect(r)}}socketState(){return this.socket.state}sendMessage(e){const t={type:e.type,...e.type==="Authenticate"&&e.tokenType==="User"?{value:`...${e.value.slice(-7)}`}:{}};if(this.socket.state==="ready"&&this.socket.paused==="no"){const r=Ys(e),n=JSON.stringify(r);try{this.socket.ws.send(n)}catch(i){this.logger.log(`Failed to send message on WebSocket, reconnecting: ${i}`),this.closeAndReconnect("FailedToSendMessage")}return this._logVerbose(`sent message with type ${e.type}: ${JSON.stringify(t)}`),!0}return this._logVerbose(`message not sent (socket state: ${this.socket.state}, paused: ${"paused"in this.socket?this.socket.paused:void 0}): ${JSON.stringify(t)}`),!1}resetServerInactivityTimeout(){this.socket.state!=="terminated"&&(this.reconnectDueToServerInactivityTimeout!==null&&(clearTimeout(this.reconnectDueToServerInactivityTimeout),this.reconnectDueToServerInactivityTimeout=null),this.reconnectDueToServerInactivityTimeout=setTimeout(()=>{this.closeAndReconnect("InactiveServer")},this.serverInactivityThreshold))}scheduleReconnect(e){this.socket={state:"disconnected"};const t=this.nextBackoff(e);this.markConnectionStateDirty(),this.logger.log(`Attempting reconnect in ${t}ms`),setTimeout(()=>this.connect(),t)}closeAndReconnect(e){switch(this._logVerbose(`begin closeAndReconnect with reason ${e}`),this.socket.state){case"disconnected":case"terminated":case"stopped":return;case"connecting":case"ready":{this.lastCloseReason=e,this.close(),this.scheduleReconnect("client");return}default:this.socket}}close(){switch(this.socket.state){case"disconnected":case"terminated":case"stopped":return Promise.resolve();case"connecting":{const e=this.socket.ws;return new Promise(t=>{e.onclose=()=>{this._logVerbose("Closed after connecting"),t()},e.onopen=()=>{this._logVerbose("Opened after connecting"),e.close()}})}case"ready":{this._logVerbose("ws.close called");const e=this.socket.ws,t=new Promise(r=>{e.onclose=()=>{r()}});return e.close(),t}default:return this.socket,Promise.resolve()}}terminate(){switch(this.reconnectDueToServerInactivityTimeout&&clearTimeout(this.reconnectDueToServerInactivityTimeout),this.socket.state){case"terminated":case"stopped":case"disconnected":case"connecting":case"ready":{const e=this.close();return this.setSocketState({state:"terminated"}),e}default:throw this.socket,new Error(`Invalid websocket state: ${this.socket.state}`)}}stop(){switch(this.socket.state){case"terminated":return Promise.resolve();case"connecting":case"stopped":case"disconnected":case"ready":{const e=this.close();return this.socket={state:"stopped"},e}default:return this.socket,Promise.resolve()}}tryRestart(){switch(this.socket.state){case"stopped":break;case"terminated":case"connecting":case"ready":case"disconnected":this.logger.logVerbose("Restart called without stopping first");return;default:this.socket}this.connect()}pause(){switch(this.socket.state){case"disconnected":case"stopped":case"terminated":return;case"connecting":case"ready":{this.socket={...this.socket,paused:"yes"};return}default:{this.socket;return}}}resume(){switch(this.socket.state){case"connecting":this.socket={...this.socket,paused:"no"};return;case"ready":this.socket.paused==="uninitialized"?(this.socket={...this.socket,paused:"no"},this.onOpen({connectionCount:this.connectionCount,lastCloseReason:this.lastCloseReason})):this.socket.paused==="yes"&&(this.socket={...this.socket,paused:"no"},this.onResume());return;case"terminated":case"stopped":case"disconnected":return;default:this.socket}this.connect()}connectionState(){return{isConnected:this.socket.state==="ready",hasEverConnected:this._hasEverConnected,connectionCount:this.connectionCount,connectionRetries:this.retries}}_logVerbose(e){this.logger.logVerbose(e)}nextBackoff(e){const r=(e==="client"?100:e==="Unknown"?this.defaultInitialBackoff:pt[e].timeout)*Math.pow(2,this.retries);this.retries+=1;const n=Math.min(r,this.maxBackoff),i=n*(Math.random()-.5);return n+i}}function or(){return ar()}function ar(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{const e=Math.random()*16|0;return(s==="x"?e:e&3|8).toString(16)})}class z extends Error{}z.prototype.name="InvalidTokenError";function cr(s){return decodeURIComponent(atob(s).replace(/(.)/g,(e,t)=>{let r=t.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r="0"+r),"%"+r}))}function ur(s){let e=s.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return cr(e)}catch{return atob(e)}}function hr(s,e){if(typeof s!="string")throw new z("Invalid token specified: must be a string");e||(e={});const t=e.header===!0?0:1,r=s.split(".")[t];if(typeof r!="string")throw new z(`Invalid token specified: missing part #${t+1}`);let n;try{n=ur(r)}catch(i){throw new z(`Invalid token specified: invalid base64 for part #${t+1} (${i.message})`)}try{return JSON.parse(n)}catch(i){throw new z(`Invalid token specified: invalid json for part #${t+1} (${i.message})`)}}var lr=Object.defineProperty,dr=(s,e,t)=>e in s?lr(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,A=(s,e,t)=>dr(s,typeof e!="symbol"?e+"":e,t);const fr=20*24*60*60*1e3,Qe=2;class gr{constructor(e,t,r){A(this,"authState",{state:"noAuth"}),A(this,"configVersion",0),A(this,"syncState"),A(this,"authenticate"),A(this,"stopSocket"),A(this,"tryRestartSocket"),A(this,"pauseSocket"),A(this,"resumeSocket"),A(this,"clearAuth"),A(this,"logger"),A(this,"refreshTokenLeewaySeconds"),A(this,"tokenConfirmationAttempts",0),this.syncState=e,this.authenticate=t.authenticate,this.stopSocket=t.stopSocket,this.tryRestartSocket=t.tryRestartSocket,this.pauseSocket=t.pauseSocket,this.resumeSocket=t.resumeSocket,this.clearAuth=t.clearAuth,this.logger=r.logger,this.refreshTokenLeewaySeconds=r.refreshTokenLeewaySeconds}async setConfig(e,t){this.resetAuthState(),this._logVerbose("pausing WS for auth token fetch"),this.pauseSocket();const r=await this.fetchTokenAndGuardAgainstRace(e,{forceRefreshToken:!1});r.isFromOutdatedConfig||(r.value?(this.setAuthState({state:"waitingForServerConfirmationOfCachedToken",config:{fetchToken:e,onAuthChange:t},hasRetried:!1}),this.authenticate(r.value)):(this.setAuthState({state:"initialRefetch",config:{fetchToken:e,onAuthChange:t}}),await this.refetchToken()),this._logVerbose("resuming WS after auth token fetch"),this.resumeSocket())}onTransition(e){if(this.syncState.isCurrentOrNewerAuthVersion(e.endVersion.identity)&&!(e.endVersion.identity<=e.startVersion.identity)){if(this.authState.state==="waitingForServerConfirmationOfCachedToken"){this._logVerbose("server confirmed auth token is valid"),this.refetchToken(),this.authState.config.onAuthChange(!0);return}this.authState.state==="waitingForServerConfirmationOfFreshToken"&&(this._logVerbose("server confirmed new auth token is valid"),this.scheduleTokenRefetch(this.authState.token),this.tokenConfirmationAttempts=0,this.authState.hadAuth||this.authState.config.onAuthChange(!0))}}onAuthError(e){if(e.authUpdateAttempted===!1&&(this.authState.state==="waitingForServerConfirmationOfFreshToken"||this.authState.state==="waitingForServerConfirmationOfCachedToken")){this._logVerbose("ignoring non-auth token expired error");return}const{baseVersion:t}=e;if(!this.syncState.isCurrentOrNewerAuthVersion(t+1)){this._logVerbose("ignoring auth error for previous auth attempt");return}this.tryToReauthenticate(e)}async tryToReauthenticate(e){if(this._logVerbose(`attempting to reauthenticate: ${e.error}`),this.authState.state==="noAuth"||this.authState.state==="waitingForServerConfirmationOfFreshToken"&&this.tokenConfirmationAttempts>=Qe){this.logger.error(`Failed to authenticate: "${e.error}", check your server auth config`),this.syncState.hasAuth()&&this.syncState.clearAuth(),this.authState.state!=="noAuth"&&this.setAndReportAuthFailed(this.authState.config.onAuthChange);return}this.authState.state==="waitingForServerConfirmationOfFreshToken"&&(this.tokenConfirmationAttempts++,this._logVerbose(`retrying reauthentication, ${Qe-this.tokenConfirmationAttempts} attempts remaining`)),await this.stopSocket();const t=await this.fetchTokenAndGuardAgainstRace(this.authState.config.fetchToken,{forceRefreshToken:!0});t.isFromOutdatedConfig||(t.value&&this.syncState.isNewAuth(t.value)?(this.authenticate(t.value),this.setAuthState({state:"waitingForServerConfirmationOfFreshToken",config:this.authState.config,token:t.value,hadAuth:this.authState.state==="notRefetching"||this.authState.state==="waitingForScheduledRefetch"})):(this._logVerbose("reauthentication failed, could not fetch a new token"),this.syncState.hasAuth()&&this.syncState.clearAuth(),this.setAndReportAuthFailed(this.authState.config.onAuthChange)),this.tryRestartSocket())}async refetchToken(){if(this.authState.state==="noAuth")return;this._logVerbose("refetching auth token");const e=await this.fetchTokenAndGuardAgainstRace(this.authState.config.fetchToken,{forceRefreshToken:!0});e.isFromOutdatedConfig||(e.value?this.syncState.isNewAuth(e.value)?(this.setAuthState({state:"waitingForServerConfirmationOfFreshToken",hadAuth:this.syncState.hasAuth(),token:e.value,config:this.authState.config}),this.authenticate(e.value)):this.setAuthState({state:"notRefetching",config:this.authState.config}):(this._logVerbose("refetching token failed"),this.syncState.hasAuth()&&this.clearAuth(),this.setAndReportAuthFailed(this.authState.config.onAuthChange)),this._logVerbose("restarting WS after auth token fetch (if currently stopped)"),this.tryRestartSocket())}scheduleTokenRefetch(e){if(this.authState.state==="noAuth")return;const t=this.decodeToken(e);if(!t){this.logger.error("Auth token is not a valid JWT, cannot refetch the token");return}const{iat:r,exp:n}=t;if(!r||!n){this.logger.error("Auth token does not have required fields, cannot refetch the token");return}const i=n-r;if(i<=2){this.logger.error("Auth token does not live long enough, cannot refetch the token");return}let o=Math.min(fr,(i-this.refreshTokenLeewaySeconds)*1e3);o<=0&&(this.logger.warn(`Refetching auth token immediately, configured leeway ${this.refreshTokenLeewaySeconds}s is larger than the token's lifetime ${i}s`),o=0);const a=setTimeout(()=>{this._logVerbose("running scheduled token refetch"),this.refetchToken()},o);this.setAuthState({state:"waitingForScheduledRefetch",refetchTokenTimeoutId:a,config:this.authState.config}),this._logVerbose(`scheduled preemptive auth token refetching in ${o}ms`)}async fetchTokenAndGuardAgainstRace(e,t){const r=++this.configVersion;this._logVerbose(`fetching token with config version ${r}`);const n=await e(t);return this.configVersion!==r?(this._logVerbose(`stale config version, expected ${r}, got ${this.configVersion}`),{isFromOutdatedConfig:!0}):{isFromOutdatedConfig:!1,value:n}}stop(){this.resetAuthState(),this.configVersion++,this._logVerbose(`config version bumped to ${this.configVersion}`)}setAndReportAuthFailed(e){e(!1),this.resetAuthState()}resetAuthState(){this.setAuthState({state:"noAuth"})}setAuthState(e){const t=e.state==="waitingForServerConfirmationOfFreshToken"?{hadAuth:e.hadAuth,state:e.state,token:`...${e.token.slice(-7)}`}:{state:e.state};switch(this._logVerbose(`setting auth state to ${JSON.stringify(t)}`),e.state){case"waitingForScheduledRefetch":case"notRefetching":case"noAuth":this.tokenConfirmationAttempts=0;break}this.authState.state==="waitingForScheduledRefetch"&&(clearTimeout(this.authState.refetchTokenTimeoutId),this.syncState.markAuthCompletion()),this.authState=e}decodeToken(e){try{return hr(e)}catch(t){return this._logVerbose(`Error decoding token: ${t instanceof Error?t.message:"Unknown error"}`),null}}_logVerbose(e){this.logger.logVerbose(`${e} [v${this.configVersion}]`)}}const yr=["convexClientConstructed","convexWebSocketOpen","convexFirstMessageReceived"];function mr(s,e){const t={sessionId:e};typeof performance>"u"||!performance.mark||performance.mark(s,{detail:t})}function pr(s){let e=s.name.slice(6);return e=e.charAt(0).toLowerCase()+e.slice(1),{name:e,startTime:s.startTime}}function vr(s){if(typeof performance>"u"||!performance.getEntriesByName)return[];const e=[];for(const t of yr){const r=performance.getEntriesByName(t).filter(n=>n.entryType==="mark").filter(n=>n.detail.sessionId===s);e.push(...r)}return e.map(pr)}var br=Object.defineProperty,wr=(s,e,t)=>e in s?br(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,b=(s,e,t)=>wr(s,typeof e!="symbol"?e+"":e,t);class Sr{constructor(e,t,r){if(b(this,"address"),b(this,"state"),b(this,"requestManager"),b(this,"webSocketManager"),b(this,"authenticationManager"),b(this,"remoteQuerySet"),b(this,"optimisticQueryResults"),b(this,"_transitionHandlerCounter",0),b(this,"_nextRequestId"),b(this,"_onTransitionFns",new Map),b(this,"_sessionId"),b(this,"firstMessageReceived",!1),b(this,"debug"),b(this,"logger"),b(this,"maxObservedTimestamp"),b(this,"connectionStateSubscribers",new Map),b(this,"nextConnectionStateSubscriberId",0),b(this,"_lastPublishedConnectionState"),b(this,"markConnectionStateDirty",()=>{Promise.resolve().then(()=>{const l=this.connectionState();if(JSON.stringify(l)!==JSON.stringify(this._lastPublishedConnectionState)){this._lastPublishedConnectionState=l;for(const d of this.connectionStateSubscribers.values())d(l)}})}),b(this,"mark",l=>{this.debug&&mr(l,this.sessionId)}),typeof e=="object")throw new Error("Passing a ClientConfig object is no longer supported. Pass the URL of the Convex deployment as a string directly.");(r==null?void 0:r.skipConvexDeploymentUrlCheck)!==!0&&ut(e),r={...r};const n=r.authRefreshTokenLeewaySeconds??2;let i=r.webSocketConstructor;if(!i&&typeof WebSocket>"u")throw new Error("No WebSocket global variable defined! To use Convex in an environment without WebSocket try the HTTP client: https://docs.convex.dev/api/classes/browser.ConvexHttpClient");i=i||WebSocket,this.debug=r.reportDebugInfoToConvex??!1,this.address=e,this.logger=r.logger===!1?Is({verbose:r.verbose??!1}):r.logger!==!0&&r.logger?r.logger:As({verbose:r.verbose??!1});const o=e.search("://");if(o===-1)throw new Error("Provided address was not an absolute URL.");const a=e.substring(o+3),c=e.substring(0,o);let h;if(c==="http")h="ws";else if(c==="https")h="wss";else throw new Error(`Unknown parent protocol ${c}`);const u=`${h}://${a}/api/${Pe}/sync`;this.state=new xs,this.remoteQuerySet=new Ne(l=>this.state.queryPath(l),this.logger),this.requestManager=new Ls(this.logger,this.markConnectionStateDirty),this.authenticationManager=new gr(this.state,{authenticate:l=>{const d=this.state.setAuth(l);return this.webSocketManager.sendMessage(d),d.baseVersion},stopSocket:()=>this.webSocketManager.stop(),tryRestartSocket:()=>this.webSocketManager.tryRestart(),pauseSocket:()=>{this.webSocketManager.pause(),this.state.pause()},resumeSocket:()=>this.webSocketManager.resume(),clearAuth:()=>{this.clearAuth()}},{logger:this.logger,refreshTokenLeewaySeconds:n}),this.optimisticQueryResults=new Qs,this.addOnTransitionHandler(l=>{t(l.queries.map(d=>d.token))}),this._nextRequestId=0,this._sessionId=or();const{unsavedChangesWarning:g}=r;if(typeof window>"u"||typeof window.addEventListener>"u"){if(g===!0)throw new Error("unsavedChangesWarning requested, but window.addEventListener not found! Remove {unsavedChangesWarning: true} from Convex client options.")}else g!==!1&&window.addEventListener("beforeunload",l=>{if(this.requestManager.hasIncompleteRequests()){l.preventDefault();const d="Are you sure you want to leave? Your changes may not be saved.";return(l||window.event).returnValue=d,d}});this.webSocketManager=new ir(u,{onOpen:l=>{this.mark("convexWebSocketOpen"),this.webSocketManager.sendMessage({...l,type:"Connect",sessionId:this._sessionId,maxObservedTimestamp:this.maxObservedTimestamp});const d=new Set(this.remoteQuerySet.remoteQueryResults().keys());this.remoteQuerySet=new Ne(T=>this.state.queryPath(T),this.logger);const[f,y]=this.state.restart(d);y&&this.webSocketManager.sendMessage(y),this.webSocketManager.sendMessage(f);for(const T of this.requestManager.restart())this.webSocketManager.sendMessage(T)},onResume:()=>{const[l,d]=this.state.resume();d&&this.webSocketManager.sendMessage(d),l&&this.webSocketManager.sendMessage(l);for(const f of this.requestManager.resume())this.webSocketManager.sendMessage(f)},onMessage:l=>{switch(this.firstMessageReceived||(this.firstMessageReceived=!0,this.mark("convexFirstMessageReceived"),this.reportMarks()),l.type){case"Transition":{this.observedTimestamp(l.endVersion.ts),this.authenticationManager.onTransition(l),this.remoteQuerySet.transition(l),this.state.transition(l);const d=this.requestManager.removeCompleted(this.remoteQuerySet.timestamp());this.notifyOnQueryResultChanges(d);break}case"MutationResponse":{l.success&&this.observedTimestamp(l.ts);const d=this.requestManager.onResponse(l);d!==null&&this.notifyOnQueryResultChanges(new Map([[d.requestId,d.result]]));break}case"ActionResponse":{this.requestManager.onResponse(l);break}case"AuthError":{this.authenticationManager.onAuthError(l);break}case"FatalError":{const d=qs(this.logger,l.error);throw this.webSocketManager.terminate(),d}}return{hasSyncedPastLastReconnect:this.hasSyncedPastLastReconnect()}},onServerDisconnectError:r.onServerDisconnectError},i,this.logger,this.markConnectionStateDirty),this.mark("convexClientConstructed")}hasSyncedPastLastReconnect(){return this.requestManager.hasSyncedPastLastReconnect()||this.state.hasSyncedPastLastReconnect()}observedTimestamp(e){(this.maxObservedTimestamp===void 0||this.maxObservedTimestamp.lessThanOrEqual(e))&&(this.maxObservedTimestamp=e)}getMaxObservedTimestamp(){return this.maxObservedTimestamp}notifyOnQueryResultChanges(e){const t=this.remoteQuerySet.remoteQueryResults(),r=new Map;for(const[i,o]of t){const a=this.state.queryToken(i);if(a!==null){const c={result:o,udfPath:this.state.queryPath(i),args:this.state.queryArgs(i)};r.set(a,c)}}const n=this.optimisticQueryResults.ingestQueryResultsFromServer(r,new Set(e.keys()));this.handleTransition({queries:n.map(i=>{const o=this.optimisticQueryResults.rawQueryResult(i);return{token:i,modification:{kind:"Updated",result:o.result}}}),reflectedMutations:Array.from(e).map(([i,o])=>({requestId:i,result:o})),timestamp:this.remoteQuerySet.timestamp()})}handleTransition(e){for(const t of this._onTransitionFns.values())t(e)}addOnTransitionHandler(e){const t=this._transitionHandlerCounter++;return this._onTransitionFns.set(t,e),()=>this._onTransitionFns.delete(t)}setAuth(e,t){this.authenticationManager.setConfig(e,t)}hasAuth(){return this.state.hasAuth()}setAdminAuth(e,t){const r=this.state.setAdminAuth(e,t);this.webSocketManager.sendMessage(r)}clearAuth(){const e=this.state.clearAuth();this.webSocketManager.sendMessage(e)}subscribe(e,t,r){const n=P(t),{modification:i,queryToken:o,unsubscribe:a}=this.state.subscribe(e,n,r==null?void 0:r.journal,r==null?void 0:r.componentPath);return i!==null&&this.webSocketManager.sendMessage(i),{queryToken:o,unsubscribe:()=>{const c=a();c&&this.webSocketManager.sendMessage(c)}}}localQueryResult(e,t){const r=P(t),n=V(e,r);return this.optimisticQueryResults.queryResult(n)}localQueryResultByToken(e){return this.optimisticQueryResults.queryResult(e)}hasLocalQueryResultByToken(e){return this.optimisticQueryResults.hasQueryResult(e)}localQueryLogs(e,t){const r=P(t),n=V(e,r);return this.optimisticQueryResults.queryLogs(n)}queryJournal(e,t){const r=P(t),n=V(e,r);return this.state.queryJournal(n)}connectionState(){const e=this.webSocketManager.connectionState();return{hasInflightRequests:this.requestManager.hasInflightRequests(),isWebSocketConnected:e.isConnected,hasEverConnected:e.hasEverConnected,connectionCount:e.connectionCount,connectionRetries:e.connectionRetries,timeOfOldestInflightRequest:this.requestManager.timeOfOldestInflightRequest(),inflightMutations:this.requestManager.inflightMutations(),inflightActions:this.requestManager.inflightActions()}}subscribeToConnectionState(e){const t=this.nextConnectionStateSubscriberId++;return this.connectionStateSubscribers.set(t,e),()=>{this.connectionStateSubscribers.delete(t)}}async mutation(e,t,r){const n=await this.mutationInternal(e,t,r);if(!n.success)throw n.errorData!==void 0?Ce(n,new Re(U("mutation",e,n))):new Error(U("mutation",e,n));return n.value}async mutationInternal(e,t,r,n){const{mutationPromise:i}=this.enqueueMutation(e,t,r,n);return i}enqueueMutation(e,t,r,n){const i=P(t);this.tryReportLongDisconnect();const o=this.nextRequestId;if(this._nextRequestId++,r!==void 0){const u=r.optimisticUpdate;if(u!==void 0){const g=f=>{u(f,i)instanceof Promise&&this.logger.warn("Optimistic update handler returned a Promise. Optimistic updates should be synchronous.")},d=this.optimisticQueryResults.applyOptimisticUpdate(g,o).map(f=>{const y=this.localQueryResultByToken(f);return{token:f,modification:{kind:"Updated",result:y===void 0?void 0:{success:!0,value:y,logLines:[]}}}});this.handleTransition({queries:d,reflectedMutations:[],timestamp:this.remoteQuerySet.timestamp()})}}const a={type:"Mutation",requestId:o,udfPath:e,componentPath:n,args:[x(i)]},c=this.webSocketManager.sendMessage(a),h=this.requestManager.request(a,c);return{requestId:o,mutationPromise:h}}async action(e,t){const r=await this.actionInternal(e,t);if(!r.success)throw r.errorData!==void 0?Ce(r,new Re(U("action",e,r))):new Error(U("action",e,r));return r.value}async actionInternal(e,t,r){const n=P(t),i=this.nextRequestId;this._nextRequestId++,this.tryReportLongDisconnect();const o={type:"Action",requestId:i,udfPath:e,componentPath:r,args:[x(n)]},a=this.webSocketManager.sendMessage(o);return this.requestManager.request(o,a)}async close(){return this.authenticationManager.stop(),this.webSocketManager.terminate()}get url(){return this.address}get nextRequestId(){return this._nextRequestId}get sessionId(){return this._sessionId}reportMarks(){if(this.debug){const e=vr(this.sessionId);this.webSocketManager.sendMessage({type:"Event",eventType:"ClientConnect",event:e})}}tryReportLongDisconnect(){if(!this.debug)return;const e=this.connectionState().timeOfOldestInflightRequest;if(e===null||Date.now()-e.getTime()<=60*1e3)return;const t=`${this.address}/api/debug_event`;fetch(t,{method:"POST",headers:{"Content-Type":"application/json","Convex-Client":`npm-${Pe}`},body:JSON.stringify({event:"LongWebsocketDisconnect"})}).then(r=>{r.ok||this.logger.warn("Analytics request failed with response:",r.body)}).catch(r=>{this.logger.warn("Analytics response failed with error:",r)})}}var kr=Object.defineProperty,Rr=(s,e,t)=>e in s?kr(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,J=(s,e,t)=>Rr(s,typeof e!="symbol"?e+"":e,t);class Cr{constructor(e,t={}){J(this,"listeners"),J(this,"_client"),J(this,"callNewListenersWithCurrentValuesTimer"),J(this,"_closed"),J(this,"_disabled"),t.skipConvexDeploymentUrlCheck!==!0&&ut(e);const{disabled:r,...n}=t;this._closed=!1,this._disabled=!!r,typeof window>"u"&&!("unsavedChangesWarning"in n)&&(n.unsavedChangesWarning=!1),this.disabled||(this._client=new Sr(e,i=>this._transition(i),n)),this.listeners=new Set}get closed(){return this._closed}get client(){if(this._client)return this._client;throw new Error("ConvexClient is disabled")}get disabled(){return this._disabled}onUpdate(e,t,r,n){if(this.disabled){const u=()=>{};return Object.assign(u,{unsubscribe:u,getCurrentValue:()=>{},getQueryLogs:()=>{}}),u}const{queryToken:i,unsubscribe:o}=this.client.subscribe(L(e),t),a={queryToken:i,callback:r,onError:n,unsubscribe:o,hasEverRun:!1,query:e,args:t};this.listeners.add(a),this.queryResultReady(i)&&this.callNewListenersWithCurrentValuesTimer===void 0&&(this.callNewListenersWithCurrentValuesTimer=setTimeout(()=>this.callNewListenersWithCurrentValues(),0));const c={unsubscribe:()=>{this.closed||(this.listeners.delete(a),o())},getCurrentValue:()=>this.client.localQueryResultByToken(i),getQueryLogs:()=>this.client.localQueryLogs(i)},h=c.unsubscribe;return Object.assign(h,c),h}callNewListenersWithCurrentValues(){this.callNewListenersWithCurrentValuesTimer=void 0,this._transition([],!0)}queryResultReady(e){return this.client.hasLocalQueryResultByToken(e)}async close(){if(!this.disabled)return this.listeners.clear(),this._closed=!0,this.client.close()}setAuth(e,t){this.disabled||this.client.setAuth(e,t??(()=>{}))}setAdminAuth(e,t){if(this.closed)throw new Error("ConvexClient has already been closed.");this.disabled||this.client.setAdminAuth(e,t)}_transition(e,t=!1){for(const r of this.listeners){const{callback:n,queryToken:i,onError:o,hasEverRun:a}=r;if(e.includes(i)||t&&!a&&this.client.hasLocalQueryResultByToken(i)){r.hasEverRun=!0;let c;try{c=this.client.localQueryResultByToken(i)}catch(h){if(!(h instanceof Error))throw h;o?o(h,"Second argument to onUpdate onError is reserved for later use"):Promise.reject(h);continue}n(c,"Second argument to onUpdate callback is reserved for later use")}}}async mutation(e,t,r){if(this.disabled)throw new Error("ConvexClient is disabled");return await this.client.mutation(L(e),t,r)}async action(e,t){if(this.disabled)throw new Error("ConvexClient is disabled");return await this.client.action(L(e),t)}async query(e,t){if(this.disabled)throw new Error("ConvexClient is disabled");const r=this.client.localQueryResult(L(e),t);return r!==void 0?Promise.resolve(r):new Promise((n,i)=>{const{unsubscribe:o}=this.onUpdate(e,t,a=>{o(),n(a)},a=>{o(),i(a)})})}connectionState(){if(this.disabled)throw new Error("ConvexClient is disabled");return this.client.connectionState()}subscribeToConnectionState(e){return this.disabled?()=>{}:this.client.subscribeToConnectionState(e)}}const vt="$$_convexClient",_r=()=>{const s=W(vt);if(!s)throw new Error("No ConvexClient was found in Svelte context. Did you forget to call setupConvex() in a parent component?");return s},Tr=s=>{ye(vt,s)},Xr=(s,e={})=>{const t={disabled:!_t,...e},r=new Cr(s,t);Tr(r),ie(()=>()=>r.close())};function Yr(s,e,t={}){const r=_r();if(typeof s=="string")throw new Error("Query must be a functionReference object, not a string");const n=We({result:H(t).initialData,argsForLastResult:void 0,lastResult:void 0,haveArgsEverChanged:!1});ie(()=>{const d=K(e);return r.onUpdate(s,d,y=>{const T=structuredClone(y);n.result=T,n.argsForLastResult=d,n.lastResult=T},y=>{n.result=y,n.argsForLastResult=d;const T=structuredClone(y);n.lastResult=T})});const i=M(()=>!!n.argsForLastResult&&JSON.stringify(x(n.argsForLastResult))===JSON.stringify(x(K(e)))),o=M(()=>!!(H(t).keepPreviousData&&n.lastResult)),a=K(e);ie(()=>{wt(()=>n.haveArgsEverChanged)||JSON.stringify(x(K(e)))!==JSON.stringify(x(a))&&(n.haveArgsEverChanged=!0,H(t).initialData!==void 0&&(n.argsForLastResult=Ae(a),n.lastResult=H(t).initialData))});const c=M(()=>{if(H(t).initialData&&!n.haveArgsEverChanged)return n.result;let f;try{f=r.disabled?void 0:r.client.localQueryResult(L(s),K(e))}catch(y){if(!(y instanceof Error))throw console.error("threw non-Error instance",y),y;f=y}return n.result,f}),h=M(()=>p(c)!==void 0?p(c):p(o)?n.lastResult:void 0),u=M(()=>p(c)===void 0&&p(o)&&!p(i)&&p(h)!==void 0),g=M(()=>{if(!(p(h)instanceof Error))return p(h)}),l=M(()=>{if(p(h)instanceof Error)return p(h)});return{get data(){return p(g)},get isLoading(){return p(l)===void 0&&p(g)===void 0},get error(){return p(l)},get isStale(){return p(u)}}}function K(s){return typeof s=="function"&&(s=s()),Ae(s)}function H(s){return typeof s=="function"&&(s=s()),Ae(s)}export{_t as B,Hr as C,Fr as D,Kr as I,Nr as S,zr as a,Dr as b,Yr as c,_r as d,Qr as e,It as f,Ur as g,Br as h,Wr as i,Xr as j,Jr as l,jr as s,j as u};
