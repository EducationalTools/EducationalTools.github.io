import"./Bzak7iHL.js";import{aA as je,p as te,e as P,g as F,a as I,c as se,i as T,aw as B,f as He,d as Je,h as be,r as Ye,B as Qe,al as $t,av as qt,w as Mt,an as Ot}from"./zOeN_PB6.js";import{a as W}from"./BpwvG457.js";import{i as Se}from"./kzG8n2m5.js";import{a as ze}from"./BHHFZoJ7.js";import{p as z,r as ke,s as dt}from"./KUXNiUzL.js";import{b as Xe,d as X,m as Ge}from"./Dpir5LKk.js";import"./CD_UOH_r.js";import{d as It,e as xt,f as Et}from"./CBP10XEx.js";import{u as ft}from"./CKrpm_9b.js";import{I as gt}from"./DZWzz3up.js";import{g as Lt}from"./gnU0ypJ3.js";import{B as Dt}from"./CoG0geaG.js";import{s as Ze}from"./DKqx73Nl.js";var Vt=He("<div><!></div>");function Cn(s,e){const t=je();te(e,!0);let n=z(e,"id",19,()=>Xe(t)),r=z(e,"ref",15,null),i=z(e,"level",3,2),o=ke(e,["$$slots","$$events","$$legacy","id","ref","child","children","level"]);const a=It.create({id:X.with(()=>n()),level:X.with(()=>i()),ref:X.with(()=>r(),h=>r(h))}),u=B(()=>Ge(o,a.props));var y=P(),C=F(y);{var b=h=>{var w=P(),k=F(w);W(k,()=>e.child,()=>({props:T(u)})),I(h,w)},f=h=>{var w=Vt();ze(w,()=>({...T(u)}));var k=Je(w);W(k,()=>e.children??be),Ye(w),I(h,w)};Se(C,h=>{e.child?h(b):h(f,!1)})}I(s,y),se()}var Pt=He("<button><!></button>");function Tn(s,e){const t=je();te(e,!0);let n=z(e,"id",19,()=>Xe(t)),r=z(e,"ref",15,null),i=z(e,"disabled",3,!1),o=ke(e,["$$slots","$$events","$$legacy","id","ref","children","child","disabled"]);const a=xt.create({id:X.with(()=>n()),ref:X.with(()=>r(),h=>r(h)),disabled:X.with(()=>!!i())}),u=B(()=>Ge(o,a.props));var y=P(),C=F(y);{var b=h=>{var w=P(),k=F(w);W(k,()=>e.child,()=>({props:T(u)})),I(h,w)},f=h=>{var w=Pt();ze(w,()=>({...T(u)}));var k=Je(w);W(k,()=>e.children??be),Ye(w),I(h,w)};Se(C,h=>{e.child?h(b):h(f,!1)})}I(s,y),se()}var Ft=He("<div><!></div>");function _n(s,e){const t=je();te(e,!0);let n=z(e,"id",19,()=>Xe(t)),r=z(e,"ref",15,null),i=ke(e,["$$slots","$$events","$$legacy","id","children","child","ref"]);const o=Et.create({id:X.with(()=>n()),ref:X.with(()=>r(),f=>r(f))}),a=B(()=>Ge(i,o.props));var u=P(),y=F(u);{var C=f=>{var h=P(),w=F(h);W(w,()=>e.child,()=>({props:T(a)})),I(f,h)},b=f=>{var h=Ft();ze(h,()=>({...T(a)}));var w=Je(h);W(w,()=>e.children??be),Ye(h),I(f,h)};Se(y,f=>{e.child?f(C):f(b,!1)})}I(s,u),se()}function An(s,e){te(e,!0);const t=ft();var n=P(),r=F(n);{var i=o=>{var a=P(),u=F(a);W(u,()=>e.children),I(o,a)};Se(r,o=>{t.auth.userId&&o(i)})}I(s,n),se()}function $n(s,e){te(e,!0);const t=ft();var n=P(),r=F(n);{var i=o=>{var a=P(),u=F(a);W(u,()=>e.children),I(o,a)};Se(r,o=>{t.auth.userId===null&&o(i)})}I(s,n),se()}function qn(s,e){te(e,!0);/**
 * @license @lucide/svelte v0.544.0 - ISC
 *
 * ISC License
 *
 * Copyright (c) for portions of Lucide are held by Cole Bemis 2013-2023 as part of Feather (MIT). All other copyright (c) for Lucide are held by Lucide Contributors 2025.
 *
 * Permission to use, copy, modify, and/or distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 *
 * ---
 *
 * The MIT License (MIT) (for portions derived from Feather)
 *
 * Copyright (c) 2013-2023 Cole Bemis
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */let t=ke(e,["$$slots","$$events","$$legacy"]);const n=[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"}]];gt(s,dt({name:"clipboard"},()=>t,{get iconNode(){return n},children:(r,i)=>{var o=P(),a=F(o);W(a,()=>e.children??be),I(r,o)},$$slots:{default:!0}})),se()}function Mn(s,e){te(e,!0);/**
 * @license @lucide/svelte v0.544.0 - ISC
 *
 * ISC License
 *
 * Copyright (c) for portions of Lucide are held by Cole Bemis 2013-2023 as part of Feather (MIT). All other copyright (c) for Lucide are held by Lucide Contributors 2025.
 *
 * Permission to use, copy, modify, and/or distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 *
 * ---
 *
 * The MIT License (MIT) (for portions derived from Feather)
 *
 * Copyright (c) 2013-2023 Cole Bemis
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */let t=ke(e,["$$slots","$$events","$$legacy"]);const n=[["circle",{cx:"12",cy:"12",r:"10"}],["path",{d:"M12 16v-4"}],["path",{d:"M12 8h.01"}]];gt(s,dt({name:"info"},()=>t,{get iconNode(){return n},children:(r,i)=>{var o=P(),a=F(o);W(a,()=>e.children??be),I(r,o)},$$slots:{default:!0}})),se()}var $e={exports:{}},Qt=$e.exports,st;function Nt(){return st||(st=1,(function(s,e){(function(t,n){s.exports=n()})(Qt,(function(){var t=1e3,n=6e4,r=36e5,i="millisecond",o="second",a="minute",u="hour",y="day",C="week",b="month",f="quarter",h="year",w="date",k="Invalid Date",Q=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,Tt=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,_t={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(m){var d=["th","st","nd","rd"],c=m%100;return"["+m+(d[(c-20)%10]||d[c]||d[0])+"]"}},xe=function(m,d,c){var g=String(m);return!g||g.length>=d?m:""+Array(d+1-g.length).join(c)+m},At={s:xe,z:function(m){var d=-m.utcOffset(),c=Math.abs(d),g=Math.floor(c/60),l=c%60;return(d<=0?"+":"-")+xe(g,2,"0")+":"+xe(l,2,"0")},m:function m(d,c){if(d.date()<c.date())return-m(c,d);var g=12*(c.year()-d.year())+(c.month()-d.month()),l=d.clone().add(g,b),p=c-l<0,v=d.clone().add(g+(p?-1:1),b);return+(-(g+(c-l)/(p?l-v:v-l))||0)},a:function(m){return m<0?Math.ceil(m)||0:Math.floor(m)},p:function(m){return{M:b,y:h,w:C,d:y,D:w,h:u,m:a,s:o,ms:i,Q:f}[m]||String(m||"").toLowerCase().replace(/s$/,"")},u:function(m){return m===void 0}},ue="en",G={};G[ue]=_t;var et="$isDayjsObject",Ee=function(m){return m instanceof Ce||!(!m||!m[et])},Re=function m(d,c,g){var l;if(!d)return ue;if(typeof d=="string"){var p=d.toLowerCase();G[p]&&(l=p),c&&(G[p]=c,l=p);var v=d.split("-");if(!l&&v.length>1)return m(v[0])}else{var R=d.name;G[R]=d,l=R}return!g&&l&&(ue=l),l||!g&&ue},$=function(m,d){if(Ee(m))return m.clone();var c=typeof d=="object"?d:{};return c.date=m,c.args=arguments,new Ce(c)},S=At;S.l=Re,S.i=Ee,S.w=function(m,d){return $(m,{locale:d.$L,utc:d.$u,x:d.$x,$offset:d.$offset})};var Ce=(function(){function m(c){this.$L=Re(c.locale,null,!0),this.parse(c),this.$x=this.$x||c.x||{},this[et]=!0}var d=m.prototype;return d.parse=function(c){this.$d=(function(g){var l=g.date,p=g.utc;if(l===null)return new Date(NaN);if(S.u(l))return new Date;if(l instanceof Date)return new Date(l);if(typeof l=="string"&&!/Z$/i.test(l)){var v=l.match(Q);if(v){var R=v[2]-1||0,_=(v[7]||"0").substring(0,3);return p?new Date(Date.UTC(v[1],R,v[3]||1,v[4]||0,v[5]||0,v[6]||0,_)):new Date(v[1],R,v[3]||1,v[4]||0,v[5]||0,v[6]||0,_)}}return new Date(l)})(c),this.init()},d.init=function(){var c=this.$d;this.$y=c.getFullYear(),this.$M=c.getMonth(),this.$D=c.getDate(),this.$W=c.getDay(),this.$H=c.getHours(),this.$m=c.getMinutes(),this.$s=c.getSeconds(),this.$ms=c.getMilliseconds()},d.$utils=function(){return S},d.isValid=function(){return this.$d.toString()!==k},d.isSame=function(c,g){var l=$(c);return this.startOf(g)<=l&&l<=this.endOf(g)},d.isAfter=function(c,g){return $(c)<this.startOf(g)},d.isBefore=function(c,g){return this.endOf(g)<$(c)},d.$g=function(c,g,l){return S.u(c)?this[g]:this.set(l,c)},d.unix=function(){return Math.floor(this.valueOf()/1e3)},d.valueOf=function(){return this.$d.getTime()},d.startOf=function(c,g){var l=this,p=!!S.u(g)||g,v=S.p(c),R=function(K,x){var H=S.w(l.$u?Date.UTC(l.$y,x,K):new Date(l.$y,x,K),l);return p?H:H.endOf(y)},_=function(K,x){return S.w(l.toDate()[K].apply(l.toDate("s"),(p?[0,0,0,0]:[23,59,59,999]).slice(x)),l)},q=this.$W,M=this.$M,L=this.$D,ne="set"+(this.$u?"UTC":"");switch(v){case h:return p?R(1,0):R(31,11);case b:return p?R(1,M):R(0,M+1);case C:var Z=this.$locale().weekStart||0,ce=(q<Z?q+7:q)-Z;return R(p?L-ce:L+(6-ce),M);case y:case w:return _(ne+"Hours",0);case u:return _(ne+"Minutes",1);case a:return _(ne+"Seconds",2);case o:return _(ne+"Milliseconds",3);default:return this.clone()}},d.endOf=function(c){return this.startOf(c,!1)},d.$set=function(c,g){var l,p=S.p(c),v="set"+(this.$u?"UTC":""),R=(l={},l[y]=v+"Date",l[w]=v+"Date",l[b]=v+"Month",l[h]=v+"FullYear",l[u]=v+"Hours",l[a]=v+"Minutes",l[o]=v+"Seconds",l[i]=v+"Milliseconds",l)[p],_=p===y?this.$D+(g-this.$W):g;if(p===b||p===h){var q=this.clone().set(w,1);q.$d[R](_),q.init(),this.$d=q.set(w,Math.min(this.$D,q.daysInMonth())).$d}else R&&this.$d[R](_);return this.init(),this},d.set=function(c,g){return this.clone().$set(c,g)},d.get=function(c){return this[S.p(c)]()},d.add=function(c,g){var l,p=this;c=Number(c);var v=S.p(g),R=function(M){var L=$(p);return S.w(L.date(L.date()+Math.round(M*c)),p)};if(v===b)return this.set(b,this.$M+c);if(v===h)return this.set(h,this.$y+c);if(v===y)return R(1);if(v===C)return R(7);var _=(l={},l[a]=n,l[u]=r,l[o]=t,l)[v]||1,q=this.$d.getTime()+c*_;return S.w(q,this)},d.subtract=function(c,g){return this.add(-1*c,g)},d.format=function(c){var g=this,l=this.$locale();if(!this.isValid())return l.invalidDate||k;var p=c||"YYYY-MM-DDTHH:mm:ssZ",v=S.z(this),R=this.$H,_=this.$m,q=this.$M,M=l.weekdays,L=l.months,ne=l.meridiem,Z=function(x,H,he,Te){return x&&(x[H]||x(g,p))||he[H].slice(0,Te)},ce=function(x){return S.s(R%12||12,x,"0")},K=ne||function(x,H,he){var Te=x<12?"AM":"PM";return he?Te.toLowerCase():Te};return p.replace(Tt,(function(x,H){return H||(function(he){switch(he){case"YY":return String(g.$y).slice(-2);case"YYYY":return S.s(g.$y,4,"0");case"M":return q+1;case"MM":return S.s(q+1,2,"0");case"MMM":return Z(l.monthsShort,q,L,3);case"MMMM":return Z(L,q);case"D":return g.$D;case"DD":return S.s(g.$D,2,"0");case"d":return String(g.$W);case"dd":return Z(l.weekdaysMin,g.$W,M,2);case"ddd":return Z(l.weekdaysShort,g.$W,M,3);case"dddd":return M[g.$W];case"H":return String(R);case"HH":return S.s(R,2,"0");case"h":return ce(1);case"hh":return ce(2);case"a":return K(R,_,!0);case"A":return K(R,_,!1);case"m":return String(_);case"mm":return S.s(_,2,"0");case"s":return String(g.$s);case"ss":return S.s(g.$s,2,"0");case"SSS":return S.s(g.$ms,3,"0");case"Z":return v}return null})(x)||v.replace(":","")}))},d.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},d.diff=function(c,g,l){var p,v=this,R=S.p(g),_=$(c),q=(_.utcOffset()-this.utcOffset())*n,M=this-_,L=function(){return S.m(v,_)};switch(R){case h:p=L()/12;break;case b:p=L();break;case f:p=L()/3;break;case C:p=(M-q)/6048e5;break;case y:p=(M-q)/864e5;break;case u:p=M/r;break;case a:p=M/n;break;case o:p=M/t;break;default:p=M}return l?p:S.a(p)},d.daysInMonth=function(){return this.endOf(b).$D},d.$locale=function(){return G[this.$L]},d.locale=function(c,g){if(!c)return this.$L;var l=this.clone(),p=Re(c,g,!0);return p&&(l.$L=p),l},d.clone=function(){return S.w(this.$d,this)},d.toDate=function(){return new Date(this.valueOf())},d.toJSON=function(){return this.isValid()?this.toISOString():null},d.toISOString=function(){return this.$d.toISOString()},d.toString=function(){return this.$d.toUTCString()},m})(),tt=Ce.prototype;return $.prototype=tt,[["$ms",i],["$s",o],["$m",a],["$H",u],["$W",y],["$M",b],["$y",h],["$D",w]].forEach((function(m){tt[m[1]]=function(d){return this.$g(d,m[0],m[1])}})),$.extend=function(m,d){return m.$i||(m(d,Ce,$),m.$i=!0),$},$.locale=Re,$.isDayjs=Ee,$.unix=function(m){return $(1e3*m)},$.en=G[ue],$.Ls=G,$.p={},$}))})($e)),$e.exports}var Bt=Nt();const On=Lt(Bt);var U=[],V=[],Ut=Uint8Array,Le="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var re=0,Wt=Le.length;re<Wt;++re)U[re]=Le[re],V[Le.charCodeAt(re)]=re;V[45]=62;V[95]=63;function jt(s){var e=s.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=s.indexOf("=");t===-1&&(t=e);var n=t===e?0:4-t%4;return[t,n]}function Ht(s,e,t){return(e+t)*3/4-t}function pe(s){var e,t=jt(s),n=t[0],r=t[1],i=new Ut(Ht(s,n,r)),o=0,a=r>0?n-4:n,u;for(u=0;u<a;u+=4)e=V[s.charCodeAt(u)]<<18|V[s.charCodeAt(u+1)]<<12|V[s.charCodeAt(u+2)]<<6|V[s.charCodeAt(u+3)],i[o++]=e>>16&255,i[o++]=e>>8&255,i[o++]=e&255;return r===2&&(e=V[s.charCodeAt(u)]<<2|V[s.charCodeAt(u+1)]>>4,i[o++]=e&255),r===1&&(e=V[s.charCodeAt(u)]<<10|V[s.charCodeAt(u+1)]<<4|V[s.charCodeAt(u+2)]>>2,i[o++]=e>>8&255,i[o++]=e&255),i}function Jt(s){return U[s>>18&63]+U[s>>12&63]+U[s>>6&63]+U[s&63]}function Yt(s,e,t){for(var n,r=[],i=e;i<t;i+=3)n=(s[i]<<16&16711680)+(s[i+1]<<8&65280)+(s[i+2]&255),r.push(Jt(n));return r.join("")}function ve(s){for(var e,t=s.length,n=t%3,r=[],i=16383,o=0,a=t-n;o<a;o+=i)r.push(Yt(s,o,o+i>a?a:o+i));return n===1?(e=s[t-1],r.push(U[e>>2]+U[e<<4&63]+"==")):n===2&&(e=(s[t-2]<<8)+s[t-1],r.push(U[e>>10]+U[e>>4&63]+U[e<<2&63]+"=")),r.join("")}function J(s){if(s===void 0)return{};if(!mt(s))throw new Error(`The arguments to a Convex function must be an object. Received: ${s}`);return s}function yt(s){if(typeof s>"u")throw new Error("Client created with undefined deployment address. If you used an environment variable, check that it's set.");if(typeof s!="string")throw new Error(`Invalid deployment address: found ${s}".`);if(!(s.startsWith("http:")||s.startsWith("https:")))throw new Error(`Invalid deployment address: Must start with "https://" or "http://". Found "${s}".`);try{new URL(s)}catch{throw new Error(`Invalid deployment address: "${s}" is not a valid URL. If you believe this URL is correct, use the \`skipConvexDeploymentUrlCheck\` option to bypass this.`)}if(s.endsWith(".convex.site"))throw new Error(`Invalid deployment address: "${s}" ends with .convex.site, which is used for HTTP Actions. Convex deployment URLs typically end with .convex.cloud? If you believe this URL is correct, use the \`skipConvexDeploymentUrlCheck\` option to bypass this.`)}function mt(s){var r;const e=typeof s=="object",t=Object.getPrototypeOf(s),n=t===null||t===Object.prototype||((r=t==null?void 0:t.constructor)==null?void 0:r.name)==="Object";return e&&n}const pt=!0,oe=BigInt("-9223372036854775808"),Ke=BigInt("9223372036854775807"),Ne=BigInt("0"),zt=BigInt("8"),Xt=BigInt("256");function vt(s){return Number.isNaN(s)||!Number.isFinite(s)||Object.is(s,-0)}function Gt(s){s<Ne&&(s-=oe+oe);let e=s.toString(16);e.length%2===1&&(e="0"+e);const t=new Uint8Array(new ArrayBuffer(8));let n=0;for(const r of e.match(/.{2}/g).reverse())t.set([parseInt(r,16)],n++),s>>=zt;return ve(t)}function Zt(s){const e=pe(s);if(e.byteLength!==8)throw new Error(`Received ${e.byteLength} bytes, expected 8 for $integer`);let t=Ne,n=Ne;for(const r of e)t+=BigInt(r)*Xt**n,n++;return t>Ke&&(t+=oe+oe),t}function Kt(s){if(s<oe||Ke<s)throw new Error(`BigInt ${s} does not fit into a 64-bit signed integer.`);const e=new ArrayBuffer(8);return new DataView(e).setBigInt64(0,s,!0),ve(new Uint8Array(e))}function es(s){const e=pe(s);if(e.byteLength!==8)throw new Error(`Received ${e.byteLength} bytes, expected 8 for $integer`);return new DataView(e.buffer).getBigInt64(0,!0)}const ts=DataView.prototype.setBigInt64?Kt:Gt,ss=DataView.prototype.getBigInt64?es:Zt,nt=1024;function wt(s){if(s.length>nt)throw new Error(`Field name ${s} exceeds maximum field name length ${nt}.`);if(s.startsWith("$"))throw new Error(`Field name ${s} starts with a '$', which is reserved.`);for(let e=0;e<s.length;e+=1){const t=s.charCodeAt(e);if(t<32||t>=127)throw new Error(`Field name ${s} has invalid character '${s[e]}': Field names can only contain non-control ASCII characters`)}}function ae(s){if(s===null||typeof s=="boolean"||typeof s=="number"||typeof s=="string")return s;if(Array.isArray(s))return s.map(n=>ae(n));if(typeof s!="object")throw new Error(`Unexpected type of ${s}`);const e=Object.entries(s);if(e.length===1){const n=e[0][0];if(n==="$bytes"){if(typeof s.$bytes!="string")throw new Error(`Malformed $bytes field on ${s}`);return pe(s.$bytes).buffer}if(n==="$integer"){if(typeof s.$integer!="string")throw new Error(`Malformed $integer field on ${s}`);return ss(s.$integer)}if(n==="$float"){if(typeof s.$float!="string")throw new Error(`Malformed $float field on ${s}`);const r=pe(s.$float);if(r.byteLength!==8)throw new Error(`Received ${r.byteLength} bytes, expected 8 for $float`);const o=new DataView(r.buffer).getFloat64(0,pt);if(!vt(o))throw new Error(`Float ${o} should be encoded as a number`);return o}if(n==="$set")throw new Error("Received a Set which is no longer supported as a Convex type.");if(n==="$map")throw new Error("Received a Map which is no longer supported as a Convex type.")}const t={};for(const[n,r]of Object.entries(s))wt(n),t[n]=ae(r);return t}function ye(s){return JSON.stringify(s,(e,t)=>t===void 0?"undefined":typeof t=="bigint"?`${t.toString()}n`:t)}function Be(s,e,t,n){var o;if(s===void 0){const a=t&&` (present at path ${t} in original object ${ye(e)})`;throw new Error(`undefined is not a valid Convex value${a}. To learn about Convex's supported types, see https://docs.convex.dev/using/types.`)}if(s===null)return s;if(typeof s=="bigint"){if(s<oe||Ke<s)throw new Error(`BigInt ${s} does not fit into a 64-bit signed integer.`);return{$integer:ts(s)}}if(typeof s=="number")if(vt(s)){const a=new ArrayBuffer(8);return new DataView(a).setFloat64(0,s,pt),{$float:ve(new Uint8Array(a))}}else return s;if(typeof s=="boolean"||typeof s=="string")return s;if(s instanceof ArrayBuffer)return{$bytes:ve(new Uint8Array(s))};if(Array.isArray(s))return s.map((a,u)=>Be(a,e,t+`[${u}]`));if(s instanceof Set)throw new Error(De(t,"Set",[...s],e));if(s instanceof Map)throw new Error(De(t,"Map",[...s],e));if(!mt(s)){const a=(o=s==null?void 0:s.constructor)==null?void 0:o.name,u=a?`${a} `:"";throw new Error(De(t,u,s,e))}const r={},i=Object.entries(s);i.sort(([a,u],[y,C])=>a===y?0:a<y?-1:1);for(const[a,u]of i)u!==void 0&&(wt(a),r[a]=Be(u,e,t+`.${a}`));return r}function De(s,e,t,n){return s?`${e}${ye(t)} is not a supported Convex type (present at path ${s} in original object ${ye(n)}). To learn about Convex's supported types, see https://docs.convex.dev/using/types.`:`${e}${ye(t)} is not a supported Convex type.`}function j(s){return Be(s,s,"")}var ns=Object.defineProperty,rs=(s,e,t)=>e in s?ns(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Ve=(s,e,t)=>rs(s,typeof e!="symbol"?e+"":e,t),rt,it;const is=Symbol.for("ConvexError");class Ue extends(it=Error,rt=is,it){constructor(e){super(typeof e=="string"?e:ye(e)),Ve(this,"name","ConvexError"),Ve(this,"data"),Ve(this,rt,!0),this.data=e}}const ot="1.25.4",qe=Symbol.for("functionName"),os=Symbol.for("toReferencePath");function as(s){return s[os]??null}function us(s){return s.startsWith("function://")}function cs(s){let e;if(typeof s=="string")us(s)?e={functionHandle:s}:e={name:s};else if(s[qe])e={name:s[qe]};else{const t=as(s);if(!t)throw new Error(`${s} is not a functionReference`);e={reference:t}}return e}function Y(s){const e=cs(s);if(e.name===void 0)throw e.functionHandle!==void 0?new Error(`Expected function reference like "api.file.func" or "internal.file.func", but received function handle ${e.functionHandle}`):e.reference!==void 0?new Error(`Expected function reference in the current component like "api.file.func" or "internal.file.func", but received reference ${e.reference}`):new Error(`Expected function reference like "api.file.func" or "internal.file.func", but received ${JSON.stringify(e)}`);if(typeof s=="string")return s;const t=s[qe];if(!t)throw new Error(`${s} is not a functionReference`);return t}function bt(s=[]){const e={get(t,n){if(typeof n=="string"){const r=[...s,n];return bt(r)}else if(n===qe){if(s.length<2){const o=["api",...s].join(".");throw new Error(`API path is expected to be of the form \`api.moduleName.functionName\`. Found: \`${o}\``)}const r=s.slice(0,-1).join("/"),i=s[s.length-1];return i==="default"?r:r+":"+i}else return n===Symbol.toStringTag?"FunctionReference":void 0}};return new Proxy({},e)}const In=bt();var hs=Object.defineProperty,ls=(s,e,t)=>e in s?hs(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,at=(s,e,t)=>ls(s,typeof e!="symbol"?e+"":e,t);const ds="color:rgb(0, 145, 255)";function St(s){switch(s){case"query":return"Q";case"mutation":return"M";case"action":return"A";case"any":return"?"}}class kt{constructor(e){at(this,"_onLogLineFuncs"),at(this,"_verbose"),this._onLogLineFuncs={},this._verbose=e.verbose}addLogLineListener(e){let t=Math.random().toString(36).substring(2,15);for(let n=0;n<10&&this._onLogLineFuncs[t]!==void 0;n++)t=Math.random().toString(36).substring(2,15);return this._onLogLineFuncs[t]=e,()=>{delete this._onLogLineFuncs[t]}}logVerbose(...e){if(this._verbose)for(const t of Object.values(this._onLogLineFuncs))t("debug",`${new Date().toISOString()}`,...e)}log(...e){for(const t of Object.values(this._onLogLineFuncs))t("info",...e)}warn(...e){for(const t of Object.values(this._onLogLineFuncs))t("warn",...e)}error(...e){for(const t of Object.values(this._onLogLineFuncs))t("error",...e)}}function fs(s){const e=new kt(s);return e.addLogLineListener((t,...n)=>{switch(t){case"debug":console.debug(...n);break;case"info":console.log(...n);break;case"warn":console.warn(...n);break;case"error":console.error(...n);break;default:console.log(...n)}}),e}function gs(s){return new kt(s)}function Me(s,e,t,n,r){const i=St(t);if(typeof r=="object"&&(r=`ConvexError ${JSON.stringify(r.errorData,null,2)}`),e==="info"){const o=r.match(/^\[.*?\] /);if(o===null){s.error(`[CONVEX ${i}(${n})] Could not parse console.log`);return}const a=r.slice(1,o[0].length-2),u=r.slice(o[0].length);s.log(`%c[CONVEX ${i}(${n})] [${a}]`,ds,u)}else s.error(`[CONVEX ${i}(${n})] ${r}`)}function ys(s,e){const t=`[CONVEX FATAL ERROR] ${e}`;return s.error(t),new Error(t)}function ie(s,e,t){return`[CONVEX ${St(s)}(${e})] ${t.errorMessage}
  Called by client`}function We(s,e){return e.data=s.errorData,e}function Oe(s){const e=s.split(":");let t,n;return e.length===1?(t=e[0],n="default"):(t=e.slice(0,e.length-1).join(":"),n=e[e.length-1]),t.endsWith(".js")&&(t=t.slice(0,-3)),`${t}:${n}`}function ee(s,e){return JSON.stringify({udfPath:Oe(s),args:j(e)})}var ms=Object.defineProperty,ps=(s,e,t)=>e in s?ms(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,N=(s,e,t)=>ps(s,typeof e!="symbol"?e+"":e,t);class vs{constructor(){N(this,"nextQueryId"),N(this,"querySetVersion"),N(this,"querySet"),N(this,"queryIdToToken"),N(this,"identityVersion"),N(this,"auth"),N(this,"outstandingQueriesOlderThanRestart"),N(this,"outstandingAuthOlderThanRestart"),N(this,"paused"),N(this,"pendingQuerySetModifications"),this.nextQueryId=0,this.querySetVersion=0,this.identityVersion=0,this.querySet=new Map,this.queryIdToToken=new Map,this.outstandingQueriesOlderThanRestart=new Set,this.outstandingAuthOlderThanRestart=!1,this.paused=!1,this.pendingQuerySetModifications=new Map}hasSyncedPastLastReconnect(){return this.outstandingQueriesOlderThanRestart.size===0&&!this.outstandingAuthOlderThanRestart}markAuthCompletion(){this.outstandingAuthOlderThanRestart=!1}subscribe(e,t,n,r){const i=Oe(e),o=ee(i,t),a=this.querySet.get(o);if(a!==void 0)return a.numSubscribers+=1,{queryToken:o,modification:null,unsubscribe:()=>this.removeSubscriber(o)};{const u=this.nextQueryId++,y={id:u,canonicalizedUdfPath:i,args:t,numSubscribers:1,journal:n,componentPath:r};this.querySet.set(o,y),this.queryIdToToken.set(u,o);const C=this.querySetVersion,b=this.querySetVersion+1,f={type:"Add",queryId:u,udfPath:i,args:[j(t)],journal:n,componentPath:r};return this.paused?this.pendingQuerySetModifications.set(u,f):this.querySetVersion=b,{queryToken:o,modification:{type:"ModifyQuerySet",baseVersion:C,newVersion:b,modifications:[f]},unsubscribe:()=>this.removeSubscriber(o)}}}transition(e){for(const t of e.modifications)switch(t.type){case"QueryUpdated":case"QueryFailed":{this.outstandingQueriesOlderThanRestart.delete(t.queryId);const n=t.journal;if(n!==void 0){const r=this.queryIdToToken.get(t.queryId);r!==void 0&&(this.querySet.get(r).journal=n)}break}case"QueryRemoved":{this.outstandingQueriesOlderThanRestart.delete(t.queryId);break}default:throw new Error(`Invalid modification ${t.type}`)}}queryId(e,t){const n=Oe(e),r=ee(n,t),i=this.querySet.get(r);return i!==void 0?i.id:null}isCurrentOrNewerAuthVersion(e){return e>=this.identityVersion}setAuth(e){this.auth={tokenType:"User",value:e};const t=this.identityVersion;return this.paused||(this.identityVersion=t+1),{type:"Authenticate",baseVersion:t,...this.auth}}setAdminAuth(e,t){const n={tokenType:"Admin",value:e,impersonating:t};this.auth=n;const r=this.identityVersion;return this.paused||(this.identityVersion=r+1),{type:"Authenticate",baseVersion:r,...n}}clearAuth(){this.auth=void 0,this.markAuthCompletion();const e=this.identityVersion;return this.paused||(this.identityVersion=e+1),{type:"Authenticate",tokenType:"None",baseVersion:e}}hasAuth(){return!!this.auth}isNewAuth(e){var t;return((t=this.auth)==null?void 0:t.value)!==e}queryPath(e){const t=this.queryIdToToken.get(e);return t?this.querySet.get(t).canonicalizedUdfPath:null}queryArgs(e){const t=this.queryIdToToken.get(e);return t?this.querySet.get(t).args:null}queryToken(e){return this.queryIdToToken.get(e)??null}queryJournal(e){var t;return(t=this.querySet.get(e))==null?void 0:t.journal}restart(e){this.unpause(),this.outstandingQueriesOlderThanRestart.clear();const t=[];for(const i of this.querySet.values()){const o={type:"Add",queryId:i.id,udfPath:i.canonicalizedUdfPath,args:[j(i.args)],journal:i.journal,componentPath:i.componentPath};t.push(o),e.has(i.id)||this.outstandingQueriesOlderThanRestart.add(i.id)}this.querySetVersion=1;const n={type:"ModifyQuerySet",baseVersion:0,newVersion:1,modifications:t};if(!this.auth)return this.identityVersion=0,[n,void 0];this.outstandingAuthOlderThanRestart=!0;const r={type:"Authenticate",baseVersion:0,...this.auth};return this.identityVersion=1,[n,r]}pause(){this.paused=!0}resume(){const e=this.pendingQuerySetModifications.size>0?{type:"ModifyQuerySet",baseVersion:this.querySetVersion,newVersion:++this.querySetVersion,modifications:Array.from(this.pendingQuerySetModifications.values())}:void 0,t=this.auth!==void 0?{type:"Authenticate",baseVersion:this.identityVersion++,...this.auth}:void 0;return this.unpause(),[e,t]}unpause(){this.paused=!1,this.pendingQuerySetModifications.clear()}removeSubscriber(e){const t=this.querySet.get(e);if(t.numSubscribers>1)return t.numSubscribers-=1,null;{this.querySet.delete(e),this.queryIdToToken.delete(t.id),this.outstandingQueriesOlderThanRestart.delete(t.id);const n=this.querySetVersion,r=this.querySetVersion+1,i={type:"Remove",queryId:t.id};return this.paused?this.pendingQuerySetModifications.has(t.id)?this.pendingQuerySetModifications.delete(t.id):this.pendingQuerySetModifications.set(t.id,i):this.querySetVersion=r,{type:"ModifyQuerySet",baseVersion:n,newVersion:r,modifications:[i]}}}}var ws=Object.defineProperty,bs=(s,e,t)=>e in s?ws(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,_e=(s,e,t)=>bs(s,typeof e!="symbol"?e+"":e,t);class Ss{constructor(e,t){this.logger=e,this.markConnectionStateDirty=t,_e(this,"inflightRequests"),_e(this,"requestsOlderThanRestart"),_e(this,"inflightMutationsCount",0),_e(this,"inflightActionsCount",0),this.inflightRequests=new Map,this.requestsOlderThanRestart=new Set}request(e,t){const n=new Promise(r=>{const i=t?"Requested":"NotSent";this.inflightRequests.set(e.requestId,{message:e,status:{status:i,requestedAt:new Date,onResult:r}}),e.type==="Mutation"?this.inflightMutationsCount++:e.type==="Action"&&this.inflightActionsCount++});return this.markConnectionStateDirty(),n}onResponse(e){const t=this.inflightRequests.get(e.requestId);if(t===void 0||t.status.status==="Completed")return null;const n=t.message.type==="Mutation"?"mutation":"action",r=t.message.udfPath;for(const u of e.logLines)Me(this.logger,"info",n,r,u);const i=t.status;let o,a;if(e.success)o={success:!0,logLines:e.logLines,value:ae(e.result)},a=()=>i.onResult(o);else{const u=e.result,{errorData:y}=e;Me(this.logger,"error",n,r,u),o={success:!1,errorMessage:u,errorData:y!==void 0?ae(y):void 0,logLines:e.logLines},a=()=>i.onResult(o)}return e.type==="ActionResponse"||!e.success?(a(),this.inflightRequests.delete(e.requestId),this.requestsOlderThanRestart.delete(e.requestId),t.message.type==="Action"?this.inflightActionsCount--:t.message.type==="Mutation"&&this.inflightMutationsCount--,this.markConnectionStateDirty(),{requestId:e.requestId,result:o}):(t.status={status:"Completed",result:o,ts:e.ts,onResolve:a},null)}removeCompleted(e){const t=new Map;for(const[n,r]of this.inflightRequests.entries()){const i=r.status;i.status==="Completed"&&i.ts.lessThanOrEqual(e)&&(i.onResolve(),t.set(n,i.result),r.message.type==="Mutation"?this.inflightMutationsCount--:r.message.type==="Action"&&this.inflightActionsCount--,this.inflightRequests.delete(n),this.requestsOlderThanRestart.delete(n))}return t.size>0&&this.markConnectionStateDirty(),t}restart(){this.requestsOlderThanRestart=new Set(this.inflightRequests.keys());const e=[];for(const[t,n]of this.inflightRequests){if(n.status.status==="NotSent"){n.status.status="Requested",e.push(n.message);continue}if(n.message.type==="Mutation")e.push(n.message);else if(n.message.type==="Action"){if(this.inflightRequests.delete(t),this.requestsOlderThanRestart.delete(t),this.inflightActionsCount--,n.status.status==="Completed")throw new Error("Action should never be in 'Completed' state");n.status.onResult({success:!1,errorMessage:"Connection lost while action was in flight",logLines:[]})}}return this.markConnectionStateDirty(),e}resume(){const e=[];for(const[,t]of this.inflightRequests)if(t.status.status==="NotSent"){t.status.status="Requested",e.push(t.message);continue}return e}hasIncompleteRequests(){for(const e of this.inflightRequests.values())if(e.status.status==="Requested")return!0;return!1}hasInflightRequests(){return this.inflightRequests.size>0}hasSyncedPastLastReconnect(){return this.requestsOlderThanRestart.size===0}timeOfOldestInflightRequest(){if(this.inflightRequests.size===0)return null;let e=Date.now();for(const t of this.inflightRequests.values())t.status.status!=="Completed"&&t.status.requestedAt.getTime()<e&&(e=t.status.requestedAt.getTime());return new Date(e)}inflightMutations(){return this.inflightMutationsCount}inflightActions(){return this.inflightActionsCount}}var ks=Object.defineProperty,Rs=(s,e,t)=>e in s?ks(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Ie=(s,e,t)=>Rs(s,typeof e!="symbol"?e+"":e,t);class we{constructor(e){Ie(this,"queryResults"),Ie(this,"modifiedQueries"),this.queryResults=e,this.modifiedQueries=[]}getQuery(e,...t){const n=J(t[0]),r=Y(e),i=this.queryResults.get(ee(r,n));if(i!==void 0)return we.queryValue(i.result)}getAllQueries(e){const t=[],n=Y(e);for(const r of this.queryResults.values())r.udfPath===Oe(n)&&t.push({args:r.args,value:we.queryValue(r.result)});return t}setQuery(e,t,n){const r=J(t),i=Y(e),o=ee(i,r);let a;n===void 0?a=void 0:a={success:!0,value:n,logLines:[]};const u={udfPath:i,args:r,result:a};this.queryResults.set(o,u),this.modifiedQueries.push(o)}static queryValue(e){if(e!==void 0)return e.success?e.value:void 0}}class Cs{constructor(){Ie(this,"queryResults"),Ie(this,"optimisticUpdates"),this.queryResults=new Map,this.optimisticUpdates=[]}ingestQueryResultsFromServer(e,t){this.optimisticUpdates=this.optimisticUpdates.filter(o=>!t.has(o.mutationId));const n=this.queryResults;this.queryResults=new Map(e);const r=new we(this.queryResults);for(const o of this.optimisticUpdates)o.update(r);const i=[];for(const[o,a]of this.queryResults){const u=n.get(o);(u===void 0||u.result!==a.result)&&i.push(o)}return i}applyOptimisticUpdate(e,t){this.optimisticUpdates.push({update:e,mutationId:t});const n=new we(this.queryResults);return e(n),n.modifiedQueries}rawQueryResult(e){return this.queryResults.get(e)}queryResult(e){const t=this.queryResults.get(e);if(t===void 0)return;const n=t.result;if(n!==void 0){if(n.success)return n.value;throw n.errorData!==void 0?We(n,new Ue(ie("query",t.udfPath,n))):new Error(ie("query",t.udfPath,n))}}hasQueryResult(e){return this.queryResults.get(e)!==void 0}queryLogs(e){var n;const t=this.queryResults.get(e);return(n=t==null?void 0:t.result)==null?void 0:n.logLines}}var Ts=Object.defineProperty,_s=(s,e,t)=>e in s?Ts(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Pe=(s,e,t)=>_s(s,typeof e!="symbol"?e+"":e,t);class E{constructor(e,t){Pe(this,"low"),Pe(this,"high"),Pe(this,"__isUnsignedLong__"),this.low=e|0,this.high=t|0,this.__isUnsignedLong__=!0}static isLong(e){return(e&&e.__isUnsignedLong__)===!0}static fromBytesLE(e){return new E(e[0]|e[1]<<8|e[2]<<16|e[3]<<24,e[4]|e[5]<<8|e[6]<<16|e[7]<<24)}toBytesLE(){const e=this.high,t=this.low;return[t&255,t>>>8&255,t>>>16&255,t>>>24,e&255,e>>>8&255,e>>>16&255,e>>>24]}static fromNumber(e){return isNaN(e)||e<0?ut:e>=As?$s:new E(e%me|0,e/me|0)}toString(){return(BigInt(this.high)*BigInt(me)+BigInt(this.low)).toString()}equals(e){return E.isLong(e)||(e=E.fromValue(e)),this.high>>>31===1&&e.high>>>31===1?!1:this.high===e.high&&this.low===e.low}notEquals(e){return!this.equals(e)}comp(e){return E.isLong(e)||(e=E.fromValue(e)),this.equals(e)?0:e.high>>>0>this.high>>>0||e.high===this.high&&e.low>>>0>this.low>>>0?-1:1}lessThanOrEqual(e){return this.comp(e)<=0}static fromValue(e){return typeof e=="number"?E.fromNumber(e):new E(e.low,e.high)}}const ut=new E(0,0),ct=65536,me=ct*ct,As=me*me,$s=new E(-1,-1);var qs=Object.defineProperty,Ms=(s,e,t)=>e in s?qs(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Ae=(s,e,t)=>Ms(s,typeof e!="symbol"?e+"":e,t);class ht{constructor(e,t){Ae(this,"version"),Ae(this,"remoteQuerySet"),Ae(this,"queryPath"),Ae(this,"logger"),this.version={querySet:0,ts:E.fromNumber(0),identity:0},this.remoteQuerySet=new Map,this.queryPath=e,this.logger=t}transition(e){const t=e.startVersion;if(this.version.querySet!==t.querySet||this.version.ts.notEquals(t.ts)||this.version.identity!==t.identity)throw new Error(`Invalid start version: ${t.ts.toString()}:${t.querySet}`);for(const n of e.modifications)switch(n.type){case"QueryUpdated":{const r=this.queryPath(n.queryId);if(r)for(const o of n.logLines)Me(this.logger,"info","query",r,o);const i=ae(n.value??null);this.remoteQuerySet.set(n.queryId,{success:!0,value:i,logLines:n.logLines});break}case"QueryFailed":{const r=this.queryPath(n.queryId);if(r)for(const o of n.logLines)Me(this.logger,"info","query",r,o);const{errorData:i}=n;this.remoteQuerySet.set(n.queryId,{success:!1,errorMessage:n.errorMessage,errorData:i!==void 0?ae(i):void 0,logLines:n.logLines});break}case"QueryRemoved":{this.remoteQuerySet.delete(n.queryId);break}default:throw new Error(`Invalid modification ${n.type}`)}this.version=e.endVersion}remoteQueryResults(){return this.remoteQuerySet}timestamp(){return this.version.ts}}function Fe(s){const e=pe(s);return E.fromBytesLE(Array.from(e))}function Os(s){const e=new Uint8Array(s.toBytesLE());return ve(e)}function Is(s){switch(s.type){case"FatalError":case"AuthError":case"ActionResponse":case"Ping":return{...s};case"MutationResponse":return s.success?{...s,ts:Fe(s.ts)}:{...s};case"Transition":return{...s,startVersion:{...s.startVersion,ts:Fe(s.startVersion.ts)},endVersion:{...s.endVersion,ts:Fe(s.endVersion.ts)}}}}function xs(s){switch(s.type){case"Authenticate":case"ModifyQuerySet":case"Mutation":case"Action":case"Event":return{...s};case"Connect":return s.maxObservedTimestamp!==void 0?{...s,maxObservedTimestamp:Os(s.maxObservedTimestamp)}:{...s,maxObservedTimestamp:void 0}}}var Es=Object.defineProperty,Ls=(s,e,t)=>e in s?Es(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,O=(s,e,t)=>Ls(s,typeof e!="symbol"?e+"":e,t);const Ds=1e3,Vs=1001,Ps=1005,Fs=4040,Rt={InternalServerError:{timeout:1e3},SubscriptionsWorkerFullError:{timeout:3e3},TooManyConcurrentRequests:{timeout:3e3},CommitterFullError:{timeout:3e3},AwsTooManyRequestsException:{timeout:3e3},ExecuteFullError:{timeout:3e3},SystemTimeoutError:{timeout:3e3},ExpiredInQueue:{timeout:3e3},VectorIndexesUnavailable:{timeout:1e3},SearchIndexesUnavailable:{timeout:1e3},VectorIndexTooLarge:{timeout:3e3},SearchIndexTooLarge:{timeout:3e3},TooManyWritesInTimePeriod:{timeout:3e3}};function Qs(s){if(s===void 0)return"Unknown";for(const e of Object.keys(Rt))if(s.startsWith(e))return e;return"Unknown"}class Ns{constructor(e,t,n,r,i){this.markConnectionStateDirty=i,O(this,"socket"),O(this,"connectionCount"),O(this,"_hasEverConnected",!1),O(this,"lastCloseReason"),O(this,"defaultInitialBackoff"),O(this,"maxBackoff"),O(this,"retries"),O(this,"serverInactivityThreshold"),O(this,"reconnectDueToServerInactivityTimeout"),O(this,"uri"),O(this,"onOpen"),O(this,"onResume"),O(this,"onMessage"),O(this,"webSocketConstructor"),O(this,"logger"),O(this,"onServerDisconnectError"),this.webSocketConstructor=n,this.socket={state:"disconnected"},this.connectionCount=0,this.lastCloseReason="InitialConnect",this.defaultInitialBackoff=1e3,this.maxBackoff=16e3,this.retries=0,this.serverInactivityThreshold=3e4,this.reconnectDueToServerInactivityTimeout=null,this.uri=e,this.onOpen=t.onOpen,this.onResume=t.onResume,this.onMessage=t.onMessage,this.onServerDisconnectError=t.onServerDisconnectError,this.logger=r,this.connect()}setSocketState(e){this.socket=e,this._logVerbose(`socket state changed: ${this.socket.state}, paused: ${"paused"in this.socket?this.socket.paused:void 0}`),this.markConnectionStateDirty()}connect(){if(this.socket.state==="terminated")return;if(this.socket.state!=="disconnected"&&this.socket.state!=="stopped")throw new Error("Didn't start connection from disconnected state: "+this.socket.state);const e=new this.webSocketConstructor(this.uri);this._logVerbose("constructed WebSocket"),this.setSocketState({state:"connecting",ws:e,paused:"no"}),this.resetServerInactivityTimeout(),e.onopen=()=>{if(this.logger.logVerbose("begin ws.onopen"),this.socket.state!=="connecting")throw new Error("onopen called with socket not in connecting state");this.setSocketState({state:"ready",ws:e,paused:this.socket.paused==="yes"?"uninitialized":"no"}),this.resetServerInactivityTimeout(),this.socket.paused==="no"&&(this._hasEverConnected=!0,this.onOpen({connectionCount:this.connectionCount,lastCloseReason:this.lastCloseReason})),this.lastCloseReason!=="InitialConnect"&&this.logger.log("WebSocket reconnected"),this.connectionCount+=1,this.lastCloseReason=null},e.onerror=t=>{const n=t.message;this.logger.log(`WebSocket error: ${n}`)},e.onmessage=t=>{this.resetServerInactivityTimeout();const n=Is(JSON.parse(t.data));this._logVerbose(`received ws message with type ${n.type}`),this.onMessage(n).hasSyncedPastLastReconnect&&(this.retries=0,this.markConnectionStateDirty())},e.onclose=t=>{if(this._logVerbose("begin ws.onclose"),this.lastCloseReason===null&&(this.lastCloseReason=t.reason??"OnCloseInvoked"),t.code!==Ds&&t.code!==Vs&&t.code!==Ps&&t.code!==Fs){let r=`WebSocket closed with code ${t.code}`;t.reason&&(r+=`: ${t.reason}`),this.logger.log(r),this.onServerDisconnectError&&t.reason&&this.onServerDisconnectError(r)}const n=Qs(t.reason);this.scheduleReconnect(n)}}socketState(){return this.socket.state}sendMessage(e){const t={type:e.type,...e.type==="Authenticate"&&e.tokenType==="User"?{value:`...${e.value.slice(-7)}`}:{}};if(this.socket.state==="ready"&&this.socket.paused==="no"){const n=xs(e),r=JSON.stringify(n);try{this.socket.ws.send(r)}catch(i){this.logger.log(`Failed to send message on WebSocket, reconnecting: ${i}`),this.closeAndReconnect("FailedToSendMessage")}return this._logVerbose(`sent message with type ${e.type}: ${JSON.stringify(t)}`),!0}return this._logVerbose(`message not sent (socket state: ${this.socket.state}, paused: ${"paused"in this.socket?this.socket.paused:void 0}): ${JSON.stringify(t)}`),!1}resetServerInactivityTimeout(){this.socket.state!=="terminated"&&(this.reconnectDueToServerInactivityTimeout!==null&&(clearTimeout(this.reconnectDueToServerInactivityTimeout),this.reconnectDueToServerInactivityTimeout=null),this.reconnectDueToServerInactivityTimeout=setTimeout(()=>{this.closeAndReconnect("InactiveServer")},this.serverInactivityThreshold))}scheduleReconnect(e){this.socket={state:"disconnected"};const t=this.nextBackoff(e);this.markConnectionStateDirty(),this.logger.log(`Attempting reconnect in ${t}ms`),setTimeout(()=>this.connect(),t)}closeAndReconnect(e){switch(this._logVerbose(`begin closeAndReconnect with reason ${e}`),this.socket.state){case"disconnected":case"terminated":case"stopped":return;case"connecting":case"ready":{this.lastCloseReason=e,this.close(),this.scheduleReconnect("client");return}default:this.socket}}close(){switch(this.socket.state){case"disconnected":case"terminated":case"stopped":return Promise.resolve();case"connecting":{const e=this.socket.ws;return new Promise(t=>{e.onclose=()=>{this._logVerbose("Closed after connecting"),t()},e.onopen=()=>{this._logVerbose("Opened after connecting"),e.close()}})}case"ready":{this._logVerbose("ws.close called");const e=this.socket.ws,t=new Promise(n=>{e.onclose=()=>{n()}});return e.close(),t}default:return this.socket,Promise.resolve()}}terminate(){switch(this.reconnectDueToServerInactivityTimeout&&clearTimeout(this.reconnectDueToServerInactivityTimeout),this.socket.state){case"terminated":case"stopped":case"disconnected":case"connecting":case"ready":{const e=this.close();return this.setSocketState({state:"terminated"}),e}default:throw this.socket,new Error(`Invalid websocket state: ${this.socket.state}`)}}stop(){switch(this.socket.state){case"terminated":return Promise.resolve();case"connecting":case"stopped":case"disconnected":case"ready":{const e=this.close();return this.socket={state:"stopped"},e}default:return this.socket,Promise.resolve()}}tryRestart(){switch(this.socket.state){case"stopped":break;case"terminated":case"connecting":case"ready":case"disconnected":this.logger.logVerbose("Restart called without stopping first");return;default:this.socket}this.connect()}pause(){switch(this.socket.state){case"disconnected":case"stopped":case"terminated":return;case"connecting":case"ready":{this.socket={...this.socket,paused:"yes"};return}default:{this.socket;return}}}resume(){switch(this.socket.state){case"connecting":this.socket={...this.socket,paused:"no"};return;case"ready":this.socket.paused==="uninitialized"?(this.socket={...this.socket,paused:"no"},this.onOpen({connectionCount:this.connectionCount,lastCloseReason:this.lastCloseReason})):this.socket.paused==="yes"&&(this.socket={...this.socket,paused:"no"},this.onResume());return;case"terminated":case"stopped":case"disconnected":return;default:this.socket}this.connect()}connectionState(){return{isConnected:this.socket.state==="ready",hasEverConnected:this._hasEverConnected,connectionCount:this.connectionCount,connectionRetries:this.retries}}_logVerbose(e){this.logger.logVerbose(e)}nextBackoff(e){const n=(e==="client"?100:e==="Unknown"?this.defaultInitialBackoff:Rt[e].timeout)*Math.pow(2,this.retries);this.retries+=1;const r=Math.min(n,this.maxBackoff),i=r*(Math.random()-.5);return r+i}}function Bs(){return Us()}function Us(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{const e=Math.random()*16|0;return(s==="x"?e:e&3|8).toString(16)})}class ge extends Error{}ge.prototype.name="InvalidTokenError";function Ws(s){return decodeURIComponent(atob(s).replace(/(.)/g,(e,t)=>{let n=t.charCodeAt(0).toString(16).toUpperCase();return n.length<2&&(n="0"+n),"%"+n}))}function js(s){let e=s.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return Ws(e)}catch{return atob(e)}}function Hs(s,e){if(typeof s!="string")throw new ge("Invalid token specified: must be a string");e||(e={});const t=e.header===!0?0:1,n=s.split(".")[t];if(typeof n!="string")throw new ge(`Invalid token specified: missing part #${t+1}`);let r;try{r=js(n)}catch(i){throw new ge(`Invalid token specified: invalid base64 for part #${t+1} (${i.message})`)}try{return JSON.parse(r)}catch(i){throw new ge(`Invalid token specified: invalid json for part #${t+1} (${i.message})`)}}var Js=Object.defineProperty,Ys=(s,e,t)=>e in s?Js(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,D=(s,e,t)=>Ys(s,typeof e!="symbol"?e+"":e,t);const zs=480*60*60*1e3,lt=2;class Xs{constructor(e,t,n){D(this,"authState",{state:"noAuth"}),D(this,"configVersion",0),D(this,"syncState"),D(this,"authenticate"),D(this,"stopSocket"),D(this,"tryRestartSocket"),D(this,"pauseSocket"),D(this,"resumeSocket"),D(this,"clearAuth"),D(this,"logger"),D(this,"refreshTokenLeewaySeconds"),D(this,"tokenConfirmationAttempts",0),this.syncState=e,this.authenticate=t.authenticate,this.stopSocket=t.stopSocket,this.tryRestartSocket=t.tryRestartSocket,this.pauseSocket=t.pauseSocket,this.resumeSocket=t.resumeSocket,this.clearAuth=t.clearAuth,this.logger=n.logger,this.refreshTokenLeewaySeconds=n.refreshTokenLeewaySeconds}async setConfig(e,t){this.resetAuthState(),this._logVerbose("pausing WS for auth token fetch"),this.pauseSocket();const n=await this.fetchTokenAndGuardAgainstRace(e,{forceRefreshToken:!1});n.isFromOutdatedConfig||(n.value?(this.setAuthState({state:"waitingForServerConfirmationOfCachedToken",config:{fetchToken:e,onAuthChange:t},hasRetried:!1}),this.authenticate(n.value)):(this.setAuthState({state:"initialRefetch",config:{fetchToken:e,onAuthChange:t}}),await this.refetchToken()),this._logVerbose("resuming WS after auth token fetch"),this.resumeSocket())}onTransition(e){if(this.syncState.isCurrentOrNewerAuthVersion(e.endVersion.identity)&&!(e.endVersion.identity<=e.startVersion.identity)){if(this.authState.state==="waitingForServerConfirmationOfCachedToken"){this._logVerbose("server confirmed auth token is valid"),this.refetchToken(),this.authState.config.onAuthChange(!0);return}this.authState.state==="waitingForServerConfirmationOfFreshToken"&&(this._logVerbose("server confirmed new auth token is valid"),this.scheduleTokenRefetch(this.authState.token),this.tokenConfirmationAttempts=0,this.authState.hadAuth||this.authState.config.onAuthChange(!0))}}onAuthError(e){if(e.authUpdateAttempted===!1&&(this.authState.state==="waitingForServerConfirmationOfFreshToken"||this.authState.state==="waitingForServerConfirmationOfCachedToken")){this._logVerbose("ignoring non-auth token expired error");return}const{baseVersion:t}=e;if(!this.syncState.isCurrentOrNewerAuthVersion(t+1)){this._logVerbose("ignoring auth error for previous auth attempt");return}this.tryToReauthenticate(e)}async tryToReauthenticate(e){if(this._logVerbose(`attempting to reauthenticate: ${e.error}`),this.authState.state==="noAuth"||this.authState.state==="waitingForServerConfirmationOfFreshToken"&&this.tokenConfirmationAttempts>=lt){this.logger.error(`Failed to authenticate: "${e.error}", check your server auth config`),this.syncState.hasAuth()&&this.syncState.clearAuth(),this.authState.state!=="noAuth"&&this.setAndReportAuthFailed(this.authState.config.onAuthChange);return}this.authState.state==="waitingForServerConfirmationOfFreshToken"&&(this.tokenConfirmationAttempts++,this._logVerbose(`retrying reauthentication, ${lt-this.tokenConfirmationAttempts} attempts remaining`)),await this.stopSocket();const t=await this.fetchTokenAndGuardAgainstRace(this.authState.config.fetchToken,{forceRefreshToken:!0});t.isFromOutdatedConfig||(t.value&&this.syncState.isNewAuth(t.value)?(this.authenticate(t.value),this.setAuthState({state:"waitingForServerConfirmationOfFreshToken",config:this.authState.config,token:t.value,hadAuth:this.authState.state==="notRefetching"||this.authState.state==="waitingForScheduledRefetch"})):(this._logVerbose("reauthentication failed, could not fetch a new token"),this.syncState.hasAuth()&&this.syncState.clearAuth(),this.setAndReportAuthFailed(this.authState.config.onAuthChange)),this.tryRestartSocket())}async refetchToken(){if(this.authState.state==="noAuth")return;this._logVerbose("refetching auth token");const e=await this.fetchTokenAndGuardAgainstRace(this.authState.config.fetchToken,{forceRefreshToken:!0});e.isFromOutdatedConfig||(e.value?this.syncState.isNewAuth(e.value)?(this.setAuthState({state:"waitingForServerConfirmationOfFreshToken",hadAuth:this.syncState.hasAuth(),token:e.value,config:this.authState.config}),this.authenticate(e.value)):this.setAuthState({state:"notRefetching",config:this.authState.config}):(this._logVerbose("refetching token failed"),this.syncState.hasAuth()&&this.clearAuth(),this.setAndReportAuthFailed(this.authState.config.onAuthChange)),this._logVerbose("restarting WS after auth token fetch (if currently stopped)"),this.tryRestartSocket())}scheduleTokenRefetch(e){if(this.authState.state==="noAuth")return;const t=this.decodeToken(e);if(!t){this.logger.error("Auth token is not a valid JWT, cannot refetch the token");return}const{iat:n,exp:r}=t;if(!n||!r){this.logger.error("Auth token does not have required fields, cannot refetch the token");return}const i=r-n;if(i<=2){this.logger.error("Auth token does not live long enough, cannot refetch the token");return}let o=Math.min(zs,(i-this.refreshTokenLeewaySeconds)*1e3);o<=0&&(this.logger.warn(`Refetching auth token immediately, configured leeway ${this.refreshTokenLeewaySeconds}s is larger than the token's lifetime ${i}s`),o=0);const a=setTimeout(()=>{this._logVerbose("running scheduled token refetch"),this.refetchToken()},o);this.setAuthState({state:"waitingForScheduledRefetch",refetchTokenTimeoutId:a,config:this.authState.config}),this._logVerbose(`scheduled preemptive auth token refetching in ${o}ms`)}async fetchTokenAndGuardAgainstRace(e,t){const n=++this.configVersion;this._logVerbose(`fetching token with config version ${n}`);const r=await e(t);return this.configVersion!==n?(this._logVerbose(`stale config version, expected ${n}, got ${this.configVersion}`),{isFromOutdatedConfig:!0}):{isFromOutdatedConfig:!1,value:r}}stop(){this.resetAuthState(),this.configVersion++,this._logVerbose(`config version bumped to ${this.configVersion}`)}setAndReportAuthFailed(e){e(!1),this.resetAuthState()}resetAuthState(){this.setAuthState({state:"noAuth"})}setAuthState(e){const t=e.state==="waitingForServerConfirmationOfFreshToken"?{hadAuth:e.hadAuth,state:e.state,token:`...${e.token.slice(-7)}`}:{state:e.state};switch(this._logVerbose(`setting auth state to ${JSON.stringify(t)}`),e.state){case"waitingForScheduledRefetch":case"notRefetching":case"noAuth":this.tokenConfirmationAttempts=0;break}this.authState.state==="waitingForScheduledRefetch"&&(clearTimeout(this.authState.refetchTokenTimeoutId),this.syncState.markAuthCompletion()),this.authState=e}decodeToken(e){try{return Hs(e)}catch(t){return this._logVerbose(`Error decoding token: ${t instanceof Error?t.message:"Unknown error"}`),null}}_logVerbose(e){this.logger.logVerbose(`${e} [v${this.configVersion}]`)}}const Gs=["convexClientConstructed","convexWebSocketOpen","convexFirstMessageReceived"];function Zs(s,e){const t={sessionId:e};typeof performance>"u"||!performance.mark||performance.mark(s,{detail:t})}function Ks(s){let e=s.name.slice(6);return e=e.charAt(0).toLowerCase()+e.slice(1),{name:e,startTime:s.startTime}}function en(s){if(typeof performance>"u"||!performance.getEntriesByName)return[];const e=[];for(const t of Gs){const n=performance.getEntriesByName(t).filter(r=>r.entryType==="mark").filter(r=>r.detail.sessionId===s);e.push(...n)}return e.map(Ks)}var tn=Object.defineProperty,sn=(s,e,t)=>e in s?tn(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,A=(s,e,t)=>sn(s,typeof e!="symbol"?e+"":e,t);class nn{constructor(e,t,n){if(A(this,"address"),A(this,"state"),A(this,"requestManager"),A(this,"webSocketManager"),A(this,"authenticationManager"),A(this,"remoteQuerySet"),A(this,"optimisticQueryResults"),A(this,"_transitionHandlerCounter",0),A(this,"_nextRequestId"),A(this,"_onTransitionFns",new Map),A(this,"_sessionId"),A(this,"firstMessageReceived",!1),A(this,"debug"),A(this,"logger"),A(this,"maxObservedTimestamp"),A(this,"connectionStateSubscribers",new Map),A(this,"nextConnectionStateSubscriberId",0),A(this,"_lastPublishedConnectionState"),A(this,"markConnectionStateDirty",()=>{Promise.resolve().then(()=>{const f=this.connectionState();if(JSON.stringify(f)!==JSON.stringify(this._lastPublishedConnectionState)){this._lastPublishedConnectionState=f;for(const h of this.connectionStateSubscribers.values())h(f)}})}),A(this,"mark",f=>{this.debug&&Zs(f,this.sessionId)}),typeof e=="object")throw new Error("Passing a ClientConfig object is no longer supported. Pass the URL of the Convex deployment as a string directly.");(n==null?void 0:n.skipConvexDeploymentUrlCheck)!==!0&&yt(e),n={...n};const r=n.authRefreshTokenLeewaySeconds??2;let i=n.webSocketConstructor;if(!i&&typeof WebSocket>"u")throw new Error("No WebSocket global variable defined! To use Convex in an environment without WebSocket try the HTTP client: https://docs.convex.dev/api/classes/browser.ConvexHttpClient");i=i||WebSocket,this.debug=n.reportDebugInfoToConvex??!1,this.address=e,this.logger=n.logger===!1?gs({verbose:n.verbose??!1}):n.logger!==!0&&n.logger?n.logger:fs({verbose:n.verbose??!1});const o=e.search("://");if(o===-1)throw new Error("Provided address was not an absolute URL.");const a=e.substring(o+3),u=e.substring(0,o);let y;if(u==="http")y="ws";else if(u==="https")y="wss";else throw new Error(`Unknown parent protocol ${u}`);const C=`${y}://${a}/api/${ot}/sync`;this.state=new vs,this.remoteQuerySet=new ht(f=>this.state.queryPath(f),this.logger),this.requestManager=new Ss(this.logger,this.markConnectionStateDirty),this.authenticationManager=new Xs(this.state,{authenticate:f=>{const h=this.state.setAuth(f);return this.webSocketManager.sendMessage(h),h.baseVersion},stopSocket:()=>this.webSocketManager.stop(),tryRestartSocket:()=>this.webSocketManager.tryRestart(),pauseSocket:()=>{this.webSocketManager.pause(),this.state.pause()},resumeSocket:()=>this.webSocketManager.resume(),clearAuth:()=>{this.clearAuth()}},{logger:this.logger,refreshTokenLeewaySeconds:r}),this.optimisticQueryResults=new Cs,this.addOnTransitionHandler(f=>{t(f.queries.map(h=>h.token))}),this._nextRequestId=0,this._sessionId=Bs();const{unsavedChangesWarning:b}=n;if(typeof window>"u"||typeof window.addEventListener>"u"){if(b===!0)throw new Error("unsavedChangesWarning requested, but window.addEventListener not found! Remove {unsavedChangesWarning: true} from Convex client options.")}else b!==!1&&window.addEventListener("beforeunload",f=>{if(this.requestManager.hasIncompleteRequests()){f.preventDefault();const h="Are you sure you want to leave? Your changes may not be saved.";return(f||window.event).returnValue=h,h}});this.webSocketManager=new Ns(C,{onOpen:f=>{this.mark("convexWebSocketOpen"),this.webSocketManager.sendMessage({...f,type:"Connect",sessionId:this._sessionId,maxObservedTimestamp:this.maxObservedTimestamp});const h=new Set(this.remoteQuerySet.remoteQueryResults().keys());this.remoteQuerySet=new ht(Q=>this.state.queryPath(Q),this.logger);const[w,k]=this.state.restart(h);k&&this.webSocketManager.sendMessage(k),this.webSocketManager.sendMessage(w);for(const Q of this.requestManager.restart())this.webSocketManager.sendMessage(Q)},onResume:()=>{const[f,h]=this.state.resume();h&&this.webSocketManager.sendMessage(h),f&&this.webSocketManager.sendMessage(f);for(const w of this.requestManager.resume())this.webSocketManager.sendMessage(w)},onMessage:f=>{switch(this.firstMessageReceived||(this.firstMessageReceived=!0,this.mark("convexFirstMessageReceived"),this.reportMarks()),f.type){case"Transition":{this.observedTimestamp(f.endVersion.ts),this.authenticationManager.onTransition(f),this.remoteQuerySet.transition(f),this.state.transition(f);const h=this.requestManager.removeCompleted(this.remoteQuerySet.timestamp());this.notifyOnQueryResultChanges(h);break}case"MutationResponse":{f.success&&this.observedTimestamp(f.ts);const h=this.requestManager.onResponse(f);h!==null&&this.notifyOnQueryResultChanges(new Map([[h.requestId,h.result]]));break}case"ActionResponse":{this.requestManager.onResponse(f);break}case"AuthError":{this.authenticationManager.onAuthError(f);break}case"FatalError":{const h=ys(this.logger,f.error);throw this.webSocketManager.terminate(),h}}return{hasSyncedPastLastReconnect:this.hasSyncedPastLastReconnect()}},onServerDisconnectError:n.onServerDisconnectError},i,this.logger,this.markConnectionStateDirty),this.mark("convexClientConstructed")}hasSyncedPastLastReconnect(){return this.requestManager.hasSyncedPastLastReconnect()||this.state.hasSyncedPastLastReconnect()}observedTimestamp(e){(this.maxObservedTimestamp===void 0||this.maxObservedTimestamp.lessThanOrEqual(e))&&(this.maxObservedTimestamp=e)}getMaxObservedTimestamp(){return this.maxObservedTimestamp}notifyOnQueryResultChanges(e){const t=this.remoteQuerySet.remoteQueryResults(),n=new Map;for(const[i,o]of t){const a=this.state.queryToken(i);if(a!==null){const u={result:o,udfPath:this.state.queryPath(i),args:this.state.queryArgs(i)};n.set(a,u)}}const r=this.optimisticQueryResults.ingestQueryResultsFromServer(n,new Set(e.keys()));this.handleTransition({queries:r.map(i=>{const o=this.optimisticQueryResults.rawQueryResult(i);return{token:i,modification:{kind:"Updated",result:o.result}}}),reflectedMutations:Array.from(e).map(([i,o])=>({requestId:i,result:o})),timestamp:this.remoteQuerySet.timestamp()})}handleTransition(e){for(const t of this._onTransitionFns.values())t(e)}addOnTransitionHandler(e){const t=this._transitionHandlerCounter++;return this._onTransitionFns.set(t,e),()=>this._onTransitionFns.delete(t)}setAuth(e,t){this.authenticationManager.setConfig(e,t)}hasAuth(){return this.state.hasAuth()}setAdminAuth(e,t){const n=this.state.setAdminAuth(e,t);this.webSocketManager.sendMessage(n)}clearAuth(){const e=this.state.clearAuth();this.webSocketManager.sendMessage(e)}subscribe(e,t,n){const r=J(t),{modification:i,queryToken:o,unsubscribe:a}=this.state.subscribe(e,r,n==null?void 0:n.journal,n==null?void 0:n.componentPath);return i!==null&&this.webSocketManager.sendMessage(i),{queryToken:o,unsubscribe:()=>{const u=a();u&&this.webSocketManager.sendMessage(u)}}}localQueryResult(e,t){const n=J(t),r=ee(e,n);return this.optimisticQueryResults.queryResult(r)}localQueryResultByToken(e){return this.optimisticQueryResults.queryResult(e)}hasLocalQueryResultByToken(e){return this.optimisticQueryResults.hasQueryResult(e)}localQueryLogs(e,t){const n=J(t),r=ee(e,n);return this.optimisticQueryResults.queryLogs(r)}queryJournal(e,t){const n=J(t),r=ee(e,n);return this.state.queryJournal(r)}connectionState(){const e=this.webSocketManager.connectionState();return{hasInflightRequests:this.requestManager.hasInflightRequests(),isWebSocketConnected:e.isConnected,hasEverConnected:e.hasEverConnected,connectionCount:e.connectionCount,connectionRetries:e.connectionRetries,timeOfOldestInflightRequest:this.requestManager.timeOfOldestInflightRequest(),inflightMutations:this.requestManager.inflightMutations(),inflightActions:this.requestManager.inflightActions()}}subscribeToConnectionState(e){const t=this.nextConnectionStateSubscriberId++;return this.connectionStateSubscribers.set(t,e),()=>{this.connectionStateSubscribers.delete(t)}}async mutation(e,t,n){const r=await this.mutationInternal(e,t,n);if(!r.success)throw r.errorData!==void 0?We(r,new Ue(ie("mutation",e,r))):new Error(ie("mutation",e,r));return r.value}async mutationInternal(e,t,n,r){const{mutationPromise:i}=this.enqueueMutation(e,t,n,r);return i}enqueueMutation(e,t,n,r){const i=J(t);this.tryReportLongDisconnect();const o=this.nextRequestId;if(this._nextRequestId++,n!==void 0){const C=n.optimisticUpdate;if(C!==void 0){const b=w=>{C(w,i)instanceof Promise&&this.logger.warn("Optimistic update handler returned a Promise. Optimistic updates should be synchronous.")},h=this.optimisticQueryResults.applyOptimisticUpdate(b,o).map(w=>{const k=this.localQueryResultByToken(w);return{token:w,modification:{kind:"Updated",result:k===void 0?void 0:{success:!0,value:k,logLines:[]}}}});this.handleTransition({queries:h,reflectedMutations:[],timestamp:this.remoteQuerySet.timestamp()})}}const a={type:"Mutation",requestId:o,udfPath:e,componentPath:r,args:[j(i)]},u=this.webSocketManager.sendMessage(a),y=this.requestManager.request(a,u);return{requestId:o,mutationPromise:y}}async action(e,t){const n=await this.actionInternal(e,t);if(!n.success)throw n.errorData!==void 0?We(n,new Ue(ie("action",e,n))):new Error(ie("action",e,n));return n.value}async actionInternal(e,t,n){const r=J(t),i=this.nextRequestId;this._nextRequestId++,this.tryReportLongDisconnect();const o={type:"Action",requestId:i,udfPath:e,componentPath:n,args:[j(r)]},a=this.webSocketManager.sendMessage(o);return this.requestManager.request(o,a)}async close(){return this.authenticationManager.stop(),this.webSocketManager.terminate()}get url(){return this.address}get nextRequestId(){return this._nextRequestId}get sessionId(){return this._sessionId}reportMarks(){if(this.debug){const e=en(this.sessionId);this.webSocketManager.sendMessage({type:"Event",eventType:"ClientConnect",event:e})}}tryReportLongDisconnect(){if(!this.debug)return;const e=this.connectionState().timeOfOldestInflightRequest;if(e===null||Date.now()-e.getTime()<=60*1e3)return;const t=`${this.address}/api/debug_event`;fetch(t,{method:"POST",headers:{"Content-Type":"application/json","Convex-Client":`npm-${ot}`},body:JSON.stringify({event:"LongWebsocketDisconnect"})}).then(n=>{n.ok||this.logger.warn("Analytics request failed with response:",n.body)}).catch(n=>{this.logger.warn("Analytics response failed with error:",n)})}}var rn=Object.defineProperty,on=(s,e,t)=>e in s?rn(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,le=(s,e,t)=>on(s,typeof e!="symbol"?e+"":e,t);class an{constructor(e,t={}){le(this,"listeners"),le(this,"_client"),le(this,"callNewListenersWithCurrentValuesTimer"),le(this,"_closed"),le(this,"_disabled"),t.skipConvexDeploymentUrlCheck!==!0&&yt(e);const{disabled:n,...r}=t;this._closed=!1,this._disabled=!!n,typeof window>"u"&&!("unsavedChangesWarning"in r)&&(r.unsavedChangesWarning=!1),this.disabled||(this._client=new nn(e,i=>this._transition(i),r)),this.listeners=new Set}get closed(){return this._closed}get client(){if(this._client)return this._client;throw new Error("ConvexClient is disabled")}get disabled(){return this._disabled}onUpdate(e,t,n,r){if(this.disabled){const C=()=>{};return Object.assign(C,{unsubscribe:C,getCurrentValue:()=>{},getQueryLogs:()=>{}}),C}const{queryToken:i,unsubscribe:o}=this.client.subscribe(Y(e),t),a={queryToken:i,callback:n,onError:r,unsubscribe:o,hasEverRun:!1,query:e,args:t};this.listeners.add(a),this.queryResultReady(i)&&this.callNewListenersWithCurrentValuesTimer===void 0&&(this.callNewListenersWithCurrentValuesTimer=setTimeout(()=>this.callNewListenersWithCurrentValues(),0));const u={unsubscribe:()=>{this.closed||(this.listeners.delete(a),o())},getCurrentValue:()=>this.client.localQueryResultByToken(i),getQueryLogs:()=>this.client.localQueryLogs(i)},y=u.unsubscribe;return Object.assign(y,u),y}callNewListenersWithCurrentValues(){this.callNewListenersWithCurrentValuesTimer=void 0,this._transition([],!0)}queryResultReady(e){return this.client.hasLocalQueryResultByToken(e)}async close(){if(!this.disabled)return this.listeners.clear(),this._closed=!0,this.client.close()}setAuth(e,t){this.disabled||this.client.setAuth(e,t??(()=>{}))}setAdminAuth(e,t){if(this.closed)throw new Error("ConvexClient has already been closed.");this.disabled||this.client.setAdminAuth(e,t)}_transition(e,t=!1){for(const n of this.listeners){const{callback:r,queryToken:i,onError:o,hasEverRun:a}=n;if(e.includes(i)||t&&!a&&this.client.hasLocalQueryResultByToken(i)){n.hasEverRun=!0;let u;try{u=this.client.localQueryResultByToken(i)}catch(y){if(!(y instanceof Error))throw y;o?o(y,"Second argument to onUpdate onError is reserved for later use"):Promise.reject(y);continue}r(u,"Second argument to onUpdate callback is reserved for later use")}}}async mutation(e,t,n){if(this.disabled)throw new Error("ConvexClient is disabled");return await this.client.mutation(Y(e),t,n)}async action(e,t){if(this.disabled)throw new Error("ConvexClient is disabled");return await this.client.action(Y(e),t)}async query(e,t){if(this.disabled)throw new Error("ConvexClient is disabled");const n=this.client.localQueryResult(Y(e),t);return n!==void 0?Promise.resolve(n):new Promise((r,i)=>{const{unsubscribe:o}=this.onUpdate(e,t,a=>{o(),r(a)},a=>{o(),i(a)})})}connectionState(){if(this.disabled)throw new Error("ConvexClient is disabled");return this.client.connectionState()}subscribeToConnectionState(e){return this.disabled?()=>{}:this.client.subscribeToConnectionState(e)}}const Ct="$$_convexClient",un=()=>{const s=$t(Ct);if(!s)throw new Error("No ConvexClient was found in Svelte context. Did you forget to call setupConvex() in a parent component?");return s},cn=s=>{Ot(Ct,s)},xn=(s,e={})=>{const t={disabled:!Dt,...e},n=new an(s,t);cn(n),Qe(()=>()=>n.close())};function En(s,e,t={}){const n=un();if(typeof s=="string")throw new Error("Query must be a functionReference object, not a string");const r=qt({result:fe(t).initialData,argsForLastResult:void 0,lastResult:void 0,haveArgsEverChanged:!1});Qe(()=>{const h=de(e);return n.onUpdate(s,h,k=>{const Q=structuredClone(k);r.result=Q,r.argsForLastResult=h,r.lastResult=Q},k=>{r.result=k,r.argsForLastResult=h;const Q=structuredClone(k);r.lastResult=Q})});const i=B(()=>!!r.argsForLastResult&&JSON.stringify(j(r.argsForLastResult))===JSON.stringify(j(de(e)))),o=B(()=>!!(fe(t).keepPreviousData&&r.lastResult)),a=de(e);Qe(()=>{Mt(()=>r.haveArgsEverChanged)||JSON.stringify(j(de(e)))!==JSON.stringify(j(a))&&(r.haveArgsEverChanged=!0,fe(t).initialData!==void 0&&(r.argsForLastResult=Ze(a),r.lastResult=fe(t).initialData))});const u=B(()=>{if(fe(t).initialData&&!r.haveArgsEverChanged)return r.result;let w;try{w=n.disabled?void 0:n.client.localQueryResult(Y(s),de(e))}catch(k){if(!(k instanceof Error))throw console.error("threw non-Error instance",k),k;w=k}return r.result,w}),y=B(()=>T(u)!==void 0?T(u):T(o)?r.lastResult:void 0),C=B(()=>T(u)===void 0&&T(o)&&!T(i)&&T(y)!==void 0),b=B(()=>{if(!(T(y)instanceof Error))return T(y)}),f=B(()=>{if(T(y)instanceof Error)return T(y)});return{get data(){return T(b)},get isLoading(){return T(f)===void 0&&T(b)===void 0},get error(){return T(f)},get isStale(){return T(C)}}}function de(s){return typeof s=="function"&&(s=s()),Ze(s)}function fe(s){return typeof s=="function"&&(s=s()),Ze(s)}export{qn as C,Tn as D,Mn as I,An as S,In as a,Cn as b,_n as c,On as d,un as e,$n as f,xn as s,En as u};
